<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>MySQLåœ¨å¯é‡å¤è¯»çš„éš”ç¦»çº§åˆ«ä¸‹åˆ°åº•è§£è§£å†³äº†å¹»è¯»çš„é—®é¢˜æ²¡æœ‰?</title>
    <link href="/2021/11/10/MySQL%E5%9C%A8%E5%8F%AF%E9%87%8D%E5%A4%8D%E8%AF%BB%E7%9A%84%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB%E4%B8%8B%E5%88%B0%E5%BA%95%E8%A7%A3%E8%A7%A3%E5%86%B3%E4%BA%86%E5%B9%BB%E8%AF%BB%E7%9A%84%E9%97%AE%E9%A2%98%E6%B2%A1%E6%9C%89/"/>
    <url>/2021/11/10/MySQL%E5%9C%A8%E5%8F%AF%E9%87%8D%E5%A4%8D%E8%AF%BB%E7%9A%84%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB%E4%B8%8B%E5%88%B0%E5%BA%95%E8%A7%A3%E8%A7%A3%E5%86%B3%E4%BA%86%E5%B9%BB%E8%AF%BB%E7%9A%84%E9%97%AE%E9%A2%98%E6%B2%A1%E6%9C%89/</url>
    
    <content type="html"><![CDATA[<h2 id="RRå¹»è¯»åˆ°åº•è¢«è§£å†³äº†æ²¡ï¼Ÿ"><a href="#RRå¹»è¯»åˆ°åº•è¢«è§£å†³äº†æ²¡ï¼Ÿ" class="headerlink" title="RRå¹»è¯»åˆ°åº•è¢«è§£å†³äº†æ²¡ï¼Ÿ"></a>RRå¹»è¯»åˆ°åº•è¢«è§£å†³äº†æ²¡ï¼Ÿ</h2><p>åšä¸šåŠ¡æœ‹å‹å¯¹æ•°æ®åº“çš„ACIDå¤šå°‘éƒ½äº†è§£ä¸€äº›ï¼Œè¿™é‡Œé¢åˆå°¤å…¶éš”ç¦»æ€§æ˜¯è®¨è®ºæœ€å¤šä¸”æœ€å¤æ‚çš„ï¼Œè¯´åˆ°éš”ç¦»æ€§å°±ä¸å¾—ä¸è¯´ç”±äºéš”ç¦»äº§ç”Ÿçš„é—®é¢˜ï¼š</p><ol><li>è„è¯»</li><li>ä¸å¯é‡å¤è¯»</li><li>å¹»è¯»</li></ol><p>è¿™é‡Œé¢äº‰è®®æœ€å¤§çš„å°±æ•°MySQLé»˜è®¤éš”ç¦»çº§åˆ«RRæ˜¯å¦è§£å†³äº†å¹»è¯»çš„é—®é¢˜ï¼Œ è¿™ç¯‡æ–‡ç« å°±æ˜¯ä»¥å®æ“çš„è§’åº¦æ¥çœ‹è¿™ä¸ªé—®é¢˜ï¼Œæ‰€è°“å…‰è¯´ä¸ç»ƒå‡æŠŠå¼ï¼Œé€è¿‡ç°è±¡çœ‹åˆ°äº‹æƒ…çš„æœ¬è´¨æ‰æ˜¯æˆ‘ä»¬è¦åšçš„</p><blockquote><p>å…ˆè¯´ç»“è®º:<br>MySQLåœ¨å¯é‡å¤è¯»éš”ç¦»çº§åˆ«ä¸‹å¹¶æ²¡æœ‰è§£å†³å¹»è¯»çš„é—®é¢˜ã€‚<br>MySQLè¯»å–æ•°æ®æœ‰ä¸¤ç§æ¨¡å¼ï¼Œåˆ†ä¸ºå¿«ç…§è¯»å’Œå½“å‰è¯»ï¼Œåœ¨å½“å‰è¯»ä¸‹MySQLé€šè¿‡å¼•å…¥é—´éš™é”ï¼ˆgap lockï¼‰ èƒ½é¿å…å¹»è¯»çš„å‡ºç°ã€‚<br>å½“ä½¿ç”¨å¿«ç…§è¯»çš„æ—¶å€™ä»å¯èƒ½å­˜åœ¨å¹»è¯»çš„å‡ºç°ã€‚</p></blockquote><p>å¯èƒ½äº†è§£ä¸€äº›MVCCçš„äººå°±ä¼šè¯´ï¼Œä½ è¿™è¯´çš„ä¸å¯¹ï¼Œéƒ½æ˜¯å¿«ç…§è¯»äº†æ€ä¹ˆå¯èƒ½è¯»å–åˆ°å¹»è¯»çš„æ•°æ®ã€‚å…¶å®è¿™ä¸ªé—®é¢˜åœ¨æˆ‘ä¸æ¸…æ¥šMVCCç»†èŠ‚çš„æ—¶å€™ä¹Ÿæœ‰ä¸€æ ·çš„ç–‘é—®ã€‚ æˆ‘ä»¬å…ˆçœ‹ä¸‹é¢çš„å®ä¾‹ã€‚</p><h2 id="å‡ºç°å¹»è¯»çš„å®ä¾‹"><a href="#å‡ºç°å¹»è¯»çš„å®ä¾‹" class="headerlink" title="å‡ºç°å¹»è¯»çš„å®ä¾‹"></a>å‡ºç°å¹»è¯»çš„å®ä¾‹</h2><p>æ•°æ®åº“è¡¨ç»“æ„ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `test` (<br>  `id` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>  `name` <span class="hljs-type">varchar</span>(<span class="hljs-number">32</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;&#x27;</span>,<br>  `age` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;0&#x27;</span>,<br>  `sex` tinyint(<span class="hljs-number">2</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;0&#x27;</span>,<br>  <span class="hljs-keyword">PRIMARY</span> KEY (`id`)<br>) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8;<br><br><span class="hljs-comment">-- ----------------------------</span><br><span class="hljs-comment">-- Records of test</span><br><span class="hljs-comment">-- ----------------------------</span><br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `test` <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">&#x27;1&#x27;</span>, <span class="hljs-string">&#x27;bob&#x27;</span>, <span class="hljs-string">&#x27;18&#x27;</span>, <span class="hljs-string">&#x27;1&#x27;</span>);<br></code></pre></div></td></tr></table></figure><p>äº‹åŠ¡æ—¶åºå›¾ï¼š</p><table><thead><tr><th>æ—¶é—´</th><th>äº‹åŠ¡A</th><th>äº‹åŠ¡B</th></tr></thead><tbody><tr><td>T1</td><td>begin;</td><td></td></tr><tr><td>T2</td><td>select * from test where id &gt;= 1;</td><td>begin;</td></tr><tr><td>T3</td><td></td><td>insert into test(id, name, age, sex) values(2, â€˜lisaâ€™, 18, 0);</td></tr><tr><td>T4</td><td></td><td>commit;</td></tr><tr><td>T5</td><td>update test set age = 19 where id &gt;=1;</td><td></td></tr><tr><td>T6</td><td>select * from test where id &gt;= 1;</td><td></td></tr><tr><td>T7</td><td>commit;</td><td></td></tr></tbody></table><p>T2æ—¶åˆ»è·å–ç»“æœï¼š</p><figure class="highlight sh"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs sh">mysql&gt; select * from <span class="hljs-built_in">test</span> <span class="hljs-built_in">where</span> id &gt;=1;<br>+----+------+-----+-----+<br>| id | name | age | sex |<br>+----+------+-----+-----+<br>|  1 | bob  |  18 |   1 |<br>+----+------+-----+-----+<br>1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br></code></pre></div></td></tr></table></figure><p>T6æ—¶åˆ»è·å–ç»“æœï¼š</p><figure class="highlight sh"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs sh">mysql&gt; select * from <span class="hljs-built_in">test</span> <span class="hljs-built_in">where</span> id &gt;= 1;<br>+----+------+-----+-----+<br>| id | name | age | sex |<br>+----+------+-----+-----+<br>|  1 | bob  |  19 |   1 |<br>|  2 | lisa |  19 |   0 |<br>+----+------+-----+-----+<br>2 rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br></code></pre></div></td></tr></table></figure><p>ä»ä¸Šå›¾ä¸­å¯ä»¥çœ‹å‡ºæˆ‘ä»¬ä½¿ç”¨<strong>å¿«ç…§è¯»</strong>åœ¨åŒä¸€ä¸ªäº‹åŠ¡çš„å‰åä¸¤æ¬¡æ“ä½œä¸­æŸ¥åˆ°äº†å…¶ä»–äº‹åŠ¡æ–°æ’å…¥çš„æ•°æ®ï¼Œæ»¡è¶³å¹»è¯»çš„æ¦‚å¿µã€‚</p><p>é‚£ä¹ˆæ—¢ç„¶ä½¿ç”¨å¿«ç…§è¯»äº†ï¼Œä¸ºä»€å‘¢è¿˜ä¼šå‡ºç°è¿™ä¸ªé—®é¢˜å˜ï¼Ÿ</p><h3 id="æŒ‰ç…§ä¸€èˆ¬çš„éš”ç¦»æ€§åˆ†æ"><a href="#æŒ‰ç…§ä¸€èˆ¬çš„éš”ç¦»æ€§åˆ†æ" class="headerlink" title="æŒ‰ç…§ä¸€èˆ¬çš„éš”ç¦»æ€§åˆ†æ"></a>æŒ‰ç…§ä¸€èˆ¬çš„éš”ç¦»æ€§åˆ†æ</h3><p>ç†æƒ³æ¡ä»¶ä¸‹ï¼Œäº‹åŠ¡Aè·å–ä¸€æ¡æ•°æ®ç„¶åæ›´æ–°è¿™æ¡æ•°æ®ï¼Œæœ€åå†æ¬¡æŸ¥è¯¢è¿™æ¡æ•°æ®ï¼Œéƒ½åº”è¯¥æ˜¯å¯¹ä¸€æ¡æ•°æ®è¿›è¡Œæ“ä½œã€‚</p><h3 id="ç„¶è€Œè¿™å¹¶ä¸æ˜¯ç†æƒ³æ¡ä»¶"><a href="#ç„¶è€Œè¿™å¹¶ä¸æ˜¯ç†æƒ³æ¡ä»¶" class="headerlink" title="ç„¶è€Œè¿™å¹¶ä¸æ˜¯ç†æƒ³æ¡ä»¶"></a>ç„¶è€Œè¿™å¹¶ä¸æ˜¯ç†æƒ³æ¡ä»¶</h3><p>å®é™…ä¸Šäº‹åŠ¡Açš„T6æ—¶åˆ»çš„æŸ¥è¯¢ï¼Œè·å¾—äº†äº‹åŠ¡Bä¸­æ–°æ’å…¥çš„æ•°æ®ï¼Œä»”ç»†çœ‹å‘ç°æ–°æ’å…¥çš„æ•°æ®ä¹Ÿè¢«äº‹åŠ¡Aä¸­çš„updateè¯­å¥æ›´æ–°äº†ã€‚</p><h3 id="é€ æˆå¹»è¯»åŸå› "><a href="#é€ æˆå¹»è¯»åŸå› " class="headerlink" title="é€ æˆå¹»è¯»åŸå› "></a>é€ æˆå¹»è¯»åŸå› </h3><ol><li>æ›´æ–°è¯­å¥æ˜¯å½“å‰è¯»ï¼ŒT5æ—¶åˆ»çš„ update è¯­å¥æ‰§è¡Œä¹‹å‰ä¼šä½¿ç”¨å½“å‰è¯»è·å–æœ€æ–°çš„å…¨éƒ¨æ»¡è¶³æ¡ä»¶çš„æ•°æ®è¿›è¡Œæ“ä½œï¼Œè¿™å°±ä¼šå¯¼è‡´æ›´æ–°è¯­å¥æŸ¥è¯¢åˆ°äº‹åŠ¡Båœ¨T3æ—¶åˆ»æ–°æ’å…¥æ»¡è¶³æ›´æ–°æ¡ä»¶çš„æ•°æ®ã€‚</li><li>åœ¨å¯é‡å¤è¯»éš”ç¦»çº§åˆ«ä¸‹ä½¿ç”¨MVCCæ— é”å®ç°å¿«ç…§è¯»ï¼ŒT6æ—¶åˆ»ç”±äºMVCCçš„åŸç†ä½¿å¾—ç”¨æˆ·å¯ä»¥è·å–åˆ°å½“å‰äº‹åŠ¡æ›´æ–°çš„æ•°æ®ï¼Œä¹Ÿå°±æ˜¯è‡ªå·±åœ¨T5æ—¶åˆ»æ›´æ–°çš„æ–°æ’å…¥çš„æ•°æ®ï¼Œæ‰€ä»¥å¯ä»¥å±•ç¤ºå‡ºç¬¬ä¸€æ¬¡å¿«ç…§è¯»ä¸­æ²¡æœ‰çš„æ•°æ®ã€‚</li></ol><h3 id="å°è¯•ç”¨å½“å‰è¯»æ‰§è¡ŒåŒæ ·çš„äº‹åŠ¡"><a href="#å°è¯•ç”¨å½“å‰è¯»æ‰§è¡ŒåŒæ ·çš„äº‹åŠ¡" class="headerlink" title="å°è¯•ç”¨å½“å‰è¯»æ‰§è¡ŒåŒæ ·çš„äº‹åŠ¡"></a>å°è¯•ç”¨å½“å‰è¯»æ‰§è¡ŒåŒæ ·çš„äº‹åŠ¡</h3><p>äº‹åŠ¡æ—¶åºå›¾ï¼š</p><table><thead><tr><th>æ—¶é—´</th><th>äº‹åŠ¡A</th><th>äº‹åŠ¡B</th></tr></thead><tbody><tr><td>T1</td><td>begin;</td><td></td></tr><tr><td>T2</td><td>select * from test where id &gt;= 1 for update ;</td><td>begin;</td></tr><tr><td>T3</td><td></td><td>insert into test(id, name, age, sex) values(2, â€˜lisaâ€™, 18, 0); <em><strong>(blocking)</strong></em></td></tr><tr><td>T4</td><td>update test set age = 19 where id &gt;=1;</td><td></td></tr><tr><td>T5</td><td>select * from test where id &gt;= 1 for update;</td><td></td></tr><tr><td>T6</td><td>commit;</td><td></td></tr><tr><td>T7</td><td></td><td>commit;</td></tr></tbody></table><p>å¯¹æ¯”å¿«ç…§è¯»T3æ—¶åˆ»æ’å…¥æ•°æ®å°†è¢«é˜»å¡ï¼Œ è¿™æ˜¯å› ä¸ºRRä¸‹å½“å‰è¯»å¼•å…¥äº†é—´éš™é”çš„æ¦‚å¿µã€‚</p><p>æŸ¥è¯¢æ¡ä»¶ where id &gt;= 1 ä¸å…‰é”ä½äº†è¡¨ä¸­å­˜åœ¨çš„æ•°æ®id=1çš„å“ªä¸€è¡Œï¼ŒåŒæ—¶ä¹Ÿé”ä½äº† (1, +âˆ) è¿™ä¸ªé—´éš™ï¼Œæ‰€ä»¥äº‹åŠ¡Båœ¨T3æ—¶åˆ»è¯­å¥å°†è¢«é˜»å¡ï¼Œç›´åˆ°äº‹åŠ¡Aæäº¤äº‹åŠ¡ä¹‹å‰éƒ½å°†ä¸€ç›´é˜»å¡ã€‚</p><p>æ‰€ä»¥æ’è¦æ’å…¥çš„æ•°æ®æ ¹æœ¬ä¸èƒ½å‡ºç°åœ¨äº‹åŠ¡Açš„æŸ¥è¯¢è¯­å¥ä¸­ï¼Œä¹Ÿå°±æ²¡æœ‰å¯èƒ½å‡ºç°å¹»è¯»ã€‚</p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><ol><li>å½“å‰è¯»ä¸‹ç”±äºæœ‰è¡Œé”å’Œé—´éš™é”ï¼Œæ‰€ä»¥ä¸å­˜åœ¨å¹»è¯»çš„æƒ…å†µå‘ç”Ÿã€‚</li><li>åœ¨å¿«ç…§è¯»çš„æƒ…å†µä¸‹ï¼Œç”±äºäº‹åŠ¡ä¸­å¯èƒ½å­˜åœ¨æ›´æ–°è¯­å¥è¦†ç›–äº†å…¶ä»–äº‹åŠ¡ä¸­ä¸å¯è§çš„æäº¤ã€‚å¯¼è‡´ä¸€è‡´æ€§è§†å›¾å‘ç”Ÿæ”¹å˜å¯ä»¥è¯»åˆ°åˆ«çš„äº‹åŠ¡æäº¤çš„è¯­å¥å†…å®¹ï¼Œæœ€ç»ˆå¯¼è‡´å‡ºç°å¹»è¯»ã€‚</li></ol><h3 id="æ€è€ƒğŸ¤”"><a href="#æ€è€ƒğŸ¤”" class="headerlink" title="æ€è€ƒğŸ¤”"></a>æ€è€ƒğŸ¤”</h3><p>mysqlçŸ¥è¯†ç‚¹éƒ½æ˜¯ç»†ç¢çš„ï¼Œä½†åˆ†æé—®é¢˜çš„æ—¶å€™å¾€å¾€éœ€è¦å°†å…¨éƒ¨çš„çŸ¥è¯†è„‰ç»œä¸²è”èµ·æ¥ï¼Œæ­£å¦‚ä¸Šé¢çš„è¿™ä¸ªä¾‹å­ï¼Œæ¶‰åŠåˆ°äº†å½“å‰è¯»ï¼Œå¿«ç…§è¯»ï¼ŒmvccåŸç†ï¼Œè¡Œé”å’Œé—´éš™é”è¿™äº›é—®é¢˜ã€‚</p><p>å½“æˆ‘ä»¬ä¸æ¸…æ¥šçš„æ—¶å€™æœ€å¥½æ˜¯å®é™…çš„åŠ¨æ‰‹å®éªŒä¸‹ï¼Œä»…å‡­ç½‘ç»œä¸Šçš„æ–‡ç« æ ¹æœ¬æ— æ³•æ¸…æ¥šé—®é¢˜çš„æœ¬è´¨ï¼Œç”šè‡³æœ‰äº›æ–‡ç« ä¸Šçš„ä¾‹å­éƒ½æ˜¯æœ‰é—®é¢˜çš„ã€‚</p><p>æ‰€ä»¥å­¦ä¹ çš„æœ€å¥½æ–¹å¼å°±æ˜¯å®è·µï¼ŒçœŸçš„åŠ¨æ‰‹å°è¯•æ‰èƒ½å‘ç°é—®é¢˜çš„æœ¬è´¨ã€‚</p><h2 id="ç›¸å…³æ¦‚å¿µ"><a href="#ç›¸å…³æ¦‚å¿µ" class="headerlink" title="ç›¸å…³æ¦‚å¿µ"></a>ç›¸å…³æ¦‚å¿µ</h2><p>æ¦‚å¿µæ¥è‡ªç½‘ç»œï¼Œæœ‰é—®é¢˜æœ›æŒ‡æ­£ã€‚</p><h3 id="å¿«ç…§è¯»"><a href="#å¿«ç…§è¯»" class="headerlink" title="å¿«ç…§è¯»"></a>å¿«ç…§è¯»</h3><p>ä¸€ä¸ªæ­£å¸¸çš„selectâ€¦è¯­å¥å°±æ˜¯å¿«ç…§è¯»ã€‚<br>å¿«ç…§è¯»ï¼Œä½¿å¾—åœ¨RRï¼ˆrepeatable readï¼‰çº§åˆ«ä¸‹ä¸€ä¸ªæ™®é€šselectâ€¦è¯­å¥ä¹Ÿèƒ½åšåˆ°å¯é‡å¤è¯»ã€‚å³åˆ©ç”¨ä¸€è‡´æ€§è§†å›¾æ¥åšåˆ°ï¼ˆå½“å‰äº‹åŠ¡åªèƒ½è¯»åˆ°è¯¥äº‹ç‰©å¼€å¯ä»¥å‰å·²ç»æäº¤çš„æ•°æ®ï¼‰ã€‚</p><h3 id="å½“å‰è¯»"><a href="#å½“å‰è¯»" class="headerlink" title="å½“å‰è¯»"></a>å½“å‰è¯»</h3><p>insertè¯­å¥ã€updateè¯­å¥ã€deleteè¯­å¥ã€æ˜¾ç¤ºåŠ é”çš„selectè¯­å¥ï¼ˆselectâ€¦ LOCK IN SHARE MODEã€selectâ€¦ FOR UPDATEï¼‰æ˜¯å½“å‰è¯»ã€‚</p><h3 id="mvccåŸç†"><a href="#mvccåŸç†" class="headerlink" title="mvccåŸç†"></a>mvccåŸç†</h3><p>å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼ˆMVCCï¼‰ æ˜¯å®ç°ä¸€ç›´æ€§è§†å›¾ï¼ˆconsistent read viewï¼‰çš„å…³é”® å…¶ä¸­ä¸»è¦åŸç†å¦‚ä¸‹ï¼š</p><h4 id="read-view-åˆ›å»ºæ—¶æœº"><a href="#read-view-åˆ›å»ºæ—¶æœº" class="headerlink" title="read view åˆ›å»ºæ—¶æœº"></a>read view åˆ›å»ºæ—¶æœº</h4><p>å¯é‡å¤è¯»éš”ç¦»çº§åˆ«ï¼šè¿™ä¸ªè§†å›¾æ˜¯åœ¨äº‹åŠ¡å¯åŠ¨æ—¶åˆ›å»ºçš„ï¼Œæ•´ä¸ªäº‹åŠ¡å­˜åœ¨æœŸé—´éƒ½ç”¨è¿™ä¸ªè§†å›¾ã€‚</p><p>è¯»æäº¤éš”ç¦»çº§åˆ«ï¼šè¿™ä¸ªè§†å›¾æ˜¯åœ¨æ¯ä¸ª SQL è¯­å¥å¼€å§‹æ‰§è¡Œçš„æ—¶å€™åˆ›å»ºçš„ã€‚</p><blockquote><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œâ€œè¯»æœªæäº¤â€éš”ç¦»çº§åˆ«ä¸‹ç›´æ¥è¿”å›è®°å½•ä¸Šçš„æœ€æ–°å€¼ï¼Œæ²¡æœ‰è§†å›¾æ¦‚å¿µï¼›è€Œâ€œä¸²è¡Œ<br>åŒ–â€éš”ç¦»çº§åˆ«ä¸‹ç›´æ¥ç”¨åŠ é”çš„æ–¹å¼æ¥é¿å…å¹¶è¡Œè®¿é—®ã€‚</p></blockquote><h4 id="read-view-çš„ä¸»è¦å†…å®¹"><a href="#read-view-çš„ä¸»è¦å†…å®¹" class="headerlink" title="read view çš„ä¸»è¦å†…å®¹"></a>read view çš„ä¸»è¦å†…å®¹</h4><p>ReadViewæ‰€è§£å†³çš„é—®é¢˜æ˜¯ä½¿ç”¨READ COMMITTEDå’ŒREPEATABLE READéš”ç¦»çº§åˆ«çš„äº‹åŠ¡ä¸­ï¼Œä¸èƒ½è¯»åˆ°æœªæäº¤çš„è®°å½•ã€‚é€šè¿‡åˆ¤æ–­ä¸€ä¸‹ç‰ˆæœ¬é“¾ä¸­çš„å“ªä¸ªç‰ˆæœ¬æ˜¯å½“å‰äº‹åŠ¡å¯è§çš„ã€‚</p><p>ReadViewä¸­ä¸»è¦åŒ…å«4ä¸ªæ¯”è¾ƒé‡è¦çš„å†…å®¹ï¼š</p><ol><li>m_idsï¼šè¡¨ç¤ºåœ¨ç”ŸæˆReadViewæ—¶å½“å‰ç³»ç»Ÿä¸­æ´»è·ƒçš„è¯»å†™äº‹åŠ¡çš„äº‹åŠ¡idåˆ—è¡¨ã€‚</li><li>min_trx_idï¼šè¡¨ç¤ºåœ¨ç”ŸæˆReadViewæ—¶å½“å‰ç³»ç»Ÿä¸­æ´»è·ƒçš„è¯»å†™äº‹åŠ¡ä¸­æœ€å°çš„äº‹åŠ¡idï¼Œä¹Ÿå°±æ˜¯m_idsä¸­çš„æœ€å°å€¼ã€‚</li><li>max_trx_idï¼šè¡¨ç¤ºç”ŸæˆReadViewæ—¶ç³»ç»Ÿä¸­åº”è¯¥åˆ†é…ç»™ä¸‹ä¸€ä¸ªäº‹åŠ¡çš„idå€¼ã€‚</li><li>creator_trx_idï¼šè¡¨ç¤ºç”Ÿæˆè¯¥ReadViewçš„äº‹åŠ¡çš„äº‹åŠ¡idã€‚</li></ol><p>InnoDB ä¸ºæ¯ä¸ªäº‹åŠ¡æ„é€ äº†ä¸€ä¸ªæ•°ç»„ï¼Œç”¨æ¥ä¿å­˜è¿™ä¸ªäº‹åŠ¡å¯åŠ¨ç¬é—´ï¼Œå½“å‰æ­£åœ¨â€œæ´»è·ƒâ€çš„æ‰€æœ‰äº‹åŠ¡ IDã€‚</p><blockquote><p>â€œæ´»è·ƒâ€æŒ‡çš„å°±æ˜¯ï¼Œå¯åŠ¨äº†ä½†è¿˜æ²¡æäº¤ã€‚</p></blockquote><p>æ•°ç»„é‡Œé¢äº‹åŠ¡ ID çš„æœ€å°å€¼è®°ä¸ºä½æ°´ä½ï¼Œå½“å‰ç³»ç»Ÿé‡Œé¢å·²ç»åˆ›å»ºè¿‡çš„äº‹åŠ¡ ID çš„æœ€å¤§å€¼åŠ  1è®°ä¸ºé«˜æ°´ä½ã€‚è¿™ä¸ªè§†å›¾æ•°ç»„å’Œé«˜æ°´ä½ï¼Œå°±ç»„æˆäº†å½“å‰äº‹åŠ¡çš„ä¸€è‡´æ€§è§†å›¾(å›¾-1)</p><p><img src="/img/mysql/read_view.png" alt="å›¾-1"></p><h4 id="å¦‚ä½•å·¥ä½œ"><a href="#å¦‚ä½•å·¥ä½œ" class="headerlink" title="å¦‚ä½•å·¥ä½œ"></a>å¦‚ä½•å·¥ä½œ</h4><p>æŒ‰ç…§ä¸‹è¾¹çš„æ­¥éª¤åˆ¤æ–­è®°å½•çš„æŸä¸ªç‰ˆæœ¬æ˜¯å¦å¯è§ï¼š</p><p>å¦‚æœè¢«è®¿é—®ç‰ˆæœ¬çš„trx_idå±æ€§å€¼ä¸ReadViewä¸­çš„creator_trx_idå€¼ç›¸åŒï¼Œæ„å‘³ç€å½“å‰äº‹åŠ¡åœ¨è®¿é—®å®ƒè‡ªå·±ä¿®æ”¹è¿‡çš„è®°å½•ï¼Œæ‰€ä»¥è¯¥ç‰ˆæœ¬å¯ä»¥è¢«å½“å‰äº‹åŠ¡è®¿é—®ã€‚<br>å¦‚æœè¢«è®¿é—®ç‰ˆæœ¬çš„trx_idå±æ€§å€¼å°äºReadViewä¸­çš„min_trx_idå€¼ï¼Œè¡¨æ˜ç”Ÿæˆè¯¥ç‰ˆæœ¬çš„äº‹åŠ¡åœ¨å½“å‰äº‹åŠ¡ç”ŸæˆReadViewå‰å·²ç»æäº¤ï¼Œæ‰€ä»¥è¯¥ç‰ˆæœ¬å¯ä»¥è¢«å½“å‰äº‹åŠ¡è®¿é—®ã€‚<br>å¦‚æœè¢«è®¿é—®ç‰ˆæœ¬çš„trx_idå±æ€§å€¼å¤§äºReadViewä¸­çš„max_trx_idå€¼ï¼Œè¡¨æ˜ç”Ÿæˆè¯¥ç‰ˆæœ¬çš„äº‹åŠ¡åœ¨å½“å‰äº‹åŠ¡ç”ŸæˆReadViewåæ‰å¼€å¯ï¼Œæ‰€ä»¥è¯¥ç‰ˆæœ¬ä¸å¯ä»¥è¢«å½“å‰äº‹åŠ¡è®¿é—®ã€‚<br>å¦‚æœè¢«è®¿é—®ç‰ˆæœ¬çš„trx_idå±æ€§å€¼åœ¨ReadViewçš„min_trx_idå’Œmax_trx_idä¹‹é—´ï¼Œé‚£å°±éœ€è¦åˆ¤æ–­ä¸€ä¸‹trx_idå±æ€§å€¼æ˜¯ä¸æ˜¯åœ¨m_idsåˆ—è¡¨ä¸­ï¼Œå¦‚æœåœ¨ï¼Œè¯´æ˜åˆ›å»ºReadViewæ—¶ç”Ÿæˆè¯¥ç‰ˆæœ¬çš„äº‹åŠ¡è¿˜æ˜¯æ´»è·ƒçš„ï¼Œè¯¥ç‰ˆæœ¬ä¸å¯ä»¥è¢«è®¿é—®ï¼›å¦‚æœä¸åœ¨ï¼Œè¯´æ˜åˆ›å»ºReadViewæ—¶ç”Ÿæˆè¯¥ç‰ˆæœ¬çš„äº‹åŠ¡å·²ç»è¢«æäº¤ï¼Œè¯¥ç‰ˆæœ¬å¯ä»¥è¢«è®¿é—®ã€‚</p><h3 id="next-key-lock"><a href="#next-key-lock" class="headerlink" title="next-key lock"></a>next-key lock</h3><p>è¡Œé”å’Œé—´éš™é”åˆç§°next-key lockã€‚Next-Key Lock åªå‘ç”Ÿåœ¨ RRï¼ˆREPEATABLE-READï¼‰ éš”ç¦»çº§åˆ«ä¸‹ã€‚</p><p>ç®€å•æ¥è®²æ˜¯å°±æ˜¯è¯´æ·é”çš„æ—¶å€™ä¸å•å•åŠ åœ¨æ»¡è¶³æ¡ä»¶çš„è¡Œä¸Šï¼ŒåŒæ—¶ä¹Ÿè¦åŠ åœ¨ä¸å­˜åœ¨æ•°æ®ä¸”æ»¡è¶³æ¡ä»¶çš„é—´éš™ä¸Šã€‚ç”±äºä¸åŒç‰ˆæœ¬çš„mysqlå¯¹æ·é”çš„è§„åˆ™ä¸Šä¼šæœ‰ä¸åŒï¼Œè¿™é‡Œä¸åšå±•å¼€ã€‚</p><h2 id="Refrence"><a href="#Refrence" class="headerlink" title="Refrence"></a>Refrence</h2><p><a href="https://time.geekbang.org/column/intro/100020801?tab=catalog">MySQLå®æˆ˜45è®²</a><br><a href="https://juejin.cn/post/6844903908146413576">ä¸€ç¯‡æ–‡ç« å¸¦ä½ æŒæ¡mysqlçš„ä¸€è‡´æ€§è§†å›¾ï¼ˆMVCCï¼‰</a><br><a href="https://dev.mysql.com/doc/refman/5.7/en/innodb-transaction-isolation-levels.html">MySQLå®˜æ–¹æ–‡æ¡£</a><br><a href="https://www.jianshu.com/p/42e60848b3a6">ä»€ä¹ˆæ˜¯é—´éš™é”ï¼Ÿåˆ°åº•é”äº†ä»€ä¹ˆï¼Ÿ</a></p>]]></content>
    
    
    <categories>
      
      <category>å­˜å‚¨</category>
      
    </categories>
    
    
    <tags>
      
      <tag>MySQL</tag>
      
      <tag>MVCC</tag>
      
      <tag>lock</tag>
      
      <tag>RR</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>golangè¿è¡Œæ—¶æ ¸å¿ƒè°ƒåº¦å‡½æ•°(scheduleï¼Œfindrunnableï¼Œsysmon)æºç åˆ†æ</title>
    <link href="/2021/10/06/golang%E8%BF%90%E8%A1%8C%E6%97%B6%E6%A0%B8%E5%BF%83%E8%B0%83%E5%BA%A6%E5%87%BD%E6%95%B0-schedule%EF%BC%8Cfindrunnable%EF%BC%8Csysmon-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
    <url>/2021/10/06/golang%E8%BF%90%E8%A1%8C%E6%97%B6%E6%A0%B8%E5%BF%83%E8%B0%83%E5%BA%A6%E5%87%BD%E6%95%B0-schedule%EF%BC%8Cfindrunnable%EF%BC%8Csysmon-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h1 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h1><p>åˆ†ææ ¸å¿ƒè°ƒåº¦å‡½æ•° shcedule findrunnable sysmon</p><h2 id="schedule"><a href="#schedule" class="headerlink" title="schedule"></a>schedule</h2><p>dlvè°ƒè¯•ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">(dlv) b runtime.schedule<br>Breakpoint 1 set at 0x435cf3 for runtime.schedule() /usr/lib/golang/src/runtime/proc.go:2609<br>(dlv) c<br><span class="hljs-meta">&gt;</span><span class="bash"> runtime.schedule() /usr/lib/golang/src/runtime/proc.go:2609 (hits total:1) (PC: 0x435cf3)</span><br>Warning: debugging optimized function<br>  2604:         &#125;<br>  2605: &#125;<br>  2606:<br>  2607: // One round of scheduler: find a runnable goroutine and execute it.<br>  2608: // Never returns.<br>=&gt;2609: func schedule() &#123;<br>  2610:         _g_ := getg()<br>  2611:<br>  2612:         if _g_.m.locks != 0 &#123;<br>  2613:                 throw(&quot;schedule: holding locks&quot;)<br>  2614:         &#125;<br></code></pre></div></td></tr></table></figure><p>å…¨éƒ¨çš„æºç å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">schedule</span><span class="hljs-params">()</span></span> &#123;<br>_g_ := getg()<br><br><span class="hljs-keyword">if</span> _g_.m.locks != <span class="hljs-number">0</span> &#123;<br>throw(<span class="hljs-string">&quot;schedule: holding locks&quot;</span>)<br>&#125;<br><br><span class="hljs-keyword">if</span> _g_.m.lockedg != <span class="hljs-number">0</span> &#123;<br>stoplockedm()<br>execute(_g_.m.lockedg.ptr(), <span class="hljs-literal">false</span>) <span class="hljs-comment">// Never returns.</span><br>&#125;<br><br><span class="hljs-comment">// We should not schedule away from a g that is executing a cgo call,</span><br><span class="hljs-comment">// since the cgo call is using the m&#x27;s g0 stack.</span><br><span class="hljs-keyword">if</span> _g_.m.incgo &#123;<br>throw(<span class="hljs-string">&quot;schedule: in cgo&quot;</span>)<br>&#125;<br><br>top:<br>pp := _g_.m.p.ptr()<br>pp.preempt = <span class="hljs-literal">false</span><br><br><span class="hljs-keyword">if</span> sched.gcwaiting != <span class="hljs-number">0</span> &#123;<br>gcstopm()<br><span class="hljs-keyword">goto</span> top<br>&#125;<br><span class="hljs-keyword">if</span> pp.runSafePointFn != <span class="hljs-number">0</span> &#123;<br>runSafePointFn()<br>&#125;<br><br><span class="hljs-comment">// Sanity check: if we are spinning, the run queue should be empty.</span><br><span class="hljs-comment">// Check this before calling checkTimers, as that might call</span><br><span class="hljs-comment">// goready to put a ready goroutine on the local run queue.</span><br><span class="hljs-keyword">if</span> _g_.m.spinning &amp;&amp; (pp.runnext != <span class="hljs-number">0</span> || pp.runqhead != pp.runqtail) &#123;<br>throw(<span class="hljs-string">&quot;schedule: spinning with local work&quot;</span>)<br>&#125;<br><br>checkTimers(pp, <span class="hljs-number">0</span>)<br><br><span class="hljs-keyword">var</span> gp *g<br><span class="hljs-keyword">var</span> inheritTime <span class="hljs-keyword">bool</span><br><br><span class="hljs-comment">// Normal goroutines will check for need to wakeP in ready,</span><br><span class="hljs-comment">// but GCworkers and tracereaders will not, so the check must</span><br><span class="hljs-comment">// be done here instead.</span><br>tryWakeP := <span class="hljs-literal">false</span><br><span class="hljs-keyword">if</span> trace.enabled || trace.shutdown &#123;<br>gp = traceReader()<br><span class="hljs-keyword">if</span> gp != <span class="hljs-literal">nil</span> &#123;<br>casgstatus(gp, _Gwaiting, _Grunnable)<br>traceGoUnpark(gp, <span class="hljs-number">0</span>)<br>tryWakeP = <span class="hljs-literal">true</span><br>&#125;<br>&#125;<br><span class="hljs-keyword">if</span> gp == <span class="hljs-literal">nil</span> &amp;&amp; gcBlackenEnabled != <span class="hljs-number">0</span> &#123;<br>gp = gcController.findRunnableGCWorker(_g_.m.p.ptr())<br>tryWakeP = tryWakeP || gp != <span class="hljs-literal">nil</span><br>&#125;<br><span class="hljs-keyword">if</span> gp == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-comment">// Check the global runnable queue once in a while to ensure fairness.</span><br><span class="hljs-comment">// Otherwise two goroutines can completely occupy the local runqueue</span><br><span class="hljs-comment">// by constantly respawning each other.</span><br><span class="hljs-keyword">if</span> _g_.m.p.ptr().schedtick%<span class="hljs-number">61</span> == <span class="hljs-number">0</span> &amp;&amp; sched.runqsize &gt; <span class="hljs-number">0</span> &#123;<br>lock(&amp;sched.lock)<br>gp = globrunqget(_g_.m.p.ptr(), <span class="hljs-number">1</span>)<br>unlock(&amp;sched.lock)<br>&#125;<br>&#125;<br><span class="hljs-keyword">if</span> gp == <span class="hljs-literal">nil</span> &#123;<br>gp, inheritTime = runqget(_g_.m.p.ptr())<br><span class="hljs-comment">// We can see gp != nil here even if the M is spinning,</span><br><span class="hljs-comment">// if checkTimers added a local goroutine via goready.</span><br>&#125;<br><span class="hljs-keyword">if</span> gp == <span class="hljs-literal">nil</span> &#123;<br>gp, inheritTime = findrunnable() <span class="hljs-comment">// blocks until work is available</span><br>&#125;<br><br><span class="hljs-comment">// This thread is going to run a goroutine and is not spinning anymore,</span><br><span class="hljs-comment">// so if it was marked as spinning we need to reset it now and potentially</span><br><span class="hljs-comment">// start a new spinning M.</span><br><span class="hljs-keyword">if</span> _g_.m.spinning &#123;<br>resetspinning()<br>&#125;<br><br><span class="hljs-keyword">if</span> sched.disable.user &amp;&amp; !schedEnabled(gp) &#123;<br><span class="hljs-comment">// Scheduling of this goroutine is disabled. Put it on</span><br><span class="hljs-comment">// the list of pending runnable goroutines for when we</span><br><span class="hljs-comment">// re-enable user scheduling and look again.</span><br>lock(&amp;sched.lock)<br><span class="hljs-keyword">if</span> schedEnabled(gp) &#123;<br><span class="hljs-comment">// Something re-enabled scheduling while we</span><br><span class="hljs-comment">// were acquiring the lock.</span><br>unlock(&amp;sched.lock)<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>sched.disable.runnable.pushBack(gp)<br>sched.disable.n++<br>unlock(&amp;sched.lock)<br><span class="hljs-keyword">goto</span> top<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// If about to schedule a not-normal goroutine (a GCworker or tracereader),</span><br><span class="hljs-comment">// wake a P if there is one.</span><br><span class="hljs-keyword">if</span> tryWakeP &#123;<br>wakep()<br>&#125;<br><span class="hljs-keyword">if</span> gp.lockedm != <span class="hljs-number">0</span> &#123;<br><span class="hljs-comment">// Hands off own p to the locked m,</span><br><span class="hljs-comment">// then blocks waiting for a new p.</span><br>startlockedm(gp)<br><span class="hljs-keyword">goto</span> top<br>&#125;<br><br>execute(gp, inheritTime)<br>&#125;<br></code></pre></div></td></tr></table></figure><p>å¿½ç•¥GCå’Œtraceååˆ†ææºç å‘ç°sheduleå‡½æ•°æœ¬è´¨å°±æ˜¯å°½åŠ›æ‰¾åˆ°å¯è¿è¡Œçš„gï¼Œç„¶åå»è¿è¡Œgä¸Šé¢çš„ä»»åŠ¡å‡½æ•°ã€‚æŸ¥æ‰¾gçš„æµç¨‹å¦‚ä¸‹ï¼š</p><ol><li>å¦‚æœå½“å‰GCéœ€è¦åœæ­¢æ•´ä¸ªä¸–ç•Œï¼ˆSTW), åˆ™è°ƒç”¨gcstopmä¼‘çœ å½“å‰çš„M</li><li>æ¯éš”61æ¬¡è°ƒåº¦è½®å›ä»å…¨å±€é˜Ÿåˆ—æ‰¾ï¼Œé¿å…å…¨å±€é˜Ÿåˆ—ä¸­çš„gè¢«é¥¿æ­»ã€‚</li><li>ä»p.runnextè·å–gï¼Œä»pçš„æœ¬åœ°é˜Ÿåˆ—ä¸­è·å–ã€‚</li><li>è°ƒç”¨ <code>findrunnable</code> æ‰¾gï¼Œæ‰¾ä¸åˆ°çš„è¯å°±å°†mä¼‘çœ ï¼Œç­‰å¾…å”¤é†’ã€‚</li></ol><p>å½“æ‰¾åˆ°ä¸€ä¸ªgåï¼Œå°±ä¼šè°ƒç”¨ <code>execute</code> å»æ‰§è¡Œgã€‚</p><h2 id="findrunnable"><a href="#findrunnable" class="headerlink" title="findrunnable"></a>findrunnable</h2><p>dlvè°ƒè¯•ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">[root@583d9a8ec1db p1]# dlv exec ./main<br>Type &#x27;help&#x27; for list of commands.<br>(dlv) b runtime.findrunnable<br>Breakpoint 1 set at 0x4348d8 for runtime.findrunnable() /usr/lib/golang/src/runtime/proc.go:2189<br>(dlv) c<br><span class="hljs-meta">&gt;</span><span class="bash"> runtime.findrunnable() /usr/lib/golang/src/runtime/proc.go:2189 (hits total:1) (PC: 0x4348d8)</span><br>Warning: debugging optimized function<br>  2184:         gogo(&amp;gp.sched)<br>  2185: &#125;<br>  2186:<br>  2187: // Finds a runnable goroutine to execute.<br>  2188: // Tries to steal from other P&#x27;s, get g from local or global queue, poll network.<br>=&gt;2189: func findrunnable() (gp *g, inheritTime bool) &#123;<br>  2190:         _g_ := getg()<br>  2191:<br>  2192:         // The conditions here and in handoffp must agree: if<br>  2193:         // findrunnable would return a G to run, handoffp must start<br>  2194:         // an M.<br>(dlv) si<br><span class="hljs-meta">&gt;</span><span class="bash"> runtime.findrunnable() /usr/lib/golang/src/runtime/proc.go:2189 (PC: 0x4348df)</span><br>Warning: debugging optimized function<br>  2184:         gogo(&amp;gp.sched)<br>  2185: &#125;<br>  2186:<br>  2187: // Finds a runnable goroutine to execute.<br>  2188: // Tries to steal from other P&#x27;s, get g from local or global queue, poll network.<br>=&gt;2189: func findrunnable() (gp *g, inheritTime bool) &#123;<br>  2190:         _g_ := getg()<br>  2191:<br>  2192:         // The conditions here and in handoffp must agree: if<br>  2193:         // findrunnable would return a G to run, handoffp must start<br>  2194:         // an M.<br></code></pre></div></td></tr></table></figure><p>å…¨éƒ¨æºä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">findrunnable</span><span class="hljs-params">()</span> <span class="hljs-params">(gp *g, inheritTime <span class="hljs-keyword">bool</span>)</span></span> &#123;<br>_g_ := getg()<br><br><span class="hljs-comment">// The conditions here and in handoffp must agree: if</span><br><span class="hljs-comment">// findrunnable would return a G to run, handoffp must start</span><br><span class="hljs-comment">// an M.</span><br><br>top:<br>_p_ := _g_.m.p.ptr()<br><span class="hljs-keyword">if</span> sched.gcwaiting != <span class="hljs-number">0</span> &#123;<br>gcstopm()<br><span class="hljs-keyword">goto</span> top<br>&#125;<br><span class="hljs-keyword">if</span> _p_.runSafePointFn != <span class="hljs-number">0</span> &#123;<br>runSafePointFn()<br>&#125;<br><br>now, pollUntil, _ := checkTimers(_p_, <span class="hljs-number">0</span>)<br><br><span class="hljs-keyword">if</span> fingwait &amp;&amp; fingwake &#123;<br><span class="hljs-keyword">if</span> gp := wakefing(); gp != <span class="hljs-literal">nil</span> &#123;<br>ready(gp, <span class="hljs-number">0</span>, <span class="hljs-literal">true</span>)<br>&#125;<br>&#125;<br><span class="hljs-keyword">if</span> *cgo_yield != <span class="hljs-literal">nil</span> &#123;<br>asmcgocall(*cgo_yield, <span class="hljs-literal">nil</span>)<br>&#125;<br><br><span class="hljs-comment">// local runq</span><br><span class="hljs-keyword">if</span> gp, inheritTime := runqget(_p_); gp != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> gp, inheritTime<br>&#125;<br><br><span class="hljs-comment">// global runq</span><br><span class="hljs-keyword">if</span> sched.runqsize != <span class="hljs-number">0</span> &#123;<br>lock(&amp;sched.lock)<br>gp := globrunqget(_p_, <span class="hljs-number">0</span>)<br>unlock(&amp;sched.lock)<br><span class="hljs-keyword">if</span> gp != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> gp, <span class="hljs-literal">false</span><br>&#125;<br>&#125;<br><br><span class="hljs-comment">// Poll network.</span><br><span class="hljs-comment">// This netpoll is only an optimization before we resort to stealing.</span><br><span class="hljs-comment">// We can safely skip it if there are no waiters or a thread is blocked</span><br><span class="hljs-comment">// in netpoll already. If there is any kind of logical race with that</span><br><span class="hljs-comment">// blocked thread (e.g. it has already returned from netpoll, but does</span><br><span class="hljs-comment">// not set lastpoll yet), this thread will do blocking netpoll below</span><br><span class="hljs-comment">// anyway.</span><br><span class="hljs-keyword">if</span> netpollinited() &amp;&amp; atomic.Load(&amp;netpollWaiters) &gt; <span class="hljs-number">0</span> &amp;&amp; atomic.Load64(&amp;sched.lastpoll) != <span class="hljs-number">0</span> &#123;<br><span class="hljs-keyword">if</span> list := netpoll(<span class="hljs-number">0</span>); !list.empty() &#123; <span class="hljs-comment">// non-blocking</span><br>gp := list.pop()<br>injectglist(&amp;list)<br>casgstatus(gp, _Gwaiting, _Grunnable)<br><span class="hljs-keyword">if</span> trace.enabled &#123;<br>traceGoUnpark(gp, <span class="hljs-number">0</span>)<br>&#125;<br><span class="hljs-keyword">return</span> gp, <span class="hljs-literal">false</span><br>&#125;<br>&#125;<br><br><span class="hljs-comment">// Steal work from other P&#x27;s.</span><br>procs := <span class="hljs-keyword">uint32</span>(gomaxprocs)<br>ranTimer := <span class="hljs-literal">false</span><br><span class="hljs-comment">// If number of spinning M&#x27;s &gt;= number of busy P&#x27;s, block.</span><br><span class="hljs-comment">// This is necessary to prevent excessive CPU consumption</span><br><span class="hljs-comment">// when GOMAXPROCS&gt;&gt;1 but the program parallelism is low.</span><br><span class="hljs-keyword">if</span> !_g_.m.spinning &amp;&amp; <span class="hljs-number">2</span>*atomic.Load(&amp;sched.nmspinning) &gt;= procs-atomic.Load(&amp;sched.npidle) &#123;<br><span class="hljs-keyword">goto</span> stop<br>&#125;<br><span class="hljs-keyword">if</span> !_g_.m.spinning &#123;<br>_g_.m.spinning = <span class="hljs-literal">true</span><br>atomic.Xadd(&amp;sched.nmspinning, <span class="hljs-number">1</span>)<br>&#125;<br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">4</span>; i++ &#123;<br><span class="hljs-keyword">for</span> enum := stealOrder.start(fastrand()); !enum.done(); enum.next() &#123;<br><span class="hljs-keyword">if</span> sched.gcwaiting != <span class="hljs-number">0</span> &#123;<br><span class="hljs-keyword">goto</span> top<br>&#125;<br>stealRunNextG := i &gt; <span class="hljs-number">2</span> <span class="hljs-comment">// first look for ready queues with more than 1 g</span><br>p2 := allp[enum.position()]<br><span class="hljs-keyword">if</span> _p_ == p2 &#123;<br><span class="hljs-keyword">continue</span><br>&#125;<br><span class="hljs-keyword">if</span> gp := runqsteal(_p_, p2, stealRunNextG); gp != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> gp, <span class="hljs-literal">false</span><br>&#125;<br><br><span class="hljs-comment">// Consider stealing timers from p2.</span><br><span class="hljs-comment">// This call to checkTimers is the only place where</span><br><span class="hljs-comment">// we hold a lock on a different P&#x27;s timers.</span><br><span class="hljs-comment">// Lock contention can be a problem here, so</span><br><span class="hljs-comment">// initially avoid grabbing the lock if p2 is running</span><br><span class="hljs-comment">// and is not marked for preemption. If p2 is running</span><br><span class="hljs-comment">// and not being preempted we assume it will handle its</span><br><span class="hljs-comment">// own timers.</span><br><span class="hljs-comment">// If we&#x27;re still looking for work after checking all</span><br><span class="hljs-comment">// the P&#x27;s, then go ahead and steal from an active P.</span><br><span class="hljs-keyword">if</span> i &gt; <span class="hljs-number">2</span> || (i &gt; <span class="hljs-number">1</span> &amp;&amp; shouldStealTimers(p2)) &#123;<br>tnow, w, ran := checkTimers(p2, now)<br>now = tnow<br><span class="hljs-keyword">if</span> w != <span class="hljs-number">0</span> &amp;&amp; (pollUntil == <span class="hljs-number">0</span> || w &lt; pollUntil) &#123;<br>pollUntil = w<br>&#125;<br><span class="hljs-keyword">if</span> ran &#123;<br><span class="hljs-comment">// Running the timers may have</span><br><span class="hljs-comment">// made an arbitrary number of G&#x27;s</span><br><span class="hljs-comment">// ready and added them to this P&#x27;s</span><br><span class="hljs-comment">// local run queue. That invalidates</span><br><span class="hljs-comment">// the assumption of runqsteal</span><br><span class="hljs-comment">// that is always has room to add</span><br><span class="hljs-comment">// stolen G&#x27;s. So check now if there</span><br><span class="hljs-comment">// is a local G to run.</span><br><span class="hljs-keyword">if</span> gp, inheritTime := runqget(_p_); gp != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> gp, inheritTime<br>&#125;<br>ranTimer = <span class="hljs-literal">true</span><br>&#125;<br>&#125;<br>&#125;<br>&#125;<br><span class="hljs-keyword">if</span> ranTimer &#123;<br><span class="hljs-comment">// Running a timer may have made some goroutine ready.</span><br><span class="hljs-keyword">goto</span> top<br>&#125;<br><br>stop:<br><br><span class="hljs-comment">// We have nothing to do. If we&#x27;re in the GC mark phase, can</span><br><span class="hljs-comment">// safely scan and blacken objects, and have work to do, run</span><br><span class="hljs-comment">// idle-time marking rather than give up the P.</span><br><span class="hljs-keyword">if</span> gcBlackenEnabled != <span class="hljs-number">0</span> &amp;&amp; _p_.gcBgMarkWorker != <span class="hljs-number">0</span> &amp;&amp; gcMarkWorkAvailable(_p_) &#123;<br>_p_.gcMarkWorkerMode = gcMarkWorkerIdleMode<br>gp := _p_.gcBgMarkWorker.ptr()<br>casgstatus(gp, _Gwaiting, _Grunnable)<br><span class="hljs-keyword">if</span> trace.enabled &#123;<br>traceGoUnpark(gp, <span class="hljs-number">0</span>)<br>&#125;<br><span class="hljs-keyword">return</span> gp, <span class="hljs-literal">false</span><br>&#125;<br><br>delta := <span class="hljs-keyword">int64</span>(<span class="hljs-number">-1</span>)<br><span class="hljs-keyword">if</span> pollUntil != <span class="hljs-number">0</span> &#123;<br><span class="hljs-comment">// checkTimers ensures that polluntil &gt; now.</span><br>delta = pollUntil - now<br>&#125;<br><br><span class="hljs-comment">// wasm only:</span><br><span class="hljs-comment">// If a callback returned and no other goroutine is awake,</span><br><span class="hljs-comment">// then wake event handler goroutine which pauses execution</span><br><span class="hljs-comment">// until a callback was triggered.</span><br>gp, otherReady := beforeIdle(delta)<br><span class="hljs-keyword">if</span> gp != <span class="hljs-literal">nil</span> &#123;<br>casgstatus(gp, _Gwaiting, _Grunnable)<br><span class="hljs-keyword">if</span> trace.enabled &#123;<br>traceGoUnpark(gp, <span class="hljs-number">0</span>)<br>&#125;<br><span class="hljs-keyword">return</span> gp, <span class="hljs-literal">false</span><br>&#125;<br><span class="hljs-keyword">if</span> otherReady &#123;<br><span class="hljs-keyword">goto</span> top<br>&#125;<br><br><span class="hljs-comment">// Before we drop our P, make a snapshot of the allp slice,</span><br><span class="hljs-comment">// which can change underfoot once we no longer block</span><br><span class="hljs-comment">// safe-points. We don&#x27;t need to snapshot the contents because</span><br><span class="hljs-comment">// everything up to cap(allp) is immutable.</span><br>allpSnapshot := allp<br><br><span class="hljs-comment">// return P and block</span><br>lock(&amp;sched.lock)<br><span class="hljs-keyword">if</span> sched.gcwaiting != <span class="hljs-number">0</span> || _p_.runSafePointFn != <span class="hljs-number">0</span> &#123;<br>unlock(&amp;sched.lock)<br><span class="hljs-keyword">goto</span> top<br>&#125;<br><span class="hljs-keyword">if</span> sched.runqsize != <span class="hljs-number">0</span> &#123;<br>gp := globrunqget(_p_, <span class="hljs-number">0</span>)<br>unlock(&amp;sched.lock)<br><span class="hljs-keyword">return</span> gp, <span class="hljs-literal">false</span><br>&#125;<br><span class="hljs-keyword">if</span> releasep() != _p_ &#123;<br>throw(<span class="hljs-string">&quot;findrunnable: wrong p&quot;</span>)<br>&#125;<br>pidleput(_p_)<br>unlock(&amp;sched.lock)<br><br><span class="hljs-comment">// Delicate dance: thread transitions from spinning to non-spinning state,</span><br><span class="hljs-comment">// potentially concurrently with submission of new goroutines. We must</span><br><span class="hljs-comment">// drop nmspinning first and then check all per-P queues again (with</span><br><span class="hljs-comment">// #StoreLoad memory barrier in between). If we do it the other way around,</span><br><span class="hljs-comment">// another thread can submit a goroutine after we&#x27;ve checked all run queues</span><br><span class="hljs-comment">// but before we drop nmspinning; as the result nobody will unpark a thread</span><br><span class="hljs-comment">// to run the goroutine.</span><br><span class="hljs-comment">// If we discover new work below, we need to restore m.spinning as a signal</span><br><span class="hljs-comment">// for resetspinning to unpark a new worker thread (because there can be more</span><br><span class="hljs-comment">// than one starving goroutine). However, if after discovering new work</span><br><span class="hljs-comment">// we also observe no idle Ps, it is OK to just park the current thread:</span><br><span class="hljs-comment">// the system is fully loaded so no spinning threads are required.</span><br><span class="hljs-comment">// Also see &quot;Worker thread parking/unparking&quot; comment at the top of the file.</span><br>wasSpinning := _g_.m.spinning<br><span class="hljs-keyword">if</span> _g_.m.spinning &#123;<br>_g_.m.spinning = <span class="hljs-literal">false</span><br><span class="hljs-keyword">if</span> <span class="hljs-keyword">int32</span>(atomic.Xadd(&amp;sched.nmspinning, <span class="hljs-number">-1</span>)) &lt; <span class="hljs-number">0</span> &#123;<br>throw(<span class="hljs-string">&quot;findrunnable: negative nmspinning&quot;</span>)<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// check all runqueues once again</span><br><span class="hljs-keyword">for</span> _, _p_ := <span class="hljs-keyword">range</span> allpSnapshot &#123;<br><span class="hljs-keyword">if</span> !runqempty(_p_) &#123;<br>lock(&amp;sched.lock)<br>_p_ = pidleget()<br>unlock(&amp;sched.lock)<br><span class="hljs-keyword">if</span> _p_ != <span class="hljs-literal">nil</span> &#123;<br>acquirep(_p_)<br><span class="hljs-keyword">if</span> wasSpinning &#123;<br>_g_.m.spinning = <span class="hljs-literal">true</span><br>atomic.Xadd(&amp;sched.nmspinning, <span class="hljs-number">1</span>)<br>&#125;<br><span class="hljs-keyword">goto</span> top<br>&#125;<br><span class="hljs-keyword">break</span><br>&#125;<br>&#125;<br><br><span class="hljs-comment">// Check for idle-priority GC work again.</span><br><span class="hljs-keyword">if</span> gcBlackenEnabled != <span class="hljs-number">0</span> &amp;&amp; gcMarkWorkAvailable(<span class="hljs-literal">nil</span>) &#123;<br>lock(&amp;sched.lock)<br>_p_ = pidleget()<br><span class="hljs-keyword">if</span> _p_ != <span class="hljs-literal">nil</span> &amp;&amp; _p_.gcBgMarkWorker == <span class="hljs-number">0</span> &#123;<br>pidleput(_p_)<br>_p_ = <span class="hljs-literal">nil</span><br>&#125;<br>unlock(&amp;sched.lock)<br><span class="hljs-keyword">if</span> _p_ != <span class="hljs-literal">nil</span> &#123;<br>acquirep(_p_)<br><span class="hljs-keyword">if</span> wasSpinning &#123;<br>_g_.m.spinning = <span class="hljs-literal">true</span><br>atomic.Xadd(&amp;sched.nmspinning, <span class="hljs-number">1</span>)<br>&#125;<br><span class="hljs-comment">// Go back to idle GC check.</span><br><span class="hljs-keyword">goto</span> stop<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// poll network</span><br><span class="hljs-keyword">if</span> netpollinited() &amp;&amp; (atomic.Load(&amp;netpollWaiters) &gt; <span class="hljs-number">0</span> || pollUntil != <span class="hljs-number">0</span>) &amp;&amp; atomic.Xchg64(&amp;sched.lastpoll, <span class="hljs-number">0</span>) != <span class="hljs-number">0</span> &#123;<br>atomic.Store64(&amp;sched.pollUntil, <span class="hljs-keyword">uint64</span>(pollUntil))<br><span class="hljs-keyword">if</span> _g_.m.p != <span class="hljs-number">0</span> &#123;<br>throw(<span class="hljs-string">&quot;findrunnable: netpoll with p&quot;</span>)<br>&#125;<br><span class="hljs-keyword">if</span> _g_.m.spinning &#123;<br>throw(<span class="hljs-string">&quot;findrunnable: netpoll with spinning&quot;</span>)<br>&#125;<br><span class="hljs-keyword">if</span> faketime != <span class="hljs-number">0</span> &#123;<br><span class="hljs-comment">// When using fake time, just poll.</span><br>delta = <span class="hljs-number">0</span><br>&#125;<br>list := netpoll(delta) <span class="hljs-comment">// block until new work is available</span><br>atomic.Store64(&amp;sched.pollUntil, <span class="hljs-number">0</span>)<br>atomic.Store64(&amp;sched.lastpoll, <span class="hljs-keyword">uint64</span>(nanotime()))<br><span class="hljs-keyword">if</span> faketime != <span class="hljs-number">0</span> &amp;&amp; list.empty() &#123;<br><span class="hljs-comment">// Using fake time and nothing is ready; stop M.</span><br><span class="hljs-comment">// When all M&#x27;s stop, checkdead will call timejump.</span><br>stopm()<br><span class="hljs-keyword">goto</span> top<br>&#125;<br>lock(&amp;sched.lock)<br>_p_ = pidleget()<br>unlock(&amp;sched.lock)<br><span class="hljs-keyword">if</span> _p_ == <span class="hljs-literal">nil</span> &#123;<br>injectglist(&amp;list)<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>acquirep(_p_)<br><span class="hljs-keyword">if</span> !list.empty() &#123;<br>gp := list.pop()<br>injectglist(&amp;list)<br>casgstatus(gp, _Gwaiting, _Grunnable)<br><span class="hljs-keyword">if</span> trace.enabled &#123;<br>traceGoUnpark(gp, <span class="hljs-number">0</span>)<br>&#125;<br><span class="hljs-keyword">return</span> gp, <span class="hljs-literal">false</span><br>&#125;<br><span class="hljs-keyword">if</span> wasSpinning &#123;<br>_g_.m.spinning = <span class="hljs-literal">true</span><br>atomic.Xadd(&amp;sched.nmspinning, <span class="hljs-number">1</span>)<br>&#125;<br><span class="hljs-keyword">goto</span> top<br>&#125;<br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> pollUntil != <span class="hljs-number">0</span> &amp;&amp; netpollinited() &#123;<br>pollerPollUntil := <span class="hljs-keyword">int64</span>(atomic.Load64(&amp;sched.pollUntil))<br><span class="hljs-keyword">if</span> pollerPollUntil == <span class="hljs-number">0</span> || pollerPollUntil &gt; pollUntil &#123;<br>netpollBreak()<br>&#125;<br>&#125;<br>stopm()<br><span class="hljs-keyword">goto</span> top<br>&#125;<br></code></pre></div></td></tr></table></figure><p>åˆ†æä¸Šè¿°æºç å¾—çŸ¥æŸ¥æ‰¾å¯ç”¨çš„gçš„è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><ol><li>è°ƒç”¨ runqget ï¼Œå°è¯•ä»Pæœ¬åœ°é˜Ÿåˆ—ä¸­è·å–gï¼Œè·å–åˆ°è¿”å›</li><li>è°ƒç”¨ globrunqget ï¼Œå°è¯•ä»å…¨å±€é˜Ÿåˆ—ä¸­è·å–gï¼Œè·å–åˆ°è¿”å›</li><li>ä»ç½‘ç»œIOè½®è¯¢å™¨ä¸­æ‰¾åˆ°å°±ç»ªçš„gï¼ŒæŠŠè¿™ä¸ªgå˜ä¸ºå¯è¿è¡Œçš„g</li><li>å¦‚æœä¸æ˜¯æ‰€æœ‰çš„Péƒ½æ˜¯ç©ºé—²çš„ï¼Œæœ€å¤šå››æ¬¡ï¼Œéšæœºé€‰ä¸€ä¸ªPï¼Œå°è¯•ä»è¿™Pä¸­å·å–ä¸€äº›gï¼Œè·å–åˆ°è¿”å›</li><li>ä¸Šé¢éƒ½æ‰¾ä¸åˆ°gæ¥è¿è¡Œï¼Œåˆ¤æ–­æ­¤æ—¶Pæ˜¯å¦å¤„äº <code>GC mark</code> é˜¶æ®µï¼Œå¦‚æœæ˜¯ï¼Œé‚£ä¹ˆæ­¤æ—¶å¯ä»¥å®‰å…¨çš„æ‰«æå’Œé»‘åŒ–å¯¹è±¡å’Œè¿”å› <code>gcBgMarkWorker</code> æ¥è¿è¡Œï¼Œ <code>gcBgMarkWorker</code> æ˜¯GCåä»£æ ‡è®°çš„goroutineã€‚</li><li>å†æ¬¡ä»å…¨å±€é˜Ÿåˆ—ä¸­è·å–gï¼Œè·å–åˆ°è¿”å›</li><li>å†æ¬¡æ£€æŸ¥æ‰€æœ‰çš„Pï¼Œæœ‰æ²¡æœ‰å¯ä»¥è¿è¡Œçš„g</li><li>å†æ¬¡æ£€æŸ¥ç½‘ç»œIOè½®è¯¢å™¨</li><li>å®åœ¨æ‰¾ä¸åˆ°å¯è¿è¡Œçš„gäº†ï¼Œé‚£å°±è°ƒç”¨ <code>stopm</code> ä¼‘çœ å§</li></ol><h2 id="sysmon"><a href="#sysmon" class="headerlink" title="sysmon"></a>sysmon</h2><p>dlvè°ƒè¯•ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">[root@583d9a8ec1db p1]# dlv exec ./main<br>Type &#x27;help&#x27; for list of commands.<br>(dlv) b runtime.sysmon<br>Breakpoint 1 set at 0x43a773 for runtime.sysmon() /usr/lib/golang/src/runtime/proc.go:4642<br>(dlv) c<br><span class="hljs-meta">&gt;</span><span class="bash"> runtime.sysmon() /usr/lib/golang/src/runtime/proc.go:4642 (hits total:1) (PC: 0x43a773)</span><br>Warning: debugging optimized function<br>  4637: var forcegcperiod int64 = 2 * 60 * 1e9<br>  4638:<br>  4639: // Always runs without a P, so write barriers are not allowed.<br>  4640: //<br>  4641: //go:nowritebarrierrec<br>=&gt;4642: func sysmon() &#123;<br>  4643:         lock(&amp;sched.lock)<br>  4644:         sched.nmsys++<br>  4645:         checkdead()<br>  4646:         unlock(&amp;sched.lock)<br>  4647:<br>(dlv) si<br><span class="hljs-meta">&gt;</span><span class="bash"> runtime.sysmon() /usr/lib/golang/src/runtime/proc.go:4642 (PC: 0x43a777)</span><br>Warning: debugging optimized function<br>  4637: var forcegcperiod int64 = 2 * 60 * 1e9<br>  4638:<br>  4639: // Always runs without a P, so write barriers are not allowed.<br>  4640: //<br>  4641: //go:nowritebarrierrec<br>=&gt;4642: func sysmon() &#123;<br>  4643:         lock(&amp;sched.lock)<br>  4644:         sched.nmsys++<br>  4645:         checkdead()<br>  4646:         unlock(&amp;sched.lock)<br>  4647:<br></code></pre></div></td></tr></table></figure><p>å…¨éƒ¨æºç ï¼š</p><figure class="highlight go"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">sysmon</span><span class="hljs-params">()</span></span> &#123;<br>lock(&amp;sched.lock)<br>sched.nmsys++<br>checkdead()<br>unlock(&amp;sched.lock)<br><br>lasttrace := <span class="hljs-keyword">int64</span>(<span class="hljs-number">0</span>)<br>idle := <span class="hljs-number">0</span> <span class="hljs-comment">// how many cycles in succession we had not wokeup somebody</span><br>delay := <span class="hljs-keyword">uint32</span>(<span class="hljs-number">0</span>)<br><span class="hljs-keyword">for</span> &#123;<br><span class="hljs-keyword">if</span> idle == <span class="hljs-number">0</span> &#123; <span class="hljs-comment">// start with 20us sleep...</span><br>delay = <span class="hljs-number">20</span><br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> idle &gt; <span class="hljs-number">50</span> &#123; <span class="hljs-comment">// start doubling the sleep after 1ms...</span><br>delay *= <span class="hljs-number">2</span><br>&#125;<br><span class="hljs-keyword">if</span> delay &gt; <span class="hljs-number">10</span>*<span class="hljs-number">1000</span> &#123; <span class="hljs-comment">// up to 10ms</span><br>delay = <span class="hljs-number">10</span> * <span class="hljs-number">1000</span><br>&#125;<br>usleep(delay)<br>now := nanotime()<br>next, _ := timeSleepUntil()<br><span class="hljs-keyword">if</span> debug.schedtrace &lt;= <span class="hljs-number">0</span> &amp;&amp; (sched.gcwaiting != <span class="hljs-number">0</span> || atomic.Load(&amp;sched.npidle) == <span class="hljs-keyword">uint32</span>(gomaxprocs)) &#123;<br>lock(&amp;sched.lock)<br><span class="hljs-keyword">if</span> atomic.Load(&amp;sched.gcwaiting) != <span class="hljs-number">0</span> || atomic.Load(&amp;sched.npidle) == <span class="hljs-keyword">uint32</span>(gomaxprocs) &#123;<br><span class="hljs-keyword">if</span> next &gt; now &#123;<br>atomic.Store(&amp;sched.sysmonwait, <span class="hljs-number">1</span>)<br>unlock(&amp;sched.lock)<br><span class="hljs-comment">// Make wake-up period small enough</span><br><span class="hljs-comment">// for the sampling to be correct.</span><br>sleep := forcegcperiod / <span class="hljs-number">2</span><br><span class="hljs-keyword">if</span> next-now &lt; sleep &#123;<br>sleep = next - now<br>&#125;<br>shouldRelax := sleep &gt;= osRelaxMinNS<br><span class="hljs-keyword">if</span> shouldRelax &#123;<br>osRelax(<span class="hljs-literal">true</span>)<br>&#125;<br>notetsleep(&amp;sched.sysmonnote, sleep)<br><span class="hljs-keyword">if</span> shouldRelax &#123;<br>osRelax(<span class="hljs-literal">false</span>)<br>&#125;<br>now = nanotime()<br>next, _ = timeSleepUntil()<br>lock(&amp;sched.lock)<br>atomic.Store(&amp;sched.sysmonwait, <span class="hljs-number">0</span>)<br>noteclear(&amp;sched.sysmonnote)<br>&#125;<br>idle = <span class="hljs-number">0</span><br>delay = <span class="hljs-number">20</span><br>&#125;<br>unlock(&amp;sched.lock)<br>&#125;<br>lock(&amp;sched.sysmonlock)<br>&#123;<br><span class="hljs-comment">// If we spent a long time blocked on sysmonlock</span><br><span class="hljs-comment">// then we want to update now and next since it&#x27;s</span><br><span class="hljs-comment">// likely stale.</span><br>now1 := nanotime()<br><span class="hljs-keyword">if</span> now1-now &gt; <span class="hljs-number">50</span>*<span class="hljs-number">1000</span> <span class="hljs-comment">/* 50Âµs */</span> &#123;<br>next, _ = timeSleepUntil()<br>&#125;<br>now = now1<br>&#125;<br><br><span class="hljs-comment">// trigger libc interceptors if needed</span><br><span class="hljs-keyword">if</span> *cgo_yield != <span class="hljs-literal">nil</span> &#123;<br>asmcgocall(*cgo_yield, <span class="hljs-literal">nil</span>)<br>&#125;<br><span class="hljs-comment">// poll network if not polled for more than 10ms</span><br>lastpoll := <span class="hljs-keyword">int64</span>(atomic.Load64(&amp;sched.lastpoll))<br><span class="hljs-keyword">if</span> netpollinited() &amp;&amp; lastpoll != <span class="hljs-number">0</span> &amp;&amp; lastpoll+<span class="hljs-number">10</span>*<span class="hljs-number">1000</span>*<span class="hljs-number">1000</span> &lt; now &#123;<br>atomic.Cas64(&amp;sched.lastpoll, <span class="hljs-keyword">uint64</span>(lastpoll), <span class="hljs-keyword">uint64</span>(now))<br>list := netpoll(<span class="hljs-number">0</span>) <span class="hljs-comment">// non-blocking - returns list of goroutines</span><br><span class="hljs-keyword">if</span> !list.empty() &#123;<br><span class="hljs-comment">// Need to decrement number of idle locked M&#x27;s</span><br><span class="hljs-comment">// (pretending that one more is running) before injectglist.</span><br><span class="hljs-comment">// Otherwise it can lead to the following situation:</span><br><span class="hljs-comment">// injectglist grabs all P&#x27;s but before it starts M&#x27;s to run the P&#x27;s,</span><br><span class="hljs-comment">// another M returns from syscall, finishes running its G,</span><br><span class="hljs-comment">// observes that there is no work to do and no other running M&#x27;s</span><br><span class="hljs-comment">// and reports deadlock.</span><br>incidlelocked(<span class="hljs-number">-1</span>)<br>injectglist(&amp;list)<br>incidlelocked(<span class="hljs-number">1</span>)<br>&#125;<br>&#125;<br><span class="hljs-keyword">if</span> next &lt; now &#123;<br><span class="hljs-comment">// There are timers that should have already run,</span><br><span class="hljs-comment">// perhaps because there is an unpreemptible P.</span><br><span class="hljs-comment">// Try to start an M to run them.</span><br>startm(<span class="hljs-literal">nil</span>, <span class="hljs-literal">false</span>)<br>&#125;<br><span class="hljs-keyword">if</span> atomic.Load(&amp;scavenge.sysmonWake) != <span class="hljs-number">0</span> &#123;<br><span class="hljs-comment">// Kick the scavenger awake if someone requested it.</span><br>wakeScavenger()<br>&#125;<br><span class="hljs-comment">// retake P&#x27;s blocked in syscalls</span><br><span class="hljs-comment">// and preempt long running G&#x27;s</span><br><span class="hljs-keyword">if</span> retake(now) != <span class="hljs-number">0</span> &#123;<br>idle = <span class="hljs-number">0</span><br>&#125; <span class="hljs-keyword">else</span> &#123;<br>idle++<br>&#125;<br><span class="hljs-comment">// check if we need to force a GC</span><br><span class="hljs-keyword">if</span> t := (gcTrigger&#123;kind: gcTriggerTime, now: now&#125;); t.test() &amp;&amp; atomic.Load(&amp;forcegc.idle) != <span class="hljs-number">0</span> &#123;<br>lock(&amp;forcegc.lock)<br>forcegc.idle = <span class="hljs-number">0</span><br><span class="hljs-keyword">var</span> list gList<br>list.push(forcegc.g)<br>injectglist(&amp;list)<br>unlock(&amp;forcegc.lock)<br>&#125;<br><span class="hljs-keyword">if</span> debug.schedtrace &gt; <span class="hljs-number">0</span> &amp;&amp; lasttrace+<span class="hljs-keyword">int64</span>(debug.schedtrace)*<span class="hljs-number">1000000</span> &lt;= now &#123;<br>lasttrace = now<br>schedtrace(debug.scheddetail &gt; <span class="hljs-number">0</span>)<br>&#125;<br>unlock(&amp;sched.sysmonlock)<br>&#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><p><code>sysmon</code> å‘¨æœŸæ€§åœ°æ£€æŸ¥å¹¶retake pï¼Œ å¦‚æœå‘ç°på¤„äºè¿™ä¸ªçŠ¶æ€ä¸”è¶…è¿‡10mså°±ä¼šå¼ºåˆ¶æ€§æ”¶å›pï¼Œmä»cgoå’Œsyscallè¿”å›åä¼šé‡æ–°å°è¯•æ‹¿pï¼Œè¿›å…¥è°ƒåº¦å¾ªç¯ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>golang</category>
      
    </categories>
    
    
    <tags>
      
      <tag>runtime</tag>
      
      <tag>schedule</tag>
      
      <tag>sysmon</tag>
      
      <tag>findrunnable</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>golangè¿è¡Œæ—¶é˜Ÿåˆ—æ“ä½œå‡½æ•°æºç åˆ†æ</title>
    <link href="/2021/10/06/golang%E8%BF%90%E8%A1%8C%E6%97%B6%E9%98%9F%E5%88%97%E6%93%8D%E4%BD%9C%E5%87%BD%E6%95%B0%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
    <url>/2021/10/06/golang%E8%BF%90%E8%A1%8C%E6%97%B6%E9%98%9F%E5%88%97%E6%93%8D%E4%BD%9C%E5%87%BD%E6%95%B0%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<blockquote><p>ç¯å¢ƒï¼š</p><p>CentOS Linux release 8.4.2105</p><p>go1.15.14</p><p>dlv1.5.0</p><p>è¢«è°ƒè¯•çš„æºç å†…å®¹ï¼š</p></blockquote><figure class="highlight golang"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs golang"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-built_in">println</span>(<span class="hljs-string">&quot;Hello World!&quot;</span>)<br>&#125;<br></code></pre></div></td></tr></table></figure><blockquote><p>å¿«é€Ÿæ­å»ºè°ƒè¯•ç¯å¢ƒ:</p></blockquote><figure class="highlight dockerfile"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs Dockerfile"><span class="hljs-keyword">FROM</span> centos<br><span class="hljs-keyword">RUN</span><span class="bash"> yum install golang -y \</span><br><span class="bash">&amp;&amp; yum install dlv -y \</span><br><span class="bash">&amp;&amp; yum install binutils -y \</span><br><span class="bash">&amp;&amp; yum install vim -y \</span><br><span class="bash">&amp;&amp; yum install gdb -y</span><br></code></pre></div></td></tr></table></figure><h1 id="golangè¿è¡Œæ—¶æ¦‚è¿°"><a href="#golangè¿è¡Œæ—¶æ¦‚è¿°" class="headerlink" title="golangè¿è¡Œæ—¶æ¦‚è¿°"></a>golangè¿è¡Œæ—¶æ¦‚è¿°</h1><p>Goçš„è°ƒåº¦æµç¨‹æœ¬è´¨ä¸Šæ˜¯ç”Ÿäº§-æ¶ˆè´¹æµç¨‹</p><ol><li>ç”Ÿäº§ç«¯ç”Ÿæˆgoruntineæ”¾å…¥é˜Ÿåˆ—</li><li>æ¶ˆè´¹ç«¯é€šè¿‡ä¸Mç»‘å®šçš„Pè·å–goroutine</li><li>Må¾ªç¯è°ƒåº¦æ‰§è¡Œ runtime.schedule-&gt;runtime.execute-&gt;runtime.gogo-&gt;runtime.goexit</li></ol><p>ä¸ºäº†ç¼“è§£ä¸€çº§é˜Ÿåˆ—ä¸­ç”Ÿäº§æ¶ˆè´¹æ¨¡å‹çš„å‹åŠ›ï¼ŒGoé‡‡ç”¨ä¸‰çº§é˜Ÿåˆ—ï¼š</p><ol><li>Pä¸­çš„runnexté˜Ÿåˆ—, è¯¥é˜Ÿåˆ—åªä¿å­˜ä¸€ä¸ªgoroutine</li><li>local run queue è¯¥é˜Ÿåˆ—æœ€å¤§ä¿å­˜256ä¸ªgoroutine</li><li>global run queue è¯¥é˜Ÿåˆ—ä»¥é“¾è¡¨çš„å½¢å¼ä¿å­˜goroutine</li></ol><p>æ“ä½œè¿è¡Œæ—¶goroutineé˜Ÿåˆ—çš„å‡½æ•°ä¸»è¦æœ‰ï¼š</p><ol><li>runqput</li><li>runqget</li><li>globrunqput</li><li>globrunqget</li></ol><blockquote><p>ä¸ºäº†æ–¹ä¾¿æè¿°ä¸€ä¸‹å†…å®¹æ‰€æœ‰çš„gä»£æŒ‡goroutine</p></blockquote><h2 id="runqput"><a href="#runqput" class="headerlink" title="runqput"></a>runqput</h2><p>ä½¿ç”¨dlvè°ƒè¯•</p><figure class="highlight sh"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs sh">[root@583d9a8ec1db p1]<span class="hljs-comment"># dlv exec ./main</span><br>Type <span class="hljs-string">&#x27;help&#x27;</span> <span class="hljs-keyword">for</span> list of commands.<br>(dlv) b runtime.runqput<br>Breakpoint 1 <span class="hljs-built_in">set</span> at 0x43c073 <span class="hljs-keyword">for</span> runtime.runqput() /usr/lib/golang/src/runtime/proc.go:5153<br>(dlv) c<br>&gt; runtime.runqput() /usr/lib/golang/src/runtime/proc.go:5153 (hits total:1) (PC: 0x43c073)<br>Warning: debugging optimized <span class="hljs-keyword">function</span><br>  5148: // runqput tries to put g on the <span class="hljs-built_in">local</span> runnable queue.<br>  5149: // If next is <span class="hljs-literal">false</span>, runqput adds g to the tail of the runnable queue.<br>  5150: // If next is <span class="hljs-literal">true</span>, runqput puts g <span class="hljs-keyword">in</span> the _p_.runnext slot.<br>  5151: // If the run queue is full, runnext puts g on the global queue.<br>  5152: // Executed only by the owner P.<br>=&gt;5153: func runqput(_p_ *p, gp *g, next bool) &#123;<br>  5154:         <span class="hljs-keyword">if</span> randomizeScheduler &amp;&amp; next &amp;&amp; fastrand()%2 == 0 &#123;<br>  5155:                 next = <span class="hljs-literal">false</span><br>  5156:         &#125;<br>  5157:<br>  5158:         <span class="hljs-keyword">if</span> next &#123;<br></code></pre></div></td></tr></table></figure><p>runqput å…¨éƒ¨æºç å†…å®¹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">runqput</span><span class="hljs-params">(_p_ *p, gp *g, next <span class="hljs-keyword">bool</span>)</span></span> &#123;<br>    <span class="hljs-keyword">if</span> randomizeScheduler &amp;&amp; next &amp;&amp; fastrand()%<span class="hljs-number">2</span> == <span class="hljs-number">0</span> &#123;<br>        next = <span class="hljs-literal">false</span><br>    &#125;<br><br>    <span class="hljs-keyword">if</span> next &#123;<br>    retryNext:<br>        oldnext := _p_.runnext<br>        <span class="hljs-keyword">if</span> !_p_.runnext.cas(oldnext, guintptr(unsafe.Pointer(gp))) &#123;<br>            <span class="hljs-keyword">goto</span> retryNext<br>        &#125;<br>        <span class="hljs-keyword">if</span> oldnext == <span class="hljs-number">0</span> &#123;<br>            <span class="hljs-keyword">return</span><br>        &#125;<br>        <span class="hljs-comment">// Kick the old runnext out to the regular run queue.</span><br>        gp = oldnext.ptr()<br>    &#125;<br><br>retry:<br>    h := atomic.LoadAcq(&amp;_p_.runqhead) <span class="hljs-comment">// load-acquire, synchronize with consumers</span><br>    t := _p_.runqtail<br>    <span class="hljs-keyword">if</span> t-h &lt; <span class="hljs-keyword">uint32</span>(<span class="hljs-built_in">len</span>(_p_.runq)) &#123;<br>        _p_.runq[t%<span class="hljs-keyword">uint32</span>(<span class="hljs-built_in">len</span>(_p_.runq))].set(gp)<br>        atomic.StoreRel(&amp;_p_.runqtail, t+<span class="hljs-number">1</span>) <span class="hljs-comment">// store-release, makes the item available for consumption</span><br>        <span class="hljs-keyword">return</span><br>    &#125;<br>    <span class="hljs-keyword">if</span> runqputslow(_p_, gp, h, t) &#123;<br>        <span class="hljs-keyword">return</span><br>    &#125;<br>    <span class="hljs-comment">// the queue is not full, now the put above must succeed</span><br>    <span class="hljs-keyword">goto</span> retry<br>&#125;<br></code></pre></div></td></tr></table></figure><p>ä»è¯¥å‡½æ•°å¯ä»¥çœ‹å‡ºgoroutineæ”¾å…¥é˜Ÿåˆ—ä¸»è¦æœ‰ä¸€ä¸‹ä¸€äº›é€»è¾‘</p><ol><li><p>å½“å…¥å‚nextä¸ºfalseæ—¶:</p><ol><li>å°è¯•å°†gæ”¾å…¥å½“å‰Pçš„runqé˜Ÿåˆ—ï¼Œæˆ‘ä»¬ç§°ä¸ºæœ¬åœ°é˜Ÿåˆ—</li><li>å½“æœ¬åœ°é˜Ÿåˆ—å·²ç»æ»¡äº†çš„æ—¶å€™è°ƒç”¨  runqputslow å‡½æ•°</li><li>runqputslowå‡½æ•°æ‰§è¡Œæ‰¹é‡çš„å°†æœ¬åœ°é˜Ÿåˆ—çš„ä¸€åŠå¤§å°å’Œå½“å‰çš„gä¸€èµ·ç§»åŠ¨åˆ°å…¨å±€é˜Ÿåˆ—</li></ol></li><li><p>å½“å…¥å‚nextä¸ºtrueæ—¶:</p><ol><li>å°è¯•å°†gæ”¾å…¥å½“å‰Pçš„runnextä¸­,å°†åŸå…ˆå­˜åœ¨çš„gä»runnextä¸­å–å‡º</li><li>å°è¯•å°†å–å‡ºçš„gæ”¾å…¥å½“å‰Pçš„runqé˜Ÿåˆ—ï¼Œæˆ‘ä»¬ç§°ä¸ºæœ¬åœ°é˜Ÿåˆ—</li><li>å½“æœ¬åœ°é˜Ÿåˆ—å·²ç»æ»¡äº†çš„æ—¶å€™è°ƒç”¨  runqputslow å‡½æ•°</li><li>runqputslowå‡½æ•°æ‰§è¡Œæ‰¹é‡çš„å°†æœ¬åœ°é˜Ÿåˆ—çš„ä¸€åŠå¤§å°å’Œå–å‡ºçš„gä¸€èµ·ç§»åŠ¨åˆ°å…¨å±€é˜Ÿåˆ—</li></ol></li></ol><h2 id="runqget"><a href="#runqget" class="headerlink" title="runqget"></a>runqget</h2><p>dlv è°ƒè¯•runqget</p><figure class="highlight sh"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs sh">(dlv) b runtime.runqget<br>Breakpoint 2 <span class="hljs-built_in">set</span> at 0x43c4a0 <span class="hljs-keyword">for</span> runtime.runqget() /usr/lib/golang/src/runtime/proc.go:5265<br>(dlv) c<br>&gt; runtime.runqget() /usr/lib/golang/src/runtime/proc.go:5265 (hits total:1) (PC: 0x43c4a0)<br>Warning: debugging optimized <span class="hljs-keyword">function</span><br>  5260:<br>  5261: // Get g from <span class="hljs-built_in">local</span> runnable queue.<br>  5262: // If inheritTime is <span class="hljs-literal">true</span>, gp should inherit the remaining time <span class="hljs-keyword">in</span> the<br>  5263: // current time slice. Otherwise, it should start a new time slice.<br>  5264: // Executed only by the owner P.<br>=&gt;5265: func runqget(_p_ *p) (gp *g, inheritTime bool) &#123;<br>  5266:         // If there<span class="hljs-string">&#x27;s a runnext, it&#x27;</span>s the next G to run.<br>  5267:         <span class="hljs-keyword">for</span> &#123;<br>  5268:                 next := _p_.runnext<br>  5269:                 <span class="hljs-keyword">if</span> next == 0 &#123;<br>  5270:                         <span class="hljs-built_in">break</span><br></code></pre></div></td></tr></table></figure><p>é€šè¿‡è°ƒè¯•ä¿¡æ¯æ‰¾åˆ°æºä»£ç ï¼š</p><figure class="highlight go"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">runqget</span><span class="hljs-params">(_p_ *p)</span> <span class="hljs-params">(gp *g, inheritTime <span class="hljs-keyword">bool</span>)</span></span> &#123;<br>    <span class="hljs-comment">// If there&#x27;s a runnext, it&#x27;s the next G to run.</span><br>    <span class="hljs-keyword">for</span> &#123;<br>        next := _p_.runnext<br>        <span class="hljs-keyword">if</span> next == <span class="hljs-number">0</span> &#123;<br>            <span class="hljs-keyword">break</span><br>        &#125;<br>        <span class="hljs-keyword">if</span> _p_.runnext.cas(next, <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">return</span> next.ptr(), <span class="hljs-literal">true</span><br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">for</span> &#123;<br>        h := atomic.LoadAcq(&amp;_p_.runqhead) <span class="hljs-comment">// load-acquire, synchronize with other consumers</span><br>        t := _p_.runqtail<br>        <span class="hljs-keyword">if</span> t == h &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">false</span><br>        &#125;<br>        gp := _p_.runq[h%<span class="hljs-keyword">uint32</span>(<span class="hljs-built_in">len</span>(_p_.runq))].ptr()<br>        <span class="hljs-keyword">if</span> atomic.CasRel(&amp;_p_.runqhead, h, h+<span class="hljs-number">1</span>) &#123; <span class="hljs-comment">// cas-release, commits consume</span><br>            <span class="hljs-keyword">return</span> gp, <span class="hljs-literal">false</span><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>ä»æºç ä¸­å¯ä»¥çœ‹å‡º runqgetä¸»è¦æ“ä½œPçš„æœ¬åœ°é˜Ÿåˆ—ï¼Œ ä¼˜å…ˆè·å–runnextä¹‹åå†è·å–runqä¸­çš„å¤´ä¸ª</p><h2 id="globalrunqput"><a href="#globalrunqput" class="headerlink" title="globalrunqput"></a>globalrunqput</h2><p>dlv è°ƒè¯•</p><figure class="highlight sh"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs sh">[root@583d9a8ec1db p1]<span class="hljs-comment"># dlv exec ./main</span><br>Type <span class="hljs-string">&#x27;help&#x27;</span> <span class="hljs-keyword">for</span> list of commands.<br>(dlv) b runtime.globrunqput<br>Breakpoint 1 <span class="hljs-built_in">set</span> at 0x435b46,0x43670e,0x437bb0,0x4396fc,0x453ca6,0x454814 <span class="hljs-keyword">for</span> runtime.injectglist() /usr/lib/golang/src/runtime/proc.go:5044<br>(dlv) c<br>&gt; runtime.goschedImpl() /usr/lib/golang/src/runtime/proc.go:5043 (hits total:1) (PC: 0x43670e)<br>Warning: debugging optimized <span class="hljs-keyword">function</span><br>  5038: // Put gp on the global runnable queue.<br>  5039: // Sched must be locked.<br>  5040: // May run during STW, so write barriers are not allowed.<br>  5041: //go:nowritebarrierrec<br>  5042: func globrunqput(gp *g) &#123;<br>=&gt;5043:         sched.runq.pushBack(gp)<br>  5044:         sched.runqsize++<br>  5045: &#125;<br>  5046:<br>  5047: // Put gp at the head of the global runnable queue.<br>  5048: // Sched must be locked.<br></code></pre></div></td></tr></table></figure><p>è¯¥å‡½æ•°é€»è¾‘æ¯”è¾ƒç®€å• åªæ˜¯å°†gæ·»åŠ åˆ°å…¨å±€é˜Ÿåˆ—çš„é“¾è¡¨ä¸­</p><h2 id="globrunqget"><a href="#globrunqget" class="headerlink" title="globrunqget"></a>globrunqget</h2><p>dlv è°ƒè¯•</p><figure class="highlight sh"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs sh">[root@583d9a8ec1db p1]<span class="hljs-comment"># dlv exec ./main</span><br>Type <span class="hljs-string">&#x27;help&#x27;</span> <span class="hljs-keyword">for</span> list of commands.<br>(dlv) b runtime.globrunqget<br>Breakpoint 1 <span class="hljs-built_in">set</span> at 0x43be33 <span class="hljs-keyword">for</span> runtime.globrunqget() /usr/lib/golang/src/runtime/proc.go:5067<br>(dlv) c<br>&gt; runtime.globrunqget() /usr/lib/golang/src/runtime/proc.go:5067 (hits total:1) (PC: 0x43be33)<br>Warning: debugging optimized <span class="hljs-keyword">function</span><br>  5062:         *batch = gQueue&#123;&#125;<br>  5063: &#125;<br>  5064:<br>  5065: // Try get a batch of G<span class="hljs-string">&#x27;s from the global runnable queue.</span><br><span class="hljs-string">  5066: // Sched must be locked.</span><br><span class="hljs-string">=&gt;5067: func globrunqget(_p_ *p, max int32) *g &#123;</span><br><span class="hljs-string">  5068:         if sched.runqsize == 0 &#123;</span><br><span class="hljs-string">  5069:                 return nil</span><br><span class="hljs-string">  5070:         &#125;</span><br><span class="hljs-string">  5071:</span><br><span class="hljs-string">  5072:         n := sched.runqsize/gomaxprocs + 1</span><br></code></pre></div></td></tr></table></figure><p>æ‰¾åˆ°å¯¹åº”æºç ä¸º:</p><figure class="highlight go"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">globrunqget</span><span class="hljs-params">(_p_ *p, max <span class="hljs-keyword">int32</span>)</span> *<span class="hljs-title">g</span></span> &#123;<br>    <span class="hljs-keyword">if</span> sched.runqsize == <span class="hljs-number">0</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>    &#125;<br><br>    n := sched.runqsize/gomaxprocs + <span class="hljs-number">1</span><br>    <span class="hljs-keyword">if</span> n &gt; sched.runqsize &#123;<br>        n = sched.runqsize<br>    &#125;<br>    <span class="hljs-keyword">if</span> max &gt; <span class="hljs-number">0</span> &amp;&amp; n &gt; max &#123;<br>        n = max<br>    &#125;<br>    <span class="hljs-keyword">if</span> n &gt; <span class="hljs-keyword">int32</span>(<span class="hljs-built_in">len</span>(_p_.runq))/<span class="hljs-number">2</span> &#123;<br>        n = <span class="hljs-keyword">int32</span>(<span class="hljs-built_in">len</span>(_p_.runq)) / <span class="hljs-number">2</span><br>    &#125;<br><br>    sched.runqsize -= n<br><br>    gp := sched.runq.pop()<br>    n--<br>    <span class="hljs-keyword">for</span> ; n &gt; <span class="hljs-number">0</span>; n-- &#123;<br>        gp1 := sched.runq.pop()<br>        runqput(_p_, gp1, <span class="hljs-literal">false</span>)<br>    &#125;<br>    <span class="hljs-keyword">return</span> gp<br>&#125;<br></code></pre></div></td></tr></table></figure><p>åˆ†ææºç å‘ç°è¯¥å‡½æ•°ä¸»è¦é€»è¾‘ï¼š</p><ol><li>æ‰¹é‡å–å‡ºéƒ¨åˆ†å…¨å±€é˜Ÿåˆ—çš„gï¼Œå–å‡ºæ•°é‡= å…¨å±€æ€»é‡/æ ¸å¿ƒæ•°+1</li><li>å°† å…¨å±€æ€»é‡/æ ¸å¿ƒæ•° çš„gåŠ å…¥åˆ°å½“å‰Pçš„æœ¬åœ°é˜Ÿåˆ—</li><li>è¿”å›ä¸€ä¸ªg</li></ol><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>è·å–ï¼š gçš„è·å–ä¼˜å…ˆä»runnext ç„¶åæœ¬åœ°runq æœ€ç»ˆè·å–ä¸åˆ°å»å…¨å±€è·å–<br>æ·»åŠ ï¼š ä¼˜å…ˆæ”¾å…¥runnext ç„¶åæœ¬åœ°é˜Ÿåˆ— æœ¬åœ°é˜Ÿåˆ—æ»¡äº†æ‰¹é‡æ”¾å…¥å…¨å±€é˜Ÿåˆ—</p>]]></content>
    
    
    <categories>
      
      <category>golang</category>
      
    </categories>
    
    
    <tags>
      
      <tag>golang</tag>
      
      <tag>runtime</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•ä»¥åŠGoå®ç°</title>
    <link href="/2021/09/03/%E4%B8%80%E8%87%B4%E6%80%A7%E5%93%88%E5%B8%8C%E7%AE%97%E6%B3%95%E4%BB%A5%E5%8F%8AGo%E5%AE%9E%E7%8E%B0/"/>
    <url>/2021/09/03/%E4%B8%80%E8%87%B4%E6%80%A7%E5%93%88%E5%B8%8C%E7%AE%97%E6%B3%95%E4%BB%A5%E5%8F%8AGo%E5%AE%9E%E7%8E%B0/</url>
    
    <content type="html"><![CDATA[<h2 id="ä»€ä¹ˆæ˜¯ä¸€è‡´æ€§å“ˆå¸Œ"><a href="#ä»€ä¹ˆæ˜¯ä¸€è‡´æ€§å“ˆå¸Œ" class="headerlink" title="ä»€ä¹ˆæ˜¯ä¸€è‡´æ€§å“ˆå¸Œ"></a>ä»€ä¹ˆæ˜¯ä¸€è‡´æ€§å“ˆå¸Œ</h2><p>ä¸€è‡´å“ˆå¸Œ æ˜¯ä¸€ç§ç‰¹æ®Šçš„å“ˆå¸Œç®—æ³•ã€‚åœ¨ä½¿ç”¨ä¸€è‡´å“ˆå¸Œç®—æ³•åï¼Œå“ˆå¸Œè¡¨æ§½ä½æ•°ï¼ˆå¤§å°ï¼‰çš„æ”¹å˜å¹³å‡åªéœ€è¦å¯¹ K/n ä¸ªå…³é”®å­—é‡æ–°æ˜ å°„ï¼Œå…¶ä¸­ K æ˜¯å…³é”®å­—çš„æ•°é‡ï¼Œnæ˜¯æ§½ä½æ•°é‡ã€‚ç„¶è€Œåœ¨ä¼ ç»Ÿçš„å“ˆå¸Œè¡¨ä¸­ï¼Œæ·»åŠ æˆ–åˆ é™¤ä¸€ä¸ªæ§½ä½çš„å‡ ä¹éœ€è¦å¯¹æ‰€æœ‰å…³é”®å­—è¿›è¡Œé‡æ–°æ˜ å°„ã€‚</p><p>ä»¥ä¸Šä¸ºç»´åŸºç™¾ç§‘ä¸­çš„ä»‹ç»ï¼Œå¾ˆæ˜¾ç„¶è¦æƒ³æ˜ç™½ä¸€è‡´æ€§å“ˆå¸Œé¦–å…ˆæˆ‘ä»¬è¦å…ˆææ‡‚ä¼ ç»Ÿå“ˆå¸Œ</p><h2 id="ä¼ ç»Ÿå“ˆå¸Œç”¨ä¾‹"><a href="#ä¼ ç»Ÿå“ˆå¸Œç”¨ä¾‹" class="headerlink" title="ä¼ ç»Ÿå“ˆå¸Œç”¨ä¾‹"></a>ä¼ ç»Ÿå“ˆå¸Œç”¨ä¾‹</h2><p>é¦–å…ˆæˆ‘ä»¬ä»¥ä¸€ç§ç®€å•çš„åˆ†å¸ƒå¼ç¼“å­˜æ¶æ„æ¥é˜è¿°</p><p><img src="/img/hash/redis-hash-cache.jpg" alt="å›¾-1"></p><p>å¦‚å›¾-1æ‰€ç¤ºï¼Œæˆ‘ä»¬æœ‰çš„æ—¶å€™åä¼šä½¿ç”¨rediså¯¹çƒ­ç‚¹æ•°æ®ç¼“å­˜è¿›è€Œç¼“è§£æ•°æ®åº“çš„å‹åŠ›ï¼Œç†è®ºä¸Šæˆ‘ä»¬è®¤ä¸ºmysqlçš„æ“ä½œæ˜¯é«˜æ˜‚çš„ã€‚</p><p class="note note-success">è¿™é‡Œå¤šä¸ªredisæœ¬è´¨ä¸Šæ˜¯å¤šä¸ªé›†ç¾¤</p><p>è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å¸Œæœ›å°†çƒ­ç‚¹æ•°æ®å‡åŒ€çš„æ‰“æ•£åˆ°å¤šä¸ªredisä¸Šï¼Œæ¥é™ä½å•ä¸ªredisé›†ç¾¤ä¸ºç¼“å­˜é€ æˆèŠ‚ç‚¹è®¿é—®è¿‡çƒ­çš„æƒ…å†µå‘ç”Ÿã€‚ç®€å•çš„æˆ‘ä»¬å¯ä»¥ç†è§£ä¸ºå°†ä¸åŒçš„æ•°æ®è½¬æ¢å”¯ä¸€å€¼åï¼ŒæŒ‰ç…§redisæ•°é‡å–æ¨¡ã€‚å‡è®¾æœ‰3å°redisåšç¼“å­˜ã€‚è®¡ç®—å…¬å¼å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">h=<span class="hljs-built_in">hash</span>(key)%3<br></code></pre></div></td></tr></table></figure><p>æˆ‘ä»¬æŠŠè¿™3ä¸ªrediså¯¹åº”ç¼–å·ï¼Œhçš„å€¼å°±æ˜¯è¿™ä¸ªæ•°æ®åº”è¯¥è½åœ¨çš„ç¼“å­˜redisçš„ä½ç½®ã€‚è¿™å°±æ˜¯ä¼ ç»Ÿçš„hashä½¿ç”¨çš„ä¸€ç§ï¼Œç±»ä¼¼çš„åœ¨æ•°æ®åº“åˆ†è¡¨å¯¹æ•°æ®æ“ä½œçš„æ—¶å€™ä¹Ÿå¯ä»¥ä½¿ç”¨è¿™ç§æ–¹å¼ã€‚</p><p><strong>ä¼ ç»Ÿå“ˆå¸Œå­˜åœ¨ä»€ä¹ˆé—®é¢˜ï¼Ÿ</strong></p><p>å¾ˆæ˜æ˜¾å­˜åœ¨è¿™ç§é—®é¢˜ï¼šå½“æˆ‘ä»¬å…¶ä¸­ä¸€ä¸ªredisæ–­ç”µä¹‹æˆ–è€…æ–°å¢ä¸€ä¸ªé‚£ä¹ˆå¯¹åº”çš„å…¨éƒ¨ç¼“å­˜å¯¹åº”çš„è¦å…¨éƒ¨æ”¹å˜ä½ç½®ï¼Œå› ä¸ºèŠ‚ç‚¹çš„æ•°é‡å‘ç”Ÿæ”¹å˜äº†ï¼Œä»ç„¶ç”¨ä¹‹å‰çš„è®¡ç®—æ–¹æ³•æ•°æ®è½ç‚¹å…¨éƒ¨å‡ºé”™ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ä¸€è‡´æ€§å“ˆå¸Œå°±å‡ºç°äº†ã€‚</p><h2 id="ä¸€è‡´æ€§å“ˆå¸ŒåŸç†"><a href="#ä¸€è‡´æ€§å“ˆå¸ŒåŸç†" class="headerlink" title="ä¸€è‡´æ€§å“ˆå¸ŒåŸç†"></a>ä¸€è‡´æ€§å“ˆå¸ŒåŸç†</h2><p>ä¸€è‡´æ€§å“ˆå¸Œå°†æ•´ä¸ªå“ˆå¸Œå€¼ç©ºé—´ç»„ç»‡æˆä¸€ä¸ªè™šæ‹Ÿçš„åœ†ç¯ï¼Œå¦‚å‡è®¾æŸå“ˆå¸Œå‡½æ•° H çš„å€¼ç©ºé—´ä¸º 0-2^32-1ï¼ˆå³å“ˆå¸Œå€¼æ˜¯ä¸€ä¸ª 32 ä½æ— ç¬¦å·æ•´å½¢ï¼‰ï¼Œæ•´ä¸ªå“ˆå¸Œç©ºé—´ç¯å¦‚ä¸‹ï¼š</p><p><img src="/img/hash/cricle-hash-1.jpg" alt="å›¾-2"></p><p>æ¥ä¸‹æ¥å°±æ˜¯å°†æˆ‘ä»¬çš„ç¼“å­˜å¯¹è±¡å“ˆå¸ŒåŒ–æ”¾åˆ°è¿™ä¸ªç¯ä¸­ï¼Œè®¿é—®æ•°æ®çš„æ—¶å€™æ•°æ®keyä¹Ÿæ˜¯ç”¨åŒæ ·çš„ç®—æ³•è®¡ç®—å‡ºå“ˆå¸Œï¼Œé€šè¿‡ç¯ä¸Šé¡ºæ—¶é’ˆè½¬åŠ¨çŸ¥é“é‡åˆ°ç¬¬ä¸€ä¸ªå­˜è´®èŠ‚ç‚¹ï¼Œè¿™ä¸ªå­˜å‚¨èŠ‚ç‚¹å°±æ˜¯æ•°æ®çš„ä¿å­˜èŠ‚ç‚¹ã€‚å¦‚å›¾-3æ‰€</p><p><img src="/img/hash/cricle-hash-2.png" alt="å›¾-3"></p><p>å›¾-3ä¸­object1çš„keyå“ˆå¸Œä¹‹åä¸º400000000é¡ºæ—¶é’ˆè½¬åŠ¨çŸ¥é“é‡åˆ°ç¬¬ä¸€ä¸ªå­˜å‚¨å¯¹è±¡node2æ‰€ä»¥object1ä¿å­˜çš„å¯¹è±¡ä¸ºnode2ã€‚</p><p class="note note-primary">ä¸€èˆ¬çš„å¦‚æœä¸€ä¸ªèŠ‚ç‚¹ä¸å¯ç”¨åˆ™è¿™ä¸ªèŠ‚ç‚¹ä¸Šçš„æ•°æ®å°±ä¼šåˆ†é…åˆ°ç›¸é‚»çš„èŠ‚ç‚¹ä¸Šè€Œå…¶ä»–keyæ‰€åœ¨çš„ä½ç½®ä¸ä¼šå˜åŒ–ã€‚æ–°å¢ä¸€ä¸ªèŠ‚ç‚¹åŒç†</p><h2 id="ä¸€è‡´æ€§å“ˆå¸Œå¼•å…¥è™šæ‹ŸèŠ‚ç‚¹è§£å†³åˆ†é…ä¸å‡é—®é¢˜"><a href="#ä¸€è‡´æ€§å“ˆå¸Œå¼•å…¥è™šæ‹ŸèŠ‚ç‚¹è§£å†³åˆ†é…ä¸å‡é—®é¢˜" class="headerlink" title="ä¸€è‡´æ€§å“ˆå¸Œå¼•å…¥è™šæ‹ŸèŠ‚ç‚¹è§£å†³åˆ†é…ä¸å‡é—®é¢˜"></a>ä¸€è‡´æ€§å“ˆå¸Œå¼•å…¥è™šæ‹ŸèŠ‚ç‚¹è§£å†³åˆ†é…ä¸å‡é—®é¢˜</h2><p>æƒ³å¿…å¤§èªæ˜çš„ä½ å·²ç»çœ‹å‡ºæ¥äº†ã€‚å½“å­˜å‚¨èŠ‚ç‚¹è¾ƒå°‘æˆ–è€…èŠ‚ç‚¹åˆ†é…æœ¬èº«å°±ä¸å‡è¡¡çš„æƒ…å†µä¸‹ï¼Œä¸€äº›keyè½å…¥çš„æ•°æ®èŠ‚ç‚¹å¿…ç„¶ä¼šä¸å‡è¡¡ï¼Œè¿™ä¸ªæ—¶å€™åˆä¼šé€ æˆèŠ‚ç‚¹è¿‡çƒ­ã€‚ä¸ºè§£å†³è¿™ä¸ªé—®é¢˜å¼•å…¥äº†è™šæ‹ŸèŠ‚ç‚¹ã€‚å³ä¸€ä¸ªçœŸå®èŠ‚ç‚¹å¯¹åº”äº†å¤šä¸ªè™šæ‹Ÿçš„èŠ‚ç‚¹å¦‚å›¾-4æ‰€ç¤ºï¼š</p><p><img src="/img/hash/cricle-hash-3.png" alt="å›¾-4"></p><p>å›¾-4ä¸­çš„è™šæ‹ŸèŠ‚ç‚¹å¹¶ä¸æ˜¯çœŸå®çš„å­˜å‚¨èŠ‚ç‚¹ï¼Œè€Œæ˜¯æŒ‰ç…§ä¸€å®šè§„åˆ™æ‰¹é‡ç”Ÿæˆçš„è™šæ‹ŸèŠ‚ç‚¹ã€‚è¿™äº›è™šæ‹ŸèŠ‚ç‚¹éƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„çœŸå®èŠ‚ç‚¹ã€‚</p><h2 id="ä¸€è‡´æ€§å“ˆå¸Œä¸å…¶å“ˆå¸Œç®—æ³•å¯¹æ¯”"><a href="#ä¸€è‡´æ€§å“ˆå¸Œä¸å…¶å“ˆå¸Œç®—æ³•å¯¹æ¯”" class="headerlink" title="ä¸€è‡´æ€§å“ˆå¸Œä¸å…¶å“ˆå¸Œç®—æ³•å¯¹æ¯”"></a>ä¸€è‡´æ€§å“ˆå¸Œä¸å…¶å“ˆå¸Œç®—æ³•å¯¹æ¯”</h2><p>å¯¹äºé›†ç¾¤ä¸­ç¼“å­˜ç±»æ•°æ®keyçš„èŠ‚ç‚¹åˆ†é…é—®é¢˜ï¼Œæœ‰è¿™å‡ ç§è§£å†³æ–¹æ³•ï¼Œç®€å•çš„hashå–æ¨¡ï¼Œæ§½æ˜ å°„ï¼Œä¸€è‡´æ€§hashã€‚</p><ul><li><p><strong>hashå–æ¨¡</strong><br>å¯¹äºhashå–æ¨¡ï¼Œå‡è¡¡æ€§æ²¡æœ‰ä»€ä¹ˆé—®é¢˜ï¼Œä½†æ˜¯å¦‚æœé›†ç¾¤ä¸­æ–°å¢ä¸€ä¸ªèŠ‚ç‚¹æ—¶ï¼Œå°†ä¼šæœ‰Nï¼ï¼ˆN+1ï¼‰çš„æ•°æ®å®æ•ˆï¼Œå½“Nå€¼è¶Šå¤§ï¼Œå¤±æ•ˆç‡è¶Šé«˜ã€‚è¿™æ˜¾ç„¶æ˜¯ä¸å¯æ¥å—çš„ã€‚</p></li><li><p><strong>æ§½æ˜ å°„</strong><br>redisé‡‡ç”¨çš„å°±æ˜¯è¿™ç§ç®—æ³•, å…¶æ€æƒ³æ˜¯å°†keyå€¼åšä¸€å®šè¿ç®—ï¼ˆå¦‚crc16ï¼Œ crc32ï¼Œhashï¼‰ï¼Œ è·å¾—ä¸€ä¸ªæ•´æ•°å€¼ï¼Œå†å°†è¯¥å€¼ä¸å›ºå®šçš„æ§½æ•°å–æ¨¡ï¼ˆslotsï¼‰ï¼Œ æ¯ä¸ªèŠ‚ç‚¹å¤„ç†å›ºå®šçš„slotsã€‚è·å–keyæ‰€åœ¨çš„èŠ‚ç‚¹æ—¶ï¼Œå…ˆè¦è®¡ç®—å‡ºkeyä¸æ§½çš„å¯¹åº”å…³ç³»ï¼Œå†é€šè¿‡æ§½ä¸èŠ‚ç‚¹çš„å¯¹åº”å…³ç³»æ‰¾åˆ°èŠ‚ç‚¹ï¼Œè¿™é‡Œæ¯æ¬¡æ–°å¢èŠ‚ç‚¹æ—¶ï¼Œåªéœ€è¦è¿ç§»ä¸€å®šæ§½å¯¹åº”çš„keyå³å¯ï¼Œè€Œä¸è¿ç§»çš„æ§½ç‚¹keyå€¼åˆ™ä¸ä¼šå®æ•ˆï¼Œè¿™ç§æ–¹å¼å°†å¤±æ•ˆç‡é™ä½åˆ°äº† 1ï¼ï¼ˆN+1ï¼‰ã€‚ä¸è¿‡è¿™ç§æ–¹å¼æœ‰ä¸ªç¼ºç‚¹å°±æ˜¯æ‰€æœ‰èŠ‚ç‚¹éƒ½éœ€è¦çŸ¥é“æ§½ä¸èŠ‚ç‚¹å¯¹åº”å…³ç³»ï¼Œå¦‚æœclientç«¯ä¸ä¿å­˜æ§½ä¸èŠ‚ç‚¹çš„å¯¹åº”å…³ç³»çš„è¯ï¼Œå®ƒéœ€è¦å®ç°é‡å®šå‘çš„é€»è¾‘ã€‚</p></li><li><p><strong>ä¸€è‡´æ€§hash</strong><br>ä¸€è‡´æ€§hashå¦‚ä¸Šæ–‡æ‰€è¨€ï¼Œå…¶æ–°å¢ä¸€ä¸ªèŠ‚ç‚¹çš„å¤±æ•ˆç‡ä»…ä¸º1ï¼ï¼ˆN+1ï¼‰ï¼Œé€šè¿‡ä¸€è‡´æ€§hashæœ€å¤§ç¨‹åº¦çš„é™ä½äº†å®æ•ˆç‡ã€‚åŒæ—¶ç›¸æ¯”äºæ§½æ˜ å°„çš„æ–¹å¼ï¼Œä¸éœ€è¦å¼•äººæ§½æ¥åšä¸­é—´å¯¹åº”ï¼Œæœ€å¤§é™åº¦çš„ç®€åŒ–äº†å®ç°ã€‚</p></li></ul><h2 id="Goå®ç°ä¸€è‡´æ€§å“ˆå¸Œ"><a href="#Goå®ç°ä¸€è‡´æ€§å“ˆå¸Œ" class="headerlink" title="Goå®ç°ä¸€è‡´æ€§å“ˆå¸Œ"></a>Goå®ç°ä¸€è‡´æ€§å“ˆå¸Œ</h2><p><strong>ä»£ç å®ç°è¯¦ç»†<a href="https://github.com/dogslee/consistent">github.com/dogslee/consistent</a></strong></p><p>ä½¿ç”¨æ ·ä¾‹:</p><figure class="highlight golang"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs golang"><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;fmt&quot;</span><br><span class="hljs-string">&quot;log&quot;</span><br><br><span class="hljs-string">&quot;github.com/dogslee/consistent&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-comment">// default consistent hash function</span><br>c := consistent.New()<br><span class="hljs-comment">// add new node</span><br>c.Add(<span class="hljs-string">&quot;node1&quot;</span>)<br>c.Add(<span class="hljs-string">&quot;node2&quot;</span>)<br>c.Add(<span class="hljs-string">&quot;node3&quot;</span>)<br>c.Add(<span class="hljs-string">&quot;node4&quot;</span>)<br>keyCase := []<span class="hljs-keyword">string</span>&#123;<span class="hljs-string">&quot;user1&quot;</span>, <span class="hljs-string">&quot;user2&quot;</span>, <span class="hljs-string">&quot;user3&quot;</span>, <span class="hljs-string">&quot;user4&quot;</span>&#125;<br><span class="hljs-keyword">for</span> _, k := <span class="hljs-keyword">range</span> keyCase &#123;<br>srvNode, err := c.Get(k)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>log.Fatal(err)<br>&#125;<br>fmt.Printf(<span class="hljs-string">&quot;key: %s ==&gt; srvNode: %s&quot;</span>, k, srvNode)<br>&#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><h2 id="Refrence"><a href="#Refrence" class="headerlink" title="Refrence"></a>Refrence</h2><p><a href="https://wizardforcel.gitbooks.io/the-art-of-programming-by-july/content/a.3.html">ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•</a><br><a href="https://juejin.cn/post/6844903750860013576">5åˆ†é’Ÿç†è§£ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•</a><br><a href="https://zh.wikipedia.org/wiki/%E4%B8%80%E8%87%B4%E5%93%88%E5%B8%8C">ç»´åŸºç™¾ç§‘-ä¸€è‡´æ€§å“ˆå¸Œ</a><br><a href="https://xie.infoq.cn/article/78043810ecc807d1896c6f3f2">golang å®ç°ä¸€è‡´æ€§ hash ç®—æ³•</a><br><a href="https://segmentfault.com/a/1190000013533592">ä¸€è‡´æ€§hashç®—æ³•åŸç†åŠgolangå®ç°</a></p>]]></content>
    
    
    <categories>
      
      <category>å­˜å‚¨</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ç¼“å­˜</tag>
      
      <tag>hash</tag>
      
      <tag>golang</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>è®¾ç½®MySQLçš„éš”ç¦»çº§åˆ«</title>
    <link href="/2021/08/25/%E8%AE%BE%E7%BD%AEMySQL%E7%9A%84%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB/"/>
    <url>/2021/08/25/%E8%AE%BE%E7%BD%AEMySQL%E7%9A%84%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB/</url>
    
    <content type="html"><![CDATA[<h2 id="æ€ä¹ˆæŸ¥å½“å‰çš„éš”ç¦»çº§åˆ«ï¼Ÿ"><a href="#æ€ä¹ˆæŸ¥å½“å‰çš„éš”ç¦»çº§åˆ«ï¼Ÿ" class="headerlink" title="æ€ä¹ˆæŸ¥å½“å‰çš„éš”ç¦»çº§åˆ«ï¼Ÿ"></a>æ€ä¹ˆæŸ¥å½“å‰çš„éš”ç¦»çº§åˆ«ï¼Ÿ</h2><p class="note note-success">MySQLæ•°æ®åº“é»˜è®¤çš„å­˜å‚¨å¼•æ“æ˜¯æ”¯æŒäº‹åŠ¡çš„innodb,æ‰€ä»¥è‡ªç„¶çš„å°±æœ‰é»˜è®¤çš„éš”ç¦»çº§åˆ«--å¯é‡å¤è¯»</p><p class="note note-warning">åªæœ‰æ”¯æŒACIDçš„å­˜å‚¨å¼•æ“æ‰æœ‰å¯¹åº”çš„å„ç§éš”ç¦»çº§åˆ«</p><p>åœ¨æˆ‘ä»¬è®¾ç½®å½“å‰äº‹åŠ¡çš„éš”ç¦»çº§åˆ«çš„æ—¶å€™æˆ‘ä»¬é¦–å…ˆè¦ä¼šæŸ¥è¯¢æˆ‘ä»¬çš„MySQLçš„éš”ç¦»çº§åˆ«æ˜¯ä»€ä¹ˆ</p><p>MySQLæŸ¥è¯¢éš”ç¦»çº§åˆ«çš„è¯­å¥æ˜¯ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">mysql&gt; select @@global.tx_isolation,@@tx_isolation;<br>+-----------------------+-----------------+<br>| @@global.tx_isolation | @@tx_isolation  |<br>+-----------------------+-----------------+<br>| REPEATABLE-READ       | REPEATABLE-READ |<br>+-----------------------+-----------------+<br>1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br></code></pre></div></td></tr></table></figure><h2 id="å¦‚ä½•è®¾ç½®è‡ªå·±çš„éš”ç¦»çº§åˆ«ï¼Ÿ"><a href="#å¦‚ä½•è®¾ç½®è‡ªå·±çš„éš”ç¦»çº§åˆ«ï¼Ÿ" class="headerlink" title="å¦‚ä½•è®¾ç½®è‡ªå·±çš„éš”ç¦»çº§åˆ«ï¼Ÿ"></a>å¦‚ä½•è®¾ç½®è‡ªå·±çš„éš”ç¦»çº§åˆ«ï¼Ÿ</h2><p>è®¾ç½®innodbçš„äº‹åŠ¡çº§åˆ«æ–¹æ³•æ˜¯ï¼š</p><p>set ä½œç”¨åŸŸ transaction isolation level äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼Œä¾‹å¦‚~</p><blockquote><p>SET [SESSION | GLOBAL] TRANSACTION ISOLATION LEVEL {READ UNCOMMITTED | READ COMMITTED | REPEATABLE READ | SERIALIZABLE}</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">// å…¨å±€çš„<br>mysql&gt; <span class="hljs-built_in">set</span> global transaction isolation level <span class="hljs-built_in">read</span> committed;<br>// å½“å‰ä¼šè¯<br>mysql&gt; <span class="hljs-built_in">set</span> session transaction isolation level <span class="hljs-built_in">read</span> committed;<br></code></pre></div></td></tr></table></figure><h2 id="å„ä¸ªéš”ç¦»çº§åˆ«éƒ½æ˜¯å•¥æ„æ€ï¼Ÿ"><a href="#å„ä¸ªéš”ç¦»çº§åˆ«éƒ½æ˜¯å•¥æ„æ€ï¼Ÿ" class="headerlink" title="å„ä¸ªéš”ç¦»çº§åˆ«éƒ½æ˜¯å•¥æ„æ€ï¼Ÿ"></a>å„ä¸ªéš”ç¦»çº§åˆ«éƒ½æ˜¯å•¥æ„æ€ï¼Ÿ</h2><p>SQLæ ‡å‡†å®šä¹‰äº†4ç±»éš”ç¦»çº§åˆ«ï¼ŒåŒ…æ‹¬äº†ä¸€äº›å…·ä½“è§„åˆ™ï¼Œç”¨æ¥é™å®šäº‹åŠ¡å†…å¤–çš„å“ªäº›æ”¹å˜æ˜¯å¯è§çš„ï¼Œå“ªäº›æ˜¯ä¸å¯è§çš„ã€‚ä½çº§åˆ«çš„éš”ç¦»çº§ä¸€èˆ¬æ”¯æŒæ›´é«˜çš„å¹¶å‘å¤„ç†ï¼Œå¹¶æ‹¥æœ‰æ›´ä½çš„ç³»ç»Ÿå¼€é”€ã€‚</p><p>ä½†æ˜¯è¯»æäº¤å’Œä¸²è¡ŒåŒ–ä¸€èˆ¬å¾ˆå°‘ä½¿ç”¨</p><ul><li><p><strong>Read Uncommittedï¼ˆè¯»å–æœªæäº¤å†…å®¹ï¼‰</strong><br>åœ¨è¯¥éš”ç¦»çº§åˆ«ï¼Œæ‰€æœ‰äº‹åŠ¡éƒ½å¯ä»¥çœ‹åˆ°å…¶ä»–æœªæäº¤äº‹åŠ¡çš„æ‰§è¡Œç»“æœã€‚æœ¬éš”ç¦»çº§åˆ«å¾ˆå°‘ç”¨äºå®é™…åº”ç”¨ï¼Œå› ä¸ºå®ƒçš„æ€§èƒ½ä¹Ÿä¸æ¯”å…¶ä»–çº§åˆ«å¥½å¤šå°‘ã€‚è¯»å–æœªæäº¤çš„æ•°æ®ï¼Œä¹Ÿè¢«ç§°ä¹‹ä¸ºè„è¯»ï¼ˆDirty Readï¼‰ã€‚</p></li><li><p><strong>Read Committedï¼ˆè¯»å–æäº¤å†…å®¹ï¼‰</strong><br>è¿™æ˜¯å¤§å¤šæ•°æ•°æ®åº“ç³»ç»Ÿçš„é»˜è®¤éš”ç¦»çº§åˆ«ï¼ˆä½†ä¸æ˜¯MySQLé»˜è®¤çš„ï¼‰ã€‚å®ƒæ»¡è¶³äº†éš”ç¦»çš„ç®€å•å®šä¹‰ï¼šä¸€ä¸ªäº‹åŠ¡åªèƒ½çœ‹è§å·²ç»æäº¤äº‹åŠ¡æ‰€åšçš„æ”¹å˜ã€‚è¿™ç§éš”ç¦»çº§åˆ« ä¹Ÿæ”¯æŒæ‰€è°“çš„ä¸å¯é‡å¤è¯»ï¼ˆNonrepeatable Readï¼‰ï¼Œå› ä¸ºåŒä¸€äº‹åŠ¡çš„å…¶ä»–å®ä¾‹åœ¨è¯¥å®ä¾‹å¤„ç†å…¶é—´å¯èƒ½ä¼šæœ‰æ–°çš„commitï¼Œæ‰€ä»¥åŒä¸€selectå¯èƒ½è¿”å›ä¸åŒç»“æœã€‚</p></li><li><p><strong>Repeatable Readï¼ˆå¯é‡è¯»ï¼‰</strong><br>è¿™æ˜¯MySQLçš„é»˜è®¤äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼Œå®ƒç¡®ä¿åŒä¸€äº‹åŠ¡çš„å¤šä¸ªå®ä¾‹åœ¨å¹¶å‘è¯»å–æ•°æ®æ—¶ï¼Œä¼šçœ‹åˆ°åŒæ ·çš„æ•°æ®è¡Œã€‚ä¸è¿‡ç†è®ºä¸Šï¼Œè¿™ä¼šå¯¼è‡´å¦ä¸€ä¸ªæ£˜æ‰‹çš„é—®é¢˜ï¼šå¹»è¯» ï¼ˆPhantom Readï¼‰ã€‚ç®€å•çš„è¯´ï¼Œå¹»è¯»æŒ‡å½“ç”¨æˆ·è¯»å–æŸä¸€èŒƒå›´çš„æ•°æ®è¡Œæ—¶ï¼Œå¦ä¸€ä¸ªäº‹åŠ¡åˆåœ¨è¯¥èŒƒå›´å†…æ’å…¥äº†æ–°è¡Œï¼Œå½“ç”¨æˆ·å†è¯»å–è¯¥èŒƒå›´çš„æ•°æ®è¡Œæ—¶ï¼Œä¼šå‘ç°æœ‰æ–°çš„â€œå¹»å½±â€ è¡Œã€‚InnoDBå’ŒFalconå­˜å‚¨å¼•æ“é€šè¿‡å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼ˆMVCCï¼ŒMultiversion Concurrency Controlï¼‰æœºåˆ¶è§£å†³äº†è¯¥é—®é¢˜ã€‚</p></li><li><p><strong>Serializableï¼ˆå¯ä¸²è¡ŒåŒ–ï¼‰</strong><br>è¿™æ˜¯æœ€é«˜çš„éš”ç¦»çº§åˆ«ï¼Œå®ƒé€šè¿‡å¼ºåˆ¶äº‹åŠ¡æ’åºï¼Œä½¿ä¹‹ä¸å¯èƒ½ç›¸äº’å†²çªï¼Œä»è€Œè§£å†³å¹»è¯»é—®é¢˜ã€‚ç®€è¨€ä¹‹ï¼Œå®ƒæ˜¯åœ¨æ¯ä¸ªè¯»çš„æ•°æ®è¡Œä¸ŠåŠ ä¸Šå…±äº«é”ã€‚åœ¨è¿™ä¸ªçº§åˆ«ï¼Œå¯èƒ½å¯¼è‡´å¤§é‡çš„è¶…æ—¶ç°è±¡å’Œé”ç«äº‰ã€‚</p></li></ul><h2 id="è„è¯»ã€ä¸å¯é‡å¤è¯»ã€å¹»è¯»"><a href="#è„è¯»ã€ä¸å¯é‡å¤è¯»ã€å¹»è¯»" class="headerlink" title="è„è¯»ã€ä¸å¯é‡å¤è¯»ã€å¹»è¯»"></a>è„è¯»ã€ä¸å¯é‡å¤è¯»ã€å¹»è¯»</h2><ol><li>è„è¯» ï¼šè¯»åˆ°äº†åˆ«çš„äº‹åŠ¡å°šæœªæäº¤ï¼ˆcommitï¼‰çš„å˜æ›´ï¼Œåˆ«äººæ²¡æäº¤ï¼Œæˆ‘è¯»åˆ°äº†ã€‚</li><li>ä¸å¯é‡å¤è¯» ï¼šåˆ«çš„äº‹åŠ¡æäº¤äº†å˜æ›´ï¼Œè¢«å½“å‰äº‹åŠ¡è¯»åˆ°äº†ã€‚ç„¶åå¯¼è‡´æœ¬äº‹åŠ¡å¤šæ¬¡selectçš„ç»“æœä¸ä¸€æ ·ï¼Œè¯»åˆ°äº†åˆ«çš„äº‹åŠ¡æäº¤çš„å†…å®¹ã€‚</li><li>å¹»è¯» : åˆ«çš„äº‹åŠ¡æäº¤äº†å˜æ›´ï¼Œè¢«å½“å‰äº‹åŠ¡è¯»åˆ°äº†ã€‚ç„¶åå¯¼è‡´æœ¬äº‹åŠ¡å¤šæ¬¡selectçš„ç»“æœä¸ä¸€æ ·ï¼Œè¯»åˆ°äº†åˆ«çš„äº‹åŠ¡æäº¤çš„å†…å®¹ã€‚æ³¨æ„è¿™é‡Œç‰¹æŒ‡(insert)æ’å…¥çš„æ•°æ®ã€‚</li></ol><p class="note note-primary">è¿™é‡Œåªæœ‰å¹»è¯»ç†è§£èµ·æ¥æœ‰äº›ç»• ç®€å•æ¥è®²å°±æ˜¯åŒä¸€ä¸ªäº‹ç‰©ä¸­è¿ç»­æ‰§è¡Œä¸¤æ¬¡åŒæ ·çš„sqlè¯­å¥ï¼Œå¯èƒ½å¯¼è‡´ä¸åŒçš„ç»“æœé—®é¢˜ï¼Œç¬¬äºŒæ¬¡sqlè¯­å¥å¯èƒ½è¿”å›ä¹‹å‰ä¸å­˜åœ¨çš„è¡Œ</p><h2 id="ä¸åŒéš”ç¦»çº§åˆ«å¯¹åº”å¯èƒ½å‡ºç°é—®é¢˜"><a href="#ä¸åŒéš”ç¦»çº§åˆ«å¯¹åº”å¯èƒ½å‡ºç°é—®é¢˜" class="headerlink" title="ä¸åŒéš”ç¦»çº§åˆ«å¯¹åº”å¯èƒ½å‡ºç°é—®é¢˜"></a>ä¸åŒéš”ç¦»çº§åˆ«å¯¹åº”å¯èƒ½å‡ºç°é—®é¢˜</h2><table><thead><tr><th>éš”ç¦»çº§åˆ«</th><th>è„è¯»</th><th>ä¸å¯é‡å¤è¯»</th><th>å¹»è¯»</th></tr></thead><tbody><tr><td>Read Uncommitted</td><td>Y</td><td>Y</td><td>Y</td></tr><tr><td>Read Committed</td><td>N</td><td>Y</td><td>Y</td></tr><tr><td>Repeatable Read</td><td>N</td><td>N</td><td>Y</td></tr><tr><td>Serializable</td><td>N</td><td>N</td><td>N</td></tr></tbody></table>]]></content>
    
    
    <categories>
      
      <category>å­˜å‚¨</category>
      
    </categories>
    
    
    <tags>
      
      <tag>mysql</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>docker-composeæ­å»ºMySqlä¸»ä»å’ŒåŒä¸»</title>
    <link href="/2021/08/23/docker-compose%E6%90%AD%E5%BB%BAMySql%E4%B8%BB%E4%BB%8E%E5%92%8C%E5%8F%8C%E4%B8%BB/"/>
    <url>/2021/08/23/docker-compose%E6%90%AD%E5%BB%BAMySql%E4%B8%BB%E4%BB%8E%E5%92%8C%E5%8F%8C%E4%B8%BB/</url>
    
    <content type="html"><![CDATA[<p class="note note-primary">ç›¸ä¿¡mysqlçš„binlogéƒ½ä¸é™Œç”Ÿ</br>binlogçš„ä¸»è¦ä½œç”¨å°±æ˜¯è¿›è¡Œæ•°æ®åŒæ­¥ï¼Œä»Šå¤©æˆ‘ä»¬ä»æ•°æ®åŒæ­¥çš„è§’åº¦æ­ä¸€ä¸‹mysqlçš„ä¸»ä»/åŒä¸»ã€‚</p><h2 id="base"><a href="#base" class="headerlink" title="base"></a>base</h2><p>ä»¥ä¸‹åŸºäºmysql5.7</p><h2 id="ç®€å•äº†è§£ä¸‹binlog"><a href="#ç®€å•äº†è§£ä¸‹binlog" class="headerlink" title="ç®€å•äº†è§£ä¸‹binlog"></a>ç®€å•äº†è§£ä¸‹binlog</h2><ul><li><p>binlogæ˜¯è®°å½•æ‰€æœ‰æ•°æ®åº“è¡¨ç»“æ„å˜æ›´ï¼ˆä¾‹å¦‚CREATEã€ALTER TABLEâ€¦ï¼‰ä»¥åŠè¡¨æ•°æ®ä¿®æ”¹ï¼ˆINSERTã€UPDATEã€DELETEâ€¦ï¼‰çš„äºŒè¿›åˆ¶æ—¥å¿—ã€‚</p></li><li><p>binlogæ—¥å¿—åŒ…æ‹¬ä¸¤ç±»æ–‡ä»¶ï¼šäºŒè¿›åˆ¶æ—¥å¿—ç´¢å¼•æ–‡ä»¶ï¼ˆæ–‡ä»¶ååç¼€ä¸º.indexï¼‰ç”¨äºè®°å½•æ‰€æœ‰çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼ŒäºŒè¿›åˆ¶æ—¥å¿—æ–‡ä»¶ï¼ˆæ–‡ä»¶ååç¼€ä¸º.00000*ï¼‰è®°å½•æ•°æ®åº“æ‰€æœ‰çš„DDLå’ŒDML(é™¤äº†æ•°æ®æŸ¥è¯¢è¯­å¥)è¯­å¥äº‹ä»¶ã€‚</p></li><li><p>binlogæœ‰ä¸‰ç§æ ¼å¼ï¼šstatementåŸºäºsqlè¯­å¥å¤åˆ¶ã€rowåŸºäºè¡Œæ•°æ®å˜æ›´çš„å¤åˆ¶ã€mixedæ··åˆå‰ä¸¤ç§æ ¼å¼çš„å¤åˆ¶ã€‚</p></li></ul><h2 id="æ­å»ºä¸»ä»ç»“æ„"><a href="#æ­å»ºä¸»ä»ç»“æ„" class="headerlink" title="æ­å»ºä¸»ä»ç»“æ„"></a>æ­å»ºä¸»ä»ç»“æ„</h2><p><img src="/img/mysql/mysql-m-s.png" alt="mysqlä¸»ä»æ¶æ„"></p><h3 id="åˆ›å»ºdocker-compose"><a href="#åˆ›å»ºdocker-compose" class="headerlink" title="åˆ›å»ºdocker-compose"></a>åˆ›å»ºdocker-compose</h3><figure class="highlight yml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yml"><span class="hljs-attr">version:</span> <span class="hljs-string">&#x27;3.8&#x27;</span><br><span class="hljs-attr">services:</span><br>  <span class="hljs-attr">mysql-master:</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">mysql-master</span> <br>    <span class="hljs-attr">image:</span> <span class="hljs-string">mysql:5.7.31</span><br>    <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-number">13306</span><span class="hljs-string">:3306</span> <br>    <span class="hljs-attr">privileged:</span> <span class="hljs-literal">true</span><br>    <span class="hljs-attr">volumes:</span><br>      <span class="hljs-comment"># è¿™ä¸ªåªå¯¹mysqlä¸»ä»è¿›è¡ŒéªŒè¯ æ²¡æœ‰æŒä¹…åŒ–é…ç½®ä»¥åŠæ—¥å¿—ç›¸å…³çš„æ˜ å°„</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">$PWD/master/conf/my.cnf:/etc/mysql/my.cnf</span><br>    <span class="hljs-attr">environment:</span><br>      <span class="hljs-attr">MYSQL_ROOT_PASSWORD:</span> <span class="hljs-string">&quot;123456&quot;</span><br>    <span class="hljs-attr">command:</span> [<br>        <span class="hljs-string">&#x27;--character-set-server=utf8mb4&#x27;</span>,<br>        <span class="hljs-string">&#x27;--collation-server=utf8mb4_general_ci&#x27;</span>,<br>        <span class="hljs-string">&#x27;--max_connections=3000&#x27;</span><br>    ]<br>    <span class="hljs-attr">networks:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">myweb</span><br>      <br>  <span class="hljs-attr">mysql-slave:</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">mysql-slave</span> <br>    <span class="hljs-attr">image:</span> <span class="hljs-string">mysql:5.7.31</span><br>    <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-number">23306</span><span class="hljs-string">:3306</span> <br>    <span class="hljs-attr">privileged:</span> <span class="hljs-literal">true</span><br>    <span class="hljs-attr">volumes:</span><br>      <span class="hljs-comment"># è¿™ä¸ªåªå¯¹mysqlä¸»ä»è¿›è¡ŒéªŒè¯ æ²¡æœ‰æŒä¹…åŒ–é…ç½®ä»¥åŠæ—¥å¿—ç›¸å…³çš„æ˜ å°„</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">$PWD/slave/conf/my.cnf:/etc/mysql/my.cnf</span><br>    <span class="hljs-attr">environment:</span><br>      <span class="hljs-attr">MYSQL_ROOT_PASSWORD:</span> <span class="hljs-string">&quot;123456&quot;</span><br>    <span class="hljs-attr">command:</span> [<br>        <span class="hljs-string">&#x27;--character-set-server=utf8mb4&#x27;</span>,<br>        <span class="hljs-string">&#x27;--collation-server=utf8mb4_general_ci&#x27;</span>,<br>        <span class="hljs-string">&#x27;--max_connections=3000&#x27;</span><br>    ]<br>    <span class="hljs-attr">networks:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">myweb</span>    <br><br><span class="hljs-attr">networks:</span><br>  <span class="hljs-attr">myweb:</span><br>    <span class="hljs-attr">driver:</span> <span class="hljs-string">bridge</span><br></code></pre></div></td></tr></table></figure><h3 id="åˆ›å»ºé…ç½®æ–‡ä»¶"><a href="#åˆ›å»ºé…ç½®æ–‡ä»¶" class="headerlink" title="åˆ›å»ºé…ç½®æ–‡ä»¶"></a>åˆ›å»ºé…ç½®æ–‡ä»¶</h3><h4 id="é…ç½®æ–‡ä»¶ç›®å½•ç»“æ„"><a href="#é…ç½®æ–‡ä»¶ç›®å½•ç»“æ„" class="headerlink" title="é…ç½®æ–‡ä»¶ç›®å½•ç»“æ„"></a>é…ç½®æ–‡ä»¶ç›®å½•ç»“æ„</h4><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">[root@xxx MySQLM-S]<span class="hljs-comment"># tree</span><br>.<br>â”œâ”€â”€ docker-compose.yaml<br>â”œâ”€â”€ master<br>â”‚Â Â  â””â”€â”€ conf<br>â”‚Â Â      â””â”€â”€ my.cnf<br>â””â”€â”€ slave<br>    â””â”€â”€ conf<br>        â””â”€â”€ my.cnf<br></code></pre></div></td></tr></table></figure><h4 id="master-conf-my-cnf-é…ç½®æ–‡ä»¶"><a href="#master-conf-my-cnf-é…ç½®æ–‡ä»¶" class="headerlink" title="master/conf/my.cnf é…ç½®æ–‡ä»¶"></a>master/conf/my.cnf é…ç½®æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">[mysqld]<br><span class="hljs-comment"># [å¿…é¡»]æœåŠ¡å™¨å”¯ä¸€IDï¼Œé»˜è®¤æ˜¯1ï¼Œä¸€èˆ¬å–IPæœ€åä¸€æ®µ</span><br>server-id=1<br><br><br><span class="hljs-comment"># ###################################################</span><br><span class="hljs-comment"># å¦‚æœå½“å‰å®ä¾‹æ—¢åšä¸»åº“åˆåšä»åº“æ¬¡é€‰çº¿å¿…é¡»å¼€å¯</span><br><span class="hljs-comment"># log-slave-updates = true </span><br><br><span class="hljs-comment"># è‡ªå¢é•¿ID</span><br><span class="hljs-comment"># ç‰¹æ®Šè¯´æ˜ å½“è¯¥å®ä¾‹ä¸ºåŒä¸»çš„æ¶æ„æ—¶è¦ç‰¹æ®Šé…ç½® ä»¥é¿å…è‡ªå¢idå†²çªçš„é—®é¢˜</span><br><span class="hljs-comment"># auto_increment_offset = 1</span><br><span class="hljs-comment"># auto_increment_increment = 2  </span><br><span class="hljs-comment"># ####################################################</span><br><br><br><span class="hljs-comment"># [å¿…é¡»]å¯ç”¨äºŒè¿›åˆ¶æ—¥å¿—</span><br>log-bin=mysql-bin <br><br><span class="hljs-comment"># å¤åˆ¶è¿‡æ»¤ï¼šä¹Ÿå°±æ˜¯æŒ‡å®šå“ªä¸ªæ•°æ®åº“ä¸ç”¨åŒæ­¥ï¼ˆmysqlåº“ä¸€èˆ¬ä¸åŒæ­¥ï¼‰</span><br>binlog-ignore-db=mysql<br><br><span class="hljs-comment"># ç¡®ä¿binlogæ—¥å¿—å†™å…¥åä¸ç¡¬ç›˜åŒæ­¥</span><br>sync_binlog = 1<br><br><span class="hljs-comment"># è®¾ç½®éœ€è¦åŒæ­¥çš„æ•°æ®åº“ binlog_do_db = æ•°æ®åº“åï¼› </span><br><span class="hljs-comment"># å¦‚æœæ˜¯å¤šä¸ªåŒæ­¥åº“ï¼Œå°±ä»¥æ­¤æ ¼å¼å¦å†™å‡ è¡Œå³å¯ã€‚</span><br><span class="hljs-comment"># å¦‚æœä¸æŒ‡æ˜å¯¹æŸä¸ªå…·ä½“åº“åŒæ­¥ï¼Œè¡¨ç¤ºåŒæ­¥æ‰€æœ‰åº“ã€‚é™¤äº†binlog-ignore-dbè®¾ç½®çš„å¿½ç•¥çš„åº“</span><br><span class="hljs-comment"># binlog_do_db = test #éœ€è¦åŒæ­¥testæ•°æ®åº“ã€‚</span><br><br><span class="hljs-comment"># è®¾ç½®éœ€è¦åŒæ­¥çš„æ•°æ®åº“ï¼Œä¸»æœåŠ¡å™¨ä¸Šä¸é™å®šæ•°æ®åº“ï¼Œåœ¨ä»æœåŠ¡å™¨ä¸Šé™å®šreplicate-do-db = æ•°æ®åº“åï¼›</span><br><span class="hljs-comment"># å¦‚æœä¸æŒ‡æ˜åŒæ­¥å“ªäº›åº“ï¼Œå°±å»æ‰è¿™è¡Œï¼Œè¡¨ç¤ºæ‰€æœ‰åº“çš„åŒæ­¥ï¼ˆé™¤äº†ignoreå¿½ç•¥çš„åº“ï¼‰ã€‚</span><br><span class="hljs-comment"># replicate-do-db = testï¼›</span><br><br><span class="hljs-comment"># è·³è¿‡æ‰€æœ‰çš„é”™è¯¯ï¼Œç»§ç»­æ‰§è¡Œå¤åˆ¶æ“ä½œ</span><br>slave-skip-errors = all  <br></code></pre></div></td></tr></table></figure><h4 id="slave-conf-my-cnf-é…ç½®æ–‡ä»¶"><a href="#slave-conf-my-cnf-é…ç½®æ–‡ä»¶" class="headerlink" title="slave/conf/my.cnf é…ç½®æ–‡ä»¶"></a>slave/conf/my.cnf é…ç½®æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">[mysqld]<br><span class="hljs-comment"># [å¿…é¡»]æœåŠ¡å™¨å”¯ä¸€IDï¼Œé»˜è®¤æ˜¯1ï¼Œä¸€èˆ¬å–IPæœ€åä¸€æ®µ  </span><br>server-id=2<br><br><br><span class="hljs-comment"># ###################################################</span><br><span class="hljs-comment"># å¦‚æœå½“å‰å®ä¾‹æ—¢åšä¸»åº“åˆåšä»åº“æ¬¡é€‰çº¿å¿…é¡»å¼€å¯</span><br><span class="hljs-comment"># log-slave-updates = true </span><br><br><span class="hljs-comment"># è‡ªå¢é•¿ID</span><br><span class="hljs-comment"># ç‰¹æ®Šè¯´æ˜ å½“è¯¥å®ä¾‹ä¸ºåŒä¸»çš„æ¶æ„æ—¶è¦ç‰¹æ®Šé…ç½® ä»¥é¿å…è‡ªå¢idå†²çªçš„é—®é¢˜</span><br><span class="hljs-comment"># auto_increment_offset = 2</span><br><span class="hljs-comment"># auto_increment_increment = 2  </span><br><span class="hljs-comment"># ####################################################</span><br><br><span class="hljs-comment"># [å¿…é¡»]å¯ç”¨äºŒè¿›åˆ¶æ—¥å¿—</span><br>log-bin=mysql-bin <br><br><span class="hljs-comment"># å¤åˆ¶è¿‡æ»¤ï¼šä¹Ÿå°±æ˜¯æŒ‡å®šå“ªä¸ªæ•°æ®åº“ä¸ç”¨åŒæ­¥ï¼ˆmysqlåº“ä¸€èˆ¬ä¸åŒæ­¥ï¼‰</span><br>binlog-ignore-db=mysql<br><br><span class="hljs-comment"># ç¡®ä¿binlogæ—¥å¿—å†™å…¥åä¸ç¡¬ç›˜åŒæ­¥</span><br><span class="hljs-comment"># sync_binlog = 1</span><br><br><span class="hljs-comment"># è®¾ç½®éœ€è¦åŒæ­¥çš„æ•°æ®åº“ binlog_do_db = æ•°æ®åº“åï¼› </span><br><span class="hljs-comment"># å¦‚æœæ˜¯å¤šä¸ªåŒæ­¥åº“ï¼Œå°±ä»¥æ­¤æ ¼å¼å¦å†™å‡ è¡Œå³å¯ã€‚</span><br><span class="hljs-comment"># å¦‚æœä¸æŒ‡æ˜å¯¹æŸä¸ªå…·ä½“åº“åŒæ­¥ï¼Œè¡¨ç¤ºåŒæ­¥æ‰€æœ‰åº“ã€‚é™¤äº†binlog-ignore-dbè®¾ç½®çš„å¿½ç•¥çš„åº“</span><br><span class="hljs-comment"># binlog_do_db = test #éœ€è¦åŒæ­¥testæ•°æ®åº“ã€‚</span><br><br><span class="hljs-comment"># è®¾ç½®éœ€è¦åŒæ­¥çš„æ•°æ®åº“ï¼Œä¸»æœåŠ¡å™¨ä¸Šä¸é™å®šæ•°æ®åº“ï¼Œåœ¨ä»æœåŠ¡å™¨ä¸Šé™å®šreplicate-do-db = æ•°æ®åº“åï¼›</span><br><span class="hljs-comment"># å¦‚æœä¸æŒ‡æ˜åŒæ­¥å“ªäº›åº“ï¼Œå°±å»æ‰è¿™è¡Œï¼Œè¡¨ç¤ºæ‰€æœ‰åº“çš„åŒæ­¥ï¼ˆé™¤äº†ignoreå¿½ç•¥çš„åº“ï¼‰ã€‚</span><br><span class="hljs-comment"># replicate-do-db = testï¼›</span><br><br><span class="hljs-comment"># è·³è¿‡æ‰€æœ‰çš„é”™è¯¯ï¼Œç»§ç»­æ‰§è¡Œå¤åˆ¶æ“ä½œ</span><br>slave-skip-errors = all <br></code></pre></div></td></tr></table></figure><h3 id="å¯åŠ¨docker-composeå¹¶é…ç½®ä¸»ä»å…³ç³»"><a href="#å¯åŠ¨docker-composeå¹¶é…ç½®ä¸»ä»å…³ç³»" class="headerlink" title="å¯åŠ¨docker-composeå¹¶é…ç½®ä¸»ä»å…³ç³»"></a>å¯åŠ¨docker-composeå¹¶é…ç½®ä¸»ä»å…³ç³»</h3><h4 id="å¯åŠ¨"><a href="#å¯åŠ¨" class="headerlink" title="å¯åŠ¨"></a>å¯åŠ¨</h4><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">docker-compose up -d <br></code></pre></div></td></tr></table></figure><h4 id="è¿›å…¥masteré…ç½®åŒæ­¥è´¦å·å’Œæƒé™"><a href="#è¿›å…¥masteré…ç½®åŒæ­¥è´¦å·å’Œæƒé™" class="headerlink" title="è¿›å…¥masteré…ç½®åŒæ­¥è´¦å·å’Œæƒé™"></a>è¿›å…¥masteré…ç½®åŒæ­¥è´¦å·å’Œæƒé™</h4><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">docker-compose <span class="hljs-built_in">exec</span> mysql-slave bash<br><br>mysql -uroot -p123455<br><br><span class="hljs-comment"># æŸ¥çœ‹é…ç½®çš„æœåŠ¡ID</span><br>mysql&gt; show variables like <span class="hljs-string">&#x27;%server_id%&#x27;</span>;<br>+----------------+-------+<br>| Variable_name  | Value |<br>+----------------+-------+<br>| server_id      | 1     |<br>| server_id_bits | 32    |<br>+----------------+-------+<br><br><span class="hljs-comment"># çœ‹masterä¿¡æ¯ File å’Œ Position ä»æœåŠ¡ä¸Šè¦ç”¨</span><br>mysql&gt; show master status;<br>+------------------+----------+--------------+------------------+-------------------+<br>| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |<br>+------------------+----------+--------------+------------------+-------------------+<br>| mysql-bin.000004 |      154 |              | mysql            |                   |<br>+------------------+----------+--------------+------------------+-------------------+<br><br><span class="hljs-comment"># åˆ›å»ºåŒæ­¥è´¦æˆ·å¹¶å¼€å¯æƒé™</span><br>mysql&gt; grant replication slave,replication client on *.* to <span class="hljs-string">&#x27;slave&#x27;</span>@<span class="hljs-string">&#x27;%&#x27;</span> identified by <span class="hljs-string">&quot;123456&quot;</span>;<br>mysql&gt; flush privileges;<br></code></pre></div></td></tr></table></figure><h4 id="è¿›å…¥slaveæœåŠ¡é…ç½®"><a href="#è¿›å…¥slaveæœåŠ¡é…ç½®" class="headerlink" title="è¿›å…¥slaveæœåŠ¡é…ç½®"></a>è¿›å…¥slaveæœåŠ¡é…ç½®</h4><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">docker-compose <span class="hljs-built_in">exec</span> docker-slave bash<br><br>mysql -uroot -p123456<br><br><span class="hljs-comment">#æŸ¥çœ‹server_idæ˜¯å¦ç”Ÿæ•ˆ</span><br>mysql&gt; show variables like <span class="hljs-string">&#x27;%server_id%&#x27;</span>;<br>+----------------+-------+<br>| Variable_name  | Value |<br>+----------------+-------+<br>| server_id      | 2     |<br>| server_id_bits | 32    |<br>+----------------+-------+<br><br><span class="hljs-comment"># è¿æ¥ä¸»mysqlæœåŠ¡ master_log_file å’Œ master_log_posçš„å€¼è¦å¡«å†™ä¸»masteré‡ŒæŸ¥å‡ºæ¥çš„å€¼ æ³¨æ„è¿™é‡Œä½¿ç”¨çš„docker-compose å†…éƒ¨æœåŠ¡çš„ç«¯å£å’Œip</span><br>mysql&gt; change master to master_host=<span class="hljs-string">&#x27;mysql-master&#x27;</span>,master_user=<span class="hljs-string">&#x27;slave&#x27;</span>,master_password=<span class="hljs-string">&#x27;123456&#x27;</span>,master_port=3306,master_log_file=<span class="hljs-string">&#x27;mysql-bin.000004&#x27;</span>, master_log_pos=154,master_connect_retry=30;<br><br><br><span class="hljs-comment"># å¼€å¯slave</span><br><br>mysql&gt; start slave;<br><br>mysql&gt; show slave status \G<br>*************************** 1. row ***************************<br>               Slave_IO_State: Waiting <span class="hljs-keyword">for</span> master to send event<br>                  Master_Host: mysql-master<br>                  Master_User: slave<br>                  Master_Port: 3306<br>                Connect_Retry: 30<br>              Master_Log_File: mysql-bin.000004<br>          Read_Master_Log_Pos: 778<br>               Relay_Log_File: af5556aff9be-relay-bin.000002<br>                Relay_Log_Pos: 944<br>        Relay_Master_Log_File: mysql-bin.000004<br>             Slave_IO_Running: Yes<br>            Slave_SQL_Running: Yes<br>              Replicate_Do_DB: <br>          Replicate_Ignore_DB: mysql<br>           Replicate_Do_Table: <br>       Replicate_Ignore_Table: <br>      Replicate_Wild_Do_Table: <br>  Replicate_Wild_Ignore_Table: <br>                   Last_Errno: 0<br>                   Last_Error: <br>                 Skip_Counter: 0<br>          Exec_Master_Log_Pos: 778<br>              Relay_Log_Space: 1158<br>              Until_Condition: None<br>               Until_Log_File: <br>                Until_Log_Pos: 0<br>           Master_SSL_Allowed: No<br>           Master_SSL_CA_File: <br>           Master_SSL_CA_Path: <br>              Master_SSL_Cert: <br>            Master_SSL_Cipher: <br>               Master_SSL_Key: <br>        Seconds_Behind_Master: 0<br>Master_SSL_Verify_Server_Cert: No<br>                Last_IO_Errno: 0<br>                Last_IO_Error: <br>               Last_SQL_Errno: 0<br>               Last_SQL_Error: <br>  Replicate_Ignore_Server_Ids: <br>             Master_Server_Id: 1<br>                  Master_UUID: 466c4a60-03f4-11ec-a1a1-0242ac160002<br>             Master_Info_File: /var/lib/mysql/master.info<br>                    SQL_Delay: 0<br>          SQL_Remaining_Delay: NULL<br>      Slave_SQL_Running_State: Slave has <span class="hljs-built_in">read</span> all relay <span class="hljs-built_in">log</span>; waiting <span class="hljs-keyword">for</span> more updates<br>           Master_Retry_Count: 86400<br>                  Master_Bind: <br>      Last_IO_Error_Timestamp: <br>     Last_SQL_Error_Timestamp: <br>               Master_SSL_Crl: <br>           Master_SSL_Crlpath: <br>           Retrieved_Gtid_Set: <br>            Executed_Gtid_Set: <br>                Auto_Position: 0<br>         Replicate_Rewrite_DB: <br>                 Channel_Name: <br>           Master_TLS_Version: <br><br></code></pre></div></td></tr></table></figure><p class="note note-success"> ä¸Šé¢çœ‹åˆ° Slave_IO_Running: Yesï¼ŒSlave_SQL_Running: Yes è¡¨ç¤ºå·²ç»æˆåŠŸå¼€å¯ä¸»ä»</p><p>è¿æ¥ä¸»mysqlå‚æ•°è¯´æ˜ï¼š</p><p><strong>master_port</strong>ï¼šMasterçš„ç«¯å£å·ï¼ŒæŒ‡çš„æ˜¯å®¹å™¨çš„ç«¯å£å·</p><p><strong>master_user</strong>ï¼šç”¨äºæ•°æ®åŒæ­¥çš„ç”¨æˆ·</p><p><strong>master_password</strong>ï¼šç”¨äºåŒæ­¥çš„ç”¨æˆ·çš„å¯†ç </p><p><strong>master_log_file</strong>ï¼šæŒ‡å®š Slave ä»å“ªä¸ªæ—¥å¿—æ–‡ä»¶å¼€å§‹å¤åˆ¶æ•°æ®ï¼Œå³ä¸Šæ–‡ä¸­æåˆ°çš„ File å­—æ®µçš„å€¼</p><p><strong>master_log_pos</strong>ï¼šä»å“ªä¸ª Position å¼€å§‹è¯»ï¼Œå³ä¸Šæ–‡ä¸­æåˆ°çš„ Position å­—æ®µçš„å€¼</p><p><strong>master_connect_retry</strong>ï¼šå¦‚æœè¿æ¥å¤±è´¥ï¼Œé‡è¯•çš„æ—¶é—´é—´éš”ï¼Œå•ä½æ˜¯ç§’ï¼Œé»˜è®¤æ˜¯60ç§’</p><h2 id="æ­å»ºåŒä¸»ç»“æ„"><a href="#æ­å»ºåŒä¸»ç»“æ„" class="headerlink" title="æ­å»ºåŒä¸»ç»“æ„"></a>æ­å»ºåŒä¸»ç»“æ„</h2><p>é€šè¿‡ä¸Šé¢ä¸»ä»ç»“æ„æˆ‘ä»¬å¯ä»¥æˆ‘ä»¬å¯ä»¥å¤§èƒ†è®¾æƒ³ï¼Œè¦æ˜¯ä¸¤ä¸ªæ•°æ®åº“çš„å®ä¾‹éƒ½é…ç½®å¯¹æ–¹ä¸ºmasterä¸å°±å®ç°çš„åŒä¸»ä¹ˆï¼Ÿäº‹å®å´æ˜¯å¦‚æ­¤ï¼š</p><p>åŒä¸»ç»“æ„åªéœ€è¦å°†åŒæ–¹çš„é…ç½®æ–‡ä»¶æ³¨é‡Šæ‰çš„åœ°æ–¹å–æ¶ˆæ³¨é‡Šæ‰åˆ†åˆ«åœ¨ä¸¤å°æœåŠ¡å™¨ä¸Šåˆ›åŒæ­¥è´¦å·å’Œé…ç½®</p><h3 id="åˆ›å»ºdocker-composeæ–‡ä»¶ï¼ˆåŒä¸»ï¼‰"><a href="#åˆ›å»ºdocker-composeæ–‡ä»¶ï¼ˆåŒä¸»ï¼‰" class="headerlink" title="åˆ›å»ºdocker-composeæ–‡ä»¶ï¼ˆåŒä¸»ï¼‰"></a>åˆ›å»ºdocker-composeæ–‡ä»¶ï¼ˆåŒä¸»ï¼‰</h3><p>è¿™é‡Œåªæ›´æ”¹äº†docker-composeä¸­æœåŠ¡çš„åç§°</p><figure class="highlight yaml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">&#x27;3.8&#x27;</span><br><span class="hljs-attr">services:</span><br>  <span class="hljs-attr">mysql-m1:</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">mysql-m1</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">mysql:5.7.31</span><br>    <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-number">13306</span><span class="hljs-string">:3306</span> <br>    <span class="hljs-attr">privileged:</span> <span class="hljs-literal">true</span><br>    <span class="hljs-attr">volumes:</span><br>      <span class="hljs-comment"># è¿™ä¸ªåªå¯¹mysqlä¸»ä»è¿›è¡ŒéªŒè¯ æ²¡æœ‰æŒä¹…åŒ–é…ç½®ä»¥åŠæ—¥å¿—ç›¸å…³çš„æ˜ å°„</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">$PWD/m1/conf/my.cnf:/etc/mysql/my.cnf</span><br>    <span class="hljs-attr">environment:</span><br>      <span class="hljs-attr">MYSQL_ROOT_PASSWORD:</span> <span class="hljs-string">&quot;123456&quot;</span><br>    <span class="hljs-attr">command:</span> [<br>        <span class="hljs-string">&#x27;--character-set-server=utf8mb4&#x27;</span>,<br>        <span class="hljs-string">&#x27;--collation-server=utf8mb4_general_ci&#x27;</span>,<br>        <span class="hljs-string">&#x27;--max_connections=3000&#x27;</span><br>    ]<br>    <span class="hljs-attr">networks:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">myweb</span><br>      <br>  <span class="hljs-attr">mysql-m2:</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">mysql-m2</span> <br>    <span class="hljs-attr">image:</span> <span class="hljs-string">mysql:5.7.31</span><br>    <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-number">23306</span><span class="hljs-string">:3306</span> <br>    <span class="hljs-attr">privileged:</span> <span class="hljs-literal">true</span><br>    <span class="hljs-attr">volumes:</span><br>      <span class="hljs-comment"># è¿™ä¸ªåªå¯¹mysqlä¸»ä»è¿›è¡ŒéªŒè¯ æ²¡æœ‰æŒä¹…åŒ–é…ç½®ä»¥åŠæ—¥å¿—ç›¸å…³çš„æ˜ å°„</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">$PWD/m2/conf/my.cnf:/etc/mysql/my.cnf</span><br>    <span class="hljs-attr">environment:</span><br>      <span class="hljs-attr">MYSQL_ROOT_PASSWORD:</span> <span class="hljs-string">&quot;123456&quot;</span><br>    <span class="hljs-attr">command:</span> [<br>        <span class="hljs-string">&#x27;--character-set-server=utf8mb4&#x27;</span>,<br>        <span class="hljs-string">&#x27;--collation-server=utf8mb4_general_ci&#x27;</span>,<br>        <span class="hljs-string">&#x27;--max_connections=3000&#x27;</span><br>    ]<br>    <span class="hljs-attr">networks:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">myweb</span>    <br><br><span class="hljs-attr">networks:</span><br>  <span class="hljs-attr">myweb:</span><br>    <span class="hljs-attr">driver:</span> <span class="hljs-string">bridge</span><br></code></pre></div></td></tr></table></figure><h3 id="åˆ›å»ºé…ç½®æ–‡ä»¶-åŒä¸»"><a href="#åˆ›å»ºé…ç½®æ–‡ä»¶-åŒä¸»" class="headerlink" title="åˆ›å»ºé…ç½®æ–‡ä»¶(åŒä¸»)"></a>åˆ›å»ºé…ç½®æ–‡ä»¶(åŒä¸»)</h3><p>è¿™é‡Œåªæ˜¯å°†ä¸»ä»ä¸­çš„é…ç½®ä¸­æ³¨é‡Šæ‰çš„æœåŠ¡æ·»åŠ ä¸Š</p><h4 id="é…ç½®æ–‡ä»¶ç›®å½•ç»“æ„ï¼ˆåŒä¸»ï¼‰"><a href="#é…ç½®æ–‡ä»¶ç›®å½•ç»“æ„ï¼ˆåŒä¸»ï¼‰" class="headerlink" title="é…ç½®æ–‡ä»¶ç›®å½•ç»“æ„ï¼ˆåŒä¸»ï¼‰"></a>é…ç½®æ–‡ä»¶ç›®å½•ç»“æ„ï¼ˆåŒä¸»ï¼‰</h4><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">[root@xxx MySQLM-M]<span class="hljs-comment"># tree</span><br>.<br>â”œâ”€â”€ docker-compose.yaml<br>â”œâ”€â”€ m1<br>â”‚   â””â”€â”€ conf<br>â”‚       â””â”€â”€ my.cnf<br>â””â”€â”€ m2<br>    â””â”€â”€ conf<br>        â””â”€â”€ my.cnf<br></code></pre></div></td></tr></table></figure><h4 id="m1-conf-my-cnf"><a href="#m1-conf-my-cnf" class="headerlink" title="m1/conf/my.cnf"></a>m1/conf/my.cnf</h4><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">[mysqld]<br><span class="hljs-comment"># [å¿…é¡»]æœåŠ¡å™¨å”¯ä¸€IDï¼Œé»˜è®¤æ˜¯1ï¼Œä¸€èˆ¬å–IPæœ€åä¸€æ®µ</span><br>server-id=1<br><br><br><span class="hljs-comment"># ###################################################</span><br><span class="hljs-comment"># å¦‚æœå½“å‰å®ä¾‹æ—¢åšä¸»åº“åˆåšä»åº“æ¬¡é€‰çº¿å¿…é¡»å¼€å¯</span><br>log-slave-updates = <span class="hljs-literal">true</span> <br><br><span class="hljs-comment"># è‡ªå¢é•¿ID</span><br><span class="hljs-comment"># ç‰¹æ®Šè¯´æ˜ å½“è¯¥å®ä¾‹ä¸ºåŒä¸»çš„æ¶æ„æ—¶è¦ç‰¹æ®Šé…ç½® ä»¥é¿å…è‡ªå¢idå†²çªçš„é—®é¢˜</span><br>auto_increment_offset = 1<br>auto_increment_increment = 2  <br><span class="hljs-comment"># ####################################################</span><br><br><br><span class="hljs-comment"># [å¿…é¡»]å¯ç”¨äºŒè¿›åˆ¶æ—¥å¿—</span><br>log-bin=mysql-bin <br><br><span class="hljs-comment"># å¤åˆ¶è¿‡æ»¤ï¼šä¹Ÿå°±æ˜¯æŒ‡å®šå“ªä¸ªæ•°æ®åº“ä¸ç”¨åŒæ­¥ï¼ˆmysqlåº“ä¸€èˆ¬ä¸åŒæ­¥ï¼‰</span><br>binlog-ignore-db=mysql<br><br><span class="hljs-comment"># ç¡®ä¿binlogæ—¥å¿—å†™å…¥åä¸ç¡¬ç›˜åŒæ­¥</span><br>sync_binlog = 1<br><br><span class="hljs-comment"># è®¾ç½®éœ€è¦åŒæ­¥çš„æ•°æ®åº“ binlog_do_db = æ•°æ®åº“åï¼› </span><br><span class="hljs-comment"># å¦‚æœæ˜¯å¤šä¸ªåŒæ­¥åº“ï¼Œå°±ä»¥æ­¤æ ¼å¼å¦å†™å‡ è¡Œå³å¯ã€‚</span><br><span class="hljs-comment"># å¦‚æœä¸æŒ‡æ˜å¯¹æŸä¸ªå…·ä½“åº“åŒæ­¥ï¼Œè¡¨ç¤ºåŒæ­¥æ‰€æœ‰åº“ã€‚é™¤äº†binlog-ignore-dbè®¾ç½®çš„å¿½ç•¥çš„åº“</span><br><span class="hljs-comment"># binlog_do_db = test #éœ€è¦åŒæ­¥testæ•°æ®åº“ã€‚</span><br><br><span class="hljs-comment"># è®¾ç½®éœ€è¦åŒæ­¥çš„æ•°æ®åº“ï¼Œä¸»æœåŠ¡å™¨ä¸Šä¸é™å®šæ•°æ®åº“ï¼Œåœ¨ä»æœåŠ¡å™¨ä¸Šé™å®šreplicate-do-db = æ•°æ®åº“åï¼›</span><br><span class="hljs-comment"># å¦‚æœä¸æŒ‡æ˜åŒæ­¥å“ªäº›åº“ï¼Œå°±å»æ‰è¿™è¡Œï¼Œè¡¨ç¤ºæ‰€æœ‰åº“çš„åŒæ­¥ï¼ˆé™¤äº†ignoreå¿½ç•¥çš„åº“ï¼‰ã€‚</span><br><span class="hljs-comment"># replicate-do-db = testï¼›</span><br><br><span class="hljs-comment"># è·³è¿‡æ‰€æœ‰çš„é”™è¯¯ï¼Œç»§ç»­æ‰§è¡Œå¤åˆ¶æ“ä½œ</span><br>slave-skip-errors = all  <br></code></pre></div></td></tr></table></figure><h4 id="m2-conf-my-cnf"><a href="#m2-conf-my-cnf" class="headerlink" title="m2/conf/my.cnf"></a>m2/conf/my.cnf</h4><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">[mysqld]<br><span class="hljs-comment"># [å¿…é¡»]æœåŠ¡å™¨å”¯ä¸€IDï¼Œé»˜è®¤æ˜¯1ï¼Œä¸€èˆ¬å–IPæœ€åä¸€æ®µ  </span><br>server-id=2<br><br><br><span class="hljs-comment"># ###################################################</span><br><span class="hljs-comment"># å¦‚æœå½“å‰å®ä¾‹æ—¢åšä¸»åº“åˆåšä»åº“æ¬¡é€‰çº¿å¿…é¡»å¼€å¯</span><br>log-slave-updates = <span class="hljs-literal">true</span> <br><br><span class="hljs-comment"># è‡ªå¢é•¿ID</span><br><span class="hljs-comment"># ç‰¹æ®Šè¯´æ˜ å½“è¯¥å®ä¾‹ä¸ºåŒä¸»çš„æ¶æ„æ—¶è¦ç‰¹æ®Šé…ç½® ä»¥é¿å…è‡ªå¢idå†²çªçš„é—®é¢˜</span><br>auto_increment_offset = 2<br>auto_increment_increment = 2  <br><span class="hljs-comment"># ####################################################</span><br><br><span class="hljs-comment"># [å¿…é¡»]å¯ç”¨äºŒè¿›åˆ¶æ—¥å¿—</span><br>log-bin=mysql-bin <br><br><span class="hljs-comment"># å¤åˆ¶è¿‡æ»¤ï¼šä¹Ÿå°±æ˜¯æŒ‡å®šå“ªä¸ªæ•°æ®åº“ä¸ç”¨åŒæ­¥ï¼ˆmysqlåº“ä¸€èˆ¬ä¸åŒæ­¥ï¼‰</span><br>binlog-ignore-db=mysql<br><br><span class="hljs-comment"># ç¡®ä¿binlogæ—¥å¿—å†™å…¥åä¸ç¡¬ç›˜åŒæ­¥</span><br>sync_binlog = 1<br><br><span class="hljs-comment"># è®¾ç½®éœ€è¦åŒæ­¥çš„æ•°æ®åº“ binlog_do_db = æ•°æ®åº“åï¼› </span><br><span class="hljs-comment"># å¦‚æœæ˜¯å¤šä¸ªåŒæ­¥åº“ï¼Œå°±ä»¥æ­¤æ ¼å¼å¦å†™å‡ è¡Œå³å¯ã€‚</span><br><span class="hljs-comment"># å¦‚æœä¸æŒ‡æ˜å¯¹æŸä¸ªå…·ä½“åº“åŒæ­¥ï¼Œè¡¨ç¤ºåŒæ­¥æ‰€æœ‰åº“ã€‚é™¤äº†binlog-ignore-dbè®¾ç½®çš„å¿½ç•¥çš„åº“</span><br><span class="hljs-comment"># binlog_do_db = test #éœ€è¦åŒæ­¥testæ•°æ®åº“ã€‚</span><br><br><span class="hljs-comment"># è®¾ç½®éœ€è¦åŒæ­¥çš„æ•°æ®åº“ï¼Œä¸»æœåŠ¡å™¨ä¸Šä¸é™å®šæ•°æ®åº“ï¼Œåœ¨ä»æœåŠ¡å™¨ä¸Šé™å®šreplicate-do-db = æ•°æ®åº“åï¼›</span><br><span class="hljs-comment"># å¦‚æœä¸æŒ‡æ˜åŒæ­¥å“ªäº›åº“ï¼Œå°±å»æ‰è¿™è¡Œï¼Œè¡¨ç¤ºæ‰€æœ‰åº“çš„åŒæ­¥ï¼ˆé™¤äº†ignoreå¿½ç•¥çš„åº“ï¼‰ã€‚</span><br><span class="hljs-comment"># replicate-do-db = testï¼›</span><br><br><span class="hljs-comment"># è·³è¿‡æ‰€æœ‰çš„é”™è¯¯ï¼Œç»§ç»­æ‰§è¡Œå¤åˆ¶æ“ä½œ</span><br>slave-skip-errors = all <br></code></pre></div></td></tr></table></figure><h3 id="å¯åŠ¨docker-composeå¹¶é…ç½®m1å’Œm2çš„åŒä¸»"><a href="#å¯åŠ¨docker-composeå¹¶é…ç½®m1å’Œm2çš„åŒä¸»" class="headerlink" title="å¯åŠ¨docker-composeå¹¶é…ç½®m1å’Œm2çš„åŒä¸»"></a>å¯åŠ¨docker-composeå¹¶é…ç½®m1å’Œm2çš„åŒä¸»</h3><h4 id="å¯åŠ¨ï¼ˆåŒä¸»ï¼‰"><a href="#å¯åŠ¨ï¼ˆåŒä¸»ï¼‰" class="headerlink" title="å¯åŠ¨ï¼ˆåŒä¸»ï¼‰"></a>å¯åŠ¨ï¼ˆåŒä¸»ï¼‰</h4><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">docker-compose up -d <br></code></pre></div></td></tr></table></figure><p>è¿›å…¥m1å’Œm2ä¸‹æ‰§è¡Œä¸‹åˆ—å‘½ä»¤æ¥è·å–å„è‡ªçš„master status å’ŒåŒæ­¥è´¦å·</p><p>m1:</p><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">docker-compose <span class="hljs-built_in">exec</span> mysql-m1 bash<br><br>mysql -uroot -p123456<br><br><span class="hljs-comment"># æŸ¥çœ‹m1 Fileå’ŒPosition</span><br>mysql&gt; show master status;<br>+------------------+----------+--------------+------------------+-------------------+<br>| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |<br>+------------------+----------+--------------+------------------+-------------------+<br>| mysql-bin.000005 |      154 |              | mysql            |                   |<br>+------------------+----------+--------------+------------------+-------------------+<br><br><span class="hljs-comment"># åˆ›å»ºåŒæ­¥è´¦å·</span><br>mysql&gt; grant replication slave,replication client on *.* to <span class="hljs-string">&#x27;slave&#x27;</span>@<span class="hljs-string">&#x27;%&#x27;</span> identified by <span class="hljs-string">&quot;123456&quot;</span>;<br>mysql&gt; flush privileges;<br><br></code></pre></div></td></tr></table></figure><p>m2:</p><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">docker-compose <span class="hljs-built_in">exec</span> mysql-m1 bash<br><br>mysql -uroot -p123456<br><br><span class="hljs-comment"># æŸ¥çœ‹m2 Fileå’ŒPosition</span><br>mysql&gt; show master status;<br>+------------------+----------+--------------+------------------+-------------------+<br>| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |<br>+------------------+----------+--------------+------------------+-------------------+<br>| mysql-bin.000005 |      154 |              | mysql            |                   |<br>+------------------+----------+--------------+------------------+-------------------+<br><br><span class="hljs-comment"># åˆ›å»ºåŒæ­¥è´¦å·</span><br>mysql&gt; grant replication slave,replication client on *.* to <span class="hljs-string">&#x27;slave&#x27;</span>@<span class="hljs-string">&#x27;%&#x27;</span> identified by <span class="hljs-string">&quot;123456&quot;</span>;<br>mysql&gt; flush privileges;<br></code></pre></div></td></tr></table></figure><p>m1:</p><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">mysql&gt; change master to master_host=<span class="hljs-string">&#x27;mysql-m2&#x27;</span>,master_user=<span class="hljs-string">&#x27;slave&#x27;</span>,master_password=<span class="hljs-string">&#x27;123456&#x27;</span>,master_port=3306,master_log_file=<span class="hljs-string">&#x27;mysql-bin.000005&#x27;</span>, master_log_pos=154,master_connect_retry=30;<br><br>mysql&gt; start slave;<br><br>mysql&gt; show slave status \G<br>*************************** 1. row ***************************<br>               Slave_IO_State: Waiting <span class="hljs-keyword">for</span> master to send event<br>                  Master_Host: mysql-m2<br>                  Master_User: slave<br>                  Master_Port: 3306<br>                Connect_Retry: 30<br>              Master_Log_File: mysql-bin.000005<br>          Read_Master_Log_Pos: 620<br>               Relay_Log_File: de7a84f1b7f1-relay-bin.000002<br>                Relay_Log_Pos: 786<br>        Relay_Master_Log_File: mysql-bin.000005<br>             Slave_IO_Running: Yes<br>            Slave_SQL_Running: Yes<br>              Replicate_Do_DB:<br>          Replicate_Ignore_DB:<br>           Replicate_Do_Table:<br>       Replicate_Ignore_Table:<br>      Replicate_Wild_Do_Table:<br>  Replicate_Wild_Ignore_Table:<br>                   Last_Errno: 0<br>                   Last_Error:<br>                 Skip_Counter: 0<br>          Exec_Master_Log_Pos: 620<br>              Relay_Log_Space: 1000<br>              Until_Condition: None<br>               Until_Log_File:<br>                Until_Log_Pos: 0<br>           Master_SSL_Allowed: No<br>           Master_SSL_CA_File:<br>           Master_SSL_CA_Path:<br>              Master_SSL_Cert:<br>            Master_SSL_Cipher:<br>               Master_SSL_Key:<br>        Seconds_Behind_Master: 0<br>Master_SSL_Verify_Server_Cert: No<br>                Last_IO_Errno: 0<br>                Last_IO_Error:<br>               Last_SQL_Errno: 0<br>               Last_SQL_Error:<br>  Replicate_Ignore_Server_Ids:<br>             Master_Server_Id: 2<br>                  Master_UUID: de8af5ce-0410-11ec-ab6d-0242ac170003<br>             Master_Info_File: /var/lib/mysql/master.info<br>                    SQL_Delay: 0<br>          SQL_Remaining_Delay: NULL<br>      Slave_SQL_Running_State: Slave has <span class="hljs-built_in">read</span> all relay <span class="hljs-built_in">log</span>; waiting <span class="hljs-keyword">for</span> more updates<br>           Master_Retry_Count: 86400<br>                  Master_Bind:<br>      Last_IO_Error_Timestamp:<br>     Last_SQL_Error_Timestamp:<br>               Master_SSL_Crl:<br>           Master_SSL_Crlpath:<br>           Retrieved_Gtid_Set:<br>            Executed_Gtid_Set:<br>                Auto_Position: 0<br>         Replicate_Rewrite_DB:<br>                 Channel_Name:<br>           Master_TLS_Version:<br><br></code></pre></div></td></tr></table></figure><p>m2:</p><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">mysql&gt; change master to master_host=<span class="hljs-string">&#x27;mysql-m1&#x27;</span>,master_user=<span class="hljs-string">&#x27;slave&#x27;</span>,master_password=<span class="hljs-string">&#x27;123456&#x27;</span>,master_port=3306,master_log_file=<span class="hljs-string">&#x27;mysql-bin.000005&#x27;</span>, master_log_pos=154,master_connect_retry=30;<br><br>mysql&gt; start slave;<br><br>mysql&gt; show slave status \G<br>*************************** 1. row ***************************<br>               Slave_IO_State: Waiting <span class="hljs-keyword">for</span> master to send event<br>                  Master_Host: mysql-m1<br>                  Master_User: slave<br>                  Master_Port: 3306<br>                Connect_Retry: 30<br>              Master_Log_File: mysql-bin.000005<br>          Read_Master_Log_Pos: 1086<br>               Relay_Log_File: 65322be4d8a9-relay-bin.000002<br>                Relay_Log_Pos: 786<br>        Relay_Master_Log_File: mysql-bin.000005<br>             Slave_IO_Running: Yes<br>            Slave_SQL_Running: Yes<br>              Replicate_Do_DB:<br>          Replicate_Ignore_DB:<br>           Replicate_Do_Table:<br>       Replicate_Ignore_Table:<br>      Replicate_Wild_Do_Table:<br>  Replicate_Wild_Ignore_Table:<br>                   Last_Errno: 0<br>                   Last_Error:<br>                 Skip_Counter: 0<br>          Exec_Master_Log_Pos: 1086<br>              Relay_Log_Space: 1000<br>              Until_Condition: None<br>               Until_Log_File:<br>                Until_Log_Pos: 0<br>           Master_SSL_Allowed: No<br>           Master_SSL_CA_File:<br>           Master_SSL_CA_Path:<br>              Master_SSL_Cert:<br>            Master_SSL_Cipher:<br>               Master_SSL_Key:<br>        Seconds_Behind_Master: 0<br>Master_SSL_Verify_Server_Cert: No<br>                Last_IO_Errno: 0<br>                Last_IO_Error:<br>               Last_SQL_Errno: 0<br>               Last_SQL_Error:<br>  Replicate_Ignore_Server_Ids:<br>             Master_Server_Id: 1<br>                  Master_UUID: de898a82-0410-11ec-9fee-0242ac170002<br>             Master_Info_File: /var/lib/mysql/master.info<br>                    SQL_Delay: 0<br>          SQL_Remaining_Delay: NULL<br>      Slave_SQL_Running_State: Slave has <span class="hljs-built_in">read</span> all relay <span class="hljs-built_in">log</span>; waiting <span class="hljs-keyword">for</span> more updates<br>           Master_Retry_Count: 86400<br>                  Master_Bind:<br>      Last_IO_Error_Timestamp:<br>     Last_SQL_Error_Timestamp:<br>               Master_SSL_Crl:<br>           Master_SSL_Crlpath:<br>           Retrieved_Gtid_Set:<br>            Executed_Gtid_Set:<br>                Auto_Position: 0<br>         Replicate_Rewrite_DB:<br>                 Channel_Name:<br>           Master_TLS_Version:<br></code></pre></div></td></tr></table></figure><p class="noet note-success">è‡³æ­¤åŒä¸»èŠ‚ç‚¹è®¾ç½®å®Œæˆ</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>ä¸»ä»æ¨¡å¼å¤šç”¨æ¥è¿›è¡Œè¯»å†™åˆ†ç¦»</p><p>åŒä¸»æ¨¡å¼å¤šç”¨æ¥è¿›è¡Œé«˜å¯ç”¨</p><p>æ›´å¤æ‚çš„éƒ¨ç½²å¯èƒ½ä¼šéƒ¨ç½²å¤šmasterå’Œå¤šslaveå¹¶ç”¨keepliveä¿è¯ç»Ÿä¸€è®¿é—®çš„æ¨¡å¼ï¼Œè¿™é‡Œæ²¡æ¢ç©¶</p>]]></content>
    
    
    <categories>
      
      <category>å­˜å‚¨</category>
      
    </categories>
    
    
    <tags>
      
      <tag>mysql</tag>
      
      <tag>é«˜å¯ç”¨</tag>
      
      <tag>æ•°æ®åŒæ­¥</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å¾®æœåŠ¡æ¦‚è¿°</title>
    <link href="/2021/08/18/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A6%82%E8%BF%B0/"/>
    <url>/2021/08/18/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A6%82%E8%BF%B0/</url>
    
    <content type="html"><![CDATA[<h2 id="å¾®æœåŠ¡èµ·æº"><a href="#å¾®æœåŠ¡èµ·æº" class="headerlink" title="å¾®æœåŠ¡èµ·æº"></a>å¾®æœåŠ¡èµ·æº</h2><h3 id="å•ä½“åº”ç”¨çš„ç¼ºç‚¹"><a href="#å•ä½“åº”ç”¨çš„ç¼ºç‚¹" class="headerlink" title="å•ä½“åº”ç”¨çš„ç¼ºç‚¹"></a>å•ä½“åº”ç”¨çš„ç¼ºç‚¹</h3><ul><li>å•ä½“åº”ç”¨å¤æ‚</li><li>åº”ç”¨æ— æ³•æ‹“å±•</li><li>å¯é æ€§ä½</li><li>æ•æ·å¼€å‘å’Œå¿«é€Ÿéƒ¨ç½²æ— æ³•å®Œæˆ</li></ul><p><em><strong>ç”±æ­¤äº§ç”Ÿå¾®æœåŠ¡</strong></em></p><blockquote><p>ä¸€åˆ‡äº‰ç«¯çš„å¼€å§‹</p></blockquote><h3 id="å¾®æœåŠ¡çš„æ¼”å˜"><a href="#å¾®æœåŠ¡çš„æ¼”å˜" class="headerlink" title="å¾®æœåŠ¡çš„æ¼”å˜"></a>å¾®æœåŠ¡çš„æ¼”å˜</h3><p>å¾®æœåŠ¡æœ¬è´¨ä¸Šæ˜¯å¯¹é¢å‘æ¶æ„çš„æ¨¡å¼(SOA)çš„ä¸€ç§å®è·µ</p><p>å¾®æœåŠ¡çš„ç‰¹ç‚¹:</p><ul><li>å°å³æ˜¯ç¾</li><li>å•ä¸€èŒè´£</li><li>å°½å¯èƒ½æ—©åˆ›å»ºåŸå‹</li><li>å¯ä»¥æ‰§è¡Œæ¯”æ•ˆç‡æ›´é‡è¦</li></ul><h3 id="å¾®æœåŠ¡çš„å®šä¹‰"><a href="#å¾®æœåŠ¡çš„å®šä¹‰" class="headerlink" title="å¾®æœåŠ¡çš„å®šä¹‰"></a>å¾®æœåŠ¡çš„å®šä¹‰</h3><p>å›´ç»•ä¸šåŠ¡åŠŸèƒ½æ„å»ºçš„ï¼ŒæœåŠ¡å…³æ³¨å•ä¸€ä¸šåŠ¡ï¼ŒæœåŠ¡é—´é‡‡ç”¨è½»é‡çº§çš„é€šä¿¡æœºåˆ¶ï¼Œå¯ä»¥å…¨è‡ªåŠ¨ç‹¬ç«‹éƒ¨ç½²ï¼Œå¯ä»¥ä½¿ç”¨ä¸åŒçš„ç¼–ç¨‹è¯­è¨€å’Œæ•°æ®å­˜å‚¨æŠ€æœ¯ã€‚å¾®æœåŠ¡æ¶æ„é€šè¿‡ä¸šåŠ¡æ‹†åˆ†å®ç°æœåŠ¡ç»„ä»¶åŒ–ï¼Œé€šè¿‡ç»„ä»¶ç»„åˆå¿«é€Ÿå¼€å‘ç³»ç»Ÿï¼Œä¸šåŠ¡å•ä¸€çš„æœåŠ¡ç»„ä»¶åˆå¯ä»¥ç‹¬ç«‹éƒ¨ç½²ï¼Œä½¿å¾—æ•´ä¸ªç³»ç»Ÿå˜å¾—æ¸…æ™°çµæ´»</p><p><em><strong>æ ¸å¿ƒï¼š åŒ–ç¹ä¸ºç®€ åˆ†è€Œæ²»ä¹‹</strong></em></p><p>ä¼˜ç‚¹ï¼š</p><ul><li>åŸå­æœåŠ¡</li><li>ç‹¬ç«‹éƒ¨ç½²</li><li>éš”ç¦»éƒ¨ç½²</li><li>å»ä¸­å¿ƒåŒ–æœåŠ¡æ²»ç†</li></ul><p>ç¼ºç‚¹ï¼š</p><ul><li>åŸºç¡€è®¾æ–½å»ºè®¾å¤æ‚åº¦é«˜</li><li>åˆ†å¸ƒå¼æœåŠ¡é—´é€šä¿¡æœºåˆ¶å˜å¾—å¤æ‚ å¯¹ä¸å¯ç”¨èŠ‚ç‚¹æœåŠ¡å¤„ç†å˜å¾—æ›´åŠ å¤æ‚</li><li>åˆ†å¸ƒå¼çš„åˆ†åŒºæ•°æ®åº“ å¯¹åˆ†å¸ƒå¼äº‹ç‰©ç­‰éœ€è¦åšå¯¹åº”çš„å¤æ‚å¤„ç†</li><li>æµ‹è¯•æ•´ä½“çš„å¾®æœåŠ¡æ¶æ„å¤æ‚</li><li>æœåŠ¡é—´çš„ä¾èµ– å±€éƒ¨å‡çº§å¯èƒ½å½±å“æ•´ä½“</li></ul><h2 id="å¾®æœåŠ¡è®¾è®¡æ€è·¯"><a href="#å¾®æœåŠ¡è®¾è®¡æ€è·¯" class="headerlink" title="å¾®æœåŠ¡è®¾è®¡æ€è·¯"></a>å¾®æœåŠ¡è®¾è®¡æ€è·¯</h2><h3 id="ç»„ä»¶æœåŠ¡åŒ–"><a href="#ç»„ä»¶æœåŠ¡åŒ–" class="headerlink" title="ç»„ä»¶æœåŠ¡åŒ–"></a>ç»„ä»¶æœåŠ¡åŒ–</h3><ul><li>kit:ä¸€ä¸ªå¾®æœåŠ¡çš„åŸºç¡€åº“ï¼ˆæ¡†æ¶ï¼‰</li><li>service: ä¸šåŠ¡ä¸šåŠ¡ä»£ç +kitä¾èµ–+ç¬¬ä¸‰æ–¹ç»„ä»¶çš„ä¾èµ–</li><li>RPC+message queue: è½»é‡çº§é€šè®¯</li></ul><h3 id="æŒ‰ä¸šåŠ¡ç»„ç»‡æœåŠ¡"><a href="#æŒ‰ä¸šåŠ¡ç»„ç»‡æœåŠ¡" class="headerlink" title="æŒ‰ä¸šåŠ¡ç»„ç»‡æœåŠ¡"></a>æŒ‰ä¸šåŠ¡ç»„ç»‡æœåŠ¡</h3><p>äº‹å®ä¸Šä¼ ç»Ÿåº”ç”¨è®¾è®¡æ¶æ„çš„åˆ†å±‚ç»“æ„æ­£åæ˜ äº†ä¸åŒè§’è‰²çš„æ²Ÿé€šç»“æ„ã€‚æ‰€ä»¥è‹¥è¦æŒ‰å¾®æœåŠ¡çš„æ–¹å¼æ¥æ„å»ºåº”ç”¨ï¼Œä¹Ÿéœ€è¦å¯¹åº”è°ƒæ•´å›¢é˜Ÿçš„ç»„ç»‡æ¶æ„ã€‚æ¯ä¸ªæœåŠ¡èƒŒåçš„å°å›¢é˜Ÿçš„ç»„ç»‡æ˜¯è·¨åŠŸèƒ½çš„ï¼ŒåŒ…å«å®ç°ä¸šåŠ¡æ‰€éœ€çš„å…¨é¢çš„æŠ€èƒ½</p><h3 id="å»ä¸­å¿ƒåŒ–"><a href="#å»ä¸­å¿ƒåŒ–" class="headerlink" title="å»ä¸­å¿ƒåŒ–"></a>å»ä¸­å¿ƒåŒ–</h3><ul><li>æ•°æ®å»ä¸­å¿ƒåŒ–</li><li>æ²»ç†å»ä¸­å¿ƒåŒ–</li><li>æŠ€æœ¯å»ä¸­å¿ƒåŒ–</li></ul><h3 id="åŸºç¡€è®¾æ–½è‡ªåŠ¨åŒ–"><a href="#åŸºç¡€è®¾æ–½è‡ªåŠ¨åŒ–" class="headerlink" title="åŸºç¡€è®¾æ–½è‡ªåŠ¨åŒ–"></a>åŸºç¡€è®¾æ–½è‡ªåŠ¨åŒ–</h3><ul><li>ci/cd</li><li>auto testing</li><li>åœ¨çº¿ç›‘æ§</li></ul><h3 id="æœåŠ¡å…¼å®¹æ€§è®¾è®¡"><a href="#æœåŠ¡å…¼å®¹æ€§è®¾è®¡" class="headerlink" title="æœåŠ¡å…¼å®¹æ€§è®¾è®¡"></a>æœåŠ¡å…¼å®¹æ€§è®¾è®¡</h3><p>å‘é€æ—¶è¦ä¿å®ˆï¼Œæ¥æ”¶æ—¶è¦å¼€æ”¾ã€‚æŒ‰ç…§ä¼¯æ–¯å¡”å°”æ³•åˆ™çš„æ€æƒ³æ¥è®¾è®¡å’Œå®ç°æœåŠ¡æ—¶ï¼Œå‘é€çš„æ•°æ®è¦æ›´ä¿å®ˆï¼Œæ„å‘³ç€æœ€å°åŒ–çš„ä¼ é€å¿…è¦çš„ä¿¡æ¯ï¼Œæ¥æ”¶æ—¶æ›´å¼€æ”¾æ„å‘³ç€è¦æœ€å¤§é™åº¦çš„å®¹å¿å†—ä½™æ•°æ®ï¼Œä¿è¯å…¼å®¹æ€§ã€‚</p><ul><li>è´Ÿè½½å‡è¡¡</li><li>è¶…æ—¶æ§åˆ¶</li><li>è´Ÿè½½ä¿æŠ¤</li><li>éš”ç¦»</li><li>é™æµ</li><li>é™çº§</li><li>é‡è¯•</li><li>ç†”æ–­</li></ul><h2 id="å¾®æœåŠ¡è®¾è®¡"><a href="#å¾®æœåŠ¡è®¾è®¡" class="headerlink" title="å¾®æœåŠ¡è®¾è®¡"></a>å¾®æœåŠ¡è®¾è®¡</h2><h3 id="API-GATEWAY"><a href="#API-GATEWAY" class="headerlink" title="API GATEWAY"></a>API GATEWAY</h3><blockquote><p>backend for forntend BFF å¯ä»¥è®¤ä¸ºæ˜¯ä¸€ç§é€‚é…æœåŠ¡ï¼Œå°†åç«¯çš„å¾®æœåŠ¡è¿›è¡Œé€‚é…ï¼ˆä¸»è¦åŒ…æ‹¬èšåˆè£å‰ªå’Œæ ¼å¼é€‚é…ç­‰é€»è¾‘ï¼‰ï¼Œå‘æ— çº¿ç«¯è®¾å¤‡æš´éœ²å‹å¥½å’Œç»Ÿä¸€çš„ APIï¼Œæ–¹ä¾¿æ— çº¿è®¾å¤‡æ¥å…¥è®¿é—®åç«¯æœåŠ¡</p></blockquote><h3 id="å¾®æœåŠ¡çš„åˆ’åˆ†"><a href="#å¾®æœåŠ¡çš„åˆ’åˆ†" class="headerlink" title="å¾®æœåŠ¡çš„åˆ’åˆ†"></a>å¾®æœåŠ¡çš„åˆ’åˆ†</h3><h3 id="å¾®æœåŠ¡çš„å®‰å…¨"><a href="#å¾®æœåŠ¡çš„å®‰å…¨" class="headerlink" title="å¾®æœåŠ¡çš„å®‰å…¨"></a>å¾®æœåŠ¡çš„å®‰å…¨</h3><h2 id="æœåŠ¡å‘ç°-amp-GRPC"><a href="#æœåŠ¡å‘ç°-amp-GRPC" class="headerlink" title="æœåŠ¡å‘ç° &amp; GRPC"></a>æœåŠ¡å‘ç° &amp; GRPC</h2><h3 id="GRPC"><a href="#GRPC" class="headerlink" title="GRPC"></a>GRPC</h3><ul><li>å¤šè¯­è¨€ï¼šè¯­è¨€ä¸­ç«‹ï¼Œæ”¯æŒå¤šç§è¯­è¨€ã€‚</li><li>è½»é‡çº§ã€é«˜æ€§èƒ½ï¼šåºåˆ—åŒ–æ”¯æŒ PBï¼ˆProtocol Bufferï¼‰å’Œ JSONï¼ŒPB æ˜¯ä¸€ç§è¯­è¨€æ— å…³çš„é«˜æ€§èƒ½åºåˆ—åŒ–æ¡†æ¶</li><li>å¯æ’æ‹”</li><li>IDLï¼šåŸºäºæ–‡ä»¶å®šä¹‰æœåŠ¡ï¼Œé€šè¿‡ proto3 å·¥å…·ç”ŸæˆæŒ‡å®šè¯­è¨€çš„æ•°æ®ç»“æ„ã€æœåŠ¡ç«¯æ¥å£ä»¥åŠå®¢æˆ·ç«¯ Stub</li><li>ç§»åŠ¨ç«¯ï¼šåŸºäºæ ‡å‡†çš„ HTTP/2 è®¾è®¡ï¼Œæ”¯æŒåŒå‘æµã€æ¶ˆæ¯å¤´å‹ç¼©ã€å• TCP çš„å¤šè·¯å¤ç”¨ã€æœåŠ¡ç«¯æ¨é€ç­‰ç‰¹æ€§ï¼Œè¿™äº›ç‰¹æ€§ä½¿å¾— gRPC åœ¨ç§»åŠ¨ç«¯è®¾å¤‡ä¸Šæ›´åŠ çœç”µå’ŒèŠ‚çœç½‘ç»œæµé‡ã€‚</li><li>æœåŠ¡è€Œéå¯¹è±¡ æ¶ˆæ¯è€Œéå¼•ç”¨ï¼šä¿ƒè¿›å¾®æœåŠ¡çš„ç³»ç»Ÿé—´ç²—ç²’åº¦æ¶ˆæ¯äº¤äº’è®¾è®¡ç†å¿µ</li><li>è´Ÿè½½æ— å…³çš„ï¼šä¸åŒçš„æœåŠ¡éœ€è¦ä½¿ç”¨ä¸åŒçš„æ¶ˆæ¯ç±»å‹å’Œç¼–ç ï¼Œä¾‹å¦‚ protocol buffersã€JSONã€XML å’Œ Thriftã€‚</li><li>æµï¼šStreaming APIã€‚</li><li>é˜»å¡å¼å’Œéé˜»å¡å¼ï¼šæ”¯æŒå¼‚æ­¥å’ŒåŒæ­¥å¤„ç†åœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯é—´äº¤äº’çš„æ¶ˆæ¯åºåˆ—ã€‚</li><li>å…ƒæ•°æ®äº¤æ¢ï¼šå¸¸è§çš„æ¨ªåˆ‡å…³æ³¨ç‚¹ï¼Œå¦‚è®¤è¯æˆ–è·Ÿè¸ªï¼Œä¾èµ–æ•°æ®äº¤æ¢ã€‚</li><li>æ ‡å‡†åŒ–çŠ¶æ€ç ï¼šå®¢æˆ·ç«¯é€šå¸¸ä»¥æœ‰é™çš„æ–¹å¼å“åº” API è°ƒç”¨è¿”å›çš„é”™è¯¯ </li></ul><h3 id="æœåŠ¡å‘ç°"><a href="#æœåŠ¡å‘ç°" class="headerlink" title="æœåŠ¡å‘ç°"></a>æœåŠ¡å‘ç°</h3><ul><li><p>å®¢æˆ·ç«¯å‘ç°ï¼š<br>ç›´è¿ æ¯”æœåŠ¡ç«¯æœåŠ¡å‘ç°å°‘ä¸€æ¬¡ç½‘ç»œè·³è½¬ Consumer éœ€è¦å†…ç½®ç‰¹å®šçš„æœåŠ¡å‘ç°å®¢æˆ·ç«¯å’Œå‘ç°é€»è¾‘</p></li><li><p>æœåŠ¡ç«¯å‘ç°ï¼š<br>Consumer æ— éœ€å…³æ³¨æœåŠ¡å‘ç°å…·ä½“ç»†èŠ‚ åªéœ€çŸ¥é“æœåŠ¡çš„ DNS åŸŸåå³å¯ æ”¯æŒå¼‚æ„è¯­è¨€å¼€å‘ éœ€è¦åŸºç¡€è®¾æ–½æ”¯æ’‘ å¤šäº†ä¸€æ¬¡ç½‘ç»œè·³è½¬ å¯èƒ½æœ‰æ€§èƒ½æŸå¤±</p></li><li><p>æœåŠ¡ç½‘æ ¼ service mesh:<br>é€šè¿‡sidercar æ–¹å¼éšå¼çš„æ”¯æŒæœåŠ¡å‘ç°ï¼ˆå¾…è¡¥å……ï¼‰</p></li></ul><h2 id="å¤šé›†ç¾¤-amp-å¤šç§Ÿæˆ·"><a href="#å¤šé›†ç¾¤-amp-å¤šç§Ÿæˆ·" class="headerlink" title="å¤šé›†ç¾¤ &amp; å¤šç§Ÿæˆ·"></a>å¤šé›†ç¾¤ &amp; å¤šç§Ÿæˆ·</h2><h3 id="å¤šé›†ç¾¤"><a href="#å¤šé›†ç¾¤" class="headerlink" title="å¤šé›†ç¾¤"></a>å¤šé›†ç¾¤</h3><p>ä¸ºäº†ä¿è¯æœåŠ¡çš„å¯ç”¨æ€§ å·²ç»å¯¹å¼‚å¸¸æƒ…å†µçš„é¢„å¤„ç† ä½¿ç”¨å¤šé›†ç¾¤çš„æ–¹å¼æé«˜ç³»ç»Ÿçš„å¯ç”¨èƒ½åŠ›</p><h3 id="å¤šç§Ÿæˆ·"><a href="#å¤šç§Ÿæˆ·" class="headerlink" title="å¤šç§Ÿæˆ·"></a>å¤šç§Ÿæˆ·</h3><p>åœ¨ä¸€ä¸ªå¾®æœåŠ¡æ¶æ„ä¸­å…è®¸å¤šç³»ç»Ÿå…±å­˜æ˜¯åˆ©ç”¨å¾®æœåŠ¡ç¨³å®šæ€§ä»¥åŠæ¨¡å—åŒ–æœ€æœ‰æ•ˆçš„æ–¹å¼ä¹‹ä¸€ è¿™ç§æ–¹å¼ä¸€èˆ¬è¢«ç§°ä¸ºå¤šç§Ÿæˆ·ï¼ˆmulti-tenancyï¼‰</p><p>é€šè¿‡ä¸åŒçš„ç§Ÿæˆ·åŒºåˆ†ä¸åŒçš„ä¸šåŠ¡åŠŸèƒ½ï¼š</p><ul><li>çº¢è“å‘å¸ƒ</li><li>ç°åº¦æµ‹è¯•</li><li>æ¨¡å—æµ‹è¯•</li></ul><blockquote><p>å¤šç§Ÿæˆ·çš„æ¦‚å¿µè¾ƒä¸ºæ¨¡ç³Š<br>æ€è€ƒï¼Ÿ å¤šç§Ÿæˆ·ä¸­æ˜¯æ€æ ·å®ç°åœ¨ä¸Šä¸‹æ–‡ä¸­ä¼ é€’å¤šç§Ÿæˆ·ä¿¡æ¯çš„?</p></blockquote>]]></content>
    
    
    <categories>
      
      <category>æ¶æ„</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ddd</tag>
      
      <tag>å¾®æœåŠ¡</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
