{"meta":{"version":1,"warehouse":"4.0.0"},"models":{"Asset":[{"_id":"node_modules/hexo-theme-landscape/source/css/style.styl","path":"css/style.styl","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-landscape/source/fancybox/jquery.fancybox.min.js","path":"fancybox/jquery.fancybox.min.js","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-landscape/source/fancybox/jquery.fancybox.min.css","path":"fancybox/jquery.fancybox.min.css","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-landscape/source/js/jquery-3.4.1.min.js","path":"js/jquery-3.4.1.min.js","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-landscape/source/js/script.js","path":"js/script.js","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-landscape/source/css/fonts/FontAwesome.otf","path":"css/fonts/FontAwesome.otf","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-landscape/source/css/fonts/fontawesome-webfont.eot","path":"css/fonts/fontawesome-webfont.eot","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-landscape/source/css/fonts/fontawesome-webfont.svg","path":"css/fonts/fontawesome-webfont.svg","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-landscape/source/css/fonts/fontawesome-webfont.ttf","path":"css/fonts/fontawesome-webfont.ttf","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-landscape/source/css/fonts/fontawesome-webfont.woff","path":"css/fonts/fontawesome-webfont.woff","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-landscape/source/css/fonts/fontawesome-webfont.woff2","path":"css/fonts/fontawesome-webfont.woff2","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-landscape/source/css/images/banner.jpg","path":"css/images/banner.jpg","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-fluid/source/css/gitalk.css","path":"css/gitalk.css","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-fluid/source/css/main.styl","path":"css/main.styl","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-fluid/source/img/avatar.png","path":"img/avatar.png","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-fluid/source/img/default.png","path":"img/default.png","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-fluid/source/img/favicon.png","path":"img/favicon.png","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-fluid/source/img/loading.gif","path":"img/loading.gif","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-fluid/source/img/police_beian.png","path":"img/police_beian.png","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-fluid/source/js/boot.js","path":"js/boot.js","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-fluid/source/js/color-schema.js","path":"js/color-schema.js","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-fluid/source/js/events.js","path":"js/events.js","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-fluid/source/js/img-lazyload.js","path":"js/img-lazyload.js","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-fluid/source/js/local-search.js","path":"js/local-search.js","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-fluid/source/js/leancloud.js","path":"js/leancloud.js","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-fluid/source/js/plugins.js","path":"js/plugins.js","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-fluid/source/js/utils.js","path":"js/utils.js","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-fluid/source/xml/local-search.xml","path":"xml/local-search.xml","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-fluid/source/lib/hint/hint.min.css","path":"lib/hint/hint.min.css","modified":0,"renderable":1},{"_id":"source/img/abg/favicon.jpg","path":"img/abg/favicon.jpg","modified":0,"renderable":0},{"_id":"source/img/abg/default.jpg","path":"img/abg/default.jpg","modified":0,"renderable":0},{"_id":"source/img/micro/top.png","path":"img/micro/top.png","modified":0,"renderable":0},{"_id":"source/img/micro/banner.jpg","path":"img/micro/banner.jpg","modified":0,"renderable":0},{"_id":"source/CNAME","path":"CNAME","modified":0,"renderable":0},{"_id":"source/img/mysql/mysql-m-s.png","path":"img/mysql/mysql-m-s.png","modified":0,"renderable":0},{"_id":"source/img/mysql/mysql.png","path":"img/mysql/mysql.png","modified":0,"renderable":0},{"_id":"source/img/mysql/banner-1.jpg","path":"img/mysql/banner-1.jpg","modified":0,"renderable":0},{"_id":"source/img/mysql/isolation.jpg","path":"img/mysql/isolation.jpg","modified":0,"renderable":0},{"_id":"source/img/hash/redis-hash-cache.png","path":"img/hash/redis-hash-cache.png","modified":0,"renderable":0},{"_id":"source/img/hash/redis-hash-cache.jpg","path":"img/hash/redis-hash-cache.jpg","modified":0,"renderable":0},{"_id":"source/img/hash/cricle-hash-1.jpg","path":"img/hash/cricle-hash-1.jpg","modified":0,"renderable":0},{"_id":"source/img/hash/cricle-hash-2.png","path":"img/hash/cricle-hash-2.png","modified":0,"renderable":0},{"_id":"source/img/hash/cricle-hash-3.png","path":"img/hash/cricle-hash-3.png","modified":0,"renderable":0}],"Cache":[{"_id":"source/_posts/page1.md","hash":"eb4d0cfaef6a04d02b85236549cc375c8363d03a","modified":1629266783715},{"_id":"source/_posts/hello-world.md","hash":"7d98d6592de80fdcd2949bd7401cec12afd98cdf","modified":1629256660631},{"_id":"node_modules/hexo-theme-landscape/README.md","hash":"d2772ece6d4422ccdaa0359c3e07588834044052","modified":1629195218765},{"_id":"node_modules/hexo-theme-landscape/_config.yml","hash":"b608c1f1322760dce9805285a602a95832730a2e","modified":1629195218765},{"_id":"node_modules/hexo-theme-landscape/LICENSE","hash":"c480fce396b23997ee23cc535518ffaaf7f458f8","modified":1629195218765},{"_id":"node_modules/hexo-theme-landscape/languages/de.yml","hash":"3ebf0775abbee928c8d7bda943c191d166ded0d3","modified":1629195218765},{"_id":"node_modules/hexo-theme-landscape/languages/en.yml","hash":"3083f319b352d21d80fc5e20113ddf27889c9d11","modified":1629195218765},{"_id":"node_modules/hexo-theme-landscape/languages/es.yml","hash":"76edb1171b86532ef12cfd15f5f2c1ac3949f061","modified":1629195218765},{"_id":"node_modules/hexo-theme-landscape/package.json","hash":"9a94875cbf4c27fbe2e63da0496242addc6d2876","modified":1629195218765},{"_id":"node_modules/hexo-theme-landscape/languages/fr.yml","hash":"415e1c580ced8e4ce20b3b0aeedc3610341c76fb","modified":1629195218765},{"_id":"node_modules/hexo-theme-landscape/languages/hu.yml","hash":"284d557130bf54a74e7dcef9d42096130e4d9550","modified":1629195218765},{"_id":"node_modules/hexo-theme-landscape/languages/it.yml","hash":"89b7d91306b2c1a0f3ac023b657bf974f798a1e8","modified":1629195218765},{"_id":"node_modules/hexo-theme-landscape/languages/ja.yml","hash":"a73e1b9c80fd6e930e2628b393bfe3fb716a21a9","modified":1629195218765},{"_id":"node_modules/hexo-theme-landscape/languages/mn.yml","hash":"2e7523951072a9403ead3840ad823edd1084c116","modified":1629195218765},{"_id":"node_modules/hexo-theme-landscape/languages/nl.yml","hash":"12ed59faba1fc4e8cdd1d42ab55ef518dde8039c","modified":1629195218765},{"_id":"node_modules/hexo-theme-landscape/languages/no.yml","hash":"965a171e70347215ec726952e63f5b47930931ef","modified":1629195218765},{"_id":"node_modules/hexo-theme-landscape/languages/pt.yml","hash":"57d07b75d434fbfc33b0ddb543021cb5f53318a8","modified":1629195218765},{"_id":"node_modules/hexo-theme-landscape/languages/ru.yml","hash":"4fda301bbd8b39f2c714e2c934eccc4b27c0a2b0","modified":1629195218765},{"_id":"node_modules/hexo-theme-landscape/languages/tr.yml","hash":"a1cdbfa17682d7a971de8ab8588bf57c74224b5b","modified":1629195218765},{"_id":"node_modules/hexo-theme-landscape/languages/zh-CN.yml","hash":"1efd95774f401c80193eac6ee3f1794bfe93dc5a","modified":1629195218765},{"_id":"node_modules/hexo-theme-landscape/languages/zh-TW.yml","hash":"53ce3000c5f767759c7d2c4efcaa9049788599c3","modified":1629195218765},{"_id":"node_modules/hexo-theme-landscape/layout/archive.ejs","hash":"2703b07cc8ac64ae46d1d263f4653013c7e1666b","modified":1629195218765},{"_id":"node_modules/hexo-theme-landscape/layout/category.ejs","hash":"765426a9c8236828dc34759e604cc2c52292835a","modified":1629195218765},{"_id":"node_modules/hexo-theme-landscape/layout/index.ejs","hash":"aa1b4456907bdb43e629be3931547e2d29ac58c8","modified":1629195218765},{"_id":"node_modules/hexo-theme-landscape/layout/layout.ejs","hash":"0d1765036e4874500e68256fedb7470e96eeb6ee","modified":1629195218765},{"_id":"node_modules/hexo-theme-landscape/layout/page.ejs","hash":"7d80e4e36b14d30a7cd2ac1f61376d9ebf264e8b","modified":1629195218765},{"_id":"node_modules/hexo-theme-landscape/layout/post.ejs","hash":"7d80e4e36b14d30a7cd2ac1f61376d9ebf264e8b","modified":1629195218765},{"_id":"node_modules/hexo-theme-landscape/layout/tag.ejs","hash":"eaa7b4ccb2ca7befb90142e4e68995fb1ea68b2e","modified":1629195218765},{"_id":"node_modules/hexo-theme-landscape/scripts/fancybox.js","hash":"c857d7a5e4a5d71c743a009c5932bf84229db428","modified":1629195218765},{"_id":"node_modules/hexo-theme-landscape/layout/_partial/after-footer.ejs","hash":"414914ebb159fac1922b056b905e570ac7521925","modified":1629195218765},{"_id":"node_modules/hexo-theme-landscape/layout/_partial/archive-post.ejs","hash":"c7a71425a946d05414c069ec91811b5c09a92c47","modified":1629195218765},{"_id":"node_modules/hexo-theme-landscape/layout/_partial/article.ejs","hash":"dfd555c00e85ffc4207c88968d12b219c1f086ec","modified":1629195218765},{"_id":"node_modules/hexo-theme-landscape/layout/_partial/footer.ejs","hash":"3656eb692254346671abc03cb3ba1459829e0dce","modified":1629195218765},{"_id":"node_modules/hexo-theme-landscape/layout/_partial/gauges-analytics.ejs","hash":"21a1e2a3907d1a3dad1cd0ab855fe6735f233c74","modified":1629195218765},{"_id":"node_modules/hexo-theme-landscape/layout/_partial/head.ejs","hash":"f215d92a882247a7cc5ea80b241bedfcec0ea6ca","modified":1629195218765},{"_id":"node_modules/hexo-theme-landscape/layout/_partial/google-analytics.ejs","hash":"2ea7442ea1e1a8ab4e41e26c563f58413b59a3d0","modified":1629195218765},{"_id":"node_modules/hexo-theme-landscape/layout/_partial/archive.ejs","hash":"7cb70a7a54f8c7ae49b10d1f37c0a9b74eab8826","modified":1629195218765},{"_id":"node_modules/hexo-theme-landscape/layout/_partial/header.ejs","hash":"c1acd247e14588cdf101a69460cb8319c18cd078","modified":1629195218765},{"_id":"node_modules/hexo-theme-landscape/layout/_partial/mobile-nav.ejs","hash":"e952a532dfc583930a666b9d4479c32d4a84b44e","modified":1629195218765},{"_id":"node_modules/hexo-theme-landscape/layout/_partial/sidebar.ejs","hash":"930da35cc2d447a92e5ee8f835735e6fd2232469","modified":1629195218765},{"_id":"node_modules/hexo-theme-landscape/layout/_widget/archive.ejs","hash":"beb4a86fcc82a9bdda9289b59db5a1988918bec3","modified":1629195218765},{"_id":"node_modules/hexo-theme-landscape/layout/_widget/category.ejs","hash":"dd1e5af3c6af3f5d6c85dfd5ca1766faed6a0b05","modified":1629195218765},{"_id":"node_modules/hexo-theme-landscape/layout/_widget/recent_posts.ejs","hash":"60c4b012dcc656438ff59997e60367e5a21ab746","modified":1629195218765},{"_id":"node_modules/hexo-theme-landscape/layout/_widget/tag.ejs","hash":"2de380865df9ab5f577f7d3bcadf44261eb5faae","modified":1629195218765},{"_id":"node_modules/hexo-theme-landscape/layout/_widget/tagcloud.ejs","hash":"b4a2079101643f63993dcdb32925c9b071763b46","modified":1629195218765},{"_id":"node_modules/hexo-theme-landscape/source/css/_extend.styl","hash":"222fbe6d222531d61c1ef0f868c90f747b1c2ced","modified":1629195218765},{"_id":"node_modules/hexo-theme-landscape/source/css/_variables.styl","hash":"581b0cbefdaa5f894922133989dd2d3bf71ded79","modified":1629195218765},{"_id":"node_modules/hexo-theme-landscape/source/css/style.styl","hash":"9c451e5efd72c5bb8b56e8c2b94be731e99db05b","modified":1629195218765},{"_id":"node_modules/hexo-theme-landscape/source/fancybox/jquery.fancybox.min.css","hash":"1be9b79be02a1cfc5d96c4a5e0feb8f472babd95","modified":1629195218765},{"_id":"node_modules/hexo-theme-landscape/layout/_partial/post/category.ejs","hash":"c6bcd0e04271ffca81da25bcff5adf3d46f02fc0","modified":1629195218765},{"_id":"node_modules/hexo-theme-landscape/source/js/script.js","hash":"998ed4c5b147e1299bf62beebf33514474f28112","modified":1629195218765},{"_id":"node_modules/hexo-theme-landscape/layout/_partial/post/gallery.ejs","hash":"3d9d81a3c693ff2378ef06ddb6810254e509de5b","modified":1629195218765},{"_id":"node_modules/hexo-theme-landscape/layout/_partial/post/date.ejs","hash":"f1458584b679545830b75bef2526e2f3eb931045","modified":1629195218765},{"_id":"node_modules/hexo-theme-landscape/layout/_partial/post/nav.ejs","hash":"16a904de7bceccbb36b4267565f2215704db2880","modified":1629195218765},{"_id":"node_modules/hexo-theme-landscape/layout/_partial/post/tag.ejs","hash":"2fcb0bf9c8847a644167a27824c9bb19ac74dd14","modified":1629195218765},{"_id":"node_modules/hexo-theme-landscape/layout/_partial/post/title.ejs","hash":"4d7e62574ddf46de9b41605fe3140d77b5ddb26d","modified":1629195218765},{"_id":"node_modules/hexo-theme-landscape/source/css/_partial/archive.styl","hash":"db15f5677dc68f1730e82190bab69c24611ca292","modified":1629195218765},{"_id":"node_modules/hexo-theme-landscape/source/css/_partial/comment.styl","hash":"79d280d8d203abb3bd933ca9b8e38c78ec684987","modified":1629195218765},{"_id":"node_modules/hexo-theme-landscape/source/css/_partial/article.styl","hash":"80759482d07063c091e940f964a1cf6693d3d406","modified":1629195218765},{"_id":"node_modules/hexo-theme-landscape/source/css/_partial/footer.styl","hash":"e35a060b8512031048919709a8e7b1ec0e40bc1b","modified":1629195218765},{"_id":"node_modules/hexo-theme-landscape/source/css/_partial/header.styl","hash":"85ab11e082f4dd86dde72bed653d57ec5381f30c","modified":1629195218765},{"_id":"node_modules/hexo-theme-landscape/source/css/_partial/highlight.styl","hash":"bf4e7be1968dad495b04e83c95eac14c4d0ad7c0","modified":1629195218765},{"_id":"node_modules/hexo-theme-landscape/source/css/_partial/mobile.styl","hash":"a399cf9e1e1cec3e4269066e2948d7ae5854d745","modified":1629195218765},{"_id":"node_modules/hexo-theme-landscape/source/css/_partial/sidebar-aside.styl","hash":"890349df5145abf46ce7712010c89237900b3713","modified":1629195218765},{"_id":"node_modules/hexo-theme-landscape/source/css/_partial/sidebar.styl","hash":"404ec059dc674a48b9ab89cd83f258dec4dcb24d","modified":1629195218765},{"_id":"node_modules/hexo-theme-landscape/source/css/_partial/sidebar-bottom.styl","hash":"8fd4f30d319542babfd31f087ddbac550f000a8a","modified":1629195218765},{"_id":"node_modules/hexo-theme-landscape/source/css/_util/grid.styl","hash":"0bf55ee5d09f193e249083602ac5fcdb1e571aed","modified":1629195218765},{"_id":"node_modules/hexo-theme-landscape/source/css/_util/mixin.styl","hash":"44f32767d9fd3c1c08a60d91f181ee53c8f0dbb3","modified":1629195218765},{"_id":"node_modules/hexo-theme-landscape/languages/ko.yml","hash":"881d6a0a101706e0452af81c580218e0bfddd9cf","modified":1629195218765},{"_id":"node_modules/hexo-theme-landscape/source/fancybox/jquery.fancybox.min.js","hash":"6181412e73966696d08e1e5b1243a572d0f22ba6","modified":1629195218765},{"_id":"node_modules/hexo-theme-landscape/source/js/jquery-3.4.1.min.js","hash":"88523924351bac0b5d560fe0c5781e2556e7693d","modified":1629195218765},{"_id":"node_modules/hexo-theme-landscape/source/css/fonts/fontawesome-webfont.woff","hash":"28b782240b3e76db824e12c02754a9731a167527","modified":1629195218765},{"_id":"node_modules/hexo-theme-landscape/source/css/fonts/fontawesome-webfont.woff2","hash":"d6f48cba7d076fb6f2fd6ba993a75b9dc1ecbf0c","modified":1629195218765},{"_id":"node_modules/hexo-theme-landscape/source/css/fonts/FontAwesome.otf","hash":"048707bc52ac4b6563aaa383bfe8660a0ddc908c","modified":1629195218765},{"_id":"node_modules/hexo-theme-landscape/source/css/fonts/fontawesome-webfont.eot","hash":"d980c2ce873dc43af460d4d572d441304499f400","modified":1629195218765},{"_id":"node_modules/hexo-theme-landscape/source/css/fonts/fontawesome-webfont.ttf","hash":"13b1eab65a983c7a73bc7997c479d66943f7c6cb","modified":1629195218765},{"_id":"node_modules/hexo-theme-landscape/source/css/images/banner.jpg","hash":"f44aa591089fcb3ec79770a1e102fd3289a7c6a6","modified":1629195218765},{"_id":"node_modules/hexo-theme-landscape/source/css/fonts/fontawesome-webfont.svg","hash":"98a8aa5cf7d62c2eff5f07ede8d844b874ef06ed","modified":1629195218765},{"_id":"public/2021/08/18/page1/index.html","hash":"fda431ef4c8bacd2bc0b8c5f57985ce2bb6781ba","modified":1629277319486},{"_id":"public/2021/08/18/hello-world/index.html","hash":"b12b91ef2d64f05af18ad6ab705be18cb69cbee3","modified":1629277319486},{"_id":"public/archives/index.html","hash":"62ae08372cadf3e90e31160dfb60096a568b78c1","modified":1630661469413},{"_id":"public/index.html","hash":"e391316347b15a6ce75e2447923e503fc94b4a84","modified":1630661469413},{"_id":"public/archives/2021/index.html","hash":"62ae08372cadf3e90e31160dfb60096a568b78c1","modified":1630661469413},{"_id":"public/archives/2021/08/index.html","hash":"62ae08372cadf3e90e31160dfb60096a568b78c1","modified":1630661469413},{"_id":"public/fancybox/jquery.fancybox.min.css","hash":"1be9b79be02a1cfc5d96c4a5e0feb8f472babd95","modified":1629257320618},{"_id":"public/js/script.js","hash":"998ed4c5b147e1299bf62beebf33514474f28112","modified":1629257320618},{"_id":"public/css/style.css","hash":"263d98c93ae32dda6f7bbc8473105f3c441aca99","modified":1629257320618},{"_id":"public/fancybox/jquery.fancybox.min.js","hash":"6181412e73966696d08e1e5b1243a572d0f22ba6","modified":1629257320618},{"_id":"public/js/jquery-3.4.1.min.js","hash":"88523924351bac0b5d560fe0c5781e2556e7693d","modified":1629257320618},{"_id":"public/css/fonts/fontawesome-webfont.woff","hash":"28b782240b3e76db824e12c02754a9731a167527","modified":1629257320618},{"_id":"public/css/fonts/fontawesome-webfont.woff2","hash":"d6f48cba7d076fb6f2fd6ba993a75b9dc1ecbf0c","modified":1629257320618},{"_id":"public/css/fonts/fontawesome-webfont.eot","hash":"d980c2ce873dc43af460d4d572d441304499f400","modified":1629257320618},{"_id":"public/css/fonts/fontawesome-webfont.ttf","hash":"13b1eab65a983c7a73bc7997c479d66943f7c6cb","modified":1629257320618},{"_id":"public/css/fonts/FontAwesome.otf","hash":"048707bc52ac4b6563aaa383bfe8660a0ddc908c","modified":1629257320618},{"_id":"public/css/images/banner.jpg","hash":"f44aa591089fcb3ec79770a1e102fd3289a7c6a6","modified":1629257320618},{"_id":"public/css/fonts/fontawesome-webfont.svg","hash":"98a8aa5cf7d62c2eff5f07ede8d844b874ef06ed","modified":1629257320618},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_category/category.styl","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1629257407578},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_tag/tag.styl","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1629257407593},{"_id":"node_modules/hexo-theme-fluid/.editorconfig","hash":"33218fbd623feb43edf5f99f15965392cecc44a6","modified":1629257407345},{"_id":"node_modules/hexo-theme-fluid/.eslintrc","hash":"4bc2b19ce2b8c4d242f97d4ccf2d741e68ab0097","modified":1629257407346},{"_id":"node_modules/hexo-theme-fluid/.gitattributes","hash":"a54f902957d49356376b59287b894b1a3d7a003f","modified":1629257407347},{"_id":"node_modules/hexo-theme-fluid/LICENSE","hash":"df5b54be535593d5442cebafbea34eb9bd69b987","modified":1629257407347},{"_id":"node_modules/hexo-theme-fluid/README_en.md","hash":"ca8fd19a4948de1f253616a62c0e8a7d81f692f5","modified":1629257407437},{"_id":"node_modules/hexo-theme-fluid/gulpfile.js","hash":"a7c87a83becf7080bddd14e81a6f09ce8c3df109","modified":1629257407418},{"_id":"node_modules/hexo-theme-fluid/package.json","hash":"45b68110fcaf5819452f45ecd77282f97d1386f5","modified":1629257407432},{"_id":"node_modules/hexo-theme-fluid/README.md","hash":"523b9db3801ca892124502c17d72864457cc4b21","modified":1629257407438},{"_id":"node_modules/hexo-theme-fluid/languages/de.yml","hash":"13a6a799415fc2f6f69ebd1a399fb44426a5d641","modified":1629257407599},{"_id":"node_modules/hexo-theme-fluid/_config.yml","hash":"dac9d10d95b9e179e8cd7c439300b450db51f0c2","modified":1629257407596},{"_id":"node_modules/hexo-theme-fluid/languages/eo.yml","hash":"a0c7984495d4f2d33b64adfa33adebbf768a5ac3","modified":1629257407599},{"_id":"node_modules/hexo-theme-fluid/languages/en.yml","hash":"a85dcc5cc21f9cab50df31e5001b8818ee62d1e2","modified":1629257407599},{"_id":"node_modules/hexo-theme-fluid/languages/ja.yml","hash":"91020031a847c0361a6fd7ab990c7be4bf17529b","modified":1629257407602},{"_id":"node_modules/hexo-theme-fluid/languages/zh-CN.yml","hash":"21307b4137c3d9b04bb58243747e75af0abc5a71","modified":1629257407602},{"_id":"node_modules/hexo-theme-fluid/languages/zh-TW.yml","hash":"1a6d415446da11dee5c5f400e7d67544fbe743ea","modified":1629257407603},{"_id":"node_modules/hexo-theme-fluid/layout/404.ejs","hash":"689d9f4efd2a7f5edfd9b24561a7ade69d46617c","modified":1629257407373},{"_id":"node_modules/hexo-theme-fluid/layout/about.ejs","hash":"ad6fed7b646d3ca961db83db0fbe020e3a5d42ad","modified":1629257407374},{"_id":"node_modules/hexo-theme-fluid/layout/archive.ejs","hash":"472d0813ca5b88000a7bc6039f33b7e27b5a3216","modified":1629257407378},{"_id":"node_modules/hexo-theme-fluid/layout/category.ejs","hash":"58291dfec65c36889dfce0ddc603540b67e4c598","modified":1629257407380},{"_id":"node_modules/hexo-theme-fluid/layout/categories.ejs","hash":"6cbd88a2ef9dd2198d72ccc1899c4966ac5f49f9","modified":1629257407379},{"_id":"node_modules/hexo-theme-fluid/layout/layout.ejs","hash":"9d6ff8772bf54d7458ae4e846e5a2d1f2921b8a7","modified":1629257407388},{"_id":"node_modules/hexo-theme-fluid/layout/index.ejs","hash":"a154785aef120988d29409847977f24069d3a3d5","modified":1629257407388},{"_id":"node_modules/hexo-theme-fluid/layout/links.ejs","hash":"19c6db0ccebc8f59fa4ef9567a066b33223eccd6","modified":1629257407389},{"_id":"node_modules/hexo-theme-fluid/layout/page.ejs","hash":"1014b901d396f4fc445cb1ffc938d5380d894d71","modified":1629257407394},{"_id":"node_modules/hexo-theme-fluid/layout/post.ejs","hash":"79e3679a7069351a6172c281b9d09f59d7580484","modified":1629257407396},{"_id":"node_modules/hexo-theme-fluid/layout/tag.ejs","hash":"0ad89eb7c92a822980fa9a85285e6d94ad845d1d","modified":1629257407400},{"_id":"node_modules/hexo-theme-fluid/layout/tags.ejs","hash":"1d06af34b6cf1d8a20d2eb565e309326ceba309f","modified":1629257407400},{"_id":"node_modules/hexo-theme-fluid/.github/ISSUE_TEMPLATE/bug_report.md","hash":"16d33eb89ecf90f4046720fde5395d972c7ba1fd","modified":1629257407435},{"_id":"node_modules/hexo-theme-fluid/.github/ISSUE_TEMPLATE/bug_report_zh.md","hash":"af977ed0792508bb0766ea8afe82d34ef1e8fb3c","modified":1629257407433},{"_id":"node_modules/hexo-theme-fluid/.github/ISSUE_TEMPLATE/feature_request_zh.md","hash":"ed08574b196447376dd74411cca664ac9227a5d4","modified":1629257407437},{"_id":"node_modules/hexo-theme-fluid/.github/ISSUE_TEMPLATE/feature_request.md","hash":"c134dd57ffd269b93402ccfffe7dbe0f0b583bec","modified":1629257407437},{"_id":"node_modules/hexo-theme-fluid/.github/ISSUE_TEMPLATE/question.md","hash":"ab5eab9e3ff889c4ba7fd82846e7f5b7ae15bebc","modified":1629257407437},{"_id":"node_modules/hexo-theme-fluid/.github/ISSUE_TEMPLATE/question_zh.md","hash":"e24b470f7aa8044499a4f5e39634e5dc43899011","modified":1629257407437},{"_id":"node_modules/hexo-theme-fluid/.github/workflows/limit.yaml","hash":"f8bd2edeb4424ee7a055b31583445d5d5dff91a4","modified":1629257407595},{"_id":"node_modules/hexo-theme-fluid/.github/workflows/lint.yaml","hash":"64d521c9c5b61d3a4852c74894fb574082dc7009","modified":1629257407596},{"_id":"node_modules/hexo-theme-fluid/layout/_partial/archive-list.ejs","hash":"8723aa57f61134a2c1dc84cc7ea88ea366f4fda3","modified":1629257407378},{"_id":"node_modules/hexo-theme-fluid/layout/_partial/beian.ejs","hash":"6ec30a9dd56341590af07f4227324f619025c109","modified":1629257407378},{"_id":"node_modules/hexo-theme-fluid/layout/_partial/css.ejs","hash":"cdcb607f1104543a42beda647f3c9cf0f3d11623","modified":1629257407382},{"_id":"node_modules/hexo-theme-fluid/layout/_partial/head.ejs","hash":"248ecd01aead6e07ac1904a7b7c45395a922bcc7","modified":1629257407385},{"_id":"node_modules/hexo-theme-fluid/layout/_partial/footer.ejs","hash":"39e63b3e1502803c9e8ea0c44ea662a7bbe15744","modified":1629257407384},{"_id":"node_modules/hexo-theme-fluid/layout/_partial/nav.ejs","hash":"245f49aad0e4124b52aa82d981281ad9c871f1f8","modified":1629257407391},{"_id":"node_modules/hexo-theme-fluid/layout/_partial/paginator.ejs","hash":"0f38a2c238169edcb63fc46c23bfc529ff3859b7","modified":1629257407394},{"_id":"node_modules/hexo-theme-fluid/layout/_partial/scripts.ejs","hash":"b3d93135d9ae74f006da31ec54343308bbd77cb5","modified":1629257407397},{"_id":"node_modules/hexo-theme-fluid/layout/_partial/post-meta.ejs","hash":"3e0fa1731b6e54dbcf52ccf8e200e83dc4549bfa","modified":1629257407395},{"_id":"node_modules/hexo-theme-fluid/layout/_partial/search.ejs","hash":"cdd7919fa01f6ef7ccc09938d662ff3d77f5d999","modified":1629257407398},{"_id":"node_modules/hexo-theme-fluid/scripts/events/index.js","hash":"44faef3e77ab08b91e4c5c6f1cd9087a9faff443","modified":1629257407420},{"_id":"node_modules/hexo-theme-fluid/scripts/filters/locals.js","hash":"58d0fec976f6b1d35e7ea03edc45414088acf05c","modified":1629257407426},{"_id":"node_modules/hexo-theme-fluid/layout/_partial/statistics.ejs","hash":"920bc618d357d48d2b96f8758f6ae8f9488fc4d8","modified":1629257407399},{"_id":"node_modules/hexo-theme-fluid/layout/_partial/toc.ejs","hash":"3d2fb5552f373e5a0c56bc356702d807bcbcb411","modified":1629257407401},{"_id":"node_modules/hexo-theme-fluid/scripts/filters/post-filter.js","hash":"6c37e9f1ac1d6d00b3c32794e02e244dba942cd9","modified":1629257407431},{"_id":"node_modules/hexo-theme-fluid/scripts/generators/local-search.js","hash":"fc2c50405b771b06b7f6cfc4e9de97b992691555","modified":1629257407424},{"_id":"node_modules/hexo-theme-fluid/scripts/generators/pages.js","hash":"d9971f15fbb6b775e3d31a1b9b45011959395010","modified":1629257407429},{"_id":"node_modules/hexo-theme-fluid/scripts/helpers/export-config.js","hash":"606131cb807846bf43776a9073fcc1473d359ec9","modified":1629257407416},{"_id":"node_modules/hexo-theme-fluid/scripts/helpers/page.js","hash":"4607607445233b3029ef20ed5e91de0da0a7f9c5","modified":1629257407428},{"_id":"node_modules/hexo-theme-fluid/scripts/helpers/url.js","hash":"99ab4551dc9c035abcc3bf4da5def2f63449d7ec","modified":1629257407431},{"_id":"node_modules/hexo-theme-fluid/scripts/helpers/utils.js","hash":"9045f47c7a71aab39f16cffb3e3847b752c2e0f1","modified":1629257407432},{"_id":"node_modules/hexo-theme-fluid/scripts/helpers/wordcount.js","hash":"e58d422eddb44c1be893f65f79f4c7feecfe6d5f","modified":1629257407432},{"_id":"node_modules/hexo-theme-fluid/scripts/tags/button.js","hash":"3eb43a8cdea0a64576ad6b31b4df6c2bf5698d4c","modified":1629257407411},{"_id":"node_modules/hexo-theme-fluid/scripts/tags/checkbox.js","hash":"63468f7875c09d9557fe8315afc97175745d9087","modified":1629257407411},{"_id":"node_modules/hexo-theme-fluid/scripts/tags/group-image.js","hash":"4aeebb797026f1df25646a5d69f7fde79b1bcd26","modified":1629257407418},{"_id":"node_modules/hexo-theme-fluid/scripts/tags/label.js","hash":"f05a6d32cca79535b22907dc03edb9d3fa2d8176","modified":1629257407422},{"_id":"node_modules/hexo-theme-fluid/scripts/tags/mermaid.js","hash":"75160561e1ef3603b6d2ad2938464ab1cb77fd38","modified":1629257407427},{"_id":"node_modules/hexo-theme-fluid/scripts/tags/note.js","hash":"f52f3a005b41f48b4da274ac64710177c8d4502f","modified":1629257407428},{"_id":"node_modules/hexo-theme-fluid/scripts/utils/join-path.js","hash":"629e7deb3955f750c1cfa6fc773f412e020fcef4","modified":1629257407421},{"_id":"node_modules/hexo-theme-fluid/scripts/utils/object.js","hash":"649457796374c79e49a19bd541e4ad8e78fe8995","modified":1629257407428},{"_id":"node_modules/hexo-theme-fluid/source/css/main.styl","hash":"d5a8a59c8d1fd17d699a951e59c4ce9ae44c419d","modified":1629257407588},{"_id":"node_modules/hexo-theme-fluid/source/img/avatar.png","hash":"fe739a158cc128f70f780eb5fa96f388b81d478f","modified":1629257407445},{"_id":"node_modules/hexo-theme-fluid/source/css/gitalk.css","hash":"a57b3cc8e04a0a4a27aefa07facf5b5e7bca0e76","modified":1629257407369},{"_id":"node_modules/hexo-theme-fluid/source/img/default.png","hash":"7bb2b8ee07db305bcadee2985b81b942027ae940","modified":1629257407455},{"_id":"node_modules/hexo-theme-fluid/source/img/favicon.png","hash":"64b215db2cb3af98fe639e94537cb5209f959c78","modified":1629257407458},{"_id":"node_modules/hexo-theme-fluid/source/js/boot.js","hash":"3de344ee619da989f6dccf7c2ae459fe91075983","modified":1629257407410},{"_id":"node_modules/hexo-theme-fluid/source/img/police_beian.png","hash":"90efded6baa2dde599a9d6b1387973e8e64923ea","modified":1629257407564},{"_id":"node_modules/hexo-theme-fluid/source/img/loading.gif","hash":"2d2fc0f947940f98c21afafef39ecf226a2e8d55","modified":1629257407408},{"_id":"node_modules/hexo-theme-fluid/source/js/events.js","hash":"4b9d2676c9544db9cc40a8c7d18456792299ba86","modified":1629257407415},{"_id":"node_modules/hexo-theme-fluid/source/js/img-lazyload.js","hash":"cbdeca434ec4da51f488c821d51b4d23c73294af","modified":1629257407420},{"_id":"node_modules/hexo-theme-fluid/source/js/leancloud.js","hash":"b7985ac3cff9ee2722db43ee6b32b5484c43f5f2","modified":1629257407423},{"_id":"node_modules/hexo-theme-fluid/source/js/color-schema.js","hash":"cc712fc71bf33d561e1ba74fe1d52d2353092171","modified":1629257407412},{"_id":"node_modules/hexo-theme-fluid/source/js/local-search.js","hash":"bf00f5786bb8de7241f635455b67243d26656222","modified":1629257407424},{"_id":"node_modules/hexo-theme-fluid/source/js/plugins.js","hash":"342b1fbc30d1465687ce389a4e07f967266d5d86","modified":1629257407430},{"_id":"node_modules/hexo-theme-fluid/layout/_partial/comments/changyan.ejs","hash":"725a1fe23c672fca87edc57739b748c3adf705da","modified":1629257407381},{"_id":"node_modules/hexo-theme-fluid/source/js/utils.js","hash":"9d492fab9c26311ad0ab553c890e09b9575a76f2","modified":1629257407432},{"_id":"node_modules/hexo-theme-fluid/source/xml/local-search.xml","hash":"8c96ba6a064705602ce28d096fd7dd9069630a55","modified":1629257407594},{"_id":"node_modules/hexo-theme-fluid/layout/_partial/comments/disqus.ejs","hash":"fb4502fc9204284f8b4e8dabde8477d478e826e5","modified":1629257407383},{"_id":"node_modules/hexo-theme-fluid/layout/_partial/comments/gitalk.ejs","hash":"843bc141a4545eb20d1c92fb63c85d459b4271ec","modified":1629257407384},{"_id":"node_modules/hexo-theme-fluid/layout/_partial/comments/cusdis.ejs","hash":"5f9dc012be27040bbe874d0c093c0d53958cc987","modified":1629257407383},{"_id":"node_modules/hexo-theme-fluid/layout/_partial/comments/remark42.ejs","hash":"d4e9532feeb02aed61bd15eda536b5b631454dac","modified":1629257407397},{"_id":"node_modules/hexo-theme-fluid/layout/_partial/comments/livere.ejs","hash":"2264758fed57542a7389c7aa9f00f1aefa17eb87","modified":1629257407389},{"_id":"node_modules/hexo-theme-fluid/layout/_partial/comments/twikoo.ejs","hash":"ffe08e76c9ebd4fc27715b8a60f385b3f10d0348","modified":1629257407401},{"_id":"node_modules/hexo-theme-fluid/layout/_partial/comments/utterances.ejs","hash":"e1ed6530dfd7310f91060a75766a93ac3c39be3a","modified":1629257407404},{"_id":"node_modules/hexo-theme-fluid/layout/_partial/comments/valine.ejs","hash":"9238063c5e2928bb6fce2b99cd25ad85e78c4d1c","modified":1629257407404},{"_id":"node_modules/hexo-theme-fluid/layout/_partial/plugins/analytics.ejs","hash":"557077a8825fffc0a2c7fe2b29f319287950244f","modified":1629257407377},{"_id":"node_modules/hexo-theme-fluid/layout/_partial/comments/waline.ejs","hash":"5b61661fbc65752f54f99402077dbb03044149a1","modified":1629257407405},{"_id":"node_modules/hexo-theme-fluid/layout/_partial/plugins/math.ejs","hash":"76c4e0608ae362a265ac5e9c0fc49f75c1bc568e","modified":1629257407390},{"_id":"node_modules/hexo-theme-fluid/layout/_partial/plugins/mermaid.ejs","hash":"10ed1f9a611449d37736e17c4e251127b38b3772","modified":1629257407391},{"_id":"node_modules/hexo-theme-fluid/layout/_partial/plugins/nprogress.ejs","hash":"4c2d39ce816b8a6dcd6b53113c8695f8bd650a23","modified":1629257407392},{"_id":"node_modules/hexo-theme-fluid/scripts/events/lib/compatible-configs.js","hash":"b5fd5a2d9c463eb59318af0f47c591c485b6ad27","modified":1629257407414},{"_id":"node_modules/hexo-theme-fluid/layout/_partial/plugins/typed.ejs","hash":"ab71df2e56b60e8e193ff827e81704e5b358a977","modified":1629257407403},{"_id":"node_modules/hexo-theme-fluid/scripts/events/lib/footnote.js","hash":"3b2abc5f5e3b681874637e98e047dc4969eb1983","modified":1629257407417},{"_id":"node_modules/hexo-theme-fluid/scripts/events/lib/hello.js","hash":"28e186c32576eb3d5d923273471a001c47fe8071","modified":1629257407419},{"_id":"node_modules/hexo-theme-fluid/scripts/events/lib/highlight.js","hash":"deed966f38cf0c8dee3f72e5b1f2e878510db0e1","modified":1629257407420},{"_id":"node_modules/hexo-theme-fluid/scripts/events/lib/lazyload.js","hash":"a2d08e3b9f98b6371b2e64d664f079c99571494b","modified":1629257407422},{"_id":"node_modules/hexo-theme-fluid/scripts/events/lib/merge-configs.js","hash":"c1db1a4f9eca6e36b660530641e3a4fb6a30c8d8","modified":1629257407427},{"_id":"node_modules/hexo-theme-fluid/source/css/_mixins/base.styl","hash":"542e306ee9494e8a78e44d6d7d409605d94caeb3","modified":1629257407575},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/pages.styl","hash":"b8e887bc7fb3b765a1f8ec9448eff8603a41984f","modified":1629257407589},{"_id":"node_modules/hexo-theme-fluid/source/css/_variables/base.styl","hash":"26d29403d8ecb0b533e63bde3ca73b2c91f171ff","modified":1629257407576},{"_id":"node_modules/hexo-theme-fluid/source/css/_functions/base.styl","hash":"2e46f3f4e2c9fe34c1ff1c598738fc7349ae8188","modified":1629257407574},{"_id":"node_modules/hexo-theme-fluid/source/lib/hint/hint.min.css","hash":"b38df228460ebfb4c0b6085336ee2878fe85aafe","modified":1629257407372},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_archive/archive.styl","hash":"6e6f22b664199772370b59ce1678b0c148b5849f","modified":1629257407571},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_about/about.styl","hash":"15d2786d00418e61022475194ad76445d68e27ea","modified":1629257407570},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_base/base.styl","hash":"dabd87267d60240c0daea0f35a46f30ee1b2337a","modified":1629257407576},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_base/color-schema.styl","hash":"32fb938d72b2d86159cb315a98b086bd17fa4415","modified":1629257407581},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_base/keyframes.styl","hash":"94065ea50f5bef7566d184f2422f6ac20866ba22","modified":1629257407585},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_base/inline.styl","hash":"d547ab0b91f84eb0acd0bc0c5d716ce17c30361a","modified":1629257407585},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_category/categories.styl","hash":"1ab7db37c2f7dc7ccdb994dcb41c16a4c8920397","modified":1629257407578},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_base/rewrite.styl","hash":"4c6fffc6d4a3b8830931800ee7da99dccf1be36e","modified":1629257407592},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_index/index.styl","hash":"ad7dcc8a060d94d3c44ca5e0788a24ca38be0f79","modified":1629257407585},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_links/links.styl","hash":"cd4ebb1426abed9fda93b797b02c6d5dd71dc2a1","modified":1629257407587},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_post/post.styl","hash":"3a6b4f8a29648d9d2c1e99b52a7b42df3f15cf62","modified":1629257407590},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_post/tag_plugin.styl","hash":"766fcf017deb4c8b0c260ac4c8d2e3489407ad89","modified":1629257407593},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_tag/tags.styl","hash":"65bfc01c76abc927fa1a23bf2422892b0d566c3f","modified":1629257407594},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_base/_widget/board.styl","hash":"32d90bcc8bf2fd5d8d78e86a567973d4b69bcfa1","modified":1629257407576},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_base/_widget/banner.styl","hash":"30f8fab95a5214d79df0ccc02b937df8bd885676","modified":1629257407573},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_base/_widget/copy-btn.styl","hash":"9f932ca3f9625c13aa5353f58319881e62c0c653","modified":1629257407582},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_base/_widget/footer.styl","hash":"35539a1ce8476e75515015a06d01ec66e4af6834","modified":1629257407583},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_base/_widget/header.styl","hash":"d8011325756eb6e4ce619b3e7b4d6d80c2de8a57","modified":1629257407584},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_base/_widget/footnote.styl","hash":"ae9289cc89649af2042907f8a003303b987f3404","modified":1629257407583},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_base/_widget/qrcode.styl","hash":"461d609a802a4f9aa9f492411ed8074813a956b7","modified":1629257407591},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_base/_widget/scroll-btn.styl","hash":"55e10a6965462f8f62f85e75fd5e143af02a4b44","modified":1629257407592},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_base/_widget/search.styl","hash":"10f7e91a91e681fb9fe46f9df7707b9ef78707c8","modified":1629257407593},{"_id":"public/local-search.xml","hash":"278708e86a7b879f974ad34a2da9fffc2f555e22","modified":1630661469413},{"_id":"public/404.html","hash":"24e020273b4a4460f80849a8450e3ddbf4278787","modified":1629776785338},{"_id":"public/tags/index.html","hash":"715c1a485d64e82e61bd1a88ec211173d1488fcc","modified":1629903994022},{"_id":"public/categories/index.html","hash":"157ba532bac8c63775bc202354b2de37ec263ad3","modified":1629903994022},{"_id":"public/links/index.html","hash":"6c203edc7c4f7caa29fba41b9f70b4a9ff25fbc1","modified":1629776785338},{"_id":"public/img/default.png","hash":"7bb2b8ee07db305bcadee2985b81b942027ae940","modified":1629258589263},{"_id":"public/img/avatar.png","hash":"fe739a158cc128f70f780eb5fa96f388b81d478f","modified":1629258589263},{"_id":"public/img/favicon.png","hash":"64b215db2cb3af98fe639e94537cb5209f959c78","modified":1629258589263},{"_id":"public/xml/local-search.xml","hash":"8c96ba6a064705602ce28d096fd7dd9069630a55","modified":1629258589263},{"_id":"public/img/loading.gif","hash":"2d2fc0f947940f98c21afafef39ecf226a2e8d55","modified":1629258589263},{"_id":"public/img/police_beian.png","hash":"90efded6baa2dde599a9d6b1387973e8e64923ea","modified":1629258589263},{"_id":"public/js/boot.js","hash":"3de344ee619da989f6dccf7c2ae459fe91075983","modified":1629258589263},{"_id":"public/js/events.js","hash":"4b9d2676c9544db9cc40a8c7d18456792299ba86","modified":1629258589263},{"_id":"public/js/color-schema.js","hash":"cc712fc71bf33d561e1ba74fe1d52d2353092171","modified":1629258589263},{"_id":"public/css/gitalk.css","hash":"a57b3cc8e04a0a4a27aefa07facf5b5e7bca0e76","modified":1629258589263},{"_id":"public/js/img-lazyload.js","hash":"cbdeca434ec4da51f488c821d51b4d23c73294af","modified":1629258589263},{"_id":"public/js/leancloud.js","hash":"b7985ac3cff9ee2722db43ee6b32b5484c43f5f2","modified":1629258589263},{"_id":"public/js/utils.js","hash":"9d492fab9c26311ad0ab553c890e09b9575a76f2","modified":1629258589263},{"_id":"public/js/local-search.js","hash":"bf00f5786bb8de7241f635455b67243d26656222","modified":1629258589263},{"_id":"public/js/plugins.js","hash":"342b1fbc30d1465687ce389a4e07f967266d5d86","modified":1629258589263},{"_id":"public/lib/hint/hint.min.css","hash":"b38df228460ebfb4c0b6085336ee2878fe85aafe","modified":1629258589263},{"_id":"public/css/main.css","hash":"be9a0652de06d61fa26f4b4128b29bcc5a4a0ad7","modified":1629258589263},{"_id":"source/.DS_Store","hash":"57e73a4a047e64ad8dd0df5125e5ce5a93417ae3","modified":1629726465909},{"_id":"source/img/page1/photo.png","hash":"41f5ac5618f938e1f0f763fa0c4b141122556c31","modified":1628693618417},{"_id":"public/img/page1/photo.png","hash":"41f5ac5618f938e1f0f763fa0c4b141122556c31","modified":1629266790034},{"_id":"source/img/.DS_Store","hash":"ba289c4c0b831bd9345622494226fc2951dd21b0","modified":1630481776713},{"_id":"source/img/abg/favicon.jpg","hash":"5355e7cb3382dc2733338e13542c2c318a0a3516","modified":1629267093000},{"_id":"source/img/abg/default.jpg","hash":"c5e4f5a6bbc8196771c2a5bd0e967d6e2d1f0368","modified":1629269734000},{"_id":"public/img/abg/favicon.jpg","hash":"5355e7cb3382dc2733338e13542c2c318a0a3516","modified":1629271940099},{"_id":"public/img/abg/default.jpg","hash":"c5e4f5a6bbc8196771c2a5bd0e967d6e2d1f0368","modified":1629271940099},{"_id":"source/about/index.md","hash":"9b63de9246ee185b3e442616e7c1201eb0f50a1d","modified":1629278699784},{"_id":"source/_posts/微服务概述.md","hash":"6bda4d3d5db266381037ef1e27a8ff98f96d2f63","modified":1629298754146},{"_id":"public/about/index.html","hash":"d13abce16786ab6eb075226fb86f8bf3ae36e03d","modified":1629776785338},{"_id":"public/2021/08/18/微服务概述/index.html","hash":"c9cfcfbe00ee92a739918a2a18fab23e385f8644","modified":1629776785338},{"_id":"source/img/micro/top.png","hash":"e9a2b17f218a68188dcd6afb660206080b7523f8","modified":1629281723104},{"_id":"public/categories/架构/index.html","hash":"24f73034bdfbc01cfef511497003025334bafbbb","modified":1629776785338},{"_id":"public/tags/ddd/index.html","hash":"4ff49be786e8c844e1ca3785102a41c0d99c49cc","modified":1629776785338},{"_id":"public/tags/微服务/index.html","hash":"4671f52f27ad7d0e820ffd3e1757b30ac5f48f31","modified":1629776785338},{"_id":"public/img/micro/top.png","hash":"e9a2b17f218a68188dcd6afb660206080b7523f8","modified":1629281764758},{"_id":"source/img/micro/banner.jpg","hash":"8f6b3e89c6d6f183f0d03c6f97d21b2b87cdc76c","modified":1629293742175},{"_id":"public/img/micro/banner.jpg","hash":"8f6b3e89c6d6f183f0d03c6f97d21b2b87cdc76c","modified":1629294544576},{"_id":"source/CNAME","hash":"ed23b6fccb9994b0407e2b78d1a687bcc6343cd7","modified":1629338173642},{"_id":"public/CNAME","hash":"ed23b6fccb9994b0407e2b78d1a687bcc6343cd7","modified":1629338186415},{"_id":"source/_posts/docker-compose搭建MySql主从和双主.md","hash":"bf481cea9657f8267f4ddec4716c5d13fdf9e6c0","modified":1629727218942},{"_id":"source/img/mysql/mysql-m-s.png","hash":"38b32caacde54b3981ac2a67489eb9b13f18f19a","modified":1629726519031},{"_id":"source/img/mysql/mysql.png","hash":"b32675731302b1cd1816bf0edc4bba403ca12671","modified":1629726855583},{"_id":"source/img/mysql/banner-1.jpg","hash":"759f8bfa9a895292082f56c89c5fbd783a0dbb39","modified":1629727156694},{"_id":"public/categories/存储/index.html","hash":"6b9215477293d3558820962445a26668150e2a69","modified":1629903994022},{"_id":"public/tags/mysql/index.html","hash":"8a050ede89f5fc194e42fc2d42b47e2670bf269d","modified":1629903994022},{"_id":"public/tags/高可用/index.html","hash":"38643335bd560addc9c9524443a79be42d731721","modified":1629776785338},{"_id":"public/tags/数据同步/index.html","hash":"14f6a18f6150d7d3bf0ef554cff286c1cc6adc66","modified":1629776785338},{"_id":"public/2021/08/23/docker-compose搭建MySql主从和双主/index.html","hash":"31a566aa16e69234212ed41443ad11acf4d4599b","modified":1629903994022},{"_id":"public/img/mysql/mysql.png","hash":"b32675731302b1cd1816bf0edc4bba403ca12671","modified":1629727312185},{"_id":"public/img/mysql/mysql-m-s.png","hash":"38b32caacde54b3981ac2a67489eb9b13f18f19a","modified":1629727312185},{"_id":"public/img/mysql/banner-1.jpg","hash":"759f8bfa9a895292082f56c89c5fbd783a0dbb39","modified":1629727312185},{"_id":"source/_posts/MySQL事务的隔离性和隔离级别.md","hash":"8b4533480c2c7a48130053e45e74587d0267da94","modified":1629895183115},{"_id":"public/2021/08/25/MySQL事务的隔离性和隔离级别/index.html","hash":"3567cf0a3418f6823a116a765bcdcf1f66418f0f","modified":1629896973004},{"_id":"public/tags/mvcc/index.html","hash":"bf8fae070979153a5f3907f9fa7ec4a6ca9c1a4d","modified":1629885327858},{"_id":"public/tags/ACID/index.html","hash":"4c80cb04d18c75b5dee3f1a4cafd7904ec20d81e","modified":1629885327858},{"_id":"public/sitemap.xml","hash":"3b00427edf277bfabe0cb89d6cfd4d603b608ba6","modified":1630661469413},{"_id":"public/baidusitemap.xml","hash":"b5675086c1eeeab925357affecdc2249036c15e0","modified":1630661469413},{"_id":"source/_drafts/MySQL事务的隔离性和隔离级别.md","hash":"8b4533480c2c7a48130053e45e74587d0267da94","modified":1629897233306},{"_id":"source/_drafts/设置MySQL的隔离级别.md","hash":"35df4e787497852f535e1df997eb1e8a70041bae","modified":1629904015478},{"_id":"source/_posts/设置MySQL的隔离级别.md","hash":"c2a45260f14eacca381a8f81f84ff133f994f68f","modified":1629964792081},{"_id":"public/2021/08/25/设置MySQL的隔离级别/index.html","hash":"1b2661a49f1e98273c60824bfe55000d25c0da06","modified":1630661469413},{"_id":"source/img/mysql/isolation.jpg","hash":"857eeda51d229fbcf1382a2a676b101158e438a3","modified":1629904327912},{"_id":"public/img/mysql/isolation.jpg","hash":"857eeda51d229fbcf1382a2a676b101158e438a3","modified":1629904440295},{"_id":"source/_posts/一致性哈希算法以及Go实现.md","hash":"fdd18b62bc63fef580ffc1145d8a60e34a1ea956","modified":1630661448657},{"_id":"source/img/hash/redis-hash-cache.png","hash":"3eb4f7e728c9fd0d1ea8a971030c6665725dbe2e","modified":1630481761124},{"_id":"source/img/hash/redis-hash-cache.jpg","hash":"74aae94646080d802e7cbb687219a62cdc258afa","modified":1630481694115},{"_id":"source/img/hash/cricle-hash-2.png","hash":"48565c305ecd06fc2e08cf87d9fc17dadcd8e456","modified":1630486090343},{"_id":"source/img/hash/cricle-hash-1.jpg","hash":"af958e472733b4ed8d8ae882ef46722cea6894e9","modified":1630484480178},{"_id":"source/img/hash/cricle-hash-3.png","hash":"29dd5ad26cf819836b0864548538414fa76df6bb","modified":1630504867304},{"_id":"public/2021/08/31/一致性哈希算法以及Go实现/index.html","hash":"8dcb463626a887d7f4b724f99a50340083c8ac19","modified":1630661469413},{"_id":"public/img/hash/redis-hash-cache.jpg","hash":"74aae94646080d802e7cbb687219a62cdc258afa","modified":1630661469413},{"_id":"public/img/hash/cricle-hash-2.png","hash":"48565c305ecd06fc2e08cf87d9fc17dadcd8e456","modified":1630661469413},{"_id":"public/img/hash/cricle-hash-1.jpg","hash":"af958e472733b4ed8d8ae882ef46722cea6894e9","modified":1630661469413},{"_id":"public/img/hash/redis-hash-cache.png","hash":"3eb4f7e728c9fd0d1ea8a971030c6665725dbe2e","modified":1630661469413},{"_id":"public/img/hash/cricle-hash-3.png","hash":"29dd5ad26cf819836b0864548538414fa76df6bb","modified":1630661469413}],"Category":[{"name":"微服务","_id":"ckshbbndm0000oa8zfb3rftn5"},{"name":"架构","_id":"ckshc2kdo00002r8z2adqd3mj"},{"name":"存储","_id":"cksoctoh70001mn8z7tr052fq"}],"Data":[],"Page":[{"title":"about","date":"2021-08-18T09:24:59.000Z","_content":"","source":"about/index.md","raw":"---\ntitle: about\ndate: 2021-08-18 17:24:59\n---\n","updated":"2021-08-18T09:24:59.784Z","path":"about/index.html","comments":1,"layout":"page","_id":"ckshaj2420000ie8zc36i3pf4","content":"","site":{"data":{}},"excerpt":"","more":""}],"Post":[{"title":"微服务概述","date":"2021-08-18T09:26:08.000Z","index_img":"/img/micro/top.png","banner_img":"/img/micro/banner.jpg","_content":"\n## 微服务起源\n\n### 单体应用的缺点\n\n- 单体应用复杂\n- 应用无法拓展\n- 可靠性低\n- 敏捷开发和快速部署无法完成\n\n***由此产生微服务***\n\n> 一切争端的开始\n\n### 微服务的演变\n\n微服务本质上是对面向架构的模式(SOA)的一种实践\n\n微服务的特点:\n\n- 小即是美\n- 单一职责\n- 尽可能早创建原型\n- 可以执行比效率更重要\n\n### 微服务的定义\n\n围绕业务功能构建的，服务关注单一业务，服务间采用轻量级的通信机制，可以全自动独立部署，可以使用不同的编程语言和数据存储技术。微服务架构通过业务拆分实现服务组件化，通过组件组合快速开发系统，业务单一的服务组件又可以独立部署，使得整个系统变得清晰灵活\n\n***核心： 化繁为简 分而治之***\n\n优点：\n\n- 原子服务\n- 独立部署\n- 隔离部署\n- 去中心化服务治理\n\n缺点：\n\n- 基础设施建设复杂度高\n- 分布式服务间通信机制变得复杂 对不可用节点服务处理变得更加复杂\n- 分布式的分区数据库 对分布式事物等需要做对应的复杂处理\n- 测试整体的微服务架构复杂\n- 服务间的依赖 局部升级可能影响整体\n\n## 微服务设计思路\n\n### 组件服务化\n\n- kit:一个微服务的基础库（框架）\n- service: 业务业务代码+kit依赖+第三方组件的依赖\n- RPC+message queue: 轻量级通讯\n\n### 按业务组织服务\n\n事实上传统应用设计架构的分层结构正反映了不同角色的沟通结构。所以若要按微服务的方式来构建应用，也需要对应调整团队的组织架构。每个服务背后的小团队的组织是跨功能的，包含实现业务所需的全面的技能\n\n### 去中心化\n\n- 数据去中心化\n- 治理去中心化\n- 技术去中心化\n\n### 基础设施自动化\n\n- ci/cd\n- auto testing\n- 在线监控\n\n### 服务兼容性设计\n\n发送时要保守，接收时要开放。按照伯斯塔尔法则的思想来设计和实现服务时，发送的数据要更保守，意味着最小化的传送必要的信息，接收时更开放意味着要最大限度的容忍冗余数据，保证兼容性。\n\n- 负载均衡\n- 超时控制\n- 负载保护\n- 隔离\n- 限流\n- 降级\n- 重试\n- 熔断\n\n## 微服务设计\n\n### API GATEWAY\n\n> backend for forntend BFF 可以认为是一种适配服务，将后端的微服务进行适配（主要包括聚合裁剪和格式适配等逻辑），向无线端设备暴露友好和统一的 API，方便无线设备接入访问后端服务\n\n### 微服务的划分\n\n### 微服务的安全\n\n## 服务发现 & GRPC\n\n### GRPC\n\n- 多语言：语言中立，支持多种语言。\n- 轻量级、高性能：序列化支持 PB（Protocol Buffer）和 JSON，PB 是一种语言无关的高性能序列化框架\n- 可插拔\n- IDL：基于文件定义服务，通过 proto3 工具生成指定语言的数据结构、服务端接口以及客户端 Stub\n- 移动端：基于标准的 HTTP/2 设计，支持双向流、消息头压缩、单 TCP 的多路复用、服务端推送等特性，这些特性使得 gRPC 在移动端设备上更加省电和节省网络流量。\n- 服务而非对象 消息而非引用：促进微服务的系统间粗粒度消息交互设计理念\n- 负载无关的：不同的服务需要使用不同的消息类型和编码，例如 protocol buffers、JSON、XML 和 Thrift。\n- 流：Streaming API。\n- 阻塞式和非阻塞式：支持异步和同步处理在客户端和服务端间交互的消息序列。\n- 元数据交换：常见的横切关注点，如认证或跟踪，依赖数据交换。\n- 标准化状态码：客户端通常以有限的方式响应 API 调用返回的错误 \n\n### 服务发现\n\n- 客户端发现：\n直连 比服务端服务发现少一次网络跳转 Consumer 需要内置特定的服务发现客户端和发现逻辑\n\n- 服务端发现：\nConsumer 无需关注服务发现具体细节 只需知道服务的 DNS 域名即可 支持异构语言开发 需要基础设施支撑 多了一次网络跳转 可能有性能损失\n\n- 服务网格 service mesh:\n通过sidercar 方式隐式的支持服务发现（待补充）\n\n## 多集群 & 多租户\n\n### 多集群\n\n为了保证服务的可用性 已经对异常情况的预处理 使用多集群的方式提高系统的可用能力\n\n### 多租户\n\n在一个微服务架构中允许多系统共存是利用微服务稳定性以及模块化最有效的方式之一 这种方式一般被称为多租户（multi-tenancy）\n\n通过不同的租户区分不同的业务功能：\n\n- 红蓝发布\n- 灰度测试\n- 模块测试\n\n> 多租户的概念较为模糊\n> 思考？ 多租户中是怎样实现在上下文中传递多租户信息的?\n","source":"_posts/微服务概述.md","raw":"---\ntitle: 微服务概述\ndate: 2021-08-18 17:26:08\nindex_img: /img/micro/top.png\nbanner_img: /img/micro/banner.jpg\ncategories:\n- 架构\ntags:\n- 微服务\n- ddd\n---\n\n## 微服务起源\n\n### 单体应用的缺点\n\n- 单体应用复杂\n- 应用无法拓展\n- 可靠性低\n- 敏捷开发和快速部署无法完成\n\n***由此产生微服务***\n\n> 一切争端的开始\n\n### 微服务的演变\n\n微服务本质上是对面向架构的模式(SOA)的一种实践\n\n微服务的特点:\n\n- 小即是美\n- 单一职责\n- 尽可能早创建原型\n- 可以执行比效率更重要\n\n### 微服务的定义\n\n围绕业务功能构建的，服务关注单一业务，服务间采用轻量级的通信机制，可以全自动独立部署，可以使用不同的编程语言和数据存储技术。微服务架构通过业务拆分实现服务组件化，通过组件组合快速开发系统，业务单一的服务组件又可以独立部署，使得整个系统变得清晰灵活\n\n***核心： 化繁为简 分而治之***\n\n优点：\n\n- 原子服务\n- 独立部署\n- 隔离部署\n- 去中心化服务治理\n\n缺点：\n\n- 基础设施建设复杂度高\n- 分布式服务间通信机制变得复杂 对不可用节点服务处理变得更加复杂\n- 分布式的分区数据库 对分布式事物等需要做对应的复杂处理\n- 测试整体的微服务架构复杂\n- 服务间的依赖 局部升级可能影响整体\n\n## 微服务设计思路\n\n### 组件服务化\n\n- kit:一个微服务的基础库（框架）\n- service: 业务业务代码+kit依赖+第三方组件的依赖\n- RPC+message queue: 轻量级通讯\n\n### 按业务组织服务\n\n事实上传统应用设计架构的分层结构正反映了不同角色的沟通结构。所以若要按微服务的方式来构建应用，也需要对应调整团队的组织架构。每个服务背后的小团队的组织是跨功能的，包含实现业务所需的全面的技能\n\n### 去中心化\n\n- 数据去中心化\n- 治理去中心化\n- 技术去中心化\n\n### 基础设施自动化\n\n- ci/cd\n- auto testing\n- 在线监控\n\n### 服务兼容性设计\n\n发送时要保守，接收时要开放。按照伯斯塔尔法则的思想来设计和实现服务时，发送的数据要更保守，意味着最小化的传送必要的信息，接收时更开放意味着要最大限度的容忍冗余数据，保证兼容性。\n\n- 负载均衡\n- 超时控制\n- 负载保护\n- 隔离\n- 限流\n- 降级\n- 重试\n- 熔断\n\n## 微服务设计\n\n### API GATEWAY\n\n> backend for forntend BFF 可以认为是一种适配服务，将后端的微服务进行适配（主要包括聚合裁剪和格式适配等逻辑），向无线端设备暴露友好和统一的 API，方便无线设备接入访问后端服务\n\n### 微服务的划分\n\n### 微服务的安全\n\n## 服务发现 & GRPC\n\n### GRPC\n\n- 多语言：语言中立，支持多种语言。\n- 轻量级、高性能：序列化支持 PB（Protocol Buffer）和 JSON，PB 是一种语言无关的高性能序列化框架\n- 可插拔\n- IDL：基于文件定义服务，通过 proto3 工具生成指定语言的数据结构、服务端接口以及客户端 Stub\n- 移动端：基于标准的 HTTP/2 设计，支持双向流、消息头压缩、单 TCP 的多路复用、服务端推送等特性，这些特性使得 gRPC 在移动端设备上更加省电和节省网络流量。\n- 服务而非对象 消息而非引用：促进微服务的系统间粗粒度消息交互设计理念\n- 负载无关的：不同的服务需要使用不同的消息类型和编码，例如 protocol buffers、JSON、XML 和 Thrift。\n- 流：Streaming API。\n- 阻塞式和非阻塞式：支持异步和同步处理在客户端和服务端间交互的消息序列。\n- 元数据交换：常见的横切关注点，如认证或跟踪，依赖数据交换。\n- 标准化状态码：客户端通常以有限的方式响应 API 调用返回的错误 \n\n### 服务发现\n\n- 客户端发现：\n直连 比服务端服务发现少一次网络跳转 Consumer 需要内置特定的服务发现客户端和发现逻辑\n\n- 服务端发现：\nConsumer 无需关注服务发现具体细节 只需知道服务的 DNS 域名即可 支持异构语言开发 需要基础设施支撑 多了一次网络跳转 可能有性能损失\n\n- 服务网格 service mesh:\n通过sidercar 方式隐式的支持服务发现（待补充）\n\n## 多集群 & 多租户\n\n### 多集群\n\n为了保证服务的可用性 已经对异常情况的预处理 使用多集群的方式提高系统的可用能力\n\n### 多租户\n\n在一个微服务架构中允许多系统共存是利用微服务稳定性以及模块化最有效的方式之一 这种方式一般被称为多租户（multi-tenancy）\n\n通过不同的租户区分不同的业务功能：\n\n- 红蓝发布\n- 灰度测试\n- 模块测试\n\n> 多租户的概念较为模糊\n> 思考？ 多租户中是怎样实现在上下文中传递多租户信息的?\n","slug":"微服务概述","published":1,"updated":"2021-08-18T14:59:14.146Z","_id":"ckshaj2460001ie8zaa5998l6","comments":1,"layout":"post","photos":[],"link":"","content":"<h2 id=\"微服务起源\"><a href=\"#微服务起源\" class=\"headerlink\" title=\"微服务起源\"></a>微服务起源</h2><h3 id=\"单体应用的缺点\"><a href=\"#单体应用的缺点\" class=\"headerlink\" title=\"单体应用的缺点\"></a>单体应用的缺点</h3><ul>\n<li>单体应用复杂</li>\n<li>应用无法拓展</li>\n<li>可靠性低</li>\n<li>敏捷开发和快速部署无法完成</li>\n</ul>\n<p><em><strong>由此产生微服务</strong></em></p>\n<blockquote>\n<p>一切争端的开始</p>\n</blockquote>\n<h3 id=\"微服务的演变\"><a href=\"#微服务的演变\" class=\"headerlink\" title=\"微服务的演变\"></a>微服务的演变</h3><p>微服务本质上是对面向架构的模式(SOA)的一种实践</p>\n<p>微服务的特点:</p>\n<ul>\n<li>小即是美</li>\n<li>单一职责</li>\n<li>尽可能早创建原型</li>\n<li>可以执行比效率更重要</li>\n</ul>\n<h3 id=\"微服务的定义\"><a href=\"#微服务的定义\" class=\"headerlink\" title=\"微服务的定义\"></a>微服务的定义</h3><p>围绕业务功能构建的，服务关注单一业务，服务间采用轻量级的通信机制，可以全自动独立部署，可以使用不同的编程语言和数据存储技术。微服务架构通过业务拆分实现服务组件化，通过组件组合快速开发系统，业务单一的服务组件又可以独立部署，使得整个系统变得清晰灵活</p>\n<p><em><strong>核心： 化繁为简 分而治之</strong></em></p>\n<p>优点：</p>\n<ul>\n<li>原子服务</li>\n<li>独立部署</li>\n<li>隔离部署</li>\n<li>去中心化服务治理</li>\n</ul>\n<p>缺点：</p>\n<ul>\n<li>基础设施建设复杂度高</li>\n<li>分布式服务间通信机制变得复杂 对不可用节点服务处理变得更加复杂</li>\n<li>分布式的分区数据库 对分布式事物等需要做对应的复杂处理</li>\n<li>测试整体的微服务架构复杂</li>\n<li>服务间的依赖 局部升级可能影响整体</li>\n</ul>\n<h2 id=\"微服务设计思路\"><a href=\"#微服务设计思路\" class=\"headerlink\" title=\"微服务设计思路\"></a>微服务设计思路</h2><h3 id=\"组件服务化\"><a href=\"#组件服务化\" class=\"headerlink\" title=\"组件服务化\"></a>组件服务化</h3><ul>\n<li>kit:一个微服务的基础库（框架）</li>\n<li>service: 业务业务代码+kit依赖+第三方组件的依赖</li>\n<li>RPC+message queue: 轻量级通讯</li>\n</ul>\n<h3 id=\"按业务组织服务\"><a href=\"#按业务组织服务\" class=\"headerlink\" title=\"按业务组织服务\"></a>按业务组织服务</h3><p>事实上传统应用设计架构的分层结构正反映了不同角色的沟通结构。所以若要按微服务的方式来构建应用，也需要对应调整团队的组织架构。每个服务背后的小团队的组织是跨功能的，包含实现业务所需的全面的技能</p>\n<h3 id=\"去中心化\"><a href=\"#去中心化\" class=\"headerlink\" title=\"去中心化\"></a>去中心化</h3><ul>\n<li>数据去中心化</li>\n<li>治理去中心化</li>\n<li>技术去中心化</li>\n</ul>\n<h3 id=\"基础设施自动化\"><a href=\"#基础设施自动化\" class=\"headerlink\" title=\"基础设施自动化\"></a>基础设施自动化</h3><ul>\n<li>ci/cd</li>\n<li>auto testing</li>\n<li>在线监控</li>\n</ul>\n<h3 id=\"服务兼容性设计\"><a href=\"#服务兼容性设计\" class=\"headerlink\" title=\"服务兼容性设计\"></a>服务兼容性设计</h3><p>发送时要保守，接收时要开放。按照伯斯塔尔法则的思想来设计和实现服务时，发送的数据要更保守，意味着最小化的传送必要的信息，接收时更开放意味着要最大限度的容忍冗余数据，保证兼容性。</p>\n<ul>\n<li>负载均衡</li>\n<li>超时控制</li>\n<li>负载保护</li>\n<li>隔离</li>\n<li>限流</li>\n<li>降级</li>\n<li>重试</li>\n<li>熔断</li>\n</ul>\n<h2 id=\"微服务设计\"><a href=\"#微服务设计\" class=\"headerlink\" title=\"微服务设计\"></a>微服务设计</h2><h3 id=\"API-GATEWAY\"><a href=\"#API-GATEWAY\" class=\"headerlink\" title=\"API GATEWAY\"></a>API GATEWAY</h3><blockquote>\n<p>backend for forntend BFF 可以认为是一种适配服务，将后端的微服务进行适配（主要包括聚合裁剪和格式适配等逻辑），向无线端设备暴露友好和统一的 API，方便无线设备接入访问后端服务</p>\n</blockquote>\n<h3 id=\"微服务的划分\"><a href=\"#微服务的划分\" class=\"headerlink\" title=\"微服务的划分\"></a>微服务的划分</h3><h3 id=\"微服务的安全\"><a href=\"#微服务的安全\" class=\"headerlink\" title=\"微服务的安全\"></a>微服务的安全</h3><h2 id=\"服务发现-amp-GRPC\"><a href=\"#服务发现-amp-GRPC\" class=\"headerlink\" title=\"服务发现 &amp; GRPC\"></a>服务发现 &amp; GRPC</h2><h3 id=\"GRPC\"><a href=\"#GRPC\" class=\"headerlink\" title=\"GRPC\"></a>GRPC</h3><ul>\n<li>多语言：语言中立，支持多种语言。</li>\n<li>轻量级、高性能：序列化支持 PB（Protocol Buffer）和 JSON，PB 是一种语言无关的高性能序列化框架</li>\n<li>可插拔</li>\n<li>IDL：基于文件定义服务，通过 proto3 工具生成指定语言的数据结构、服务端接口以及客户端 Stub</li>\n<li>移动端：基于标准的 HTTP/2 设计，支持双向流、消息头压缩、单 TCP 的多路复用、服务端推送等特性，这些特性使得 gRPC 在移动端设备上更加省电和节省网络流量。</li>\n<li>服务而非对象 消息而非引用：促进微服务的系统间粗粒度消息交互设计理念</li>\n<li>负载无关的：不同的服务需要使用不同的消息类型和编码，例如 protocol buffers、JSON、XML 和 Thrift。</li>\n<li>流：Streaming API。</li>\n<li>阻塞式和非阻塞式：支持异步和同步处理在客户端和服务端间交互的消息序列。</li>\n<li>元数据交换：常见的横切关注点，如认证或跟踪，依赖数据交换。</li>\n<li>标准化状态码：客户端通常以有限的方式响应 API 调用返回的错误 </li>\n</ul>\n<h3 id=\"服务发现\"><a href=\"#服务发现\" class=\"headerlink\" title=\"服务发现\"></a>服务发现</h3><ul>\n<li><p>客户端发现：<br>直连 比服务端服务发现少一次网络跳转 Consumer 需要内置特定的服务发现客户端和发现逻辑</p>\n</li>\n<li><p>服务端发现：<br>Consumer 无需关注服务发现具体细节 只需知道服务的 DNS 域名即可 支持异构语言开发 需要基础设施支撑 多了一次网络跳转 可能有性能损失</p>\n</li>\n<li><p>服务网格 service mesh:<br>通过sidercar 方式隐式的支持服务发现（待补充）</p>\n</li>\n</ul>\n<h2 id=\"多集群-amp-多租户\"><a href=\"#多集群-amp-多租户\" class=\"headerlink\" title=\"多集群 &amp; 多租户\"></a>多集群 &amp; 多租户</h2><h3 id=\"多集群\"><a href=\"#多集群\" class=\"headerlink\" title=\"多集群\"></a>多集群</h3><p>为了保证服务的可用性 已经对异常情况的预处理 使用多集群的方式提高系统的可用能力</p>\n<h3 id=\"多租户\"><a href=\"#多租户\" class=\"headerlink\" title=\"多租户\"></a>多租户</h3><p>在一个微服务架构中允许多系统共存是利用微服务稳定性以及模块化最有效的方式之一 这种方式一般被称为多租户（multi-tenancy）</p>\n<p>通过不同的租户区分不同的业务功能：</p>\n<ul>\n<li>红蓝发布</li>\n<li>灰度测试</li>\n<li>模块测试</li>\n</ul>\n<blockquote>\n<p>多租户的概念较为模糊<br>思考？ 多租户中是怎样实现在上下文中传递多租户信息的?</p>\n</blockquote>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"微服务起源\"><a href=\"#微服务起源\" class=\"headerlink\" title=\"微服务起源\"></a>微服务起源</h2><h3 id=\"单体应用的缺点\"><a href=\"#单体应用的缺点\" class=\"headerlink\" title=\"单体应用的缺点\"></a>单体应用的缺点</h3><ul>\n<li>单体应用复杂</li>\n<li>应用无法拓展</li>\n<li>可靠性低</li>\n<li>敏捷开发和快速部署无法完成</li>\n</ul>\n<p><em><strong>由此产生微服务</strong></em></p>\n<blockquote>\n<p>一切争端的开始</p>\n</blockquote>\n<h3 id=\"微服务的演变\"><a href=\"#微服务的演变\" class=\"headerlink\" title=\"微服务的演变\"></a>微服务的演变</h3><p>微服务本质上是对面向架构的模式(SOA)的一种实践</p>\n<p>微服务的特点:</p>\n<ul>\n<li>小即是美</li>\n<li>单一职责</li>\n<li>尽可能早创建原型</li>\n<li>可以执行比效率更重要</li>\n</ul>\n<h3 id=\"微服务的定义\"><a href=\"#微服务的定义\" class=\"headerlink\" title=\"微服务的定义\"></a>微服务的定义</h3><p>围绕业务功能构建的，服务关注单一业务，服务间采用轻量级的通信机制，可以全自动独立部署，可以使用不同的编程语言和数据存储技术。微服务架构通过业务拆分实现服务组件化，通过组件组合快速开发系统，业务单一的服务组件又可以独立部署，使得整个系统变得清晰灵活</p>\n<p><em><strong>核心： 化繁为简 分而治之</strong></em></p>\n<p>优点：</p>\n<ul>\n<li>原子服务</li>\n<li>独立部署</li>\n<li>隔离部署</li>\n<li>去中心化服务治理</li>\n</ul>\n<p>缺点：</p>\n<ul>\n<li>基础设施建设复杂度高</li>\n<li>分布式服务间通信机制变得复杂 对不可用节点服务处理变得更加复杂</li>\n<li>分布式的分区数据库 对分布式事物等需要做对应的复杂处理</li>\n<li>测试整体的微服务架构复杂</li>\n<li>服务间的依赖 局部升级可能影响整体</li>\n</ul>\n<h2 id=\"微服务设计思路\"><a href=\"#微服务设计思路\" class=\"headerlink\" title=\"微服务设计思路\"></a>微服务设计思路</h2><h3 id=\"组件服务化\"><a href=\"#组件服务化\" class=\"headerlink\" title=\"组件服务化\"></a>组件服务化</h3><ul>\n<li>kit:一个微服务的基础库（框架）</li>\n<li>service: 业务业务代码+kit依赖+第三方组件的依赖</li>\n<li>RPC+message queue: 轻量级通讯</li>\n</ul>\n<h3 id=\"按业务组织服务\"><a href=\"#按业务组织服务\" class=\"headerlink\" title=\"按业务组织服务\"></a>按业务组织服务</h3><p>事实上传统应用设计架构的分层结构正反映了不同角色的沟通结构。所以若要按微服务的方式来构建应用，也需要对应调整团队的组织架构。每个服务背后的小团队的组织是跨功能的，包含实现业务所需的全面的技能</p>\n<h3 id=\"去中心化\"><a href=\"#去中心化\" class=\"headerlink\" title=\"去中心化\"></a>去中心化</h3><ul>\n<li>数据去中心化</li>\n<li>治理去中心化</li>\n<li>技术去中心化</li>\n</ul>\n<h3 id=\"基础设施自动化\"><a href=\"#基础设施自动化\" class=\"headerlink\" title=\"基础设施自动化\"></a>基础设施自动化</h3><ul>\n<li>ci/cd</li>\n<li>auto testing</li>\n<li>在线监控</li>\n</ul>\n<h3 id=\"服务兼容性设计\"><a href=\"#服务兼容性设计\" class=\"headerlink\" title=\"服务兼容性设计\"></a>服务兼容性设计</h3><p>发送时要保守，接收时要开放。按照伯斯塔尔法则的思想来设计和实现服务时，发送的数据要更保守，意味着最小化的传送必要的信息，接收时更开放意味着要最大限度的容忍冗余数据，保证兼容性。</p>\n<ul>\n<li>负载均衡</li>\n<li>超时控制</li>\n<li>负载保护</li>\n<li>隔离</li>\n<li>限流</li>\n<li>降级</li>\n<li>重试</li>\n<li>熔断</li>\n</ul>\n<h2 id=\"微服务设计\"><a href=\"#微服务设计\" class=\"headerlink\" title=\"微服务设计\"></a>微服务设计</h2><h3 id=\"API-GATEWAY\"><a href=\"#API-GATEWAY\" class=\"headerlink\" title=\"API GATEWAY\"></a>API GATEWAY</h3><blockquote>\n<p>backend for forntend BFF 可以认为是一种适配服务，将后端的微服务进行适配（主要包括聚合裁剪和格式适配等逻辑），向无线端设备暴露友好和统一的 API，方便无线设备接入访问后端服务</p>\n</blockquote>\n<h3 id=\"微服务的划分\"><a href=\"#微服务的划分\" class=\"headerlink\" title=\"微服务的划分\"></a>微服务的划分</h3><h3 id=\"微服务的安全\"><a href=\"#微服务的安全\" class=\"headerlink\" title=\"微服务的安全\"></a>微服务的安全</h3><h2 id=\"服务发现-amp-GRPC\"><a href=\"#服务发现-amp-GRPC\" class=\"headerlink\" title=\"服务发现 &amp; GRPC\"></a>服务发现 &amp; GRPC</h2><h3 id=\"GRPC\"><a href=\"#GRPC\" class=\"headerlink\" title=\"GRPC\"></a>GRPC</h3><ul>\n<li>多语言：语言中立，支持多种语言。</li>\n<li>轻量级、高性能：序列化支持 PB（Protocol Buffer）和 JSON，PB 是一种语言无关的高性能序列化框架</li>\n<li>可插拔</li>\n<li>IDL：基于文件定义服务，通过 proto3 工具生成指定语言的数据结构、服务端接口以及客户端 Stub</li>\n<li>移动端：基于标准的 HTTP/2 设计，支持双向流、消息头压缩、单 TCP 的多路复用、服务端推送等特性，这些特性使得 gRPC 在移动端设备上更加省电和节省网络流量。</li>\n<li>服务而非对象 消息而非引用：促进微服务的系统间粗粒度消息交互设计理念</li>\n<li>负载无关的：不同的服务需要使用不同的消息类型和编码，例如 protocol buffers、JSON、XML 和 Thrift。</li>\n<li>流：Streaming API。</li>\n<li>阻塞式和非阻塞式：支持异步和同步处理在客户端和服务端间交互的消息序列。</li>\n<li>元数据交换：常见的横切关注点，如认证或跟踪，依赖数据交换。</li>\n<li>标准化状态码：客户端通常以有限的方式响应 API 调用返回的错误 </li>\n</ul>\n<h3 id=\"服务发现\"><a href=\"#服务发现\" class=\"headerlink\" title=\"服务发现\"></a>服务发现</h3><ul>\n<li><p>客户端发现：<br>直连 比服务端服务发现少一次网络跳转 Consumer 需要内置特定的服务发现客户端和发现逻辑</p>\n</li>\n<li><p>服务端发现：<br>Consumer 无需关注服务发现具体细节 只需知道服务的 DNS 域名即可 支持异构语言开发 需要基础设施支撑 多了一次网络跳转 可能有性能损失</p>\n</li>\n<li><p>服务网格 service mesh:<br>通过sidercar 方式隐式的支持服务发现（待补充）</p>\n</li>\n</ul>\n<h2 id=\"多集群-amp-多租户\"><a href=\"#多集群-amp-多租户\" class=\"headerlink\" title=\"多集群 &amp; 多租户\"></a>多集群 &amp; 多租户</h2><h3 id=\"多集群\"><a href=\"#多集群\" class=\"headerlink\" title=\"多集群\"></a>多集群</h3><p>为了保证服务的可用性 已经对异常情况的预处理 使用多集群的方式提高系统的可用能力</p>\n<h3 id=\"多租户\"><a href=\"#多租户\" class=\"headerlink\" title=\"多租户\"></a>多租户</h3><p>在一个微服务架构中允许多系统共存是利用微服务稳定性以及模块化最有效的方式之一 这种方式一般被称为多租户（multi-tenancy）</p>\n<p>通过不同的租户区分不同的业务功能：</p>\n<ul>\n<li>红蓝发布</li>\n<li>灰度测试</li>\n<li>模块测试</li>\n</ul>\n<blockquote>\n<p>多租户的概念较为模糊<br>思考？ 多租户中是怎样实现在上下文中传递多租户信息的?</p>\n</blockquote>\n"},{"title":"docker-compose搭建MySql主从和双主","date":"2021-08-23T08:03:58.000Z","index_img":"/img/mysql/mysql.png","banner_img":"/img/mysql/banner-1.jpg","_content":"\n<p class=\"note note-primary\">相信mysql的binlog都不陌生</br>binlog的主要作用就是进行数据同步，今天我们从数据同步的角度搭一下mysql的主从/双主。</p>\n\n## base\n\n以下基于mysql5.7\n\n## 简单了解下binlog\n\n- binlog是记录所有数据库表结构变更（例如CREATE、ALTER TABLE…）以及表数据修改（INSERT、UPDATE、DELETE…）的二进制日志。\n\n- binlog日志包括两类文件：二进制日志索引文件（文件名后缀为.index）用于记录所有的二进制文件，二进制日志文件（文件名后缀为.00000*）记录数据库所有的DDL和DML(除了数据查询语句)语句事件。\n\n- binlog有三种格式：statement基于sql语句复制、row基于行数据变更的复制、mixed混合前两种格式的复制。\n\n## 搭建主从结构\n\n![mysql主从架构](/img/mysql/mysql-m-s.png)\n\n### 创建docker-compose\n\n```yml\nversion: '3.8'\nservices:\n  mysql-master:\n    container_name: mysql-master \n    image: mysql:5.7.31\n    restart: always\n    ports:\n      - 13306:3306 \n    privileged: true\n    volumes:\n      # 这个只对mysql主从进行验证 没有持久化配置以及日志相关的映射\n      - $PWD/master/conf/my.cnf:/etc/mysql/my.cnf\n    environment:\n      MYSQL_ROOT_PASSWORD: \"123456\"\n    command: [\n        '--character-set-server=utf8mb4',\n        '--collation-server=utf8mb4_general_ci',\n        '--max_connections=3000'\n    ]\n    networks:\n      - myweb\n      \n  mysql-slave:\n    container_name: mysql-slave \n    image: mysql:5.7.31\n    restart: always\n    ports:\n      - 23306:3306 \n    privileged: true\n    volumes:\n      # 这个只对mysql主从进行验证 没有持久化配置以及日志相关的映射\n      - $PWD/slave/conf/my.cnf:/etc/mysql/my.cnf\n    environment:\n      MYSQL_ROOT_PASSWORD: \"123456\"\n    command: [\n        '--character-set-server=utf8mb4',\n        '--collation-server=utf8mb4_general_ci',\n        '--max_connections=3000'\n    ]\n    networks:\n      - myweb    \n\nnetworks:\n  myweb:\n    driver: bridge\n```\n\n### 创建配置文件\n\n#### 配置文件目录结构\n\n```bash\n[root@xxx MySQLM-S]# tree\n.\n├── docker-compose.yaml\n├── master\n│   └── conf\n│       └── my.cnf\n└── slave\n    └── conf\n        └── my.cnf\n```\n\n#### master/conf/my.cnf 配置文件\n\n```bash\n[mysqld]\n# [必须]服务器唯一ID，默认是1，一般取IP最后一段\nserver-id=1\n\n\n# ###################################################\n# 如果当前实例既做主库又做从库次选线必须开启\n# log-slave-updates = true \n\n# 自增长ID\n# 特殊说明 当该实例为双主的架构时要特殊配置 以避免自增id冲突的问题\n# auto_increment_offset = 1\n# auto_increment_increment = 2  \n# ####################################################\n\n\n# [必须]启用二进制日志\nlog-bin=mysql-bin \n\n# 复制过滤：也就是指定哪个数据库不用同步（mysql库一般不同步）\nbinlog-ignore-db=mysql\n\n# 确保binlog日志写入后与硬盘同步\nsync_binlog = 1\n\n# 设置需要同步的数据库 binlog_do_db = 数据库名； \n# 如果是多个同步库，就以此格式另写几行即可。\n# 如果不指明对某个具体库同步，表示同步所有库。除了binlog-ignore-db设置的忽略的库\n# binlog_do_db = test #需要同步test数据库。\n\n# 设置需要同步的数据库，主服务器上不限定数据库，在从服务器上限定replicate-do-db = 数据库名；\n# 如果不指明同步哪些库，就去掉这行，表示所有库的同步（除了ignore忽略的库）。\n# replicate-do-db = test；\n\n# 跳过所有的错误，继续执行复制操作\nslave-skip-errors = all  \n```\n\n#### slave/conf/my.cnf 配置文件\n\n```bash\n[mysqld]\n# [必须]服务器唯一ID，默认是1，一般取IP最后一段  \nserver-id=2\n\n\n# ###################################################\n# 如果当前实例既做主库又做从库次选线必须开启\n# log-slave-updates = true \n\n# 自增长ID\n# 特殊说明 当该实例为双主的架构时要特殊配置 以避免自增id冲突的问题\n# auto_increment_offset = 2\n# auto_increment_increment = 2  \n# ####################################################\n\n# [必须]启用二进制日志\nlog-bin=mysql-bin \n\n# 复制过滤：也就是指定哪个数据库不用同步（mysql库一般不同步）\nbinlog-ignore-db=mysql\n\n# 确保binlog日志写入后与硬盘同步\n# sync_binlog = 1\n\n# 设置需要同步的数据库 binlog_do_db = 数据库名； \n# 如果是多个同步库，就以此格式另写几行即可。\n# 如果不指明对某个具体库同步，表示同步所有库。除了binlog-ignore-db设置的忽略的库\n# binlog_do_db = test #需要同步test数据库。\n\n# 设置需要同步的数据库，主服务器上不限定数据库，在从服务器上限定replicate-do-db = 数据库名；\n# 如果不指明同步哪些库，就去掉这行，表示所有库的同步（除了ignore忽略的库）。\n# replicate-do-db = test；\n\n# 跳过所有的错误，继续执行复制操作\nslave-skip-errors = all \n```\n\n### 启动docker-compose并配置主从关系\n\n#### 启动\n\n```bash\ndocker-compose up -d \n```\n\n#### 进入master配置同步账号和权限\n\n```bash\ndocker-compose exec mysql-slave bash\n\nmysql -uroot -p123455\n\n# 查看配置的服务ID\nmysql> show variables like '%server_id%';\n+----------------+-------+\n| Variable_name  | Value |\n+----------------+-------+\n| server_id      | 1     |\n| server_id_bits | 32    |\n+----------------+-------+\n\n# 看master信息 File 和 Position 从服务上要用\nmysql> show master status;\n+------------------+----------+--------------+------------------+-------------------+\n| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |\n+------------------+----------+--------------+------------------+-------------------+\n| mysql-bin.000004 |      154 |              | mysql            |                   |\n+------------------+----------+--------------+------------------+-------------------+\n\n# 创建同步账户并开启权限\nmysql> grant replication slave,replication client on *.* to 'slave'@'%' identified by \"123456\";\nmysql> flush privileges;\n```\n\n#### 进入slave服务配置\n\n```bash\ndocker-compose exec docker-slave bash\n\nmysql -uroot -p123456\n\n#查看server_id是否生效\nmysql> show variables like '%server_id%';\n+----------------+-------+\n| Variable_name  | Value |\n+----------------+-------+\n| server_id      | 2     |\n| server_id_bits | 32    |\n+----------------+-------+\n\n# 连接主mysql服务 master_log_file 和 master_log_pos的值要填写主master里查出来的值 注意这里使用的docker-compose 内部服务的端口和ip\nmysql> change master to master_host='mysql-master',master_user='slave',master_password='123456',master_port=3306,master_log_file='mysql-bin.000004', master_log_pos=154,master_connect_retry=30;\n\n\n# 开启slave\n\nmysql> start slave;\n\nmysql> show slave status \\G\n*************************** 1. row ***************************\n               Slave_IO_State: Waiting for master to send event\n                  Master_Host: mysql-master\n                  Master_User: slave\n                  Master_Port: 3306\n                Connect_Retry: 30\n              Master_Log_File: mysql-bin.000004\n          Read_Master_Log_Pos: 778\n               Relay_Log_File: af5556aff9be-relay-bin.000002\n                Relay_Log_Pos: 944\n        Relay_Master_Log_File: mysql-bin.000004\n             Slave_IO_Running: Yes\n            Slave_SQL_Running: Yes\n              Replicate_Do_DB: \n          Replicate_Ignore_DB: mysql\n           Replicate_Do_Table: \n       Replicate_Ignore_Table: \n      Replicate_Wild_Do_Table: \n  Replicate_Wild_Ignore_Table: \n                   Last_Errno: 0\n                   Last_Error: \n                 Skip_Counter: 0\n          Exec_Master_Log_Pos: 778\n              Relay_Log_Space: 1158\n              Until_Condition: None\n               Until_Log_File: \n                Until_Log_Pos: 0\n           Master_SSL_Allowed: No\n           Master_SSL_CA_File: \n           Master_SSL_CA_Path: \n              Master_SSL_Cert: \n            Master_SSL_Cipher: \n               Master_SSL_Key: \n        Seconds_Behind_Master: 0\nMaster_SSL_Verify_Server_Cert: No\n                Last_IO_Errno: 0\n                Last_IO_Error: \n               Last_SQL_Errno: 0\n               Last_SQL_Error: \n  Replicate_Ignore_Server_Ids: \n             Master_Server_Id: 1\n                  Master_UUID: 466c4a60-03f4-11ec-a1a1-0242ac160002\n             Master_Info_File: /var/lib/mysql/master.info\n                    SQL_Delay: 0\n          SQL_Remaining_Delay: NULL\n      Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates\n           Master_Retry_Count: 86400\n                  Master_Bind: \n      Last_IO_Error_Timestamp: \n     Last_SQL_Error_Timestamp: \n               Master_SSL_Crl: \n           Master_SSL_Crlpath: \n           Retrieved_Gtid_Set: \n            Executed_Gtid_Set: \n                Auto_Position: 0\n         Replicate_Rewrite_DB: \n                 Channel_Name: \n           Master_TLS_Version: \n\n```\n\n<p class=\"note note-success\"> 上面看到 Slave_IO_Running: Yes，Slave_SQL_Running: Yes 表示已经成功开启主从</p>\n\n连接主mysql参数说明：\n\n**master_port**：Master的端口号，指的是容器的端口号\n\n**master_user**：用于数据同步的用户\n\n**master_password**：用于同步的用户的密码\n\n**master_log_file**：指定 Slave 从哪个日志文件开始复制数据，即上文中提到的 File 字段的值\n\n**master_log_pos**：从哪个 Position 开始读，即上文中提到的 Position 字段的值\n\n**master_connect_retry**：如果连接失败，重试的时间间隔，单位是秒，默认是60秒\n\n## 搭建双主结构\n\n通过上面主从结构我们可以我们可以大胆设想，要是两个数据库的实例都配置对方为master不就实现的双主么？事实却是如此：\n\n双主结构只需要将双方的配置文件注释掉的地方取消注释掉分别在两台服务器上创同步账号和配置\n\n### 创建docker-compose文件（双主）\n\n这里只更改了docker-compose中服务的名称\n\n```yaml\nversion: '3.8'\nservices:\n  mysql-m1:\n    container_name: mysql-m1\n    image: mysql:5.7.31\n    restart: always\n    ports:\n      - 13306:3306 \n    privileged: true\n    volumes:\n      # 这个只对mysql主从进行验证 没有持久化配置以及日志相关的映射\n      - $PWD/m1/conf/my.cnf:/etc/mysql/my.cnf\n    environment:\n      MYSQL_ROOT_PASSWORD: \"123456\"\n    command: [\n        '--character-set-server=utf8mb4',\n        '--collation-server=utf8mb4_general_ci',\n        '--max_connections=3000'\n    ]\n    networks:\n      - myweb\n      \n  mysql-m2:\n    container_name: mysql-m2 \n    image: mysql:5.7.31\n    restart: always\n    ports:\n      - 23306:3306 \n    privileged: true\n    volumes:\n      # 这个只对mysql主从进行验证 没有持久化配置以及日志相关的映射\n      - $PWD/m2/conf/my.cnf:/etc/mysql/my.cnf\n    environment:\n      MYSQL_ROOT_PASSWORD: \"123456\"\n    command: [\n        '--character-set-server=utf8mb4',\n        '--collation-server=utf8mb4_general_ci',\n        '--max_connections=3000'\n    ]\n    networks:\n      - myweb    \n\nnetworks:\n  myweb:\n    driver: bridge\n```\n\n### 创建配置文件(双主)\n\n这里只是将主从中的配置中注释掉的服务添加上\n\n#### 配置文件目录结构（双主）\n\n```bash\n[root@xxx MySQLM-M]# tree\n.\n├── docker-compose.yaml\n├── m1\n│   └── conf\n│       └── my.cnf\n└── m2\n    └── conf\n        └── my.cnf\n```\n\n#### m1/conf/my.cnf\n\n```bash\n[mysqld]\n# [必须]服务器唯一ID，默认是1，一般取IP最后一段\nserver-id=1\n\n\n# ###################################################\n# 如果当前实例既做主库又做从库次选线必须开启\nlog-slave-updates = true \n\n# 自增长ID\n# 特殊说明 当该实例为双主的架构时要特殊配置 以避免自增id冲突的问题\nauto_increment_offset = 1\nauto_increment_increment = 2  \n# ####################################################\n\n\n# [必须]启用二进制日志\nlog-bin=mysql-bin \n\n# 复制过滤：也就是指定哪个数据库不用同步（mysql库一般不同步）\nbinlog-ignore-db=mysql\n\n# 确保binlog日志写入后与硬盘同步\nsync_binlog = 1\n\n# 设置需要同步的数据库 binlog_do_db = 数据库名； \n# 如果是多个同步库，就以此格式另写几行即可。\n# 如果不指明对某个具体库同步，表示同步所有库。除了binlog-ignore-db设置的忽略的库\n# binlog_do_db = test #需要同步test数据库。\n\n# 设置需要同步的数据库，主服务器上不限定数据库，在从服务器上限定replicate-do-db = 数据库名；\n# 如果不指明同步哪些库，就去掉这行，表示所有库的同步（除了ignore忽略的库）。\n# replicate-do-db = test；\n\n# 跳过所有的错误，继续执行复制操作\nslave-skip-errors = all  \n```\n\n#### m2/conf/my.cnf\n\n```bash\n[mysqld]\n# [必须]服务器唯一ID，默认是1，一般取IP最后一段  \nserver-id=2\n\n\n# ###################################################\n# 如果当前实例既做主库又做从库次选线必须开启\nlog-slave-updates = true \n\n# 自增长ID\n# 特殊说明 当该实例为双主的架构时要特殊配置 以避免自增id冲突的问题\nauto_increment_offset = 2\nauto_increment_increment = 2  \n# ####################################################\n\n# [必须]启用二进制日志\nlog-bin=mysql-bin \n\n# 复制过滤：也就是指定哪个数据库不用同步（mysql库一般不同步）\nbinlog-ignore-db=mysql\n\n# 确保binlog日志写入后与硬盘同步\nsync_binlog = 1\n\n# 设置需要同步的数据库 binlog_do_db = 数据库名； \n# 如果是多个同步库，就以此格式另写几行即可。\n# 如果不指明对某个具体库同步，表示同步所有库。除了binlog-ignore-db设置的忽略的库\n# binlog_do_db = test #需要同步test数据库。\n\n# 设置需要同步的数据库，主服务器上不限定数据库，在从服务器上限定replicate-do-db = 数据库名；\n# 如果不指明同步哪些库，就去掉这行，表示所有库的同步（除了ignore忽略的库）。\n# replicate-do-db = test；\n\n# 跳过所有的错误，继续执行复制操作\nslave-skip-errors = all \n```\n\n### 启动docker-compose并配置m1和m2的双主\n\n#### 启动（双主）\n\n```bash\ndocker-compose up -d \n```\n\n进入m1和m2下执行下列命令来获取各自的master status 和同步账号\n\nm1:\n\n```bash\ndocker-compose exec mysql-m1 bash\n\nmysql -uroot -p123456\n\n# 查看m1 File和Position\nmysql> show master status;\n+------------------+----------+--------------+------------------+-------------------+\n| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |\n+------------------+----------+--------------+------------------+-------------------+\n| mysql-bin.000005 |      154 |              | mysql            |                   |\n+------------------+----------+--------------+------------------+-------------------+\n\n# 创建同步账号\nmysql> grant replication slave,replication client on *.* to 'slave'@'%' identified by \"123456\";\nmysql> flush privileges;\n\n```\n\nm2:\n\n```bash\ndocker-compose exec mysql-m1 bash\n\nmysql -uroot -p123456\n\n# 查看m2 File和Position\nmysql> show master status;\n+------------------+----------+--------------+------------------+-------------------+\n| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |\n+------------------+----------+--------------+------------------+-------------------+\n| mysql-bin.000005 |      154 |              | mysql            |                   |\n+------------------+----------+--------------+------------------+-------------------+\n\n# 创建同步账号\nmysql> grant replication slave,replication client on *.* to 'slave'@'%' identified by \"123456\";\nmysql> flush privileges;\n```\n\nm1:\n\n```bash\nmysql> change master to master_host='mysql-m2',master_user='slave',master_password='123456',master_port=3306,master_log_file='mysql-bin.000005', master_log_pos=154,master_connect_retry=30;\n\nmysql> start slave;\n\nmysql> show slave status \\G\n*************************** 1. row ***************************\n               Slave_IO_State: Waiting for master to send event\n                  Master_Host: mysql-m2\n                  Master_User: slave\n                  Master_Port: 3306\n                Connect_Retry: 30\n              Master_Log_File: mysql-bin.000005\n          Read_Master_Log_Pos: 620\n               Relay_Log_File: de7a84f1b7f1-relay-bin.000002\n                Relay_Log_Pos: 786\n        Relay_Master_Log_File: mysql-bin.000005\n             Slave_IO_Running: Yes\n            Slave_SQL_Running: Yes\n              Replicate_Do_DB:\n          Replicate_Ignore_DB:\n           Replicate_Do_Table:\n       Replicate_Ignore_Table:\n      Replicate_Wild_Do_Table:\n  Replicate_Wild_Ignore_Table:\n                   Last_Errno: 0\n                   Last_Error:\n                 Skip_Counter: 0\n          Exec_Master_Log_Pos: 620\n              Relay_Log_Space: 1000\n              Until_Condition: None\n               Until_Log_File:\n                Until_Log_Pos: 0\n           Master_SSL_Allowed: No\n           Master_SSL_CA_File:\n           Master_SSL_CA_Path:\n              Master_SSL_Cert:\n            Master_SSL_Cipher:\n               Master_SSL_Key:\n        Seconds_Behind_Master: 0\nMaster_SSL_Verify_Server_Cert: No\n                Last_IO_Errno: 0\n                Last_IO_Error:\n               Last_SQL_Errno: 0\n               Last_SQL_Error:\n  Replicate_Ignore_Server_Ids:\n             Master_Server_Id: 2\n                  Master_UUID: de8af5ce-0410-11ec-ab6d-0242ac170003\n             Master_Info_File: /var/lib/mysql/master.info\n                    SQL_Delay: 0\n          SQL_Remaining_Delay: NULL\n      Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates\n           Master_Retry_Count: 86400\n                  Master_Bind:\n      Last_IO_Error_Timestamp:\n     Last_SQL_Error_Timestamp:\n               Master_SSL_Crl:\n           Master_SSL_Crlpath:\n           Retrieved_Gtid_Set:\n            Executed_Gtid_Set:\n                Auto_Position: 0\n         Replicate_Rewrite_DB:\n                 Channel_Name:\n           Master_TLS_Version:\n\n```\n\nm2:\n\n```bash\nmysql> change master to master_host='mysql-m1',master_user='slave',master_password='123456',master_port=3306,master_log_file='mysql-bin.000005', master_log_pos=154,master_connect_retry=30;\n\nmysql> start slave;\n\nmysql> show slave status \\G\n*************************** 1. row ***************************\n               Slave_IO_State: Waiting for master to send event\n                  Master_Host: mysql-m1\n                  Master_User: slave\n                  Master_Port: 3306\n                Connect_Retry: 30\n              Master_Log_File: mysql-bin.000005\n          Read_Master_Log_Pos: 1086\n               Relay_Log_File: 65322be4d8a9-relay-bin.000002\n                Relay_Log_Pos: 786\n        Relay_Master_Log_File: mysql-bin.000005\n             Slave_IO_Running: Yes\n            Slave_SQL_Running: Yes\n              Replicate_Do_DB:\n          Replicate_Ignore_DB:\n           Replicate_Do_Table:\n       Replicate_Ignore_Table:\n      Replicate_Wild_Do_Table:\n  Replicate_Wild_Ignore_Table:\n                   Last_Errno: 0\n                   Last_Error:\n                 Skip_Counter: 0\n          Exec_Master_Log_Pos: 1086\n              Relay_Log_Space: 1000\n              Until_Condition: None\n               Until_Log_File:\n                Until_Log_Pos: 0\n           Master_SSL_Allowed: No\n           Master_SSL_CA_File:\n           Master_SSL_CA_Path:\n              Master_SSL_Cert:\n            Master_SSL_Cipher:\n               Master_SSL_Key:\n        Seconds_Behind_Master: 0\nMaster_SSL_Verify_Server_Cert: No\n                Last_IO_Errno: 0\n                Last_IO_Error:\n               Last_SQL_Errno: 0\n               Last_SQL_Error:\n  Replicate_Ignore_Server_Ids:\n             Master_Server_Id: 1\n                  Master_UUID: de898a82-0410-11ec-9fee-0242ac170002\n             Master_Info_File: /var/lib/mysql/master.info\n                    SQL_Delay: 0\n          SQL_Remaining_Delay: NULL\n      Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates\n           Master_Retry_Count: 86400\n                  Master_Bind:\n      Last_IO_Error_Timestamp:\n     Last_SQL_Error_Timestamp:\n               Master_SSL_Crl:\n           Master_SSL_Crlpath:\n           Retrieved_Gtid_Set:\n            Executed_Gtid_Set:\n                Auto_Position: 0\n         Replicate_Rewrite_DB:\n                 Channel_Name:\n           Master_TLS_Version:\n```\n\n<p class=\"noet note-success\">至此双主节点设置完成</p>\n\n## 总结\n\n主从模式多用来进行读写分离\n\n双主模式多用来进行高可用\n\n更复杂的部署可能会部署多master和多slave并用keeplive保证统一访问的模式，这里没探究\n","source":"_posts/docker-compose搭建MySql主从和双主.md","raw":"---\ntitle: docker-compose搭建MySql主从和双主\ndate: 2021-08-23 16:03:58\nindex_img: /img/mysql/mysql.png\nbanner_img: /img/mysql/banner-1.jpg\ncategories:\n- 存储\ntags:\n- mysql\n- 高可用\n- 数据同步\n---\n\n<p class=\"note note-primary\">相信mysql的binlog都不陌生</br>binlog的主要作用就是进行数据同步，今天我们从数据同步的角度搭一下mysql的主从/双主。</p>\n\n## base\n\n以下基于mysql5.7\n\n## 简单了解下binlog\n\n- binlog是记录所有数据库表结构变更（例如CREATE、ALTER TABLE…）以及表数据修改（INSERT、UPDATE、DELETE…）的二进制日志。\n\n- binlog日志包括两类文件：二进制日志索引文件（文件名后缀为.index）用于记录所有的二进制文件，二进制日志文件（文件名后缀为.00000*）记录数据库所有的DDL和DML(除了数据查询语句)语句事件。\n\n- binlog有三种格式：statement基于sql语句复制、row基于行数据变更的复制、mixed混合前两种格式的复制。\n\n## 搭建主从结构\n\n![mysql主从架构](/img/mysql/mysql-m-s.png)\n\n### 创建docker-compose\n\n```yml\nversion: '3.8'\nservices:\n  mysql-master:\n    container_name: mysql-master \n    image: mysql:5.7.31\n    restart: always\n    ports:\n      - 13306:3306 \n    privileged: true\n    volumes:\n      # 这个只对mysql主从进行验证 没有持久化配置以及日志相关的映射\n      - $PWD/master/conf/my.cnf:/etc/mysql/my.cnf\n    environment:\n      MYSQL_ROOT_PASSWORD: \"123456\"\n    command: [\n        '--character-set-server=utf8mb4',\n        '--collation-server=utf8mb4_general_ci',\n        '--max_connections=3000'\n    ]\n    networks:\n      - myweb\n      \n  mysql-slave:\n    container_name: mysql-slave \n    image: mysql:5.7.31\n    restart: always\n    ports:\n      - 23306:3306 \n    privileged: true\n    volumes:\n      # 这个只对mysql主从进行验证 没有持久化配置以及日志相关的映射\n      - $PWD/slave/conf/my.cnf:/etc/mysql/my.cnf\n    environment:\n      MYSQL_ROOT_PASSWORD: \"123456\"\n    command: [\n        '--character-set-server=utf8mb4',\n        '--collation-server=utf8mb4_general_ci',\n        '--max_connections=3000'\n    ]\n    networks:\n      - myweb    \n\nnetworks:\n  myweb:\n    driver: bridge\n```\n\n### 创建配置文件\n\n#### 配置文件目录结构\n\n```bash\n[root@xxx MySQLM-S]# tree\n.\n├── docker-compose.yaml\n├── master\n│   └── conf\n│       └── my.cnf\n└── slave\n    └── conf\n        └── my.cnf\n```\n\n#### master/conf/my.cnf 配置文件\n\n```bash\n[mysqld]\n# [必须]服务器唯一ID，默认是1，一般取IP最后一段\nserver-id=1\n\n\n# ###################################################\n# 如果当前实例既做主库又做从库次选线必须开启\n# log-slave-updates = true \n\n# 自增长ID\n# 特殊说明 当该实例为双主的架构时要特殊配置 以避免自增id冲突的问题\n# auto_increment_offset = 1\n# auto_increment_increment = 2  \n# ####################################################\n\n\n# [必须]启用二进制日志\nlog-bin=mysql-bin \n\n# 复制过滤：也就是指定哪个数据库不用同步（mysql库一般不同步）\nbinlog-ignore-db=mysql\n\n# 确保binlog日志写入后与硬盘同步\nsync_binlog = 1\n\n# 设置需要同步的数据库 binlog_do_db = 数据库名； \n# 如果是多个同步库，就以此格式另写几行即可。\n# 如果不指明对某个具体库同步，表示同步所有库。除了binlog-ignore-db设置的忽略的库\n# binlog_do_db = test #需要同步test数据库。\n\n# 设置需要同步的数据库，主服务器上不限定数据库，在从服务器上限定replicate-do-db = 数据库名；\n# 如果不指明同步哪些库，就去掉这行，表示所有库的同步（除了ignore忽略的库）。\n# replicate-do-db = test；\n\n# 跳过所有的错误，继续执行复制操作\nslave-skip-errors = all  \n```\n\n#### slave/conf/my.cnf 配置文件\n\n```bash\n[mysqld]\n# [必须]服务器唯一ID，默认是1，一般取IP最后一段  \nserver-id=2\n\n\n# ###################################################\n# 如果当前实例既做主库又做从库次选线必须开启\n# log-slave-updates = true \n\n# 自增长ID\n# 特殊说明 当该实例为双主的架构时要特殊配置 以避免自增id冲突的问题\n# auto_increment_offset = 2\n# auto_increment_increment = 2  \n# ####################################################\n\n# [必须]启用二进制日志\nlog-bin=mysql-bin \n\n# 复制过滤：也就是指定哪个数据库不用同步（mysql库一般不同步）\nbinlog-ignore-db=mysql\n\n# 确保binlog日志写入后与硬盘同步\n# sync_binlog = 1\n\n# 设置需要同步的数据库 binlog_do_db = 数据库名； \n# 如果是多个同步库，就以此格式另写几行即可。\n# 如果不指明对某个具体库同步，表示同步所有库。除了binlog-ignore-db设置的忽略的库\n# binlog_do_db = test #需要同步test数据库。\n\n# 设置需要同步的数据库，主服务器上不限定数据库，在从服务器上限定replicate-do-db = 数据库名；\n# 如果不指明同步哪些库，就去掉这行，表示所有库的同步（除了ignore忽略的库）。\n# replicate-do-db = test；\n\n# 跳过所有的错误，继续执行复制操作\nslave-skip-errors = all \n```\n\n### 启动docker-compose并配置主从关系\n\n#### 启动\n\n```bash\ndocker-compose up -d \n```\n\n#### 进入master配置同步账号和权限\n\n```bash\ndocker-compose exec mysql-slave bash\n\nmysql -uroot -p123455\n\n# 查看配置的服务ID\nmysql> show variables like '%server_id%';\n+----------------+-------+\n| Variable_name  | Value |\n+----------------+-------+\n| server_id      | 1     |\n| server_id_bits | 32    |\n+----------------+-------+\n\n# 看master信息 File 和 Position 从服务上要用\nmysql> show master status;\n+------------------+----------+--------------+------------------+-------------------+\n| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |\n+------------------+----------+--------------+------------------+-------------------+\n| mysql-bin.000004 |      154 |              | mysql            |                   |\n+------------------+----------+--------------+------------------+-------------------+\n\n# 创建同步账户并开启权限\nmysql> grant replication slave,replication client on *.* to 'slave'@'%' identified by \"123456\";\nmysql> flush privileges;\n```\n\n#### 进入slave服务配置\n\n```bash\ndocker-compose exec docker-slave bash\n\nmysql -uroot -p123456\n\n#查看server_id是否生效\nmysql> show variables like '%server_id%';\n+----------------+-------+\n| Variable_name  | Value |\n+----------------+-------+\n| server_id      | 2     |\n| server_id_bits | 32    |\n+----------------+-------+\n\n# 连接主mysql服务 master_log_file 和 master_log_pos的值要填写主master里查出来的值 注意这里使用的docker-compose 内部服务的端口和ip\nmysql> change master to master_host='mysql-master',master_user='slave',master_password='123456',master_port=3306,master_log_file='mysql-bin.000004', master_log_pos=154,master_connect_retry=30;\n\n\n# 开启slave\n\nmysql> start slave;\n\nmysql> show slave status \\G\n*************************** 1. row ***************************\n               Slave_IO_State: Waiting for master to send event\n                  Master_Host: mysql-master\n                  Master_User: slave\n                  Master_Port: 3306\n                Connect_Retry: 30\n              Master_Log_File: mysql-bin.000004\n          Read_Master_Log_Pos: 778\n               Relay_Log_File: af5556aff9be-relay-bin.000002\n                Relay_Log_Pos: 944\n        Relay_Master_Log_File: mysql-bin.000004\n             Slave_IO_Running: Yes\n            Slave_SQL_Running: Yes\n              Replicate_Do_DB: \n          Replicate_Ignore_DB: mysql\n           Replicate_Do_Table: \n       Replicate_Ignore_Table: \n      Replicate_Wild_Do_Table: \n  Replicate_Wild_Ignore_Table: \n                   Last_Errno: 0\n                   Last_Error: \n                 Skip_Counter: 0\n          Exec_Master_Log_Pos: 778\n              Relay_Log_Space: 1158\n              Until_Condition: None\n               Until_Log_File: \n                Until_Log_Pos: 0\n           Master_SSL_Allowed: No\n           Master_SSL_CA_File: \n           Master_SSL_CA_Path: \n              Master_SSL_Cert: \n            Master_SSL_Cipher: \n               Master_SSL_Key: \n        Seconds_Behind_Master: 0\nMaster_SSL_Verify_Server_Cert: No\n                Last_IO_Errno: 0\n                Last_IO_Error: \n               Last_SQL_Errno: 0\n               Last_SQL_Error: \n  Replicate_Ignore_Server_Ids: \n             Master_Server_Id: 1\n                  Master_UUID: 466c4a60-03f4-11ec-a1a1-0242ac160002\n             Master_Info_File: /var/lib/mysql/master.info\n                    SQL_Delay: 0\n          SQL_Remaining_Delay: NULL\n      Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates\n           Master_Retry_Count: 86400\n                  Master_Bind: \n      Last_IO_Error_Timestamp: \n     Last_SQL_Error_Timestamp: \n               Master_SSL_Crl: \n           Master_SSL_Crlpath: \n           Retrieved_Gtid_Set: \n            Executed_Gtid_Set: \n                Auto_Position: 0\n         Replicate_Rewrite_DB: \n                 Channel_Name: \n           Master_TLS_Version: \n\n```\n\n<p class=\"note note-success\"> 上面看到 Slave_IO_Running: Yes，Slave_SQL_Running: Yes 表示已经成功开启主从</p>\n\n连接主mysql参数说明：\n\n**master_port**：Master的端口号，指的是容器的端口号\n\n**master_user**：用于数据同步的用户\n\n**master_password**：用于同步的用户的密码\n\n**master_log_file**：指定 Slave 从哪个日志文件开始复制数据，即上文中提到的 File 字段的值\n\n**master_log_pos**：从哪个 Position 开始读，即上文中提到的 Position 字段的值\n\n**master_connect_retry**：如果连接失败，重试的时间间隔，单位是秒，默认是60秒\n\n## 搭建双主结构\n\n通过上面主从结构我们可以我们可以大胆设想，要是两个数据库的实例都配置对方为master不就实现的双主么？事实却是如此：\n\n双主结构只需要将双方的配置文件注释掉的地方取消注释掉分别在两台服务器上创同步账号和配置\n\n### 创建docker-compose文件（双主）\n\n这里只更改了docker-compose中服务的名称\n\n```yaml\nversion: '3.8'\nservices:\n  mysql-m1:\n    container_name: mysql-m1\n    image: mysql:5.7.31\n    restart: always\n    ports:\n      - 13306:3306 \n    privileged: true\n    volumes:\n      # 这个只对mysql主从进行验证 没有持久化配置以及日志相关的映射\n      - $PWD/m1/conf/my.cnf:/etc/mysql/my.cnf\n    environment:\n      MYSQL_ROOT_PASSWORD: \"123456\"\n    command: [\n        '--character-set-server=utf8mb4',\n        '--collation-server=utf8mb4_general_ci',\n        '--max_connections=3000'\n    ]\n    networks:\n      - myweb\n      \n  mysql-m2:\n    container_name: mysql-m2 \n    image: mysql:5.7.31\n    restart: always\n    ports:\n      - 23306:3306 \n    privileged: true\n    volumes:\n      # 这个只对mysql主从进行验证 没有持久化配置以及日志相关的映射\n      - $PWD/m2/conf/my.cnf:/etc/mysql/my.cnf\n    environment:\n      MYSQL_ROOT_PASSWORD: \"123456\"\n    command: [\n        '--character-set-server=utf8mb4',\n        '--collation-server=utf8mb4_general_ci',\n        '--max_connections=3000'\n    ]\n    networks:\n      - myweb    \n\nnetworks:\n  myweb:\n    driver: bridge\n```\n\n### 创建配置文件(双主)\n\n这里只是将主从中的配置中注释掉的服务添加上\n\n#### 配置文件目录结构（双主）\n\n```bash\n[root@xxx MySQLM-M]# tree\n.\n├── docker-compose.yaml\n├── m1\n│   └── conf\n│       └── my.cnf\n└── m2\n    └── conf\n        └── my.cnf\n```\n\n#### m1/conf/my.cnf\n\n```bash\n[mysqld]\n# [必须]服务器唯一ID，默认是1，一般取IP最后一段\nserver-id=1\n\n\n# ###################################################\n# 如果当前实例既做主库又做从库次选线必须开启\nlog-slave-updates = true \n\n# 自增长ID\n# 特殊说明 当该实例为双主的架构时要特殊配置 以避免自增id冲突的问题\nauto_increment_offset = 1\nauto_increment_increment = 2  \n# ####################################################\n\n\n# [必须]启用二进制日志\nlog-bin=mysql-bin \n\n# 复制过滤：也就是指定哪个数据库不用同步（mysql库一般不同步）\nbinlog-ignore-db=mysql\n\n# 确保binlog日志写入后与硬盘同步\nsync_binlog = 1\n\n# 设置需要同步的数据库 binlog_do_db = 数据库名； \n# 如果是多个同步库，就以此格式另写几行即可。\n# 如果不指明对某个具体库同步，表示同步所有库。除了binlog-ignore-db设置的忽略的库\n# binlog_do_db = test #需要同步test数据库。\n\n# 设置需要同步的数据库，主服务器上不限定数据库，在从服务器上限定replicate-do-db = 数据库名；\n# 如果不指明同步哪些库，就去掉这行，表示所有库的同步（除了ignore忽略的库）。\n# replicate-do-db = test；\n\n# 跳过所有的错误，继续执行复制操作\nslave-skip-errors = all  \n```\n\n#### m2/conf/my.cnf\n\n```bash\n[mysqld]\n# [必须]服务器唯一ID，默认是1，一般取IP最后一段  \nserver-id=2\n\n\n# ###################################################\n# 如果当前实例既做主库又做从库次选线必须开启\nlog-slave-updates = true \n\n# 自增长ID\n# 特殊说明 当该实例为双主的架构时要特殊配置 以避免自增id冲突的问题\nauto_increment_offset = 2\nauto_increment_increment = 2  \n# ####################################################\n\n# [必须]启用二进制日志\nlog-bin=mysql-bin \n\n# 复制过滤：也就是指定哪个数据库不用同步（mysql库一般不同步）\nbinlog-ignore-db=mysql\n\n# 确保binlog日志写入后与硬盘同步\nsync_binlog = 1\n\n# 设置需要同步的数据库 binlog_do_db = 数据库名； \n# 如果是多个同步库，就以此格式另写几行即可。\n# 如果不指明对某个具体库同步，表示同步所有库。除了binlog-ignore-db设置的忽略的库\n# binlog_do_db = test #需要同步test数据库。\n\n# 设置需要同步的数据库，主服务器上不限定数据库，在从服务器上限定replicate-do-db = 数据库名；\n# 如果不指明同步哪些库，就去掉这行，表示所有库的同步（除了ignore忽略的库）。\n# replicate-do-db = test；\n\n# 跳过所有的错误，继续执行复制操作\nslave-skip-errors = all \n```\n\n### 启动docker-compose并配置m1和m2的双主\n\n#### 启动（双主）\n\n```bash\ndocker-compose up -d \n```\n\n进入m1和m2下执行下列命令来获取各自的master status 和同步账号\n\nm1:\n\n```bash\ndocker-compose exec mysql-m1 bash\n\nmysql -uroot -p123456\n\n# 查看m1 File和Position\nmysql> show master status;\n+------------------+----------+--------------+------------------+-------------------+\n| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |\n+------------------+----------+--------------+------------------+-------------------+\n| mysql-bin.000005 |      154 |              | mysql            |                   |\n+------------------+----------+--------------+------------------+-------------------+\n\n# 创建同步账号\nmysql> grant replication slave,replication client on *.* to 'slave'@'%' identified by \"123456\";\nmysql> flush privileges;\n\n```\n\nm2:\n\n```bash\ndocker-compose exec mysql-m1 bash\n\nmysql -uroot -p123456\n\n# 查看m2 File和Position\nmysql> show master status;\n+------------------+----------+--------------+------------------+-------------------+\n| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |\n+------------------+----------+--------------+------------------+-------------------+\n| mysql-bin.000005 |      154 |              | mysql            |                   |\n+------------------+----------+--------------+------------------+-------------------+\n\n# 创建同步账号\nmysql> grant replication slave,replication client on *.* to 'slave'@'%' identified by \"123456\";\nmysql> flush privileges;\n```\n\nm1:\n\n```bash\nmysql> change master to master_host='mysql-m2',master_user='slave',master_password='123456',master_port=3306,master_log_file='mysql-bin.000005', master_log_pos=154,master_connect_retry=30;\n\nmysql> start slave;\n\nmysql> show slave status \\G\n*************************** 1. row ***************************\n               Slave_IO_State: Waiting for master to send event\n                  Master_Host: mysql-m2\n                  Master_User: slave\n                  Master_Port: 3306\n                Connect_Retry: 30\n              Master_Log_File: mysql-bin.000005\n          Read_Master_Log_Pos: 620\n               Relay_Log_File: de7a84f1b7f1-relay-bin.000002\n                Relay_Log_Pos: 786\n        Relay_Master_Log_File: mysql-bin.000005\n             Slave_IO_Running: Yes\n            Slave_SQL_Running: Yes\n              Replicate_Do_DB:\n          Replicate_Ignore_DB:\n           Replicate_Do_Table:\n       Replicate_Ignore_Table:\n      Replicate_Wild_Do_Table:\n  Replicate_Wild_Ignore_Table:\n                   Last_Errno: 0\n                   Last_Error:\n                 Skip_Counter: 0\n          Exec_Master_Log_Pos: 620\n              Relay_Log_Space: 1000\n              Until_Condition: None\n               Until_Log_File:\n                Until_Log_Pos: 0\n           Master_SSL_Allowed: No\n           Master_SSL_CA_File:\n           Master_SSL_CA_Path:\n              Master_SSL_Cert:\n            Master_SSL_Cipher:\n               Master_SSL_Key:\n        Seconds_Behind_Master: 0\nMaster_SSL_Verify_Server_Cert: No\n                Last_IO_Errno: 0\n                Last_IO_Error:\n               Last_SQL_Errno: 0\n               Last_SQL_Error:\n  Replicate_Ignore_Server_Ids:\n             Master_Server_Id: 2\n                  Master_UUID: de8af5ce-0410-11ec-ab6d-0242ac170003\n             Master_Info_File: /var/lib/mysql/master.info\n                    SQL_Delay: 0\n          SQL_Remaining_Delay: NULL\n      Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates\n           Master_Retry_Count: 86400\n                  Master_Bind:\n      Last_IO_Error_Timestamp:\n     Last_SQL_Error_Timestamp:\n               Master_SSL_Crl:\n           Master_SSL_Crlpath:\n           Retrieved_Gtid_Set:\n            Executed_Gtid_Set:\n                Auto_Position: 0\n         Replicate_Rewrite_DB:\n                 Channel_Name:\n           Master_TLS_Version:\n\n```\n\nm2:\n\n```bash\nmysql> change master to master_host='mysql-m1',master_user='slave',master_password='123456',master_port=3306,master_log_file='mysql-bin.000005', master_log_pos=154,master_connect_retry=30;\n\nmysql> start slave;\n\nmysql> show slave status \\G\n*************************** 1. row ***************************\n               Slave_IO_State: Waiting for master to send event\n                  Master_Host: mysql-m1\n                  Master_User: slave\n                  Master_Port: 3306\n                Connect_Retry: 30\n              Master_Log_File: mysql-bin.000005\n          Read_Master_Log_Pos: 1086\n               Relay_Log_File: 65322be4d8a9-relay-bin.000002\n                Relay_Log_Pos: 786\n        Relay_Master_Log_File: mysql-bin.000005\n             Slave_IO_Running: Yes\n            Slave_SQL_Running: Yes\n              Replicate_Do_DB:\n          Replicate_Ignore_DB:\n           Replicate_Do_Table:\n       Replicate_Ignore_Table:\n      Replicate_Wild_Do_Table:\n  Replicate_Wild_Ignore_Table:\n                   Last_Errno: 0\n                   Last_Error:\n                 Skip_Counter: 0\n          Exec_Master_Log_Pos: 1086\n              Relay_Log_Space: 1000\n              Until_Condition: None\n               Until_Log_File:\n                Until_Log_Pos: 0\n           Master_SSL_Allowed: No\n           Master_SSL_CA_File:\n           Master_SSL_CA_Path:\n              Master_SSL_Cert:\n            Master_SSL_Cipher:\n               Master_SSL_Key:\n        Seconds_Behind_Master: 0\nMaster_SSL_Verify_Server_Cert: No\n                Last_IO_Errno: 0\n                Last_IO_Error:\n               Last_SQL_Errno: 0\n               Last_SQL_Error:\n  Replicate_Ignore_Server_Ids:\n             Master_Server_Id: 1\n                  Master_UUID: de898a82-0410-11ec-9fee-0242ac170002\n             Master_Info_File: /var/lib/mysql/master.info\n                    SQL_Delay: 0\n          SQL_Remaining_Delay: NULL\n      Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates\n           Master_Retry_Count: 86400\n                  Master_Bind:\n      Last_IO_Error_Timestamp:\n     Last_SQL_Error_Timestamp:\n               Master_SSL_Crl:\n           Master_SSL_Crlpath:\n           Retrieved_Gtid_Set:\n            Executed_Gtid_Set:\n                Auto_Position: 0\n         Replicate_Rewrite_DB:\n                 Channel_Name:\n           Master_TLS_Version:\n```\n\n<p class=\"noet note-success\">至此双主节点设置完成</p>\n\n## 总结\n\n主从模式多用来进行读写分离\n\n双主模式多用来进行高可用\n\n更复杂的部署可能会部署多master和多slave并用keeplive保证统一访问的模式，这里没探究\n","slug":"docker-compose搭建MySql主从和双主","published":1,"updated":"2021-08-23T14:00:18.942Z","_id":"cksoctoh00000mn8z5wzr74op","comments":1,"layout":"post","photos":[],"link":"","content":"<p class=\"note note-primary\">相信mysql的binlog都不陌生</br>binlog的主要作用就是进行数据同步，今天我们从数据同步的角度搭一下mysql的主从/双主。</p>\n\n<h2 id=\"base\"><a href=\"#base\" class=\"headerlink\" title=\"base\"></a>base</h2><p>以下基于mysql5.7</p>\n<h2 id=\"简单了解下binlog\"><a href=\"#简单了解下binlog\" class=\"headerlink\" title=\"简单了解下binlog\"></a>简单了解下binlog</h2><ul>\n<li><p>binlog是记录所有数据库表结构变更（例如CREATE、ALTER TABLE…）以及表数据修改（INSERT、UPDATE、DELETE…）的二进制日志。</p>\n</li>\n<li><p>binlog日志包括两类文件：二进制日志索引文件（文件名后缀为.index）用于记录所有的二进制文件，二进制日志文件（文件名后缀为.00000*）记录数据库所有的DDL和DML(除了数据查询语句)语句事件。</p>\n</li>\n<li><p>binlog有三种格式：statement基于sql语句复制、row基于行数据变更的复制、mixed混合前两种格式的复制。</p>\n</li>\n</ul>\n<h2 id=\"搭建主从结构\"><a href=\"#搭建主从结构\" class=\"headerlink\" title=\"搭建主从结构\"></a>搭建主从结构</h2><p><img src=\"/img/mysql/mysql-m-s.png\" alt=\"mysql主从架构\"></p>\n<h3 id=\"创建docker-compose\"><a href=\"#创建docker-compose\" class=\"headerlink\" title=\"创建docker-compose\"></a>创建docker-compose</h3><figure class=\"highlight yml\"><table><tr><td class=\"gutter hljs\"><div class=\"hljs code-wrapper\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></div></td><td class=\"code\"><div class=\"hljs code-wrapper\"><pre><code class=\"hljs yml\"><span class=\"hljs-attr\">version:</span> <span class=\"hljs-string\">&#x27;3.8&#x27;</span><br><span class=\"hljs-attr\">services:</span><br>  <span class=\"hljs-attr\">mysql-master:</span><br>    <span class=\"hljs-attr\">container_name:</span> <span class=\"hljs-string\">mysql-master</span> <br>    <span class=\"hljs-attr\">image:</span> <span class=\"hljs-string\">mysql:5.7.31</span><br>    <span class=\"hljs-attr\">restart:</span> <span class=\"hljs-string\">always</span><br>    <span class=\"hljs-attr\">ports:</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-number\">13306</span><span class=\"hljs-string\">:3306</span> <br>    <span class=\"hljs-attr\">privileged:</span> <span class=\"hljs-literal\">true</span><br>    <span class=\"hljs-attr\">volumes:</span><br>      <span class=\"hljs-comment\"># 这个只对mysql主从进行验证 没有持久化配置以及日志相关的映射</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">$PWD/master/conf/my.cnf:/etc/mysql/my.cnf</span><br>    <span class=\"hljs-attr\">environment:</span><br>      <span class=\"hljs-attr\">MYSQL_ROOT_PASSWORD:</span> <span class=\"hljs-string\">&quot;123456&quot;</span><br>    <span class=\"hljs-attr\">command:</span> [<br>        <span class=\"hljs-string\">&#x27;--character-set-server=utf8mb4&#x27;</span>,<br>        <span class=\"hljs-string\">&#x27;--collation-server=utf8mb4_general_ci&#x27;</span>,<br>        <span class=\"hljs-string\">&#x27;--max_connections=3000&#x27;</span><br>    ]<br>    <span class=\"hljs-attr\">networks:</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">myweb</span><br>      <br>  <span class=\"hljs-attr\">mysql-slave:</span><br>    <span class=\"hljs-attr\">container_name:</span> <span class=\"hljs-string\">mysql-slave</span> <br>    <span class=\"hljs-attr\">image:</span> <span class=\"hljs-string\">mysql:5.7.31</span><br>    <span class=\"hljs-attr\">restart:</span> <span class=\"hljs-string\">always</span><br>    <span class=\"hljs-attr\">ports:</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-number\">23306</span><span class=\"hljs-string\">:3306</span> <br>    <span class=\"hljs-attr\">privileged:</span> <span class=\"hljs-literal\">true</span><br>    <span class=\"hljs-attr\">volumes:</span><br>      <span class=\"hljs-comment\"># 这个只对mysql主从进行验证 没有持久化配置以及日志相关的映射</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">$PWD/slave/conf/my.cnf:/etc/mysql/my.cnf</span><br>    <span class=\"hljs-attr\">environment:</span><br>      <span class=\"hljs-attr\">MYSQL_ROOT_PASSWORD:</span> <span class=\"hljs-string\">&quot;123456&quot;</span><br>    <span class=\"hljs-attr\">command:</span> [<br>        <span class=\"hljs-string\">&#x27;--character-set-server=utf8mb4&#x27;</span>,<br>        <span class=\"hljs-string\">&#x27;--collation-server=utf8mb4_general_ci&#x27;</span>,<br>        <span class=\"hljs-string\">&#x27;--max_connections=3000&#x27;</span><br>    ]<br>    <span class=\"hljs-attr\">networks:</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">myweb</span>    <br><br><span class=\"hljs-attr\">networks:</span><br>  <span class=\"hljs-attr\">myweb:</span><br>    <span class=\"hljs-attr\">driver:</span> <span class=\"hljs-string\">bridge</span><br></code></pre></div></td></tr></table></figure>\n\n<h3 id=\"创建配置文件\"><a href=\"#创建配置文件\" class=\"headerlink\" title=\"创建配置文件\"></a>创建配置文件</h3><h4 id=\"配置文件目录结构\"><a href=\"#配置文件目录结构\" class=\"headerlink\" title=\"配置文件目录结构\"></a>配置文件目录结构</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter hljs\"><div class=\"hljs code-wrapper\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></div></td><td class=\"code\"><div class=\"hljs code-wrapper\"><pre><code class=\"hljs bash\">[root@xxx MySQLM-S]<span class=\"hljs-comment\"># tree</span><br>.<br>├── docker-compose.yaml<br>├── master<br>│   └── conf<br>│       └── my.cnf<br>└── slave<br>    └── conf<br>        └── my.cnf<br></code></pre></div></td></tr></table></figure>\n\n<h4 id=\"master-conf-my-cnf-配置文件\"><a href=\"#master-conf-my-cnf-配置文件\" class=\"headerlink\" title=\"master/conf/my.cnf 配置文件\"></a>master/conf/my.cnf 配置文件</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter hljs\"><div class=\"hljs code-wrapper\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></div></td><td class=\"code\"><div class=\"hljs code-wrapper\"><pre><code class=\"hljs bash\">[mysqld]<br><span class=\"hljs-comment\"># [必须]服务器唯一ID，默认是1，一般取IP最后一段</span><br>server-id=1<br><br><br><span class=\"hljs-comment\"># ###################################################</span><br><span class=\"hljs-comment\"># 如果当前实例既做主库又做从库次选线必须开启</span><br><span class=\"hljs-comment\"># log-slave-updates = true </span><br><br><span class=\"hljs-comment\"># 自增长ID</span><br><span class=\"hljs-comment\"># 特殊说明 当该实例为双主的架构时要特殊配置 以避免自增id冲突的问题</span><br><span class=\"hljs-comment\"># auto_increment_offset = 1</span><br><span class=\"hljs-comment\"># auto_increment_increment = 2  </span><br><span class=\"hljs-comment\"># ####################################################</span><br><br><br><span class=\"hljs-comment\"># [必须]启用二进制日志</span><br>log-bin=mysql-bin <br><br><span class=\"hljs-comment\"># 复制过滤：也就是指定哪个数据库不用同步（mysql库一般不同步）</span><br>binlog-ignore-db=mysql<br><br><span class=\"hljs-comment\"># 确保binlog日志写入后与硬盘同步</span><br>sync_binlog = 1<br><br><span class=\"hljs-comment\"># 设置需要同步的数据库 binlog_do_db = 数据库名； </span><br><span class=\"hljs-comment\"># 如果是多个同步库，就以此格式另写几行即可。</span><br><span class=\"hljs-comment\"># 如果不指明对某个具体库同步，表示同步所有库。除了binlog-ignore-db设置的忽略的库</span><br><span class=\"hljs-comment\"># binlog_do_db = test #需要同步test数据库。</span><br><br><span class=\"hljs-comment\"># 设置需要同步的数据库，主服务器上不限定数据库，在从服务器上限定replicate-do-db = 数据库名；</span><br><span class=\"hljs-comment\"># 如果不指明同步哪些库，就去掉这行，表示所有库的同步（除了ignore忽略的库）。</span><br><span class=\"hljs-comment\"># replicate-do-db = test；</span><br><br><span class=\"hljs-comment\"># 跳过所有的错误，继续执行复制操作</span><br>slave-skip-errors = all  <br></code></pre></div></td></tr></table></figure>\n\n<h4 id=\"slave-conf-my-cnf-配置文件\"><a href=\"#slave-conf-my-cnf-配置文件\" class=\"headerlink\" title=\"slave/conf/my.cnf 配置文件\"></a>slave/conf/my.cnf 配置文件</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter hljs\"><div class=\"hljs code-wrapper\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></div></td><td class=\"code\"><div class=\"hljs code-wrapper\"><pre><code class=\"hljs bash\">[mysqld]<br><span class=\"hljs-comment\"># [必须]服务器唯一ID，默认是1，一般取IP最后一段  </span><br>server-id=2<br><br><br><span class=\"hljs-comment\"># ###################################################</span><br><span class=\"hljs-comment\"># 如果当前实例既做主库又做从库次选线必须开启</span><br><span class=\"hljs-comment\"># log-slave-updates = true </span><br><br><span class=\"hljs-comment\"># 自增长ID</span><br><span class=\"hljs-comment\"># 特殊说明 当该实例为双主的架构时要特殊配置 以避免自增id冲突的问题</span><br><span class=\"hljs-comment\"># auto_increment_offset = 2</span><br><span class=\"hljs-comment\"># auto_increment_increment = 2  </span><br><span class=\"hljs-comment\"># ####################################################</span><br><br><span class=\"hljs-comment\"># [必须]启用二进制日志</span><br>log-bin=mysql-bin <br><br><span class=\"hljs-comment\"># 复制过滤：也就是指定哪个数据库不用同步（mysql库一般不同步）</span><br>binlog-ignore-db=mysql<br><br><span class=\"hljs-comment\"># 确保binlog日志写入后与硬盘同步</span><br><span class=\"hljs-comment\"># sync_binlog = 1</span><br><br><span class=\"hljs-comment\"># 设置需要同步的数据库 binlog_do_db = 数据库名； </span><br><span class=\"hljs-comment\"># 如果是多个同步库，就以此格式另写几行即可。</span><br><span class=\"hljs-comment\"># 如果不指明对某个具体库同步，表示同步所有库。除了binlog-ignore-db设置的忽略的库</span><br><span class=\"hljs-comment\"># binlog_do_db = test #需要同步test数据库。</span><br><br><span class=\"hljs-comment\"># 设置需要同步的数据库，主服务器上不限定数据库，在从服务器上限定replicate-do-db = 数据库名；</span><br><span class=\"hljs-comment\"># 如果不指明同步哪些库，就去掉这行，表示所有库的同步（除了ignore忽略的库）。</span><br><span class=\"hljs-comment\"># replicate-do-db = test；</span><br><br><span class=\"hljs-comment\"># 跳过所有的错误，继续执行复制操作</span><br>slave-skip-errors = all <br></code></pre></div></td></tr></table></figure>\n\n<h3 id=\"启动docker-compose并配置主从关系\"><a href=\"#启动docker-compose并配置主从关系\" class=\"headerlink\" title=\"启动docker-compose并配置主从关系\"></a>启动docker-compose并配置主从关系</h3><h4 id=\"启动\"><a href=\"#启动\" class=\"headerlink\" title=\"启动\"></a>启动</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter hljs\"><div class=\"hljs code-wrapper\"><pre><span class=\"line\">1</span><br></pre></div></td><td class=\"code\"><div class=\"hljs code-wrapper\"><pre><code class=\"hljs bash\">docker-compose up -d <br></code></pre></div></td></tr></table></figure>\n\n<h4 id=\"进入master配置同步账号和权限\"><a href=\"#进入master配置同步账号和权限\" class=\"headerlink\" title=\"进入master配置同步账号和权限\"></a>进入master配置同步账号和权限</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter hljs\"><div class=\"hljs code-wrapper\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></div></td><td class=\"code\"><div class=\"hljs code-wrapper\"><pre><code class=\"hljs bash\">docker-compose <span class=\"hljs-built_in\">exec</span> mysql-slave bash<br><br>mysql -uroot -p123455<br><br><span class=\"hljs-comment\"># 查看配置的服务ID</span><br>mysql&gt; show variables like <span class=\"hljs-string\">&#x27;%server_id%&#x27;</span>;<br>+----------------+-------+<br>| Variable_name  | Value |<br>+----------------+-------+<br>| server_id      | 1     |<br>| server_id_bits | 32    |<br>+----------------+-------+<br><br><span class=\"hljs-comment\"># 看master信息 File 和 Position 从服务上要用</span><br>mysql&gt; show master status;<br>+------------------+----------+--------------+------------------+-------------------+<br>| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |<br>+------------------+----------+--------------+------------------+-------------------+<br>| mysql-bin.000004 |      154 |              | mysql            |                   |<br>+------------------+----------+--------------+------------------+-------------------+<br><br><span class=\"hljs-comment\"># 创建同步账户并开启权限</span><br>mysql&gt; grant replication slave,replication client on *.* to <span class=\"hljs-string\">&#x27;slave&#x27;</span>@<span class=\"hljs-string\">&#x27;%&#x27;</span> identified by <span class=\"hljs-string\">&quot;123456&quot;</span>;<br>mysql&gt; flush privileges;<br></code></pre></div></td></tr></table></figure>\n\n<h4 id=\"进入slave服务配置\"><a href=\"#进入slave服务配置\" class=\"headerlink\" title=\"进入slave服务配置\"></a>进入slave服务配置</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter hljs\"><div class=\"hljs code-wrapper\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br></pre></div></td><td class=\"code\"><div class=\"hljs code-wrapper\"><pre><code class=\"hljs bash\">docker-compose <span class=\"hljs-built_in\">exec</span> docker-slave bash<br><br>mysql -uroot -p123456<br><br><span class=\"hljs-comment\">#查看server_id是否生效</span><br>mysql&gt; show variables like <span class=\"hljs-string\">&#x27;%server_id%&#x27;</span>;<br>+----------------+-------+<br>| Variable_name  | Value |<br>+----------------+-------+<br>| server_id      | 2     |<br>| server_id_bits | 32    |<br>+----------------+-------+<br><br><span class=\"hljs-comment\"># 连接主mysql服务 master_log_file 和 master_log_pos的值要填写主master里查出来的值 注意这里使用的docker-compose 内部服务的端口和ip</span><br>mysql&gt; change master to master_host=<span class=\"hljs-string\">&#x27;mysql-master&#x27;</span>,master_user=<span class=\"hljs-string\">&#x27;slave&#x27;</span>,master_password=<span class=\"hljs-string\">&#x27;123456&#x27;</span>,master_port=3306,master_log_file=<span class=\"hljs-string\">&#x27;mysql-bin.000004&#x27;</span>, master_log_pos=154,master_connect_retry=30;<br><br><br><span class=\"hljs-comment\"># 开启slave</span><br><br>mysql&gt; start slave;<br><br>mysql&gt; show slave status \\G<br>*************************** 1. row ***************************<br>               Slave_IO_State: Waiting <span class=\"hljs-keyword\">for</span> master to send event<br>                  Master_Host: mysql-master<br>                  Master_User: slave<br>                  Master_Port: 3306<br>                Connect_Retry: 30<br>              Master_Log_File: mysql-bin.000004<br>          Read_Master_Log_Pos: 778<br>               Relay_Log_File: af5556aff9be-relay-bin.000002<br>                Relay_Log_Pos: 944<br>        Relay_Master_Log_File: mysql-bin.000004<br>             Slave_IO_Running: Yes<br>            Slave_SQL_Running: Yes<br>              Replicate_Do_DB: <br>          Replicate_Ignore_DB: mysql<br>           Replicate_Do_Table: <br>       Replicate_Ignore_Table: <br>      Replicate_Wild_Do_Table: <br>  Replicate_Wild_Ignore_Table: <br>                   Last_Errno: 0<br>                   Last_Error: <br>                 Skip_Counter: 0<br>          Exec_Master_Log_Pos: 778<br>              Relay_Log_Space: 1158<br>              Until_Condition: None<br>               Until_Log_File: <br>                Until_Log_Pos: 0<br>           Master_SSL_Allowed: No<br>           Master_SSL_CA_File: <br>           Master_SSL_CA_Path: <br>              Master_SSL_Cert: <br>            Master_SSL_Cipher: <br>               Master_SSL_Key: <br>        Seconds_Behind_Master: 0<br>Master_SSL_Verify_Server_Cert: No<br>                Last_IO_Errno: 0<br>                Last_IO_Error: <br>               Last_SQL_Errno: 0<br>               Last_SQL_Error: <br>  Replicate_Ignore_Server_Ids: <br>             Master_Server_Id: 1<br>                  Master_UUID: 466c4a60-03f4-11ec-a1a1-0242ac160002<br>             Master_Info_File: /var/lib/mysql/master.info<br>                    SQL_Delay: 0<br>          SQL_Remaining_Delay: NULL<br>      Slave_SQL_Running_State: Slave has <span class=\"hljs-built_in\">read</span> all relay <span class=\"hljs-built_in\">log</span>; waiting <span class=\"hljs-keyword\">for</span> more updates<br>           Master_Retry_Count: 86400<br>                  Master_Bind: <br>      Last_IO_Error_Timestamp: <br>     Last_SQL_Error_Timestamp: <br>               Master_SSL_Crl: <br>           Master_SSL_Crlpath: <br>           Retrieved_Gtid_Set: <br>            Executed_Gtid_Set: <br>                Auto_Position: 0<br>         Replicate_Rewrite_DB: <br>                 Channel_Name: <br>           Master_TLS_Version: <br><br></code></pre></div></td></tr></table></figure>\n\n<p class=\"note note-success\"> 上面看到 Slave_IO_Running: Yes，Slave_SQL_Running: Yes 表示已经成功开启主从</p>\n\n<p>连接主mysql参数说明：</p>\n<p><strong>master_port</strong>：Master的端口号，指的是容器的端口号</p>\n<p><strong>master_user</strong>：用于数据同步的用户</p>\n<p><strong>master_password</strong>：用于同步的用户的密码</p>\n<p><strong>master_log_file</strong>：指定 Slave 从哪个日志文件开始复制数据，即上文中提到的 File 字段的值</p>\n<p><strong>master_log_pos</strong>：从哪个 Position 开始读，即上文中提到的 Position 字段的值</p>\n<p><strong>master_connect_retry</strong>：如果连接失败，重试的时间间隔，单位是秒，默认是60秒</p>\n<h2 id=\"搭建双主结构\"><a href=\"#搭建双主结构\" class=\"headerlink\" title=\"搭建双主结构\"></a>搭建双主结构</h2><p>通过上面主从结构我们可以我们可以大胆设想，要是两个数据库的实例都配置对方为master不就实现的双主么？事实却是如此：</p>\n<p>双主结构只需要将双方的配置文件注释掉的地方取消注释掉分别在两台服务器上创同步账号和配置</p>\n<h3 id=\"创建docker-compose文件（双主）\"><a href=\"#创建docker-compose文件（双主）\" class=\"headerlink\" title=\"创建docker-compose文件（双主）\"></a>创建docker-compose文件（双主）</h3><p>这里只更改了docker-compose中服务的名称</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter hljs\"><div class=\"hljs code-wrapper\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></div></td><td class=\"code\"><div class=\"hljs code-wrapper\"><pre><code class=\"hljs yaml\"><span class=\"hljs-attr\">version:</span> <span class=\"hljs-string\">&#x27;3.8&#x27;</span><br><span class=\"hljs-attr\">services:</span><br>  <span class=\"hljs-attr\">mysql-m1:</span><br>    <span class=\"hljs-attr\">container_name:</span> <span class=\"hljs-string\">mysql-m1</span><br>    <span class=\"hljs-attr\">image:</span> <span class=\"hljs-string\">mysql:5.7.31</span><br>    <span class=\"hljs-attr\">restart:</span> <span class=\"hljs-string\">always</span><br>    <span class=\"hljs-attr\">ports:</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-number\">13306</span><span class=\"hljs-string\">:3306</span> <br>    <span class=\"hljs-attr\">privileged:</span> <span class=\"hljs-literal\">true</span><br>    <span class=\"hljs-attr\">volumes:</span><br>      <span class=\"hljs-comment\"># 这个只对mysql主从进行验证 没有持久化配置以及日志相关的映射</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">$PWD/m1/conf/my.cnf:/etc/mysql/my.cnf</span><br>    <span class=\"hljs-attr\">environment:</span><br>      <span class=\"hljs-attr\">MYSQL_ROOT_PASSWORD:</span> <span class=\"hljs-string\">&quot;123456&quot;</span><br>    <span class=\"hljs-attr\">command:</span> [<br>        <span class=\"hljs-string\">&#x27;--character-set-server=utf8mb4&#x27;</span>,<br>        <span class=\"hljs-string\">&#x27;--collation-server=utf8mb4_general_ci&#x27;</span>,<br>        <span class=\"hljs-string\">&#x27;--max_connections=3000&#x27;</span><br>    ]<br>    <span class=\"hljs-attr\">networks:</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">myweb</span><br>      <br>  <span class=\"hljs-attr\">mysql-m2:</span><br>    <span class=\"hljs-attr\">container_name:</span> <span class=\"hljs-string\">mysql-m2</span> <br>    <span class=\"hljs-attr\">image:</span> <span class=\"hljs-string\">mysql:5.7.31</span><br>    <span class=\"hljs-attr\">restart:</span> <span class=\"hljs-string\">always</span><br>    <span class=\"hljs-attr\">ports:</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-number\">23306</span><span class=\"hljs-string\">:3306</span> <br>    <span class=\"hljs-attr\">privileged:</span> <span class=\"hljs-literal\">true</span><br>    <span class=\"hljs-attr\">volumes:</span><br>      <span class=\"hljs-comment\"># 这个只对mysql主从进行验证 没有持久化配置以及日志相关的映射</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">$PWD/m2/conf/my.cnf:/etc/mysql/my.cnf</span><br>    <span class=\"hljs-attr\">environment:</span><br>      <span class=\"hljs-attr\">MYSQL_ROOT_PASSWORD:</span> <span class=\"hljs-string\">&quot;123456&quot;</span><br>    <span class=\"hljs-attr\">command:</span> [<br>        <span class=\"hljs-string\">&#x27;--character-set-server=utf8mb4&#x27;</span>,<br>        <span class=\"hljs-string\">&#x27;--collation-server=utf8mb4_general_ci&#x27;</span>,<br>        <span class=\"hljs-string\">&#x27;--max_connections=3000&#x27;</span><br>    ]<br>    <span class=\"hljs-attr\">networks:</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">myweb</span>    <br><br><span class=\"hljs-attr\">networks:</span><br>  <span class=\"hljs-attr\">myweb:</span><br>    <span class=\"hljs-attr\">driver:</span> <span class=\"hljs-string\">bridge</span><br></code></pre></div></td></tr></table></figure>\n\n<h3 id=\"创建配置文件-双主\"><a href=\"#创建配置文件-双主\" class=\"headerlink\" title=\"创建配置文件(双主)\"></a>创建配置文件(双主)</h3><p>这里只是将主从中的配置中注释掉的服务添加上</p>\n<h4 id=\"配置文件目录结构（双主）\"><a href=\"#配置文件目录结构（双主）\" class=\"headerlink\" title=\"配置文件目录结构（双主）\"></a>配置文件目录结构（双主）</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter hljs\"><div class=\"hljs code-wrapper\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></div></td><td class=\"code\"><div class=\"hljs code-wrapper\"><pre><code class=\"hljs bash\">[root@xxx MySQLM-M]<span class=\"hljs-comment\"># tree</span><br>.<br>├── docker-compose.yaml<br>├── m1<br>│   └── conf<br>│       └── my.cnf<br>└── m2<br>    └── conf<br>        └── my.cnf<br></code></pre></div></td></tr></table></figure>\n\n<h4 id=\"m1-conf-my-cnf\"><a href=\"#m1-conf-my-cnf\" class=\"headerlink\" title=\"m1/conf/my.cnf\"></a>m1/conf/my.cnf</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter hljs\"><div class=\"hljs code-wrapper\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></div></td><td class=\"code\"><div class=\"hljs code-wrapper\"><pre><code class=\"hljs bash\">[mysqld]<br><span class=\"hljs-comment\"># [必须]服务器唯一ID，默认是1，一般取IP最后一段</span><br>server-id=1<br><br><br><span class=\"hljs-comment\"># ###################################################</span><br><span class=\"hljs-comment\"># 如果当前实例既做主库又做从库次选线必须开启</span><br>log-slave-updates = <span class=\"hljs-literal\">true</span> <br><br><span class=\"hljs-comment\"># 自增长ID</span><br><span class=\"hljs-comment\"># 特殊说明 当该实例为双主的架构时要特殊配置 以避免自增id冲突的问题</span><br>auto_increment_offset = 1<br>auto_increment_increment = 2  <br><span class=\"hljs-comment\"># ####################################################</span><br><br><br><span class=\"hljs-comment\"># [必须]启用二进制日志</span><br>log-bin=mysql-bin <br><br><span class=\"hljs-comment\"># 复制过滤：也就是指定哪个数据库不用同步（mysql库一般不同步）</span><br>binlog-ignore-db=mysql<br><br><span class=\"hljs-comment\"># 确保binlog日志写入后与硬盘同步</span><br>sync_binlog = 1<br><br><span class=\"hljs-comment\"># 设置需要同步的数据库 binlog_do_db = 数据库名； </span><br><span class=\"hljs-comment\"># 如果是多个同步库，就以此格式另写几行即可。</span><br><span class=\"hljs-comment\"># 如果不指明对某个具体库同步，表示同步所有库。除了binlog-ignore-db设置的忽略的库</span><br><span class=\"hljs-comment\"># binlog_do_db = test #需要同步test数据库。</span><br><br><span class=\"hljs-comment\"># 设置需要同步的数据库，主服务器上不限定数据库，在从服务器上限定replicate-do-db = 数据库名；</span><br><span class=\"hljs-comment\"># 如果不指明同步哪些库，就去掉这行，表示所有库的同步（除了ignore忽略的库）。</span><br><span class=\"hljs-comment\"># replicate-do-db = test；</span><br><br><span class=\"hljs-comment\"># 跳过所有的错误，继续执行复制操作</span><br>slave-skip-errors = all  <br></code></pre></div></td></tr></table></figure>\n\n<h4 id=\"m2-conf-my-cnf\"><a href=\"#m2-conf-my-cnf\" class=\"headerlink\" title=\"m2/conf/my.cnf\"></a>m2/conf/my.cnf</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter hljs\"><div class=\"hljs code-wrapper\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></div></td><td class=\"code\"><div class=\"hljs code-wrapper\"><pre><code class=\"hljs bash\">[mysqld]<br><span class=\"hljs-comment\"># [必须]服务器唯一ID，默认是1，一般取IP最后一段  </span><br>server-id=2<br><br><br><span class=\"hljs-comment\"># ###################################################</span><br><span class=\"hljs-comment\"># 如果当前实例既做主库又做从库次选线必须开启</span><br>log-slave-updates = <span class=\"hljs-literal\">true</span> <br><br><span class=\"hljs-comment\"># 自增长ID</span><br><span class=\"hljs-comment\"># 特殊说明 当该实例为双主的架构时要特殊配置 以避免自增id冲突的问题</span><br>auto_increment_offset = 2<br>auto_increment_increment = 2  <br><span class=\"hljs-comment\"># ####################################################</span><br><br><span class=\"hljs-comment\"># [必须]启用二进制日志</span><br>log-bin=mysql-bin <br><br><span class=\"hljs-comment\"># 复制过滤：也就是指定哪个数据库不用同步（mysql库一般不同步）</span><br>binlog-ignore-db=mysql<br><br><span class=\"hljs-comment\"># 确保binlog日志写入后与硬盘同步</span><br>sync_binlog = 1<br><br><span class=\"hljs-comment\"># 设置需要同步的数据库 binlog_do_db = 数据库名； </span><br><span class=\"hljs-comment\"># 如果是多个同步库，就以此格式另写几行即可。</span><br><span class=\"hljs-comment\"># 如果不指明对某个具体库同步，表示同步所有库。除了binlog-ignore-db设置的忽略的库</span><br><span class=\"hljs-comment\"># binlog_do_db = test #需要同步test数据库。</span><br><br><span class=\"hljs-comment\"># 设置需要同步的数据库，主服务器上不限定数据库，在从服务器上限定replicate-do-db = 数据库名；</span><br><span class=\"hljs-comment\"># 如果不指明同步哪些库，就去掉这行，表示所有库的同步（除了ignore忽略的库）。</span><br><span class=\"hljs-comment\"># replicate-do-db = test；</span><br><br><span class=\"hljs-comment\"># 跳过所有的错误，继续执行复制操作</span><br>slave-skip-errors = all <br></code></pre></div></td></tr></table></figure>\n\n<h3 id=\"启动docker-compose并配置m1和m2的双主\"><a href=\"#启动docker-compose并配置m1和m2的双主\" class=\"headerlink\" title=\"启动docker-compose并配置m1和m2的双主\"></a>启动docker-compose并配置m1和m2的双主</h3><h4 id=\"启动（双主）\"><a href=\"#启动（双主）\" class=\"headerlink\" title=\"启动（双主）\"></a>启动（双主）</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter hljs\"><div class=\"hljs code-wrapper\"><pre><span class=\"line\">1</span><br></pre></div></td><td class=\"code\"><div class=\"hljs code-wrapper\"><pre><code class=\"hljs bash\">docker-compose up -d <br></code></pre></div></td></tr></table></figure>\n\n<p>进入m1和m2下执行下列命令来获取各自的master status 和同步账号</p>\n<p>m1:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter hljs\"><div class=\"hljs code-wrapper\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></div></td><td class=\"code\"><div class=\"hljs code-wrapper\"><pre><code class=\"hljs bash\">docker-compose <span class=\"hljs-built_in\">exec</span> mysql-m1 bash<br><br>mysql -uroot -p123456<br><br><span class=\"hljs-comment\"># 查看m1 File和Position</span><br>mysql&gt; show master status;<br>+------------------+----------+--------------+------------------+-------------------+<br>| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |<br>+------------------+----------+--------------+------------------+-------------------+<br>| mysql-bin.000005 |      154 |              | mysql            |                   |<br>+------------------+----------+--------------+------------------+-------------------+<br><br><span class=\"hljs-comment\"># 创建同步账号</span><br>mysql&gt; grant replication slave,replication client on *.* to <span class=\"hljs-string\">&#x27;slave&#x27;</span>@<span class=\"hljs-string\">&#x27;%&#x27;</span> identified by <span class=\"hljs-string\">&quot;123456&quot;</span>;<br>mysql&gt; flush privileges;<br><br></code></pre></div></td></tr></table></figure>\n\n<p>m2:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter hljs\"><div class=\"hljs code-wrapper\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></div></td><td class=\"code\"><div class=\"hljs code-wrapper\"><pre><code class=\"hljs bash\">docker-compose <span class=\"hljs-built_in\">exec</span> mysql-m1 bash<br><br>mysql -uroot -p123456<br><br><span class=\"hljs-comment\"># 查看m2 File和Position</span><br>mysql&gt; show master status;<br>+------------------+----------+--------------+------------------+-------------------+<br>| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |<br>+------------------+----------+--------------+------------------+-------------------+<br>| mysql-bin.000005 |      154 |              | mysql            |                   |<br>+------------------+----------+--------------+------------------+-------------------+<br><br><span class=\"hljs-comment\"># 创建同步账号</span><br>mysql&gt; grant replication slave,replication client on *.* to <span class=\"hljs-string\">&#x27;slave&#x27;</span>@<span class=\"hljs-string\">&#x27;%&#x27;</span> identified by <span class=\"hljs-string\">&quot;123456&quot;</span>;<br>mysql&gt; flush privileges;<br></code></pre></div></td></tr></table></figure>\n\n<p>m1:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter hljs\"><div class=\"hljs code-wrapper\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br></pre></div></td><td class=\"code\"><div class=\"hljs code-wrapper\"><pre><code class=\"hljs bash\">mysql&gt; change master to master_host=<span class=\"hljs-string\">&#x27;mysql-m2&#x27;</span>,master_user=<span class=\"hljs-string\">&#x27;slave&#x27;</span>,master_password=<span class=\"hljs-string\">&#x27;123456&#x27;</span>,master_port=3306,master_log_file=<span class=\"hljs-string\">&#x27;mysql-bin.000005&#x27;</span>, master_log_pos=154,master_connect_retry=30;<br><br>mysql&gt; start slave;<br><br>mysql&gt; show slave status \\G<br>*************************** 1. row ***************************<br>               Slave_IO_State: Waiting <span class=\"hljs-keyword\">for</span> master to send event<br>                  Master_Host: mysql-m2<br>                  Master_User: slave<br>                  Master_Port: 3306<br>                Connect_Retry: 30<br>              Master_Log_File: mysql-bin.000005<br>          Read_Master_Log_Pos: 620<br>               Relay_Log_File: de7a84f1b7f1-relay-bin.000002<br>                Relay_Log_Pos: 786<br>        Relay_Master_Log_File: mysql-bin.000005<br>             Slave_IO_Running: Yes<br>            Slave_SQL_Running: Yes<br>              Replicate_Do_DB:<br>          Replicate_Ignore_DB:<br>           Replicate_Do_Table:<br>       Replicate_Ignore_Table:<br>      Replicate_Wild_Do_Table:<br>  Replicate_Wild_Ignore_Table:<br>                   Last_Errno: 0<br>                   Last_Error:<br>                 Skip_Counter: 0<br>          Exec_Master_Log_Pos: 620<br>              Relay_Log_Space: 1000<br>              Until_Condition: None<br>               Until_Log_File:<br>                Until_Log_Pos: 0<br>           Master_SSL_Allowed: No<br>           Master_SSL_CA_File:<br>           Master_SSL_CA_Path:<br>              Master_SSL_Cert:<br>            Master_SSL_Cipher:<br>               Master_SSL_Key:<br>        Seconds_Behind_Master: 0<br>Master_SSL_Verify_Server_Cert: No<br>                Last_IO_Errno: 0<br>                Last_IO_Error:<br>               Last_SQL_Errno: 0<br>               Last_SQL_Error:<br>  Replicate_Ignore_Server_Ids:<br>             Master_Server_Id: 2<br>                  Master_UUID: de8af5ce-0410-11ec-ab6d-0242ac170003<br>             Master_Info_File: /var/lib/mysql/master.info<br>                    SQL_Delay: 0<br>          SQL_Remaining_Delay: NULL<br>      Slave_SQL_Running_State: Slave has <span class=\"hljs-built_in\">read</span> all relay <span class=\"hljs-built_in\">log</span>; waiting <span class=\"hljs-keyword\">for</span> more updates<br>           Master_Retry_Count: 86400<br>                  Master_Bind:<br>      Last_IO_Error_Timestamp:<br>     Last_SQL_Error_Timestamp:<br>               Master_SSL_Crl:<br>           Master_SSL_Crlpath:<br>           Retrieved_Gtid_Set:<br>            Executed_Gtid_Set:<br>                Auto_Position: 0<br>         Replicate_Rewrite_DB:<br>                 Channel_Name:<br>           Master_TLS_Version:<br><br></code></pre></div></td></tr></table></figure>\n\n<p>m2:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter hljs\"><div class=\"hljs code-wrapper\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br></pre></div></td><td class=\"code\"><div class=\"hljs code-wrapper\"><pre><code class=\"hljs bash\">mysql&gt; change master to master_host=<span class=\"hljs-string\">&#x27;mysql-m1&#x27;</span>,master_user=<span class=\"hljs-string\">&#x27;slave&#x27;</span>,master_password=<span class=\"hljs-string\">&#x27;123456&#x27;</span>,master_port=3306,master_log_file=<span class=\"hljs-string\">&#x27;mysql-bin.000005&#x27;</span>, master_log_pos=154,master_connect_retry=30;<br><br>mysql&gt; start slave;<br><br>mysql&gt; show slave status \\G<br>*************************** 1. row ***************************<br>               Slave_IO_State: Waiting <span class=\"hljs-keyword\">for</span> master to send event<br>                  Master_Host: mysql-m1<br>                  Master_User: slave<br>                  Master_Port: 3306<br>                Connect_Retry: 30<br>              Master_Log_File: mysql-bin.000005<br>          Read_Master_Log_Pos: 1086<br>               Relay_Log_File: 65322be4d8a9-relay-bin.000002<br>                Relay_Log_Pos: 786<br>        Relay_Master_Log_File: mysql-bin.000005<br>             Slave_IO_Running: Yes<br>            Slave_SQL_Running: Yes<br>              Replicate_Do_DB:<br>          Replicate_Ignore_DB:<br>           Replicate_Do_Table:<br>       Replicate_Ignore_Table:<br>      Replicate_Wild_Do_Table:<br>  Replicate_Wild_Ignore_Table:<br>                   Last_Errno: 0<br>                   Last_Error:<br>                 Skip_Counter: 0<br>          Exec_Master_Log_Pos: 1086<br>              Relay_Log_Space: 1000<br>              Until_Condition: None<br>               Until_Log_File:<br>                Until_Log_Pos: 0<br>           Master_SSL_Allowed: No<br>           Master_SSL_CA_File:<br>           Master_SSL_CA_Path:<br>              Master_SSL_Cert:<br>            Master_SSL_Cipher:<br>               Master_SSL_Key:<br>        Seconds_Behind_Master: 0<br>Master_SSL_Verify_Server_Cert: No<br>                Last_IO_Errno: 0<br>                Last_IO_Error:<br>               Last_SQL_Errno: 0<br>               Last_SQL_Error:<br>  Replicate_Ignore_Server_Ids:<br>             Master_Server_Id: 1<br>                  Master_UUID: de898a82-0410-11ec-9fee-0242ac170002<br>             Master_Info_File: /var/lib/mysql/master.info<br>                    SQL_Delay: 0<br>          SQL_Remaining_Delay: NULL<br>      Slave_SQL_Running_State: Slave has <span class=\"hljs-built_in\">read</span> all relay <span class=\"hljs-built_in\">log</span>; waiting <span class=\"hljs-keyword\">for</span> more updates<br>           Master_Retry_Count: 86400<br>                  Master_Bind:<br>      Last_IO_Error_Timestamp:<br>     Last_SQL_Error_Timestamp:<br>               Master_SSL_Crl:<br>           Master_SSL_Crlpath:<br>           Retrieved_Gtid_Set:<br>            Executed_Gtid_Set:<br>                Auto_Position: 0<br>         Replicate_Rewrite_DB:<br>                 Channel_Name:<br>           Master_TLS_Version:<br></code></pre></div></td></tr></table></figure>\n\n<p class=\"noet note-success\">至此双主节点设置完成</p>\n\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>主从模式多用来进行读写分离</p>\n<p>双主模式多用来进行高可用</p>\n<p>更复杂的部署可能会部署多master和多slave并用keeplive保证统一访问的模式，这里没探究</p>\n","site":{"data":{}},"excerpt":"","more":"<p class=\"note note-primary\">相信mysql的binlog都不陌生</br>binlog的主要作用就是进行数据同步，今天我们从数据同步的角度搭一下mysql的主从/双主。</p>\n\n<h2 id=\"base\"><a href=\"#base\" class=\"headerlink\" title=\"base\"></a>base</h2><p>以下基于mysql5.7</p>\n<h2 id=\"简单了解下binlog\"><a href=\"#简单了解下binlog\" class=\"headerlink\" title=\"简单了解下binlog\"></a>简单了解下binlog</h2><ul>\n<li><p>binlog是记录所有数据库表结构变更（例如CREATE、ALTER TABLE…）以及表数据修改（INSERT、UPDATE、DELETE…）的二进制日志。</p>\n</li>\n<li><p>binlog日志包括两类文件：二进制日志索引文件（文件名后缀为.index）用于记录所有的二进制文件，二进制日志文件（文件名后缀为.00000*）记录数据库所有的DDL和DML(除了数据查询语句)语句事件。</p>\n</li>\n<li><p>binlog有三种格式：statement基于sql语句复制、row基于行数据变更的复制、mixed混合前两种格式的复制。</p>\n</li>\n</ul>\n<h2 id=\"搭建主从结构\"><a href=\"#搭建主从结构\" class=\"headerlink\" title=\"搭建主从结构\"></a>搭建主从结构</h2><p><img src=\"/img/mysql/mysql-m-s.png\" alt=\"mysql主从架构\"></p>\n<h3 id=\"创建docker-compose\"><a href=\"#创建docker-compose\" class=\"headerlink\" title=\"创建docker-compose\"></a>创建docker-compose</h3><figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yml\"><span class=\"hljs-attr\">version:</span> <span class=\"hljs-string\">&#x27;3.8&#x27;</span><br><span class=\"hljs-attr\">services:</span><br>  <span class=\"hljs-attr\">mysql-master:</span><br>    <span class=\"hljs-attr\">container_name:</span> <span class=\"hljs-string\">mysql-master</span> <br>    <span class=\"hljs-attr\">image:</span> <span class=\"hljs-string\">mysql:5.7.31</span><br>    <span class=\"hljs-attr\">restart:</span> <span class=\"hljs-string\">always</span><br>    <span class=\"hljs-attr\">ports:</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-number\">13306</span><span class=\"hljs-string\">:3306</span> <br>    <span class=\"hljs-attr\">privileged:</span> <span class=\"hljs-literal\">true</span><br>    <span class=\"hljs-attr\">volumes:</span><br>      <span class=\"hljs-comment\"># 这个只对mysql主从进行验证 没有持久化配置以及日志相关的映射</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">$PWD/master/conf/my.cnf:/etc/mysql/my.cnf</span><br>    <span class=\"hljs-attr\">environment:</span><br>      <span class=\"hljs-attr\">MYSQL_ROOT_PASSWORD:</span> <span class=\"hljs-string\">&quot;123456&quot;</span><br>    <span class=\"hljs-attr\">command:</span> [<br>        <span class=\"hljs-string\">&#x27;--character-set-server=utf8mb4&#x27;</span>,<br>        <span class=\"hljs-string\">&#x27;--collation-server=utf8mb4_general_ci&#x27;</span>,<br>        <span class=\"hljs-string\">&#x27;--max_connections=3000&#x27;</span><br>    ]<br>    <span class=\"hljs-attr\">networks:</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">myweb</span><br>      <br>  <span class=\"hljs-attr\">mysql-slave:</span><br>    <span class=\"hljs-attr\">container_name:</span> <span class=\"hljs-string\">mysql-slave</span> <br>    <span class=\"hljs-attr\">image:</span> <span class=\"hljs-string\">mysql:5.7.31</span><br>    <span class=\"hljs-attr\">restart:</span> <span class=\"hljs-string\">always</span><br>    <span class=\"hljs-attr\">ports:</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-number\">23306</span><span class=\"hljs-string\">:3306</span> <br>    <span class=\"hljs-attr\">privileged:</span> <span class=\"hljs-literal\">true</span><br>    <span class=\"hljs-attr\">volumes:</span><br>      <span class=\"hljs-comment\"># 这个只对mysql主从进行验证 没有持久化配置以及日志相关的映射</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">$PWD/slave/conf/my.cnf:/etc/mysql/my.cnf</span><br>    <span class=\"hljs-attr\">environment:</span><br>      <span class=\"hljs-attr\">MYSQL_ROOT_PASSWORD:</span> <span class=\"hljs-string\">&quot;123456&quot;</span><br>    <span class=\"hljs-attr\">command:</span> [<br>        <span class=\"hljs-string\">&#x27;--character-set-server=utf8mb4&#x27;</span>,<br>        <span class=\"hljs-string\">&#x27;--collation-server=utf8mb4_general_ci&#x27;</span>,<br>        <span class=\"hljs-string\">&#x27;--max_connections=3000&#x27;</span><br>    ]<br>    <span class=\"hljs-attr\">networks:</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">myweb</span>    <br><br><span class=\"hljs-attr\">networks:</span><br>  <span class=\"hljs-attr\">myweb:</span><br>    <span class=\"hljs-attr\">driver:</span> <span class=\"hljs-string\">bridge</span><br></code></pre></td></tr></table></figure>\n\n<h3 id=\"创建配置文件\"><a href=\"#创建配置文件\" class=\"headerlink\" title=\"创建配置文件\"></a>创建配置文件</h3><h4 id=\"配置文件目录结构\"><a href=\"#配置文件目录结构\" class=\"headerlink\" title=\"配置文件目录结构\"></a>配置文件目录结构</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">[root@xxx MySQLM-S]<span class=\"hljs-comment\"># tree</span><br>.<br>├── docker-compose.yaml<br>├── master<br>│   └── conf<br>│       └── my.cnf<br>└── slave<br>    └── conf<br>        └── my.cnf<br></code></pre></td></tr></table></figure>\n\n<h4 id=\"master-conf-my-cnf-配置文件\"><a href=\"#master-conf-my-cnf-配置文件\" class=\"headerlink\" title=\"master/conf/my.cnf 配置文件\"></a>master/conf/my.cnf 配置文件</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">[mysqld]<br><span class=\"hljs-comment\"># [必须]服务器唯一ID，默认是1，一般取IP最后一段</span><br>server-id=1<br><br><br><span class=\"hljs-comment\"># ###################################################</span><br><span class=\"hljs-comment\"># 如果当前实例既做主库又做从库次选线必须开启</span><br><span class=\"hljs-comment\"># log-slave-updates = true </span><br><br><span class=\"hljs-comment\"># 自增长ID</span><br><span class=\"hljs-comment\"># 特殊说明 当该实例为双主的架构时要特殊配置 以避免自增id冲突的问题</span><br><span class=\"hljs-comment\"># auto_increment_offset = 1</span><br><span class=\"hljs-comment\"># auto_increment_increment = 2  </span><br><span class=\"hljs-comment\"># ####################################################</span><br><br><br><span class=\"hljs-comment\"># [必须]启用二进制日志</span><br>log-bin=mysql-bin <br><br><span class=\"hljs-comment\"># 复制过滤：也就是指定哪个数据库不用同步（mysql库一般不同步）</span><br>binlog-ignore-db=mysql<br><br><span class=\"hljs-comment\"># 确保binlog日志写入后与硬盘同步</span><br>sync_binlog = 1<br><br><span class=\"hljs-comment\"># 设置需要同步的数据库 binlog_do_db = 数据库名； </span><br><span class=\"hljs-comment\"># 如果是多个同步库，就以此格式另写几行即可。</span><br><span class=\"hljs-comment\"># 如果不指明对某个具体库同步，表示同步所有库。除了binlog-ignore-db设置的忽略的库</span><br><span class=\"hljs-comment\"># binlog_do_db = test #需要同步test数据库。</span><br><br><span class=\"hljs-comment\"># 设置需要同步的数据库，主服务器上不限定数据库，在从服务器上限定replicate-do-db = 数据库名；</span><br><span class=\"hljs-comment\"># 如果不指明同步哪些库，就去掉这行，表示所有库的同步（除了ignore忽略的库）。</span><br><span class=\"hljs-comment\"># replicate-do-db = test；</span><br><br><span class=\"hljs-comment\"># 跳过所有的错误，继续执行复制操作</span><br>slave-skip-errors = all  <br></code></pre></td></tr></table></figure>\n\n<h4 id=\"slave-conf-my-cnf-配置文件\"><a href=\"#slave-conf-my-cnf-配置文件\" class=\"headerlink\" title=\"slave/conf/my.cnf 配置文件\"></a>slave/conf/my.cnf 配置文件</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">[mysqld]<br><span class=\"hljs-comment\"># [必须]服务器唯一ID，默认是1，一般取IP最后一段  </span><br>server-id=2<br><br><br><span class=\"hljs-comment\"># ###################################################</span><br><span class=\"hljs-comment\"># 如果当前实例既做主库又做从库次选线必须开启</span><br><span class=\"hljs-comment\"># log-slave-updates = true </span><br><br><span class=\"hljs-comment\"># 自增长ID</span><br><span class=\"hljs-comment\"># 特殊说明 当该实例为双主的架构时要特殊配置 以避免自增id冲突的问题</span><br><span class=\"hljs-comment\"># auto_increment_offset = 2</span><br><span class=\"hljs-comment\"># auto_increment_increment = 2  </span><br><span class=\"hljs-comment\"># ####################################################</span><br><br><span class=\"hljs-comment\"># [必须]启用二进制日志</span><br>log-bin=mysql-bin <br><br><span class=\"hljs-comment\"># 复制过滤：也就是指定哪个数据库不用同步（mysql库一般不同步）</span><br>binlog-ignore-db=mysql<br><br><span class=\"hljs-comment\"># 确保binlog日志写入后与硬盘同步</span><br><span class=\"hljs-comment\"># sync_binlog = 1</span><br><br><span class=\"hljs-comment\"># 设置需要同步的数据库 binlog_do_db = 数据库名； </span><br><span class=\"hljs-comment\"># 如果是多个同步库，就以此格式另写几行即可。</span><br><span class=\"hljs-comment\"># 如果不指明对某个具体库同步，表示同步所有库。除了binlog-ignore-db设置的忽略的库</span><br><span class=\"hljs-comment\"># binlog_do_db = test #需要同步test数据库。</span><br><br><span class=\"hljs-comment\"># 设置需要同步的数据库，主服务器上不限定数据库，在从服务器上限定replicate-do-db = 数据库名；</span><br><span class=\"hljs-comment\"># 如果不指明同步哪些库，就去掉这行，表示所有库的同步（除了ignore忽略的库）。</span><br><span class=\"hljs-comment\"># replicate-do-db = test；</span><br><br><span class=\"hljs-comment\"># 跳过所有的错误，继续执行复制操作</span><br>slave-skip-errors = all <br></code></pre></td></tr></table></figure>\n\n<h3 id=\"启动docker-compose并配置主从关系\"><a href=\"#启动docker-compose并配置主从关系\" class=\"headerlink\" title=\"启动docker-compose并配置主从关系\"></a>启动docker-compose并配置主从关系</h3><h4 id=\"启动\"><a href=\"#启动\" class=\"headerlink\" title=\"启动\"></a>启动</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">docker-compose up -d <br></code></pre></td></tr></table></figure>\n\n<h4 id=\"进入master配置同步账号和权限\"><a href=\"#进入master配置同步账号和权限\" class=\"headerlink\" title=\"进入master配置同步账号和权限\"></a>进入master配置同步账号和权限</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">docker-compose <span class=\"hljs-built_in\">exec</span> mysql-slave bash<br><br>mysql -uroot -p123455<br><br><span class=\"hljs-comment\"># 查看配置的服务ID</span><br>mysql&gt; show variables like <span class=\"hljs-string\">&#x27;%server_id%&#x27;</span>;<br>+----------------+-------+<br>| Variable_name  | Value |<br>+----------------+-------+<br>| server_id      | 1     |<br>| server_id_bits | 32    |<br>+----------------+-------+<br><br><span class=\"hljs-comment\"># 看master信息 File 和 Position 从服务上要用</span><br>mysql&gt; show master status;<br>+------------------+----------+--------------+------------------+-------------------+<br>| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |<br>+------------------+----------+--------------+------------------+-------------------+<br>| mysql-bin.000004 |      154 |              | mysql            |                   |<br>+------------------+----------+--------------+------------------+-------------------+<br><br><span class=\"hljs-comment\"># 创建同步账户并开启权限</span><br>mysql&gt; grant replication slave,replication client on *.* to <span class=\"hljs-string\">&#x27;slave&#x27;</span>@<span class=\"hljs-string\">&#x27;%&#x27;</span> identified by <span class=\"hljs-string\">&quot;123456&quot;</span>;<br>mysql&gt; flush privileges;<br></code></pre></td></tr></table></figure>\n\n<h4 id=\"进入slave服务配置\"><a href=\"#进入slave服务配置\" class=\"headerlink\" title=\"进入slave服务配置\"></a>进入slave服务配置</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">docker-compose <span class=\"hljs-built_in\">exec</span> docker-slave bash<br><br>mysql -uroot -p123456<br><br><span class=\"hljs-comment\">#查看server_id是否生效</span><br>mysql&gt; show variables like <span class=\"hljs-string\">&#x27;%server_id%&#x27;</span>;<br>+----------------+-------+<br>| Variable_name  | Value |<br>+----------------+-------+<br>| server_id      | 2     |<br>| server_id_bits | 32    |<br>+----------------+-------+<br><br><span class=\"hljs-comment\"># 连接主mysql服务 master_log_file 和 master_log_pos的值要填写主master里查出来的值 注意这里使用的docker-compose 内部服务的端口和ip</span><br>mysql&gt; change master to master_host=<span class=\"hljs-string\">&#x27;mysql-master&#x27;</span>,master_user=<span class=\"hljs-string\">&#x27;slave&#x27;</span>,master_password=<span class=\"hljs-string\">&#x27;123456&#x27;</span>,master_port=3306,master_log_file=<span class=\"hljs-string\">&#x27;mysql-bin.000004&#x27;</span>, master_log_pos=154,master_connect_retry=30;<br><br><br><span class=\"hljs-comment\"># 开启slave</span><br><br>mysql&gt; start slave;<br><br>mysql&gt; show slave status \\G<br>*************************** 1. row ***************************<br>               Slave_IO_State: Waiting <span class=\"hljs-keyword\">for</span> master to send event<br>                  Master_Host: mysql-master<br>                  Master_User: slave<br>                  Master_Port: 3306<br>                Connect_Retry: 30<br>              Master_Log_File: mysql-bin.000004<br>          Read_Master_Log_Pos: 778<br>               Relay_Log_File: af5556aff9be-relay-bin.000002<br>                Relay_Log_Pos: 944<br>        Relay_Master_Log_File: mysql-bin.000004<br>             Slave_IO_Running: Yes<br>            Slave_SQL_Running: Yes<br>              Replicate_Do_DB: <br>          Replicate_Ignore_DB: mysql<br>           Replicate_Do_Table: <br>       Replicate_Ignore_Table: <br>      Replicate_Wild_Do_Table: <br>  Replicate_Wild_Ignore_Table: <br>                   Last_Errno: 0<br>                   Last_Error: <br>                 Skip_Counter: 0<br>          Exec_Master_Log_Pos: 778<br>              Relay_Log_Space: 1158<br>              Until_Condition: None<br>               Until_Log_File: <br>                Until_Log_Pos: 0<br>           Master_SSL_Allowed: No<br>           Master_SSL_CA_File: <br>           Master_SSL_CA_Path: <br>              Master_SSL_Cert: <br>            Master_SSL_Cipher: <br>               Master_SSL_Key: <br>        Seconds_Behind_Master: 0<br>Master_SSL_Verify_Server_Cert: No<br>                Last_IO_Errno: 0<br>                Last_IO_Error: <br>               Last_SQL_Errno: 0<br>               Last_SQL_Error: <br>  Replicate_Ignore_Server_Ids: <br>             Master_Server_Id: 1<br>                  Master_UUID: 466c4a60-03f4-11ec-a1a1-0242ac160002<br>             Master_Info_File: /var/lib/mysql/master.info<br>                    SQL_Delay: 0<br>          SQL_Remaining_Delay: NULL<br>      Slave_SQL_Running_State: Slave has <span class=\"hljs-built_in\">read</span> all relay <span class=\"hljs-built_in\">log</span>; waiting <span class=\"hljs-keyword\">for</span> more updates<br>           Master_Retry_Count: 86400<br>                  Master_Bind: <br>      Last_IO_Error_Timestamp: <br>     Last_SQL_Error_Timestamp: <br>               Master_SSL_Crl: <br>           Master_SSL_Crlpath: <br>           Retrieved_Gtid_Set: <br>            Executed_Gtid_Set: <br>                Auto_Position: 0<br>         Replicate_Rewrite_DB: <br>                 Channel_Name: <br>           Master_TLS_Version: <br><br></code></pre></td></tr></table></figure>\n\n<p class=\"note note-success\"> 上面看到 Slave_IO_Running: Yes，Slave_SQL_Running: Yes 表示已经成功开启主从</p>\n\n<p>连接主mysql参数说明：</p>\n<p><strong>master_port</strong>：Master的端口号，指的是容器的端口号</p>\n<p><strong>master_user</strong>：用于数据同步的用户</p>\n<p><strong>master_password</strong>：用于同步的用户的密码</p>\n<p><strong>master_log_file</strong>：指定 Slave 从哪个日志文件开始复制数据，即上文中提到的 File 字段的值</p>\n<p><strong>master_log_pos</strong>：从哪个 Position 开始读，即上文中提到的 Position 字段的值</p>\n<p><strong>master_connect_retry</strong>：如果连接失败，重试的时间间隔，单位是秒，默认是60秒</p>\n<h2 id=\"搭建双主结构\"><a href=\"#搭建双主结构\" class=\"headerlink\" title=\"搭建双主结构\"></a>搭建双主结构</h2><p>通过上面主从结构我们可以我们可以大胆设想，要是两个数据库的实例都配置对方为master不就实现的双主么？事实却是如此：</p>\n<p>双主结构只需要将双方的配置文件注释掉的地方取消注释掉分别在两台服务器上创同步账号和配置</p>\n<h3 id=\"创建docker-compose文件（双主）\"><a href=\"#创建docker-compose文件（双主）\" class=\"headerlink\" title=\"创建docker-compose文件（双主）\"></a>创建docker-compose文件（双主）</h3><p>这里只更改了docker-compose中服务的名称</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-attr\">version:</span> <span class=\"hljs-string\">&#x27;3.8&#x27;</span><br><span class=\"hljs-attr\">services:</span><br>  <span class=\"hljs-attr\">mysql-m1:</span><br>    <span class=\"hljs-attr\">container_name:</span> <span class=\"hljs-string\">mysql-m1</span><br>    <span class=\"hljs-attr\">image:</span> <span class=\"hljs-string\">mysql:5.7.31</span><br>    <span class=\"hljs-attr\">restart:</span> <span class=\"hljs-string\">always</span><br>    <span class=\"hljs-attr\">ports:</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-number\">13306</span><span class=\"hljs-string\">:3306</span> <br>    <span class=\"hljs-attr\">privileged:</span> <span class=\"hljs-literal\">true</span><br>    <span class=\"hljs-attr\">volumes:</span><br>      <span class=\"hljs-comment\"># 这个只对mysql主从进行验证 没有持久化配置以及日志相关的映射</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">$PWD/m1/conf/my.cnf:/etc/mysql/my.cnf</span><br>    <span class=\"hljs-attr\">environment:</span><br>      <span class=\"hljs-attr\">MYSQL_ROOT_PASSWORD:</span> <span class=\"hljs-string\">&quot;123456&quot;</span><br>    <span class=\"hljs-attr\">command:</span> [<br>        <span class=\"hljs-string\">&#x27;--character-set-server=utf8mb4&#x27;</span>,<br>        <span class=\"hljs-string\">&#x27;--collation-server=utf8mb4_general_ci&#x27;</span>,<br>        <span class=\"hljs-string\">&#x27;--max_connections=3000&#x27;</span><br>    ]<br>    <span class=\"hljs-attr\">networks:</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">myweb</span><br>      <br>  <span class=\"hljs-attr\">mysql-m2:</span><br>    <span class=\"hljs-attr\">container_name:</span> <span class=\"hljs-string\">mysql-m2</span> <br>    <span class=\"hljs-attr\">image:</span> <span class=\"hljs-string\">mysql:5.7.31</span><br>    <span class=\"hljs-attr\">restart:</span> <span class=\"hljs-string\">always</span><br>    <span class=\"hljs-attr\">ports:</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-number\">23306</span><span class=\"hljs-string\">:3306</span> <br>    <span class=\"hljs-attr\">privileged:</span> <span class=\"hljs-literal\">true</span><br>    <span class=\"hljs-attr\">volumes:</span><br>      <span class=\"hljs-comment\"># 这个只对mysql主从进行验证 没有持久化配置以及日志相关的映射</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">$PWD/m2/conf/my.cnf:/etc/mysql/my.cnf</span><br>    <span class=\"hljs-attr\">environment:</span><br>      <span class=\"hljs-attr\">MYSQL_ROOT_PASSWORD:</span> <span class=\"hljs-string\">&quot;123456&quot;</span><br>    <span class=\"hljs-attr\">command:</span> [<br>        <span class=\"hljs-string\">&#x27;--character-set-server=utf8mb4&#x27;</span>,<br>        <span class=\"hljs-string\">&#x27;--collation-server=utf8mb4_general_ci&#x27;</span>,<br>        <span class=\"hljs-string\">&#x27;--max_connections=3000&#x27;</span><br>    ]<br>    <span class=\"hljs-attr\">networks:</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">myweb</span>    <br><br><span class=\"hljs-attr\">networks:</span><br>  <span class=\"hljs-attr\">myweb:</span><br>    <span class=\"hljs-attr\">driver:</span> <span class=\"hljs-string\">bridge</span><br></code></pre></td></tr></table></figure>\n\n<h3 id=\"创建配置文件-双主\"><a href=\"#创建配置文件-双主\" class=\"headerlink\" title=\"创建配置文件(双主)\"></a>创建配置文件(双主)</h3><p>这里只是将主从中的配置中注释掉的服务添加上</p>\n<h4 id=\"配置文件目录结构（双主）\"><a href=\"#配置文件目录结构（双主）\" class=\"headerlink\" title=\"配置文件目录结构（双主）\"></a>配置文件目录结构（双主）</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">[root@xxx MySQLM-M]<span class=\"hljs-comment\"># tree</span><br>.<br>├── docker-compose.yaml<br>├── m1<br>│   └── conf<br>│       └── my.cnf<br>└── m2<br>    └── conf<br>        └── my.cnf<br></code></pre></td></tr></table></figure>\n\n<h4 id=\"m1-conf-my-cnf\"><a href=\"#m1-conf-my-cnf\" class=\"headerlink\" title=\"m1/conf/my.cnf\"></a>m1/conf/my.cnf</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">[mysqld]<br><span class=\"hljs-comment\"># [必须]服务器唯一ID，默认是1，一般取IP最后一段</span><br>server-id=1<br><br><br><span class=\"hljs-comment\"># ###################################################</span><br><span class=\"hljs-comment\"># 如果当前实例既做主库又做从库次选线必须开启</span><br>log-slave-updates = <span class=\"hljs-literal\">true</span> <br><br><span class=\"hljs-comment\"># 自增长ID</span><br><span class=\"hljs-comment\"># 特殊说明 当该实例为双主的架构时要特殊配置 以避免自增id冲突的问题</span><br>auto_increment_offset = 1<br>auto_increment_increment = 2  <br><span class=\"hljs-comment\"># ####################################################</span><br><br><br><span class=\"hljs-comment\"># [必须]启用二进制日志</span><br>log-bin=mysql-bin <br><br><span class=\"hljs-comment\"># 复制过滤：也就是指定哪个数据库不用同步（mysql库一般不同步）</span><br>binlog-ignore-db=mysql<br><br><span class=\"hljs-comment\"># 确保binlog日志写入后与硬盘同步</span><br>sync_binlog = 1<br><br><span class=\"hljs-comment\"># 设置需要同步的数据库 binlog_do_db = 数据库名； </span><br><span class=\"hljs-comment\"># 如果是多个同步库，就以此格式另写几行即可。</span><br><span class=\"hljs-comment\"># 如果不指明对某个具体库同步，表示同步所有库。除了binlog-ignore-db设置的忽略的库</span><br><span class=\"hljs-comment\"># binlog_do_db = test #需要同步test数据库。</span><br><br><span class=\"hljs-comment\"># 设置需要同步的数据库，主服务器上不限定数据库，在从服务器上限定replicate-do-db = 数据库名；</span><br><span class=\"hljs-comment\"># 如果不指明同步哪些库，就去掉这行，表示所有库的同步（除了ignore忽略的库）。</span><br><span class=\"hljs-comment\"># replicate-do-db = test；</span><br><br><span class=\"hljs-comment\"># 跳过所有的错误，继续执行复制操作</span><br>slave-skip-errors = all  <br></code></pre></td></tr></table></figure>\n\n<h4 id=\"m2-conf-my-cnf\"><a href=\"#m2-conf-my-cnf\" class=\"headerlink\" title=\"m2/conf/my.cnf\"></a>m2/conf/my.cnf</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">[mysqld]<br><span class=\"hljs-comment\"># [必须]服务器唯一ID，默认是1，一般取IP最后一段  </span><br>server-id=2<br><br><br><span class=\"hljs-comment\"># ###################################################</span><br><span class=\"hljs-comment\"># 如果当前实例既做主库又做从库次选线必须开启</span><br>log-slave-updates = <span class=\"hljs-literal\">true</span> <br><br><span class=\"hljs-comment\"># 自增长ID</span><br><span class=\"hljs-comment\"># 特殊说明 当该实例为双主的架构时要特殊配置 以避免自增id冲突的问题</span><br>auto_increment_offset = 2<br>auto_increment_increment = 2  <br><span class=\"hljs-comment\"># ####################################################</span><br><br><span class=\"hljs-comment\"># [必须]启用二进制日志</span><br>log-bin=mysql-bin <br><br><span class=\"hljs-comment\"># 复制过滤：也就是指定哪个数据库不用同步（mysql库一般不同步）</span><br>binlog-ignore-db=mysql<br><br><span class=\"hljs-comment\"># 确保binlog日志写入后与硬盘同步</span><br>sync_binlog = 1<br><br><span class=\"hljs-comment\"># 设置需要同步的数据库 binlog_do_db = 数据库名； </span><br><span class=\"hljs-comment\"># 如果是多个同步库，就以此格式另写几行即可。</span><br><span class=\"hljs-comment\"># 如果不指明对某个具体库同步，表示同步所有库。除了binlog-ignore-db设置的忽略的库</span><br><span class=\"hljs-comment\"># binlog_do_db = test #需要同步test数据库。</span><br><br><span class=\"hljs-comment\"># 设置需要同步的数据库，主服务器上不限定数据库，在从服务器上限定replicate-do-db = 数据库名；</span><br><span class=\"hljs-comment\"># 如果不指明同步哪些库，就去掉这行，表示所有库的同步（除了ignore忽略的库）。</span><br><span class=\"hljs-comment\"># replicate-do-db = test；</span><br><br><span class=\"hljs-comment\"># 跳过所有的错误，继续执行复制操作</span><br>slave-skip-errors = all <br></code></pre></td></tr></table></figure>\n\n<h3 id=\"启动docker-compose并配置m1和m2的双主\"><a href=\"#启动docker-compose并配置m1和m2的双主\" class=\"headerlink\" title=\"启动docker-compose并配置m1和m2的双主\"></a>启动docker-compose并配置m1和m2的双主</h3><h4 id=\"启动（双主）\"><a href=\"#启动（双主）\" class=\"headerlink\" title=\"启动（双主）\"></a>启动（双主）</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">docker-compose up -d <br></code></pre></td></tr></table></figure>\n\n<p>进入m1和m2下执行下列命令来获取各自的master status 和同步账号</p>\n<p>m1:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">docker-compose <span class=\"hljs-built_in\">exec</span> mysql-m1 bash<br><br>mysql -uroot -p123456<br><br><span class=\"hljs-comment\"># 查看m1 File和Position</span><br>mysql&gt; show master status;<br>+------------------+----------+--------------+------------------+-------------------+<br>| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |<br>+------------------+----------+--------------+------------------+-------------------+<br>| mysql-bin.000005 |      154 |              | mysql            |                   |<br>+------------------+----------+--------------+------------------+-------------------+<br><br><span class=\"hljs-comment\"># 创建同步账号</span><br>mysql&gt; grant replication slave,replication client on *.* to <span class=\"hljs-string\">&#x27;slave&#x27;</span>@<span class=\"hljs-string\">&#x27;%&#x27;</span> identified by <span class=\"hljs-string\">&quot;123456&quot;</span>;<br>mysql&gt; flush privileges;<br><br></code></pre></td></tr></table></figure>\n\n<p>m2:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">docker-compose <span class=\"hljs-built_in\">exec</span> mysql-m1 bash<br><br>mysql -uroot -p123456<br><br><span class=\"hljs-comment\"># 查看m2 File和Position</span><br>mysql&gt; show master status;<br>+------------------+----------+--------------+------------------+-------------------+<br>| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |<br>+------------------+----------+--------------+------------------+-------------------+<br>| mysql-bin.000005 |      154 |              | mysql            |                   |<br>+------------------+----------+--------------+------------------+-------------------+<br><br><span class=\"hljs-comment\"># 创建同步账号</span><br>mysql&gt; grant replication slave,replication client on *.* to <span class=\"hljs-string\">&#x27;slave&#x27;</span>@<span class=\"hljs-string\">&#x27;%&#x27;</span> identified by <span class=\"hljs-string\">&quot;123456&quot;</span>;<br>mysql&gt; flush privileges;<br></code></pre></td></tr></table></figure>\n\n<p>m1:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">mysql&gt; change master to master_host=<span class=\"hljs-string\">&#x27;mysql-m2&#x27;</span>,master_user=<span class=\"hljs-string\">&#x27;slave&#x27;</span>,master_password=<span class=\"hljs-string\">&#x27;123456&#x27;</span>,master_port=3306,master_log_file=<span class=\"hljs-string\">&#x27;mysql-bin.000005&#x27;</span>, master_log_pos=154,master_connect_retry=30;<br><br>mysql&gt; start slave;<br><br>mysql&gt; show slave status \\G<br>*************************** 1. row ***************************<br>               Slave_IO_State: Waiting <span class=\"hljs-keyword\">for</span> master to send event<br>                  Master_Host: mysql-m2<br>                  Master_User: slave<br>                  Master_Port: 3306<br>                Connect_Retry: 30<br>              Master_Log_File: mysql-bin.000005<br>          Read_Master_Log_Pos: 620<br>               Relay_Log_File: de7a84f1b7f1-relay-bin.000002<br>                Relay_Log_Pos: 786<br>        Relay_Master_Log_File: mysql-bin.000005<br>             Slave_IO_Running: Yes<br>            Slave_SQL_Running: Yes<br>              Replicate_Do_DB:<br>          Replicate_Ignore_DB:<br>           Replicate_Do_Table:<br>       Replicate_Ignore_Table:<br>      Replicate_Wild_Do_Table:<br>  Replicate_Wild_Ignore_Table:<br>                   Last_Errno: 0<br>                   Last_Error:<br>                 Skip_Counter: 0<br>          Exec_Master_Log_Pos: 620<br>              Relay_Log_Space: 1000<br>              Until_Condition: None<br>               Until_Log_File:<br>                Until_Log_Pos: 0<br>           Master_SSL_Allowed: No<br>           Master_SSL_CA_File:<br>           Master_SSL_CA_Path:<br>              Master_SSL_Cert:<br>            Master_SSL_Cipher:<br>               Master_SSL_Key:<br>        Seconds_Behind_Master: 0<br>Master_SSL_Verify_Server_Cert: No<br>                Last_IO_Errno: 0<br>                Last_IO_Error:<br>               Last_SQL_Errno: 0<br>               Last_SQL_Error:<br>  Replicate_Ignore_Server_Ids:<br>             Master_Server_Id: 2<br>                  Master_UUID: de8af5ce-0410-11ec-ab6d-0242ac170003<br>             Master_Info_File: /var/lib/mysql/master.info<br>                    SQL_Delay: 0<br>          SQL_Remaining_Delay: NULL<br>      Slave_SQL_Running_State: Slave has <span class=\"hljs-built_in\">read</span> all relay <span class=\"hljs-built_in\">log</span>; waiting <span class=\"hljs-keyword\">for</span> more updates<br>           Master_Retry_Count: 86400<br>                  Master_Bind:<br>      Last_IO_Error_Timestamp:<br>     Last_SQL_Error_Timestamp:<br>               Master_SSL_Crl:<br>           Master_SSL_Crlpath:<br>           Retrieved_Gtid_Set:<br>            Executed_Gtid_Set:<br>                Auto_Position: 0<br>         Replicate_Rewrite_DB:<br>                 Channel_Name:<br>           Master_TLS_Version:<br><br></code></pre></td></tr></table></figure>\n\n<p>m2:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">mysql&gt; change master to master_host=<span class=\"hljs-string\">&#x27;mysql-m1&#x27;</span>,master_user=<span class=\"hljs-string\">&#x27;slave&#x27;</span>,master_password=<span class=\"hljs-string\">&#x27;123456&#x27;</span>,master_port=3306,master_log_file=<span class=\"hljs-string\">&#x27;mysql-bin.000005&#x27;</span>, master_log_pos=154,master_connect_retry=30;<br><br>mysql&gt; start slave;<br><br>mysql&gt; show slave status \\G<br>*************************** 1. row ***************************<br>               Slave_IO_State: Waiting <span class=\"hljs-keyword\">for</span> master to send event<br>                  Master_Host: mysql-m1<br>                  Master_User: slave<br>                  Master_Port: 3306<br>                Connect_Retry: 30<br>              Master_Log_File: mysql-bin.000005<br>          Read_Master_Log_Pos: 1086<br>               Relay_Log_File: 65322be4d8a9-relay-bin.000002<br>                Relay_Log_Pos: 786<br>        Relay_Master_Log_File: mysql-bin.000005<br>             Slave_IO_Running: Yes<br>            Slave_SQL_Running: Yes<br>              Replicate_Do_DB:<br>          Replicate_Ignore_DB:<br>           Replicate_Do_Table:<br>       Replicate_Ignore_Table:<br>      Replicate_Wild_Do_Table:<br>  Replicate_Wild_Ignore_Table:<br>                   Last_Errno: 0<br>                   Last_Error:<br>                 Skip_Counter: 0<br>          Exec_Master_Log_Pos: 1086<br>              Relay_Log_Space: 1000<br>              Until_Condition: None<br>               Until_Log_File:<br>                Until_Log_Pos: 0<br>           Master_SSL_Allowed: No<br>           Master_SSL_CA_File:<br>           Master_SSL_CA_Path:<br>              Master_SSL_Cert:<br>            Master_SSL_Cipher:<br>               Master_SSL_Key:<br>        Seconds_Behind_Master: 0<br>Master_SSL_Verify_Server_Cert: No<br>                Last_IO_Errno: 0<br>                Last_IO_Error:<br>               Last_SQL_Errno: 0<br>               Last_SQL_Error:<br>  Replicate_Ignore_Server_Ids:<br>             Master_Server_Id: 1<br>                  Master_UUID: de898a82-0410-11ec-9fee-0242ac170002<br>             Master_Info_File: /var/lib/mysql/master.info<br>                    SQL_Delay: 0<br>          SQL_Remaining_Delay: NULL<br>      Slave_SQL_Running_State: Slave has <span class=\"hljs-built_in\">read</span> all relay <span class=\"hljs-built_in\">log</span>; waiting <span class=\"hljs-keyword\">for</span> more updates<br>           Master_Retry_Count: 86400<br>                  Master_Bind:<br>      Last_IO_Error_Timestamp:<br>     Last_SQL_Error_Timestamp:<br>               Master_SSL_Crl:<br>           Master_SSL_Crlpath:<br>           Retrieved_Gtid_Set:<br>            Executed_Gtid_Set:<br>                Auto_Position: 0<br>         Replicate_Rewrite_DB:<br>                 Channel_Name:<br>           Master_TLS_Version:<br></code></pre></td></tr></table></figure>\n\n<p class=\"noet note-success\">至此双主节点设置完成</p>\n\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>主从模式多用来进行读写分离</p>\n<p>双主模式多用来进行高可用</p>\n<p>更复杂的部署可能会部署多master和多slave并用keeplive保证统一访问的模式，这里没探究</p>\n"},{"title":"MySQL事务的隔离性和隔离级别","date":"2021-08-25T09:51:27.000Z","index_img":null,"banner_img":null,"_content":"\n## 用人话说说事务和特性？\n\n## 事务怎么有这么多的隔离级别？\n\n## MVCC是咋回事？\n\n## 穿针引线\n","source":"_drafts/MySQL事务的隔离性和隔离级别.md","raw":"---\ntitle: MySQL事务的隔离性和隔离级别\ndate: 2021-08-25 17:51:27\nindex_img:\nbanner_img:\ncategories:\n- 存储\ntags:\n- mysql\n- ACID\n- mvcc\n---\n\n## 用人话说说事务和特性？\n\n## 事务怎么有这么多的隔离级别？\n\n## MVCC是咋回事？\n\n## 穿针引线\n","slug":"MySQL事务的隔离性和隔离级别","published":0,"updated":"2021-08-25T13:13:53.306Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cksriqm8v0000c88zfvb4dus5","content":"<h2 id=\"用人话说说事务和特性？\"><a href=\"#用人话说说事务和特性？\" class=\"headerlink\" title=\"用人话说说事务和特性？\"></a>用人话说说事务和特性？</h2><h2 id=\"事务怎么有这么多的隔离级别？\"><a href=\"#事务怎么有这么多的隔离级别？\" class=\"headerlink\" title=\"事务怎么有这么多的隔离级别？\"></a>事务怎么有这么多的隔离级别？</h2><h2 id=\"MVCC是咋回事？\"><a href=\"#MVCC是咋回事？\" class=\"headerlink\" title=\"MVCC是咋回事？\"></a>MVCC是咋回事？</h2><h2 id=\"穿针引线\"><a href=\"#穿针引线\" class=\"headerlink\" title=\"穿针引线\"></a>穿针引线</h2>","site":{"data":{}},"excerpt":"","more":"<h2 id=\"用人话说说事务和特性？\"><a href=\"#用人话说说事务和特性？\" class=\"headerlink\" title=\"用人话说说事务和特性？\"></a>用人话说说事务和特性？</h2><h2 id=\"事务怎么有这么多的隔离级别？\"><a href=\"#事务怎么有这么多的隔离级别？\" class=\"headerlink\" title=\"事务怎么有这么多的隔离级别？\"></a>事务怎么有这么多的隔离级别？</h2><h2 id=\"MVCC是咋回事？\"><a href=\"#MVCC是咋回事？\" class=\"headerlink\" title=\"MVCC是咋回事？\"></a>MVCC是咋回事？</h2><h2 id=\"穿针引线\"><a href=\"#穿针引线\" class=\"headerlink\" title=\"穿针引线\"></a>穿针引线</h2>"},{"title":"设置MySQL的隔离级别","date":"2021-08-25T15:00:28.000Z","index_img":"/img/mysql/mysql.png","banner_img":"/img/mysql/isolation.jpg","_content":"\n\n## 怎么查当前的隔离级别？\n\n<p class=\"note note-success\">MySQL数据库默认的存储引擎是支持事务的innodb,所以自然的就有默认的隔离级别--可重复读</p>\n<p class=\"note note-warning\">只有支持ACID的存储引擎才有对应的各种隔离级别</p>\n\n在我们设置当前事务的隔离级别的时候我们首先要会查询我们的MySQL的隔离级别是什么\n\nMySQL查询隔离级别的语句是：\n\n```bash\nmysql> select @@global.tx_isolation,@@tx_isolation;\n+-----------------------+-----------------+\n| @@global.tx_isolation | @@tx_isolation  |\n+-----------------------+-----------------+\n| REPEATABLE-READ       | REPEATABLE-READ |\n+-----------------------+-----------------+\n1 row in set (0.00 sec)\n```\n\n## 如何设置自己的隔离级别？\n\n设置innodb的事务级别方法是：\n\nset 作用域 transaction isolation level 事务隔离级别，例如~\n\n> SET [SESSION | GLOBAL] TRANSACTION ISOLATION LEVEL {READ UNCOMMITTED | READ COMMITTED | REPEATABLE READ | SERIALIZABLE}\n\n```bash\n// 全局的\nmysql> set global transaction isolation level read committed;\n// 当前会话\nmysql> set session transaction isolation level read committed;\n```\n\n## 各个隔离级别都是啥意思？\n\nSQL标准定义了4类隔离级别，包括了一些具体规则，用来限定事务内外的哪些改变是可见的，哪些是不可见的。低级别的隔离级一般支持更高的并发处理，并拥有更低的系统开销。\n\n但是读提交和串行化一般很少使用\n\n- **Read Uncommitted（读取未提交内容）**\n在该隔离级别，所有事务都可以看到其他未提交事务的执行结果。本隔离级别很少用于实际应用，因为它的性能也不比其他级别好多少。读取未提交的数据，也被称之为脏读（Dirty Read）。\n\n- **Read Committed（读取提交内容）**\n这是大多数数据库系统的默认隔离级别（但不是MySQL默认的）。它满足了隔离的简单定义：一个事务只能看见已经提交事务所做的改变。这种隔离级别 也支持所谓的不可重复读（Nonrepeatable Read），因为同一事务的其他实例在该实例处理其间可能会有新的commit，所以同一select可能返回不同结果。\n\n- **Repeatable Read（可重读）**\n这是MySQL的默认事务隔离级别，它确保同一事务的多个实例在并发读取数据时，会看到同样的数据行。不过理论上，这会导致另一个棘手的问题：幻读 （Phantom Read）。简单的说，幻读指当用户读取某一范围的数据行时，另一个事务又在该范围内插入了新行，当用户再读取该范围的数据行时，会发现有新的“幻影” 行。InnoDB和Falcon存储引擎通过多版本并发控制（MVCC，Multiversion Concurrency Control）机制解决了该问题。\n\n- **Serializable（可串行化）**\n这是最高的隔离级别，它通过强制事务排序，使之不可能相互冲突，从而解决幻读问题。简言之，它是在每个读的数据行上加上共享锁。在这个级别，可能导致大量的超时现象和锁竞争。\n\n## 脏读、不可重复读、幻读\n\n1. 脏读 ：脏读就是指当一个事务正在访问数据，并且对数据进行了修改，而这种修改还没有提交到数据库中，这时，另外一个事务也访问 这个数据，然后使用了这个数据。\n \n2. 不可重复读 ：是指在一个事务内，多次读同一数据。在这个事务还没有结束时，另外一个事务也访问该同一数据。那么，在第一个事务中的两 次读数据之间，由于第二个事务的修改，那么第一个事务两次读到的的数据可能是不一样的。这样就发生了在一个事务内两次读到的数据是不一样的，因此称为是不 可重复读。例如，一个编辑人员两次读取同一文档，但在两次读取之间，作者重写了该文档。当编辑人员第二次读取文档时，文档已更改。原始读取不可重复。如果 只有在作者全部完成编写后编辑人员才可以读取文档，则可以避免该问题。\n \n3. 幻读 : 是指当事务不是独立执行时发生的一种现象，例如第一个事务对一个表中的数据进行了修改，这种修改涉及到表中的全部数据行。 同时，第二个事务也修改这个表中的数据，这种修改是向表中插入一行新数据。那么，以后就会发生操作第一个事务的用户发现表中还有没有修改的数据行，就好象 发生了幻觉一样。例如，一个编辑人员更改作者提交的文档，但当生产部门将其更改内容合并到该文档的主复本时，发现作者已将未编辑的新材料添加到该文档中。 如果在编辑人员和生产部门完成对原始文档的处理之前，任何人都不能将新材料添加到文档中，则可以避免该问题。\n\n<p class=\"note note-primary\">这里只有幻读理解起来有些绕 简单来讲就是同一个事物中连续执行两次同样的sql语句，可能导致不同的结果问题，第二次sql语句可能返回之前不存在的行</p>\n\n## 不同隔离级别对应可能出现问题\n\n|      隔离级别      |  脏读  | 不可重复读 | 幻读  |\n|       ----        | ----  | ---      | ---   |\n| Read Uncommitted  | Y     | Y        | Y     |\n| Read Committed    | N     | Y        | Y     |\n| Repeatable Read   | N     | N        | Y     |\n| Serializable      | N     | N        | N     |\n\n","source":"_posts/设置MySQL的隔离级别.md","raw":"---\ntitle: 设置MySQL的隔离级别\ndate: 2021-08-25 23:00:28\nindex_img: /img/mysql/mysql.png\nbanner_img: /img/mysql/isolation.jpg\ncategories:\n  - 存储\ntags:\n  - mysql\n---\n\n\n## 怎么查当前的隔离级别？\n\n<p class=\"note note-success\">MySQL数据库默认的存储引擎是支持事务的innodb,所以自然的就有默认的隔离级别--可重复读</p>\n<p class=\"note note-warning\">只有支持ACID的存储引擎才有对应的各种隔离级别</p>\n\n在我们设置当前事务的隔离级别的时候我们首先要会查询我们的MySQL的隔离级别是什么\n\nMySQL查询隔离级别的语句是：\n\n```bash\nmysql> select @@global.tx_isolation,@@tx_isolation;\n+-----------------------+-----------------+\n| @@global.tx_isolation | @@tx_isolation  |\n+-----------------------+-----------------+\n| REPEATABLE-READ       | REPEATABLE-READ |\n+-----------------------+-----------------+\n1 row in set (0.00 sec)\n```\n\n## 如何设置自己的隔离级别？\n\n设置innodb的事务级别方法是：\n\nset 作用域 transaction isolation level 事务隔离级别，例如~\n\n> SET [SESSION | GLOBAL] TRANSACTION ISOLATION LEVEL {READ UNCOMMITTED | READ COMMITTED | REPEATABLE READ | SERIALIZABLE}\n\n```bash\n// 全局的\nmysql> set global transaction isolation level read committed;\n// 当前会话\nmysql> set session transaction isolation level read committed;\n```\n\n## 各个隔离级别都是啥意思？\n\nSQL标准定义了4类隔离级别，包括了一些具体规则，用来限定事务内外的哪些改变是可见的，哪些是不可见的。低级别的隔离级一般支持更高的并发处理，并拥有更低的系统开销。\n\n但是读提交和串行化一般很少使用\n\n- **Read Uncommitted（读取未提交内容）**\n在该隔离级别，所有事务都可以看到其他未提交事务的执行结果。本隔离级别很少用于实际应用，因为它的性能也不比其他级别好多少。读取未提交的数据，也被称之为脏读（Dirty Read）。\n\n- **Read Committed（读取提交内容）**\n这是大多数数据库系统的默认隔离级别（但不是MySQL默认的）。它满足了隔离的简单定义：一个事务只能看见已经提交事务所做的改变。这种隔离级别 也支持所谓的不可重复读（Nonrepeatable Read），因为同一事务的其他实例在该实例处理其间可能会有新的commit，所以同一select可能返回不同结果。\n\n- **Repeatable Read（可重读）**\n这是MySQL的默认事务隔离级别，它确保同一事务的多个实例在并发读取数据时，会看到同样的数据行。不过理论上，这会导致另一个棘手的问题：幻读 （Phantom Read）。简单的说，幻读指当用户读取某一范围的数据行时，另一个事务又在该范围内插入了新行，当用户再读取该范围的数据行时，会发现有新的“幻影” 行。InnoDB和Falcon存储引擎通过多版本并发控制（MVCC，Multiversion Concurrency Control）机制解决了该问题。\n\n- **Serializable（可串行化）**\n这是最高的隔离级别，它通过强制事务排序，使之不可能相互冲突，从而解决幻读问题。简言之，它是在每个读的数据行上加上共享锁。在这个级别，可能导致大量的超时现象和锁竞争。\n\n## 脏读、不可重复读、幻读\n\n1. 脏读 ：脏读就是指当一个事务正在访问数据，并且对数据进行了修改，而这种修改还没有提交到数据库中，这时，另外一个事务也访问 这个数据，然后使用了这个数据。\n \n2. 不可重复读 ：是指在一个事务内，多次读同一数据。在这个事务还没有结束时，另外一个事务也访问该同一数据。那么，在第一个事务中的两 次读数据之间，由于第二个事务的修改，那么第一个事务两次读到的的数据可能是不一样的。这样就发生了在一个事务内两次读到的数据是不一样的，因此称为是不 可重复读。例如，一个编辑人员两次读取同一文档，但在两次读取之间，作者重写了该文档。当编辑人员第二次读取文档时，文档已更改。原始读取不可重复。如果 只有在作者全部完成编写后编辑人员才可以读取文档，则可以避免该问题。\n \n3. 幻读 : 是指当事务不是独立执行时发生的一种现象，例如第一个事务对一个表中的数据进行了修改，这种修改涉及到表中的全部数据行。 同时，第二个事务也修改这个表中的数据，这种修改是向表中插入一行新数据。那么，以后就会发生操作第一个事务的用户发现表中还有没有修改的数据行，就好象 发生了幻觉一样。例如，一个编辑人员更改作者提交的文档，但当生产部门将其更改内容合并到该文档的主复本时，发现作者已将未编辑的新材料添加到该文档中。 如果在编辑人员和生产部门完成对原始文档的处理之前，任何人都不能将新材料添加到文档中，则可以避免该问题。\n\n<p class=\"note note-primary\">这里只有幻读理解起来有些绕 简单来讲就是同一个事物中连续执行两次同样的sql语句，可能导致不同的结果问题，第二次sql语句可能返回之前不存在的行</p>\n\n## 不同隔离级别对应可能出现问题\n\n|      隔离级别      |  脏读  | 不可重复读 | 幻读  |\n|       ----        | ----  | ---      | ---   |\n| Read Uncommitted  | Y     | Y        | Y     |\n| Read Committed    | N     | Y        | Y     |\n| Repeatable Read   | N     | N        | Y     |\n| Serializable      | N     | N        | N     |\n\n","slug":"设置MySQL的隔离级别","published":1,"updated":"2021-08-26T07:59:52.081Z","_id":"cksrmjlz70000lo8z831y2ng7","comments":1,"layout":"post","photos":[],"link":"","content":"<h2 id=\"怎么查当前的隔离级别？\"><a href=\"#怎么查当前的隔离级别？\" class=\"headerlink\" title=\"怎么查当前的隔离级别？\"></a>怎么查当前的隔离级别？</h2><p class=\"note note-success\">MySQL数据库默认的存储引擎是支持事务的innodb,所以自然的就有默认的隔离级别--可重复读</p>\n<p class=\"note note-warning\">只有支持ACID的存储引擎才有对应的各种隔离级别</p>\n\n<p>在我们设置当前事务的隔离级别的时候我们首先要会查询我们的MySQL的隔离级别是什么</p>\n<p>MySQL查询隔离级别的语句是：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter hljs\"><div class=\"hljs code-wrapper\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></div></td><td class=\"code\"><div class=\"hljs code-wrapper\"><pre><code class=\"hljs bash\">mysql&gt; select @@global.tx_isolation,@@tx_isolation;<br>+-----------------------+-----------------+<br>| @@global.tx_isolation | @@tx_isolation  |<br>+-----------------------+-----------------+<br>| REPEATABLE-READ       | REPEATABLE-READ |<br>+-----------------------+-----------------+<br>1 row <span class=\"hljs-keyword\">in</span> <span class=\"hljs-built_in\">set</span> (0.00 sec)<br></code></pre></div></td></tr></table></figure>\n\n<h2 id=\"如何设置自己的隔离级别？\"><a href=\"#如何设置自己的隔离级别？\" class=\"headerlink\" title=\"如何设置自己的隔离级别？\"></a>如何设置自己的隔离级别？</h2><p>设置innodb的事务级别方法是：</p>\n<p>set 作用域 transaction isolation level 事务隔离级别，例如~</p>\n<blockquote>\n<p>SET [SESSION | GLOBAL] TRANSACTION ISOLATION LEVEL {READ UNCOMMITTED | READ COMMITTED | REPEATABLE READ | SERIALIZABLE}</p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter hljs\"><div class=\"hljs code-wrapper\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></div></td><td class=\"code\"><div class=\"hljs code-wrapper\"><pre><code class=\"hljs bash\">// 全局的<br>mysql&gt; <span class=\"hljs-built_in\">set</span> global transaction isolation level <span class=\"hljs-built_in\">read</span> committed;<br>// 当前会话<br>mysql&gt; <span class=\"hljs-built_in\">set</span> session transaction isolation level <span class=\"hljs-built_in\">read</span> committed;<br></code></pre></div></td></tr></table></figure>\n\n<h2 id=\"各个隔离级别都是啥意思？\"><a href=\"#各个隔离级别都是啥意思？\" class=\"headerlink\" title=\"各个隔离级别都是啥意思？\"></a>各个隔离级别都是啥意思？</h2><p>SQL标准定义了4类隔离级别，包括了一些具体规则，用来限定事务内外的哪些改变是可见的，哪些是不可见的。低级别的隔离级一般支持更高的并发处理，并拥有更低的系统开销。</p>\n<p>但是读提交和串行化一般很少使用</p>\n<ul>\n<li><p><strong>Read Uncommitted（读取未提交内容）</strong><br>在该隔离级别，所有事务都可以看到其他未提交事务的执行结果。本隔离级别很少用于实际应用，因为它的性能也不比其他级别好多少。读取未提交的数据，也被称之为脏读（Dirty Read）。</p>\n</li>\n<li><p><strong>Read Committed（读取提交内容）</strong><br>这是大多数数据库系统的默认隔离级别（但不是MySQL默认的）。它满足了隔离的简单定义：一个事务只能看见已经提交事务所做的改变。这种隔离级别 也支持所谓的不可重复读（Nonrepeatable Read），因为同一事务的其他实例在该实例处理其间可能会有新的commit，所以同一select可能返回不同结果。</p>\n</li>\n<li><p><strong>Repeatable Read（可重读）</strong><br>这是MySQL的默认事务隔离级别，它确保同一事务的多个实例在并发读取数据时，会看到同样的数据行。不过理论上，这会导致另一个棘手的问题：幻读 （Phantom Read）。简单的说，幻读指当用户读取某一范围的数据行时，另一个事务又在该范围内插入了新行，当用户再读取该范围的数据行时，会发现有新的“幻影” 行。InnoDB和Falcon存储引擎通过多版本并发控制（MVCC，Multiversion Concurrency Control）机制解决了该问题。</p>\n</li>\n<li><p><strong>Serializable（可串行化）</strong><br>这是最高的隔离级别，它通过强制事务排序，使之不可能相互冲突，从而解决幻读问题。简言之，它是在每个读的数据行上加上共享锁。在这个级别，可能导致大量的超时现象和锁竞争。</p>\n</li>\n</ul>\n<h2 id=\"脏读、不可重复读、幻读\"><a href=\"#脏读、不可重复读、幻读\" class=\"headerlink\" title=\"脏读、不可重复读、幻读\"></a>脏读、不可重复读、幻读</h2><ol>\n<li>脏读 ：脏读就是指当一个事务正在访问数据，并且对数据进行了修改，而这种修改还没有提交到数据库中，这时，另外一个事务也访问 这个数据，然后使用了这个数据。</li>\n<li>不可重复读 ：是指在一个事务内，多次读同一数据。在这个事务还没有结束时，另外一个事务也访问该同一数据。那么，在第一个事务中的两 次读数据之间，由于第二个事务的修改，那么第一个事务两次读到的的数据可能是不一样的。这样就发生了在一个事务内两次读到的数据是不一样的，因此称为是不 可重复读。例如，一个编辑人员两次读取同一文档，但在两次读取之间，作者重写了该文档。当编辑人员第二次读取文档时，文档已更改。原始读取不可重复。如果 只有在作者全部完成编写后编辑人员才可以读取文档，则可以避免该问题。</li>\n<li>幻读 : 是指当事务不是独立执行时发生的一种现象，例如第一个事务对一个表中的数据进行了修改，这种修改涉及到表中的全部数据行。 同时，第二个事务也修改这个表中的数据，这种修改是向表中插入一行新数据。那么，以后就会发生操作第一个事务的用户发现表中还有没有修改的数据行，就好象 发生了幻觉一样。例如，一个编辑人员更改作者提交的文档，但当生产部门将其更改内容合并到该文档的主复本时，发现作者已将未编辑的新材料添加到该文档中。 如果在编辑人员和生产部门完成对原始文档的处理之前，任何人都不能将新材料添加到文档中，则可以避免该问题。</li>\n</ol>\n<p class=\"note note-primary\">这里只有幻读理解起来有些绕 简单来讲就是同一个事物中连续执行两次同样的sql语句，可能导致不同的结果问题，第二次sql语句可能返回之前不存在的行</p>\n\n<h2 id=\"不同隔离级别对应可能出现问题\"><a href=\"#不同隔离级别对应可能出现问题\" class=\"headerlink\" title=\"不同隔离级别对应可能出现问题\"></a>不同隔离级别对应可能出现问题</h2><table>\n<thead>\n<tr>\n<th>隔离级别</th>\n<th>脏读</th>\n<th>不可重复读</th>\n<th>幻读</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Read Uncommitted</td>\n<td>Y</td>\n<td>Y</td>\n<td>Y</td>\n</tr>\n<tr>\n<td>Read Committed</td>\n<td>N</td>\n<td>Y</td>\n<td>Y</td>\n</tr>\n<tr>\n<td>Repeatable Read</td>\n<td>N</td>\n<td>N</td>\n<td>Y</td>\n</tr>\n<tr>\n<td>Serializable</td>\n<td>N</td>\n<td>N</td>\n<td>N</td>\n</tr>\n</tbody></table>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"怎么查当前的隔离级别？\"><a href=\"#怎么查当前的隔离级别？\" class=\"headerlink\" title=\"怎么查当前的隔离级别？\"></a>怎么查当前的隔离级别？</h2><p class=\"note note-success\">MySQL数据库默认的存储引擎是支持事务的innodb,所以自然的就有默认的隔离级别--可重复读</p>\n<p class=\"note note-warning\">只有支持ACID的存储引擎才有对应的各种隔离级别</p>\n\n<p>在我们设置当前事务的隔离级别的时候我们首先要会查询我们的MySQL的隔离级别是什么</p>\n<p>MySQL查询隔离级别的语句是：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">mysql&gt; select @@global.tx_isolation,@@tx_isolation;<br>+-----------------------+-----------------+<br>| @@global.tx_isolation | @@tx_isolation  |<br>+-----------------------+-----------------+<br>| REPEATABLE-READ       | REPEATABLE-READ |<br>+-----------------------+-----------------+<br>1 row <span class=\"hljs-keyword\">in</span> <span class=\"hljs-built_in\">set</span> (0.00 sec)<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"如何设置自己的隔离级别？\"><a href=\"#如何设置自己的隔离级别？\" class=\"headerlink\" title=\"如何设置自己的隔离级别？\"></a>如何设置自己的隔离级别？</h2><p>设置innodb的事务级别方法是：</p>\n<p>set 作用域 transaction isolation level 事务隔离级别，例如~</p>\n<blockquote>\n<p>SET [SESSION | GLOBAL] TRANSACTION ISOLATION LEVEL {READ UNCOMMITTED | READ COMMITTED | REPEATABLE READ | SERIALIZABLE}</p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">// 全局的<br>mysql&gt; <span class=\"hljs-built_in\">set</span> global transaction isolation level <span class=\"hljs-built_in\">read</span> committed;<br>// 当前会话<br>mysql&gt; <span class=\"hljs-built_in\">set</span> session transaction isolation level <span class=\"hljs-built_in\">read</span> committed;<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"各个隔离级别都是啥意思？\"><a href=\"#各个隔离级别都是啥意思？\" class=\"headerlink\" title=\"各个隔离级别都是啥意思？\"></a>各个隔离级别都是啥意思？</h2><p>SQL标准定义了4类隔离级别，包括了一些具体规则，用来限定事务内外的哪些改变是可见的，哪些是不可见的。低级别的隔离级一般支持更高的并发处理，并拥有更低的系统开销。</p>\n<p>但是读提交和串行化一般很少使用</p>\n<ul>\n<li><p><strong>Read Uncommitted（读取未提交内容）</strong><br>在该隔离级别，所有事务都可以看到其他未提交事务的执行结果。本隔离级别很少用于实际应用，因为它的性能也不比其他级别好多少。读取未提交的数据，也被称之为脏读（Dirty Read）。</p>\n</li>\n<li><p><strong>Read Committed（读取提交内容）</strong><br>这是大多数数据库系统的默认隔离级别（但不是MySQL默认的）。它满足了隔离的简单定义：一个事务只能看见已经提交事务所做的改变。这种隔离级别 也支持所谓的不可重复读（Nonrepeatable Read），因为同一事务的其他实例在该实例处理其间可能会有新的commit，所以同一select可能返回不同结果。</p>\n</li>\n<li><p><strong>Repeatable Read（可重读）</strong><br>这是MySQL的默认事务隔离级别，它确保同一事务的多个实例在并发读取数据时，会看到同样的数据行。不过理论上，这会导致另一个棘手的问题：幻读 （Phantom Read）。简单的说，幻读指当用户读取某一范围的数据行时，另一个事务又在该范围内插入了新行，当用户再读取该范围的数据行时，会发现有新的“幻影” 行。InnoDB和Falcon存储引擎通过多版本并发控制（MVCC，Multiversion Concurrency Control）机制解决了该问题。</p>\n</li>\n<li><p><strong>Serializable（可串行化）</strong><br>这是最高的隔离级别，它通过强制事务排序，使之不可能相互冲突，从而解决幻读问题。简言之，它是在每个读的数据行上加上共享锁。在这个级别，可能导致大量的超时现象和锁竞争。</p>\n</li>\n</ul>\n<h2 id=\"脏读、不可重复读、幻读\"><a href=\"#脏读、不可重复读、幻读\" class=\"headerlink\" title=\"脏读、不可重复读、幻读\"></a>脏读、不可重复读、幻读</h2><ol>\n<li>脏读 ：脏读就是指当一个事务正在访问数据，并且对数据进行了修改，而这种修改还没有提交到数据库中，这时，另外一个事务也访问 这个数据，然后使用了这个数据。</li>\n<li>不可重复读 ：是指在一个事务内，多次读同一数据。在这个事务还没有结束时，另外一个事务也访问该同一数据。那么，在第一个事务中的两 次读数据之间，由于第二个事务的修改，那么第一个事务两次读到的的数据可能是不一样的。这样就发生了在一个事务内两次读到的数据是不一样的，因此称为是不 可重复读。例如，一个编辑人员两次读取同一文档，但在两次读取之间，作者重写了该文档。当编辑人员第二次读取文档时，文档已更改。原始读取不可重复。如果 只有在作者全部完成编写后编辑人员才可以读取文档，则可以避免该问题。</li>\n<li>幻读 : 是指当事务不是独立执行时发生的一种现象，例如第一个事务对一个表中的数据进行了修改，这种修改涉及到表中的全部数据行。 同时，第二个事务也修改这个表中的数据，这种修改是向表中插入一行新数据。那么，以后就会发生操作第一个事务的用户发现表中还有没有修改的数据行，就好象 发生了幻觉一样。例如，一个编辑人员更改作者提交的文档，但当生产部门将其更改内容合并到该文档的主复本时，发现作者已将未编辑的新材料添加到该文档中。 如果在编辑人员和生产部门完成对原始文档的处理之前，任何人都不能将新材料添加到文档中，则可以避免该问题。</li>\n</ol>\n<p class=\"note note-primary\">这里只有幻读理解起来有些绕 简单来讲就是同一个事物中连续执行两次同样的sql语句，可能导致不同的结果问题，第二次sql语句可能返回之前不存在的行</p>\n\n<h2 id=\"不同隔离级别对应可能出现问题\"><a href=\"#不同隔离级别对应可能出现问题\" class=\"headerlink\" title=\"不同隔离级别对应可能出现问题\"></a>不同隔离级别对应可能出现问题</h2><table>\n<thead>\n<tr>\n<th>隔离级别</th>\n<th>脏读</th>\n<th>不可重复读</th>\n<th>幻读</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Read Uncommitted</td>\n<td>Y</td>\n<td>Y</td>\n<td>Y</td>\n</tr>\n<tr>\n<td>Read Committed</td>\n<td>N</td>\n<td>Y</td>\n<td>Y</td>\n</tr>\n<tr>\n<td>Repeatable Read</td>\n<td>N</td>\n<td>N</td>\n<td>Y</td>\n</tr>\n<tr>\n<td>Serializable</td>\n<td>N</td>\n<td>N</td>\n<td>N</td>\n</tr>\n</tbody></table>\n"},{"title":"一致性哈希算法以及Go实现","_content":"\n## 什么是一致性哈希\n\n一致哈希 是一种特殊的哈希算法。在使用一致哈希算法后，哈希表槽位数（大小）的改变平均只需要对 K/n 个关键字重新映射，其中 K 是关键字的数量，n是槽位数量。然而在传统的哈希表中，添加或删除一个槽位的几乎需要对所有关键字进行重新映射。\n\n以上为维基百科中的介绍，很显然要想明白一致性哈希首先我们要先搞懂传统哈希\n\n## 传统哈希用例\n\n首先我们以一种简单的分布式缓存架构来阐述\n\n![图-1](/img/hash/redis-hash-cache.jpg)\n\n如图-1所示，我们有的时候后会使用redis对热点数据进行缓存进而缓解数据库的压力，理论上我们认为mysql的操作是高昂的。\n\n<p class=\"note note-success\">这里多个redis本质上是多个集群</p>\n\n这个时候我们希望将热点数据均匀的打散的多个redis上，来降低单个redis集群为缓存造成节点访问过热的情况发生。简单的我们可以理解为将不同的数据转换唯一值key后它按照redis数量取模。假设有3台redis做缓存。计算公式如下：\n\n```bash\n    h=hash(key)%3\n```\n\n我们把这3个redis对应编号，h的值就是这个数据应该落在的缓存redis的位置。这种方式就是传统的hash使用的一种，类似的在数据库分表对数据操作的时候也可以使用这种方式。\n\n**但是这种凡是是否完善呢？**\n\n很明显这种方式存在问题：当我们其中一个redis断电之或者新增一个那么对应的全部缓存对应的要全部改变位置，因为节点的数量发生改变了，仍然用之前的计算方法数据落点就会出现问题。为了解决这个问题一致性哈希就出现了。\n\n## 一致性哈希原理\n\n一致性哈希将整个哈希值空间组织成一个虚拟的圆环，如假设某哈希函数 H 的值空间为 0-2^32-1（即哈希值是一个 32 位无符号整形），整个哈希空间环如下：\n\n![图-2](/img/hash/cricle-hash-1.jpg)\n\n接下来就是将我们的缓存对象哈希化放到这个环中，访问数据的时候数据key也是用同样的算法计算出哈希，通过环上顺时针转动知道遇到第一个存贮节点，这个存储节点就是数据的保存节点。如图-3所\n\n![图-3](/img/hash/cricle-hash-2.png)\n\n图-3中object1的key哈希之后为400000000顺时针转动知道遇到第一个存储对象node2所以object1保存的对象为node2。\n\n<p class=\"note note-primary\">一般的如果一个节点不可用则这个节点上的数据就会分配到相邻的节点上而其他key所在的位置不会变化。新增一个节点同理</p>\n\n## 一致性哈希引入虚拟节点解决分配不均问题\n\n想必大聪明的你已经看出来了。当存储节点较少或者节点分配本身就不均衡的情况下，一些key落入的数据节点必然会不均衡这个时候又会造成节点过热。为解决这个问题引入了虚拟节点。即一个真实节点对应了多个虚拟的节点如图-4所示：\n\n![图-4](/img/hash/cricle-hash-3.png)\n\n图-4中的虚拟节点并不是真实的存储节点，而是按照一定规则批量生成的虚拟节点。这些虚拟节点都有一个对应的真实节点。\n\n## 一致性哈希与其哈希算法对比\n\n对于集群中缓存类数据key的节点分配问题，有这几种解决方法，简单的hash取模，槽映射，一致性hash。\n\n- **hash取模**\n对于hash取模，均衡性没有什么问题，但是如果集群中新增一个节点时，将会有N／（N+1）的数据实效，当N值越大，失效率越高。这显然是不可接受的。\n\n- **槽映射**\nredis采用的就是这种算法, 其思想是将key值做一定运算（如crc16， crc32，hash）， 获得一个整数值，再将该值与固定的槽数取模（slots）， 每个节点处理固定的slots。获取key所在的节点时，先要计算出key与槽的对应关系，再通过槽与节点的对应关系找到节点，这里每次新增节点时，只需要迁移一定槽对应的key即可，而不迁移的槽点key值则不会实效，这种方式将失效率降低到了 1／（N+1）。不过这种方式有个缺点就是所有节点都需要知道槽与节点对应关系，如果client端不保存槽与节点的对应关系的话，它需要实现重定向的逻辑。\n\n- **一致性hash**\n一致性hash如上文所言，其新增一个节点的失效率仅为1／（N+1），通过一致性hash最大程度的降低了实效率。同时相比于槽映射的方式，不需要引人槽来做中间对应，最大限度的简化了实现。\n\n## Go实现一致性哈希\n\n**代码实现详细[github.com/dogslee/consistent](https://github.com/dogslee/consistent)**\n\n使用样例:\n\n```golang\nimport (\n\t\"fmt\"\n\t\"log\"\n\n\t\"github.com/dogslee/consistent\"\n)\n\nfunc main() {\n\t// default consistent hash function\n\tc := consistent.New()\n\t// add new node\n\tc.Add(\"node1\")\n\tc.Add(\"node2\")\n\tc.Add(\"node3\")\n\tc.Add(\"node4\")\n\tkeyCase := []string{\"user1\", \"user2\", \"user3\", \"user4\"}\n\tfor _, k := range keyCase {\n\t\tsrvNode, err := c.Get(k)\n\t\tif err != nil {\n\t\t\tlog.Fatal(err)\n\t\t}\n\t\tfmt.Printf(\"key: %s ==> srvNode: %s\", k, srvNode)\n\t}\n}\n```\n\n## Refrence\n\n[一致性哈希算法](https://wizardforcel.gitbooks.io/the-art-of-programming-by-july/content/a.3.html)\n[5分钟理解一致性哈希算法](https://juejin.cn/post/6844903750860013576)\n[维基百科-一致性哈希](https://zh.wikipedia.org/wiki/%E4%B8%80%E8%87%B4%E5%93%88%E5%B8%8C)\n[golang 实现一致性 hash 算法](https://xie.infoq.cn/article/78043810ecc807d1896c6f3f2)\n[一致性hash算法原理及golang实现](https://segmentfault.com/a/1190000013533592)\n","source":"_posts/一致性哈希算法以及Go实现.md","raw":"---\ntitle: 一致性哈希算法以及Go实现\ntags:\n---\n\n## 什么是一致性哈希\n\n一致哈希 是一种特殊的哈希算法。在使用一致哈希算法后，哈希表槽位数（大小）的改变平均只需要对 K/n 个关键字重新映射，其中 K 是关键字的数量，n是槽位数量。然而在传统的哈希表中，添加或删除一个槽位的几乎需要对所有关键字进行重新映射。\n\n以上为维基百科中的介绍，很显然要想明白一致性哈希首先我们要先搞懂传统哈希\n\n## 传统哈希用例\n\n首先我们以一种简单的分布式缓存架构来阐述\n\n![图-1](/img/hash/redis-hash-cache.jpg)\n\n如图-1所示，我们有的时候后会使用redis对热点数据进行缓存进而缓解数据库的压力，理论上我们认为mysql的操作是高昂的。\n\n<p class=\"note note-success\">这里多个redis本质上是多个集群</p>\n\n这个时候我们希望将热点数据均匀的打散的多个redis上，来降低单个redis集群为缓存造成节点访问过热的情况发生。简单的我们可以理解为将不同的数据转换唯一值key后它按照redis数量取模。假设有3台redis做缓存。计算公式如下：\n\n```bash\n    h=hash(key)%3\n```\n\n我们把这3个redis对应编号，h的值就是这个数据应该落在的缓存redis的位置。这种方式就是传统的hash使用的一种，类似的在数据库分表对数据操作的时候也可以使用这种方式。\n\n**但是这种凡是是否完善呢？**\n\n很明显这种方式存在问题：当我们其中一个redis断电之或者新增一个那么对应的全部缓存对应的要全部改变位置，因为节点的数量发生改变了，仍然用之前的计算方法数据落点就会出现问题。为了解决这个问题一致性哈希就出现了。\n\n## 一致性哈希原理\n\n一致性哈希将整个哈希值空间组织成一个虚拟的圆环，如假设某哈希函数 H 的值空间为 0-2^32-1（即哈希值是一个 32 位无符号整形），整个哈希空间环如下：\n\n![图-2](/img/hash/cricle-hash-1.jpg)\n\n接下来就是将我们的缓存对象哈希化放到这个环中，访问数据的时候数据key也是用同样的算法计算出哈希，通过环上顺时针转动知道遇到第一个存贮节点，这个存储节点就是数据的保存节点。如图-3所\n\n![图-3](/img/hash/cricle-hash-2.png)\n\n图-3中object1的key哈希之后为400000000顺时针转动知道遇到第一个存储对象node2所以object1保存的对象为node2。\n\n<p class=\"note note-primary\">一般的如果一个节点不可用则这个节点上的数据就会分配到相邻的节点上而其他key所在的位置不会变化。新增一个节点同理</p>\n\n## 一致性哈希引入虚拟节点解决分配不均问题\n\n想必大聪明的你已经看出来了。当存储节点较少或者节点分配本身就不均衡的情况下，一些key落入的数据节点必然会不均衡这个时候又会造成节点过热。为解决这个问题引入了虚拟节点。即一个真实节点对应了多个虚拟的节点如图-4所示：\n\n![图-4](/img/hash/cricle-hash-3.png)\n\n图-4中的虚拟节点并不是真实的存储节点，而是按照一定规则批量生成的虚拟节点。这些虚拟节点都有一个对应的真实节点。\n\n## 一致性哈希与其哈希算法对比\n\n对于集群中缓存类数据key的节点分配问题，有这几种解决方法，简单的hash取模，槽映射，一致性hash。\n\n- **hash取模**\n对于hash取模，均衡性没有什么问题，但是如果集群中新增一个节点时，将会有N／（N+1）的数据实效，当N值越大，失效率越高。这显然是不可接受的。\n\n- **槽映射**\nredis采用的就是这种算法, 其思想是将key值做一定运算（如crc16， crc32，hash）， 获得一个整数值，再将该值与固定的槽数取模（slots）， 每个节点处理固定的slots。获取key所在的节点时，先要计算出key与槽的对应关系，再通过槽与节点的对应关系找到节点，这里每次新增节点时，只需要迁移一定槽对应的key即可，而不迁移的槽点key值则不会实效，这种方式将失效率降低到了 1／（N+1）。不过这种方式有个缺点就是所有节点都需要知道槽与节点对应关系，如果client端不保存槽与节点的对应关系的话，它需要实现重定向的逻辑。\n\n- **一致性hash**\n一致性hash如上文所言，其新增一个节点的失效率仅为1／（N+1），通过一致性hash最大程度的降低了实效率。同时相比于槽映射的方式，不需要引人槽来做中间对应，最大限度的简化了实现。\n\n## Go实现一致性哈希\n\n**代码实现详细[github.com/dogslee/consistent](https://github.com/dogslee/consistent)**\n\n使用样例:\n\n```golang\nimport (\n\t\"fmt\"\n\t\"log\"\n\n\t\"github.com/dogslee/consistent\"\n)\n\nfunc main() {\n\t// default consistent hash function\n\tc := consistent.New()\n\t// add new node\n\tc.Add(\"node1\")\n\tc.Add(\"node2\")\n\tc.Add(\"node3\")\n\tc.Add(\"node4\")\n\tkeyCase := []string{\"user1\", \"user2\", \"user3\", \"user4\"}\n\tfor _, k := range keyCase {\n\t\tsrvNode, err := c.Get(k)\n\t\tif err != nil {\n\t\t\tlog.Fatal(err)\n\t\t}\n\t\tfmt.Printf(\"key: %s ==> srvNode: %s\", k, srvNode)\n\t}\n}\n```\n\n## Refrence\n\n[一致性哈希算法](https://wizardforcel.gitbooks.io/the-art-of-programming-by-july/content/a.3.html)\n[5分钟理解一致性哈希算法](https://juejin.cn/post/6844903750860013576)\n[维基百科-一致性哈希](https://zh.wikipedia.org/wiki/%E4%B8%80%E8%87%B4%E5%93%88%E5%B8%8C)\n[golang 实现一致性 hash 算法](https://xie.infoq.cn/article/78043810ecc807d1896c6f3f2)\n[一致性hash算法原理及golang实现](https://segmentfault.com/a/1190000013533592)\n","slug":"一致性哈希算法以及Go实现","published":1,"date":"2021-08-31T09:47:11.441Z","updated":"2021-09-03T09:30:48.657Z","_id":"ckt45i8a500010v8zddqfhzos","comments":1,"layout":"post","photos":[],"link":"","content":"<h2 id=\"什么是一致性哈希\"><a href=\"#什么是一致性哈希\" class=\"headerlink\" title=\"什么是一致性哈希\"></a>什么是一致性哈希</h2><p>一致哈希 是一种特殊的哈希算法。在使用一致哈希算法后，哈希表槽位数（大小）的改变平均只需要对 K/n 个关键字重新映射，其中 K 是关键字的数量，n是槽位数量。然而在传统的哈希表中，添加或删除一个槽位的几乎需要对所有关键字进行重新映射。</p>\n<p>以上为维基百科中的介绍，很显然要想明白一致性哈希首先我们要先搞懂传统哈希</p>\n<h2 id=\"传统哈希用例\"><a href=\"#传统哈希用例\" class=\"headerlink\" title=\"传统哈希用例\"></a>传统哈希用例</h2><p>首先我们以一种简单的分布式缓存架构来阐述</p>\n<p><img src=\"/img/hash/redis-hash-cache.jpg\" alt=\"图-1\"></p>\n<p>如图-1所示，我们有的时候后会使用redis对热点数据进行缓存进而缓解数据库的压力，理论上我们认为mysql的操作是高昂的。</p>\n<p class=\"note note-success\">这里多个redis本质上是多个集群</p>\n\n<p>这个时候我们希望将热点数据均匀的打散的多个redis上，来降低单个redis集群为缓存造成节点访问过热的情况发生。简单的我们可以理解为将不同的数据转换唯一值key后它按照redis数量取模。假设有3台redis做缓存。计算公式如下：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter hljs\"><div class=\"hljs code-wrapper\"><pre><span class=\"line\">1</span><br></pre></div></td><td class=\"code\"><div class=\"hljs code-wrapper\"><pre><code class=\"hljs bash\">h=<span class=\"hljs-built_in\">hash</span>(key)%3<br></code></pre></div></td></tr></table></figure>\n\n<p>我们把这3个redis对应编号，h的值就是这个数据应该落在的缓存redis的位置。这种方式就是传统的hash使用的一种，类似的在数据库分表对数据操作的时候也可以使用这种方式。</p>\n<p><strong>但是这种凡是是否完善呢？</strong></p>\n<p>很明显这种方式存在问题：当我们其中一个redis断电之或者新增一个那么对应的全部缓存对应的要全部改变位置，因为节点的数量发生改变了，仍然用之前的计算方法数据落点就会出现问题。为了解决这个问题一致性哈希就出现了。</p>\n<h2 id=\"一致性哈希原理\"><a href=\"#一致性哈希原理\" class=\"headerlink\" title=\"一致性哈希原理\"></a>一致性哈希原理</h2><p>一致性哈希将整个哈希值空间组织成一个虚拟的圆环，如假设某哈希函数 H 的值空间为 0-2^32-1（即哈希值是一个 32 位无符号整形），整个哈希空间环如下：</p>\n<p><img src=\"/img/hash/cricle-hash-1.jpg\" alt=\"图-2\"></p>\n<p>接下来就是将我们的缓存对象哈希化放到这个环中，访问数据的时候数据key也是用同样的算法计算出哈希，通过环上顺时针转动知道遇到第一个存贮节点，这个存储节点就是数据的保存节点。如图-3所</p>\n<p><img src=\"/img/hash/cricle-hash-2.png\" alt=\"图-3\"></p>\n<p>图-3中object1的key哈希之后为400000000顺时针转动知道遇到第一个存储对象node2所以object1保存的对象为node2。</p>\n<p class=\"note note-primary\">一般的如果一个节点不可用则这个节点上的数据就会分配到相邻的节点上而其他key所在的位置不会变化。新增一个节点同理</p>\n\n<h2 id=\"一致性哈希引入虚拟节点解决分配不均问题\"><a href=\"#一致性哈希引入虚拟节点解决分配不均问题\" class=\"headerlink\" title=\"一致性哈希引入虚拟节点解决分配不均问题\"></a>一致性哈希引入虚拟节点解决分配不均问题</h2><p>想必大聪明的你已经看出来了。当存储节点较少或者节点分配本身就不均衡的情况下，一些key落入的数据节点必然会不均衡这个时候又会造成节点过热。为解决这个问题引入了虚拟节点。即一个真实节点对应了多个虚拟的节点如图-4所示：</p>\n<p><img src=\"/img/hash/cricle-hash-3.png\" alt=\"图-4\"></p>\n<p>图-4中的虚拟节点并不是真实的存储节点，而是按照一定规则批量生成的虚拟节点。这些虚拟节点都有一个对应的真实节点。</p>\n<h2 id=\"一致性哈希与其哈希算法对比\"><a href=\"#一致性哈希与其哈希算法对比\" class=\"headerlink\" title=\"一致性哈希与其哈希算法对比\"></a>一致性哈希与其哈希算法对比</h2><p>对于集群中缓存类数据key的节点分配问题，有这几种解决方法，简单的hash取模，槽映射，一致性hash。</p>\n<ul>\n<li><p><strong>hash取模</strong><br>对于hash取模，均衡性没有什么问题，但是如果集群中新增一个节点时，将会有N／（N+1）的数据实效，当N值越大，失效率越高。这显然是不可接受的。</p>\n</li>\n<li><p><strong>槽映射</strong><br>redis采用的就是这种算法, 其思想是将key值做一定运算（如crc16， crc32，hash）， 获得一个整数值，再将该值与固定的槽数取模（slots）， 每个节点处理固定的slots。获取key所在的节点时，先要计算出key与槽的对应关系，再通过槽与节点的对应关系找到节点，这里每次新增节点时，只需要迁移一定槽对应的key即可，而不迁移的槽点key值则不会实效，这种方式将失效率降低到了 1／（N+1）。不过这种方式有个缺点就是所有节点都需要知道槽与节点对应关系，如果client端不保存槽与节点的对应关系的话，它需要实现重定向的逻辑。</p>\n</li>\n<li><p><strong>一致性hash</strong><br>一致性hash如上文所言，其新增一个节点的失效率仅为1／（N+1），通过一致性hash最大程度的降低了实效率。同时相比于槽映射的方式，不需要引人槽来做中间对应，最大限度的简化了实现。</p>\n</li>\n</ul>\n<h2 id=\"Go实现一致性哈希\"><a href=\"#Go实现一致性哈希\" class=\"headerlink\" title=\"Go实现一致性哈希\"></a>Go实现一致性哈希</h2><p><strong>代码实现详细<a href=\"https://github.com/dogslee/consistent\">github.com/dogslee/consistent</a></strong></p>\n<p>使用样例:</p>\n<figure class=\"highlight golang\"><table><tr><td class=\"gutter hljs\"><div class=\"hljs code-wrapper\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></div></td><td class=\"code\"><div class=\"hljs code-wrapper\"><pre><code class=\"hljs golang\"><span class=\"hljs-keyword\">import</span> (<br>\t<span class=\"hljs-string\">&quot;fmt&quot;</span><br>\t<span class=\"hljs-string\">&quot;log&quot;</span><br><br>\t<span class=\"hljs-string\">&quot;github.com/dogslee/consistent&quot;</span><br>)<br><br><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-title\">main</span><span class=\"hljs-params\">()</span></span> &#123;<br>\t<span class=\"hljs-comment\">// default consistent hash function</span><br>\tc := consistent.New()<br>\t<span class=\"hljs-comment\">// add new node</span><br>\tc.Add(<span class=\"hljs-string\">&quot;node1&quot;</span>)<br>\tc.Add(<span class=\"hljs-string\">&quot;node2&quot;</span>)<br>\tc.Add(<span class=\"hljs-string\">&quot;node3&quot;</span>)<br>\tc.Add(<span class=\"hljs-string\">&quot;node4&quot;</span>)<br>\tkeyCase := []<span class=\"hljs-keyword\">string</span>&#123;<span class=\"hljs-string\">&quot;user1&quot;</span>, <span class=\"hljs-string\">&quot;user2&quot;</span>, <span class=\"hljs-string\">&quot;user3&quot;</span>, <span class=\"hljs-string\">&quot;user4&quot;</span>&#125;<br>\t<span class=\"hljs-keyword\">for</span> _, k := <span class=\"hljs-keyword\">range</span> keyCase &#123;<br>\t\tsrvNode, err := c.Get(k)<br>\t\t<span class=\"hljs-keyword\">if</span> err != <span class=\"hljs-literal\">nil</span> &#123;<br>\t\t\tlog.Fatal(err)<br>\t\t&#125;<br>\t\tfmt.Printf(<span class=\"hljs-string\">&quot;key: %s ==&gt; srvNode: %s&quot;</span>, k, srvNode)<br>\t&#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>\n\n<h2 id=\"Refrence\"><a href=\"#Refrence\" class=\"headerlink\" title=\"Refrence\"></a>Refrence</h2><p><a href=\"https://wizardforcel.gitbooks.io/the-art-of-programming-by-july/content/a.3.html\">一致性哈希算法</a><br><a href=\"https://juejin.cn/post/6844903750860013576\">5分钟理解一致性哈希算法</a><br><a href=\"https://zh.wikipedia.org/wiki/%E4%B8%80%E8%87%B4%E5%93%88%E5%B8%8C\">维基百科-一致性哈希</a><br><a href=\"https://xie.infoq.cn/article/78043810ecc807d1896c6f3f2\">golang 实现一致性 hash 算法</a><br><a href=\"https://segmentfault.com/a/1190000013533592\">一致性hash算法原理及golang实现</a></p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"什么是一致性哈希\"><a href=\"#什么是一致性哈希\" class=\"headerlink\" title=\"什么是一致性哈希\"></a>什么是一致性哈希</h2><p>一致哈希 是一种特殊的哈希算法。在使用一致哈希算法后，哈希表槽位数（大小）的改变平均只需要对 K/n 个关键字重新映射，其中 K 是关键字的数量，n是槽位数量。然而在传统的哈希表中，添加或删除一个槽位的几乎需要对所有关键字进行重新映射。</p>\n<p>以上为维基百科中的介绍，很显然要想明白一致性哈希首先我们要先搞懂传统哈希</p>\n<h2 id=\"传统哈希用例\"><a href=\"#传统哈希用例\" class=\"headerlink\" title=\"传统哈希用例\"></a>传统哈希用例</h2><p>首先我们以一种简单的分布式缓存架构来阐述</p>\n<p><img src=\"/img/hash/redis-hash-cache.jpg\" alt=\"图-1\"></p>\n<p>如图-1所示，我们有的时候后会使用redis对热点数据进行缓存进而缓解数据库的压力，理论上我们认为mysql的操作是高昂的。</p>\n<p class=\"note note-success\">这里多个redis本质上是多个集群</p>\n\n<p>这个时候我们希望将热点数据均匀的打散的多个redis上，来降低单个redis集群为缓存造成节点访问过热的情况发生。简单的我们可以理解为将不同的数据转换唯一值key后它按照redis数量取模。假设有3台redis做缓存。计算公式如下：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">h=<span class=\"hljs-built_in\">hash</span>(key)%3<br></code></pre></td></tr></table></figure>\n\n<p>我们把这3个redis对应编号，h的值就是这个数据应该落在的缓存redis的位置。这种方式就是传统的hash使用的一种，类似的在数据库分表对数据操作的时候也可以使用这种方式。</p>\n<p><strong>但是这种凡是是否完善呢？</strong></p>\n<p>很明显这种方式存在问题：当我们其中一个redis断电之或者新增一个那么对应的全部缓存对应的要全部改变位置，因为节点的数量发生改变了，仍然用之前的计算方法数据落点就会出现问题。为了解决这个问题一致性哈希就出现了。</p>\n<h2 id=\"一致性哈希原理\"><a href=\"#一致性哈希原理\" class=\"headerlink\" title=\"一致性哈希原理\"></a>一致性哈希原理</h2><p>一致性哈希将整个哈希值空间组织成一个虚拟的圆环，如假设某哈希函数 H 的值空间为 0-2^32-1（即哈希值是一个 32 位无符号整形），整个哈希空间环如下：</p>\n<p><img src=\"/img/hash/cricle-hash-1.jpg\" alt=\"图-2\"></p>\n<p>接下来就是将我们的缓存对象哈希化放到这个环中，访问数据的时候数据key也是用同样的算法计算出哈希，通过环上顺时针转动知道遇到第一个存贮节点，这个存储节点就是数据的保存节点。如图-3所</p>\n<p><img src=\"/img/hash/cricle-hash-2.png\" alt=\"图-3\"></p>\n<p>图-3中object1的key哈希之后为400000000顺时针转动知道遇到第一个存储对象node2所以object1保存的对象为node2。</p>\n<p class=\"note note-primary\">一般的如果一个节点不可用则这个节点上的数据就会分配到相邻的节点上而其他key所在的位置不会变化。新增一个节点同理</p>\n\n<h2 id=\"一致性哈希引入虚拟节点解决分配不均问题\"><a href=\"#一致性哈希引入虚拟节点解决分配不均问题\" class=\"headerlink\" title=\"一致性哈希引入虚拟节点解决分配不均问题\"></a>一致性哈希引入虚拟节点解决分配不均问题</h2><p>想必大聪明的你已经看出来了。当存储节点较少或者节点分配本身就不均衡的情况下，一些key落入的数据节点必然会不均衡这个时候又会造成节点过热。为解决这个问题引入了虚拟节点。即一个真实节点对应了多个虚拟的节点如图-4所示：</p>\n<p><img src=\"/img/hash/cricle-hash-3.png\" alt=\"图-4\"></p>\n<p>图-4中的虚拟节点并不是真实的存储节点，而是按照一定规则批量生成的虚拟节点。这些虚拟节点都有一个对应的真实节点。</p>\n<h2 id=\"一致性哈希与其哈希算法对比\"><a href=\"#一致性哈希与其哈希算法对比\" class=\"headerlink\" title=\"一致性哈希与其哈希算法对比\"></a>一致性哈希与其哈希算法对比</h2><p>对于集群中缓存类数据key的节点分配问题，有这几种解决方法，简单的hash取模，槽映射，一致性hash。</p>\n<ul>\n<li><p><strong>hash取模</strong><br>对于hash取模，均衡性没有什么问题，但是如果集群中新增一个节点时，将会有N／（N+1）的数据实效，当N值越大，失效率越高。这显然是不可接受的。</p>\n</li>\n<li><p><strong>槽映射</strong><br>redis采用的就是这种算法, 其思想是将key值做一定运算（如crc16， crc32，hash）， 获得一个整数值，再将该值与固定的槽数取模（slots）， 每个节点处理固定的slots。获取key所在的节点时，先要计算出key与槽的对应关系，再通过槽与节点的对应关系找到节点，这里每次新增节点时，只需要迁移一定槽对应的key即可，而不迁移的槽点key值则不会实效，这种方式将失效率降低到了 1／（N+1）。不过这种方式有个缺点就是所有节点都需要知道槽与节点对应关系，如果client端不保存槽与节点的对应关系的话，它需要实现重定向的逻辑。</p>\n</li>\n<li><p><strong>一致性hash</strong><br>一致性hash如上文所言，其新增一个节点的失效率仅为1／（N+1），通过一致性hash最大程度的降低了实效率。同时相比于槽映射的方式，不需要引人槽来做中间对应，最大限度的简化了实现。</p>\n</li>\n</ul>\n<h2 id=\"Go实现一致性哈希\"><a href=\"#Go实现一致性哈希\" class=\"headerlink\" title=\"Go实现一致性哈希\"></a>Go实现一致性哈希</h2><p><strong>代码实现详细<a href=\"https://github.com/dogslee/consistent\">github.com/dogslee/consistent</a></strong></p>\n<p>使用样例:</p>\n<figure class=\"highlight golang\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs golang\"><span class=\"hljs-keyword\">import</span> (<br>\t<span class=\"hljs-string\">&quot;fmt&quot;</span><br>\t<span class=\"hljs-string\">&quot;log&quot;</span><br><br>\t<span class=\"hljs-string\">&quot;github.com/dogslee/consistent&quot;</span><br>)<br><br><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-title\">main</span><span class=\"hljs-params\">()</span></span> &#123;<br>\t<span class=\"hljs-comment\">// default consistent hash function</span><br>\tc := consistent.New()<br>\t<span class=\"hljs-comment\">// add new node</span><br>\tc.Add(<span class=\"hljs-string\">&quot;node1&quot;</span>)<br>\tc.Add(<span class=\"hljs-string\">&quot;node2&quot;</span>)<br>\tc.Add(<span class=\"hljs-string\">&quot;node3&quot;</span>)<br>\tc.Add(<span class=\"hljs-string\">&quot;node4&quot;</span>)<br>\tkeyCase := []<span class=\"hljs-keyword\">string</span>&#123;<span class=\"hljs-string\">&quot;user1&quot;</span>, <span class=\"hljs-string\">&quot;user2&quot;</span>, <span class=\"hljs-string\">&quot;user3&quot;</span>, <span class=\"hljs-string\">&quot;user4&quot;</span>&#125;<br>\t<span class=\"hljs-keyword\">for</span> _, k := <span class=\"hljs-keyword\">range</span> keyCase &#123;<br>\t\tsrvNode, err := c.Get(k)<br>\t\t<span class=\"hljs-keyword\">if</span> err != <span class=\"hljs-literal\">nil</span> &#123;<br>\t\t\tlog.Fatal(err)<br>\t\t&#125;<br>\t\tfmt.Printf(<span class=\"hljs-string\">&quot;key: %s ==&gt; srvNode: %s&quot;</span>, k, srvNode)<br>\t&#125;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"Refrence\"><a href=\"#Refrence\" class=\"headerlink\" title=\"Refrence\"></a>Refrence</h2><p><a href=\"https://wizardforcel.gitbooks.io/the-art-of-programming-by-july/content/a.3.html\">一致性哈希算法</a><br><a href=\"https://juejin.cn/post/6844903750860013576\">5分钟理解一致性哈希算法</a><br><a href=\"https://zh.wikipedia.org/wiki/%E4%B8%80%E8%87%B4%E5%93%88%E5%B8%8C\">维基百科-一致性哈希</a><br><a href=\"https://xie.infoq.cn/article/78043810ecc807d1896c6f3f2\">golang 实现一致性 hash 算法</a><br><a href=\"https://segmentfault.com/a/1190000013533592\">一致性hash算法原理及golang实现</a></p>\n"}],"PostAsset":[],"PostCategory":[{"post_id":"ckshaj2460001ie8zaa5998l6","category_id":"ckshc2kdo00002r8z2adqd3mj","_id":"ckshls3e200029d8zejs27y6v"},{"post_id":"cksoctoh00000mn8z5wzr74op","category_id":"cksoctoh70001mn8z7tr052fq","_id":"cksoctohb0004mn8zhjiuell2"},{"post_id":"cksriqm8v0000c88zfvb4dus5","category_id":"cksoctoh70001mn8z7tr052fq","_id":"cksriqm910003c88z8y50dug6"},{"post_id":"cksrmjlz70000lo8z831y2ng7","category_id":"cksoctoh70001mn8z7tr052fq","_id":"cksrmjlzf0002lo8z7mvl8dfa"}],"PostTag":[{"post_id":"ckshaj2460001ie8zaa5998l6","tag_id":"ckshc2kdr00012r8z4414c3mi","_id":"ckshls3dz00009d8z0eqp1p37"},{"post_id":"ckshaj2460001ie8zaa5998l6","tag_id":"ckshbt0m80000tn8zhr2vfybb","_id":"ckshls3e200019d8z4fwg0jqj"},{"post_id":"cksoctoh00000mn8z5wzr74op","tag_id":"cksoctoh90002mn8zhor2fxcq","_id":"cksoctohc0006mn8zbvun1ieo"},{"post_id":"cksoctoh00000mn8z5wzr74op","tag_id":"cksoctoha0003mn8z8ujq9jc9","_id":"cksoctohc0007mn8z477rf4m7"},{"post_id":"cksoctoh00000mn8z5wzr74op","tag_id":"cksoctohb0005mn8zdvkednm4","_id":"cksoctohc0008mn8zdpnl55ec"},{"post_id":"cksriqm8v0000c88zfvb4dus5","tag_id":"cksoctoh90002mn8zhor2fxcq","_id":"cksriqm910001c88zgpmu3fsl"},{"post_id":"cksriqm8v0000c88zfvb4dus5","tag_id":"cksrbn4bh00011w8z29tfecvu","_id":"cksriqm910002c88z6vvm1zo6"},{"post_id":"cksriqm8v0000c88zfvb4dus5","tag_id":"cksrbn4bk00031w8zdfvc1vl4","_id":"cksriqm910004c88zfw150nhy"},{"post_id":"cksrmjlz70000lo8z831y2ng7","tag_id":"cksoctoh90002mn8zhor2fxcq","_id":"cksrmjlzf0001lo8zh9y4fv6j"}],"Tag":[{"name":"ddd","_id":"ckshbt0m80000tn8zhr2vfybb"},{"name":"微服务","_id":"ckshc2kdr00012r8z4414c3mi"},{"name":"mysql","_id":"cksoctoh90002mn8zhor2fxcq"},{"name":"高可用","_id":"cksoctoha0003mn8z8ujq9jc9"},{"name":"数据同步","_id":"cksoctohb0005mn8zdvkednm4"},{"name":"ACID","_id":"cksrbn4bh00011w8z29tfecvu"},{"name":"mvcc","_id":"cksrbn4bk00031w8zdfvc1vl4"}]}}